{"version":3,"file":"continuous.min.js","sources":["../src/continuous.js"],"sourcesContent":["// Continuous-only logic for harpiasurvey chat.\nimport {\n    Templates,\n    Notification,\n    Config,\n    getString,\n    $,\n    conversationTrees,\n    scrollToBottom,\n    addError,\n    getCmid\n} from './common_chat';\n\nlet initialized = false;\nlet commonHandlersRegistered = false;\nlet treeHandlersRegistered = false;\nlet editLabel = 'Edit';\n\nconst lockQuestionItem = (questionItem) => {\n    questionItem.attr('data-response-locked', '1');\n    questionItem.removeAttr('data-response-editing');\n    questionItem.find('input, select, textarea').prop('disabled', true);\n};\n\nconst ensureEditButton = (questionItem) => {\n    let controls = questionItem.find('.question-edit-controls');\n    if (controls.length === 0) {\n        controls = $('<div class=\"mt-2 question-edit-controls\"></div>');\n        questionItem.append(controls);\n    }\n    let button = controls.find('.question-edit-btn');\n    if (button.length === 0) {\n        button = $('<button type=\"button\" class=\"btn btn-sm btn-outline-secondary question-edit-btn\"></button>');\n        controls.append(button);\n    }\n    button.text(editLabel);\n    button.show();\n};\n\nconst clearEvaluationQuestion = (questionItem) => {\n    questionItem.removeAttr('data-response-locked');\n    questionItem.removeAttr('data-response-editing');\n    questionItem.find('.saved-response-message').remove();\n    questionItem.find('.answer-history').remove();\n    questionItem.find('.question-edit-controls').remove();\n\n    const questionType = questionItem.data('questiontype');\n    if (questionType === 'singlechoice' || questionType === 'likert') {\n        questionItem.find('input[type=\"radio\"]').prop('checked', false);\n    } else if (questionType === 'multiplechoice') {\n        questionItem.find('input[type=\"checkbox\"]').prop('checked', false);\n    } else if (questionType === 'select') {\n        questionItem.find('select').prop('selectedIndex', 0);\n    } else if (questionType === 'number' || questionType === 'shorttext') {\n        questionItem.find('input[type=\"number\"], input[type=\"text\"]').val('');\n    } else if (questionType === 'longtext') {\n        questionItem.find('textarea').val('');\n    }\n    questionItem.find('input, select, textarea').prop('disabled', false);\n};\n\nconst loadConversationEvaluationResponses = (pageid, conversationId) => {\n    const cmid = getCmid(pageid);\n    if (!cmid) {\n        return;\n    }\n    let evaluationContainer = $(\n        `.save-all-responses-btn[data-pageid=\"${pageid}\"]`\n    ).first().closest('.page-questions');\n    if (evaluationContainer.length === 0) {\n        evaluationContainer = $(`.page-questions`).first();\n    }\n    if (evaluationContainer.length === 0) {\n        return;\n    }\n\n    const questionItems = evaluationContainer.find('.question-item[data-questionid]');\n    questionItems.each(function() {\n        clearEvaluationQuestion($(this));\n    });\n\n    if (!conversationId) {\n        return;\n    }\n\n    const params = new URLSearchParams({\n        action: 'get_turn_responses',\n        cmid: cmid,\n        pageid: pageid,\n        turn_id: conversationId,\n        sesskey: Config.sesskey\n    });\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (!data.success || !data.responses) {\n            return;\n        }\n\n        Object.keys(data.responses).forEach((questionId) => {\n            const responseData = data.responses[questionId];\n            const questionItem = evaluationContainer.find(`.question-item[data-questionid=\"${questionId}\"]`);\n            if (questionItem.length === 0) {\n                return;\n            }\n\n            const questionType = questionItem.data('questiontype');\n            const value = responseData.response;\n\n            if (questionType === 'singlechoice' || questionType === 'likert') {\n                questionItem.find('input[type=\"radio\"]').prop('checked', false);\n                questionItem.find(`input[type=\"radio\"][value=\"${value}\"]`).prop('checked', true);\n            } else if (questionType === 'multiplechoice') {\n                questionItem.find('input[type=\"checkbox\"]').prop('checked', false);\n                try {\n                    const values = JSON.parse(value);\n                    if (Array.isArray(values)) {\n                        values.forEach((val) => {\n                            questionItem.find(`input[type=\"checkbox\"][value=\"${val}\"]`).prop('checked', true);\n                        });\n                    }\n                } catch (e) {\n                    // ignore invalid JSON\n                }\n            } else if (questionType === 'select') {\n                questionItem.find('select').val(value);\n            } else if (questionType === 'number') {\n                questionItem.find('input[type=\"number\"]').val(value);\n            } else if (questionType === 'shorttext') {\n                questionItem.find('input[type=\"text\"]').val(value);\n            } else if (questionType === 'longtext') {\n                questionItem.find('textarea').val(value);\n            }\n\n            if (responseData.saved_datetime) {\n                getString('saved', 'mod_harpiasurvey').then((savedText) => {\n                    getString('on', 'mod_harpiasurvey').then((onText) => {\n                        const icon = '<i class=\"fa fa-check-circle\" aria-hidden=\"true\"></i>';\n                        questionItem.append(\n                            '<div class=\"mt-2 small text-muted saved-response-message\">' +\n                            `${icon} ${savedText} ${onText} ${responseData.saved_datetime}</div>`\n                        );\n                    });\n                });\n            }\n\n            getString('answerhistory', 'mod_harpiasurvey').then((historyText) => {\n                if ((responseData.history_count || 0) > 1) {\n                    const details = $('<details class=\"answer-history mt-1\"></details>');\n                    details.append(`<summary>${historyText} (${responseData.history_count})</summary>`);\n                    const list = $('<ul class=\"list-unstyled mt-2 mb-0\"></ul>');\n                    (responseData.history_items || []).forEach((item) => {\n                        list.append(`<li class=\"mb-1\"><span class=\"text-muted\">${item.time}</span> â€” ${item.response}</li>`);\n                    });\n                    details.append(list);\n                    questionItem.append(details);\n                }\n            });\n\n            lockQuestionItem(questionItem);\n            ensureEditButton(questionItem);\n        });\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error loading continuous evaluation responses:', error);\n    });\n};\n\nexport const init = () => initialize();\n\n/**\n * Initialize continuous-mode chat containers.\n */\nconst initialize = () => {\n    if (initialized) {\n        return;\n    }\n    getString('edit', 'moodle').then((str) => {\n        editLabel = str;\n    }).catch(() => {\n        editLabel = 'Edit';\n    });\n    const containers = $('.ai-conversation-container[data-behavior=\"continuous\"]');\n    if (containers.length === 0) {\n        return;\n    }\n    containers.each(function() {\n        const pageid = parseInt($(this).data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n        initContinuousPage(pageid);\n    });\n    registerCommonHandlers();\n    registerTreeHandlers();\n    initialized = true;\n};\n\n/**\n * Initialize a specific continuous chat page.\n *\n * @param {number} pageid Page ID\n */\nconst initContinuousPage = (pageid) => {\n    const container = $(`.ai-conversation-container[data-pageid=\"${pageid}\"]`);\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    const allMessages = messagesContainer.find('.message');\n    if (allMessages.length > 0) {\n        const lastMessage = allMessages.last();\n        const lastMessageId = parseInt(lastMessage.data('messageid'), 10);\n        if (lastMessageId && !isNaN(lastMessageId)) {\n            let rootId = lastMessageId;\n            let currentId = lastMessageId;\n            let found = false;\n            const parentMap = new Map();\n            allMessages.each(function() {\n                const msgId = parseInt($(this).data('messageid'), 10);\n                const parentId = parseInt($(this).data('parentid'), 10);\n                if (msgId && !isNaN(msgId)) {\n                    parentMap.set(msgId, parentId && !isNaN(parentId) ? parentId : null);\n                }\n            });\n            while (currentId && !found) {\n                const parentId = parentMap.get(currentId);\n                if (!parentId) {\n                    rootId = currentId;\n                    found = true;\n                } else {\n                    currentId = parentId;\n                }\n            }\n            if (found) {\n                container.data('viewing-conversation', rootId);\n                container.attr('data-viewing-conversation', rootId);\n                filterMessagesByConversation(pageid, rootId);\n                loadConversationEvaluationResponses(pageid, rootId);\n            }\n        }\n    }\n    if (!allMessages.length) {\n        loadConversationEvaluationResponses(pageid, null);\n    }\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (sidebar.length > 0) {\n        sidebar.show();\n        loadConversationTree(pageid);\n    }\n};\n\nfunction registerCommonHandlers() {\n    if (commonHandlersRegistered) {\n        return;\n    }\n    $(document).on('click', '.chat-send-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const pageid = parseInt(button.data('pageid'), 10);\n        if (!cmid || !pageid) {\n            addError('Missing cmid or pageid');\n            return;\n        }\n        const input = $(`#chat-input-page-${pageid}`);\n        if (input.length === 0) {\n            addError('Chat input not found');\n            return;\n        }\n        const inputValue = input.val();\n        if (!inputValue) {\n            return;\n        }\n        const message = inputValue.trim();\n        if (!message) {\n            return;\n        }\n        const container = button.closest('.ai-conversation-container');\n        const modelsdata = container.data('models');\n        let modelid = null;\n        if (modelsdata) {\n            const modelids = modelsdata.split(',');\n            if (modelids.length > 0) {\n                modelid = parseInt(modelids[0], 10);\n            }\n        }\n        if (!modelid) {\n            addError('No model available');\n            return;\n        }\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n        input.val('');\n        const tempId = 'temp-user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n        displayUserMessage(pageid, message, tempId);\n        const loading = $(`#chat-loading-page-${pageid}`);\n        loading.show();\n        sendMessage(cmid, pageid, message, modelid, button, input, loading);\n    });\n\n    $(document).on('keydown', '.chat-input', function(e) {\n        if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault();\n            $(this).closest('.ai-conversation-container').find('.chat-send-btn').click();\n        }\n    });\n\n    commonHandlersRegistered = true;\n}\n\nfunction registerTreeHandlers() {\n    if (treeHandlersRegistered) {\n        return;\n    }\n    $(document).on('click', '.tree-node-content[data-action=\"navigate\"]', function(e) {\n        e.preventDefault();\n        const node = $(this);\n        const conversationId = parseInt(node.data('conversation-id'), 10);\n        const pageid = node.closest('.conversation-tree-sidebar').attr('id').replace('conversation-tree-sidebar-', '');\n        if (!pageid) {\n            return;\n        }\n        navigateToConversation(parseInt(pageid, 10), conversationId);\n    });\n\n    $(document).on('click', '.conversation-item', function(e) {\n        e.preventDefault();\n        const item = $(this);\n        const conversationId = parseInt(item.data('conversation-id'), 10);\n        const sidebarId = item.closest('.conversation-tree-sidebar').attr('id');\n        const pageid = parseInt(sidebarId.replace('conversation-tree-sidebar-', ''), 10);\n        if (!pageid) {\n            return;\n        }\n        navigateToConversation(pageid, conversationId);\n    });\n\n    $(document).on('click', '.create-root-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            addError('Missing required data to create root');\n            return;\n        }\n        createNewRoot(cmid, pageid);\n    });\n    \n    // Handle export conversation button clicks.\n    $(document).on('click', '.export-conversation-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            addError('Missing required data to export conversation');\n            return;\n        }\n        \n        // Get current viewing conversation\n        const container = $(`.ai-conversation-container[data-pageid=\"${pageid}\"]`);\n        const conversationId = container.data('viewing-conversation') || \n                                parseInt(container.attr('data-viewing-conversation'), 10);\n        \n        // Build export URL\n        const params = new URLSearchParams();\n        params.append('action', 'export_conversation');\n        params.append('cmid', cmid);\n        params.append('pageid', pageid);\n        params.append('sesskey', Config.sesskey);\n        \n        if (conversationId) {\n            params.append('conversation_id', conversationId);\n        }\n        \n        // Open export URL in new window/tab to trigger download\n        window.open(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), '_blank');\n    });\n\n    treeHandlersRegistered = true;\n}\n\nconst filterMessagesByConversation = (pageid, conversationId) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    const conversationMessageIds = new Set();\n    conversationMessageIds.add(conversationId);\n    const messageParentMap = new Map();\n    \n    // Build parent map for ALL messages, including root messages (parentId = null)\n    messagesContainer.find('.message').each(function() {\n        const messageId = parseInt($(this).data('messageid'), 10);\n        const parentId = parseInt($(this).data('parentid'), 10);\n        if (messageId && !isNaN(messageId)) {\n            // Include all messages in the map, even if parentId is null/undefined\n            messageParentMap.set(messageId, (parentId && !isNaN(parentId)) ? parentId : null);\n        }\n    });\n    \n    // Traverse down from the root conversation ID to find all child messages\n    let changed = true;\n    while (changed) {\n        changed = false;\n        for (const [messageId, parentId] of messageParentMap.entries()) {\n            // If this message's parent is in the conversation, add this message\n            if (!conversationMessageIds.has(messageId) && parentId && conversationMessageIds.has(parentId)) {\n                conversationMessageIds.add(messageId);\n                changed = true;\n            }\n        }\n    }\n    \n    // Also ensure the root message itself is included (in case it wasn't found in traversal)\n    if (messageParentMap.has(conversationId)) {\n        conversationMessageIds.add(conversationId);\n    }\n    \n    // Show/hide messages based on conversation membership\n    let hasVisibleMessages = false;\n    messagesContainer.find('.message').each(function() {\n        const messageId = parseInt($(this).data('messageid'), 10);\n        if (conversationMessageIds.has(messageId)) {\n            $(this).show();\n            hasVisibleMessages = true;\n        } else {\n            $(this).hide();\n        }\n    });\n    \n    // Show placeholder if no messages are visible\n    const placeholder = messagesContainer.find('.text-center.text-muted');\n    if (!hasVisibleMessages) {\n        if (placeholder.length === 0) {\n            messagesContainer.prepend('<div class=\"text-center text-muted py-4\"><p>' +\n                'No messages yet. Send a message to start the conversation.</p></div>');\n        } else {\n            placeholder.show();\n        }\n    } else {\n        placeholder.hide();\n    }\n    \n    setTimeout(() => scrollToBottom(pageid), 50);\n};\n\nconst sendMessage = (cmid, pageid, message, modelid, button, input, loading) => {\n    const container = $(`#chat-messages-page-${pageid}`).closest('.ai-conversation-container');\n    const viewingConversation = container.data('viewing-conversation');\n    let parentid = null;\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    \n    if (viewingConversation) {\n        // Find the last message that belongs to this conversation\n        // Build parent map to find all messages in this conversation\n        const conversationMessageIds = new Set();\n        conversationMessageIds.add(viewingConversation);\n        const messageParentMap = new Map();\n        \n        // Build parent map for ALL messages\n        messagesContainer.find('.message').each(function() {\n            const messageId = parseInt($(this).data('messageid'), 10);\n            const parentId = parseInt($(this).data('parentid'), 10);\n            if (messageId && !isNaN(messageId)) {\n                messageParentMap.set(messageId, (parentId && !isNaN(parentId)) ? parentId : null);\n            }\n        });\n        \n        // Traverse down from root to find all messages in this conversation\n        let changed = true;\n        while (changed) {\n            changed = false;\n            for (const [messageId, parentId] of messageParentMap.entries()) {\n                if (!conversationMessageIds.has(messageId) && parentId && conversationMessageIds.has(parentId)) {\n                    conversationMessageIds.add(messageId);\n                    changed = true;\n                }\n            }\n        }\n        \n        // Find the last message in this conversation (by timecreated or order in DOM)\n        let lastMessageInConversation = null;\n        let lastTimeCreated = 0;\n        messagesContainer.find('.message').each(function() {\n            const messageId = parseInt($(this).data('messageid'), 10);\n            if (conversationMessageIds.has(messageId)) {\n                const timeCreated = parseInt($(this).data('timecreated'), 10) || 0;\n                if (timeCreated >= lastTimeCreated) {\n                    lastTimeCreated = timeCreated;\n                    lastMessageInConversation = $(this);\n                }\n            }\n        });\n        \n        if (lastMessageInConversation && lastMessageInConversation.length > 0) {\n            const lastMessageId = parseInt(lastMessageInConversation.data('messageid'), 10);\n            if (lastMessageId && !isNaN(lastMessageId)) {\n                parentid = lastMessageId;\n            }\n        } else {\n            // If no messages found in DOM, use the conversation root as parent\n            // This handles the case where a new conversation was just created and the placeholder isn't in the DOM yet\n            parentid = viewingConversation;\n        }\n    } else {\n        // No conversation selected - this shouldn't happen, but if it does, don't send a parentid\n        // The backend will create a new conversation\n        parentid = null;\n    }\n    const params = new URLSearchParams({\n        action: 'send_ai_message',\n        cmid: cmid,\n        pageid: pageid,\n        message: message,\n        modelid: modelid,\n        sesskey: Config.sesskey\n    });\n    // Always send parentid if we have one (even if it's the placeholder/conversation root)\n    // This ensures messages go to the correct conversation\n    if (parentid && !isNaN(parentid) && parentid > 0) {\n        params.append('parentid', parentid);\n    }\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then(response => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then(data => {\n        loading.hide();\n        if (data.success) {\n            if (data.root_conversation_id) {\n                container.data('viewing-conversation', data.root_conversation_id);\n                container.attr('data-viewing-conversation', data.root_conversation_id);\n                loadConversationEvaluationResponses(pageid, data.root_conversation_id);\n            }\n            if (data.messageid && data.content) {\n                displayAIMessage(pageid, data.content, data.messageid, data.turn_id).then(() => {\n                    loadConversationTree(pageid);\n                    setTimeout(() => {\n                        scrollToBottom(pageid);\n                    }, 100);\n                    input.prop('disabled', false);\n                    button.prop('disabled', false);\n                    input.focus();\n                });\n            } else {\n                addError('Received response but missing message ID or content');\n                input.prop('disabled', false);\n                button.prop('disabled', false);\n                input.focus();\n            }\n        } else {\n            addError(data.message || 'Error sending message');\n            input.prop('disabled', false);\n            button.prop('disabled', false);\n            input.focus();\n        }\n    })\n    .catch(error => {\n        loading.hide();\n        // eslint-disable-next-line no-console\n        console.error('Error sending message:', error);\n        addError('Error sending message: ' + error.message);\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    });\n};\n\nconst displayUserMessage = (pageid, message, messageid) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    messagesContainer.find('.text-center.text-muted').remove();\n    Templates.render('mod_harpiasurvey/chat_user_message', {\n        id: messageid,\n        content: message,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottom(pageid);\n    }).catch(Notification.exception);\n};\n\nconst displayAIMessage = (pageid, content, messageid) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return Promise.resolve();\n    }\n    return Templates.render('mod_harpiasurvey/chat_ai_message', {\n        id: messageid,\n        content: content,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottom(pageid);\n        return html;\n    }).catch(Notification.exception);\n};\n\n/**\n * Render simple conversation list in sidebar (for continuous mode, no fancytree).\n *\n * @param {number} pageid Page ID\n * @param {Array} roots Array of root conversations\n */\nconst renderConversationListSimple = (pageid, roots) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    if (treeContainer.length === 0) {\n        return;\n    }\n    if (roots.length === 0) {\n        treeContainer.html('<div class=\"text-muted text-center small py-3\">' +\n            'No conversations yet. Click \"New conversation\" to start.</div>');\n        return;\n    }\n    \n    // Get the current viewing conversation\n    const container = $(`.ai-conversation-container[data-pageid=\"${pageid}\"]`);\n    const viewingConversation = container.data('viewing-conversation') || \n                                 parseInt(container.attr('data-viewing-conversation'), 10);\n    \n    let html = '<ul class=\"list-group list-group-flush\">';\n    roots.forEach((root) => {\n        const conversationNumber = root.conversation_number || '';\n        // Try multiple possible ID fields\n        const conversationId = root.id || root.conversation_id || root.turn_id;\n        const isActive = viewingConversation && parseInt(conversationId, 10) === parseInt(viewingConversation, 10);\n        const activeClass = isActive ? 'active' : '';\n        html += `<li class=\"list-group-item conversation-item ${activeClass}\" data-conversation-id=\"${conversationId}\" style=\"cursor: pointer;\">`;\n        html += `<div class=\"d-flex justify-content-between align-items-center\">`;\n        html += `<span class=\"font-weight-bold\">Conversation ${conversationNumber}</span>`;\n        html += `<small class=\"${isActive ? 'text-white-50' : 'text-muted'}\">${root.message_count || 0} messages</small>`;\n        html += `</div>`;\n        html += `</li>`;\n    });\n    html += '</ul>';\n    treeContainer.html(html);\n};\n\nconst loadConversationTree = (pageid) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (treeContainer.length === 0) {\n        return Promise.resolve(null);\n    }\n    const cmid = getCmid(pageid);\n    if (!cmid) {\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error: Course module ID not found. Please refresh the page.</div>');\n        return Promise.resolve(null);\n    }\n    const params = new URLSearchParams();\n    params.append('action', 'get_conversation_tree');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n    return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (data.success && data.tree) {\n            data.tree.roots = (data.tree.roots || []).map((root, idx) => ({\n                ...root,\n                conversation_number: idx + 1\n            }));\n            conversationTrees[pageid] = data.tree;\n            sidebar.data('sidebar-view', 'list');\n            renderConversationListSimple(pageid, data.tree.roots);\n            // Note: updateMessageTurnLabels is for turns mode only, not needed for continuous\n            return data.tree;\n        } else {\n            treeContainer.html('<div class=\"text-muted text-center small py-3\">' +\n                (data.message || 'No conversation tree available yet.') + '</div>');\n            return null;\n        }\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error loading conversation tree:', error);\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error loading conversation tree: ' + error.message + '<br>' +\n            'Please check the browser console for details and refresh the page.</div>');\n        return null;\n    });\n};\n\nconst navigateToConversation = (pageid, conversationId) => {\n    const container = $(`#chat-messages-page-${pageid}`).closest('.ai-conversation-container');\n    container.data('viewing-conversation', conversationId);\n    container.attr('data-viewing-conversation', conversationId);\n    filterMessagesByConversation(pageid, conversationId);\n    loadConversationEvaluationResponses(pageid, conversationId);\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (sidebar.length) {\n        sidebar.data('sidebar-view', 'list');\n        // Reload tree to update active state\n        loadConversationTree(pageid);\n    }\n};\n\nconst updateMessageTurnLabels = (pageid) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    messagesContainer.find('.message').each(function() {\n        const $msg = $(this);\n        const turnId = parseInt($msg.data('turn-id'), 10);\n        if (turnId) {\n            const turnLabel = 'Turno ' + turnId;\n            const $badge = $msg.find('.badge').filter(function() {\n                return $(this).closest('.position-absolute').length > 0;\n            });\n            if ($badge.length > 0) {\n                $badge.text(turnLabel);\n            } else {\n                const $firstBadge = $msg.find('.badge').first();\n                if ($firstBadge.length > 0) {\n                    $firstBadge.text(turnLabel);\n                }\n            }\n        }\n    });\n};\n\nconst createNewRoot = (cmid, pageid) => {\n    const container = $(`.ai-conversation-container[data-pageid=\"${pageid}\"]`);\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    const params = new URLSearchParams();\n    params.append('action', 'create_root');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (data.success) {\n            const newConversationId = parseInt(data.new_conversation_id || data.new_turn_id, 10);\n            container.data('viewing-conversation', newConversationId);\n            container.attr('data-viewing-conversation', newConversationId);\n            loadConversationEvaluationResponses(pageid, newConversationId);\n            messagesContainer.html('<div class=\"text-muted text-center small py-3\">' +\n                'New conversation started. Send a message to begin.</div>');\n            const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n            sidebar.data('sidebar-view', 'list');\n            setTimeout(() => {\n                loadConversationTree(pageid).then((tree) => {\n                    if (tree && tree.roots) {\n                        const root = tree.roots.find(r =>\n                            parseInt((r.conversation_id || r.turn_id), 10) === newConversationId\n                        );\n                        if (root) {\n                            navigateToConversation(pageid, root.conversation_id || root.turn_id);\n                            return;\n                        }\n                    }\n                    const treeData = conversationTrees[pageid] || {roots: []};\n                    const nextNumber = (treeData.roots?.length || 0) + 1;\n                    const newRoot = {\n                        turn_id: newConversationId,\n                        conversation_id: newConversationId,\n                        is_root: true,\n                        children: [],\n                        parent_turn_id: null,\n                        branch_label: null,\n                        timecreated: Math.floor(Date.now() / 1000),\n                        timecreated_str: new Date().toLocaleString(),\n                        message_count: 1,\n                        conversation_number: nextNumber\n                    };\n                    treeData.roots = [...(treeData.roots || []), newRoot];\n                    conversationTrees[pageid] = treeData;\n                    renderConversationListSimple(pageid, treeData.roots);\n                    navigateToConversation(pageid, newConversationId);\n                });\n            }, 100);\n            Notification.addNotification({\n                message: data.message || 'New conversation created successfully',\n                type: 'success'\n            });\n        } else {\n            addError(data.message || 'Failed to create new root');\n        }\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error creating new root:', error);\n        addError('Error creating new root: ' + error.message);\n    });\n};\n"],"names":["initialized","commonHandlersRegistered","treeHandlersRegistered","editLabel","loadConversationEvaluationResponses","pageid","conversationId","cmid","evaluationContainer","first","closest","length","find","each","questionItem","removeAttr","remove","questionType","data","prop","val","clearEvaluationQuestion","this","params","URLSearchParams","action","turn_id","sesskey","Config","fetch","wwwroot","toString","method","headers","then","response","ok","Error","status","json","success","responses","Object","keys","forEach","questionId","responseData","value","values","JSON","parse","Array","isArray","e","saved_datetime","savedText","onText","append","historyText","history_count","details","list","history_items","item","time","attr","lockQuestionItem","controls","button","text","show","ensureEditButton","catch","error","console","initialize","str","containers","parseInt","initContinuousPage","document","on","preventDefault","input","inputValue","message","trim","modelsdata","modelid","modelids","split","tempId","Date","now","Math","random","substr","displayUserMessage","loading","sendMessage","key","shiftKey","click","registerCommonHandlers","node","replace","navigateToConversation","sidebarId","createNewRoot","container","window","open","registerTreeHandlers","allMessages","lastMessage","last","lastMessageId","isNaN","rootId","currentId","found","parentMap","Map","msgId","parentId","set","get","filterMessagesByConversation","sidebar","loadConversationTree","messagesContainer","conversationMessageIds","Set","add","messageParentMap","messageId","changed","entries","has","hasVisibleMessages","hide","placeholder","prepend","setTimeout","viewingConversation","parentid","lastMessageInConversation","lastTimeCreated","timeCreated","root_conversation_id","messageid","content","displayAIMessage","focus","render","id","timecreated","floor","html","Notification","exception","Promise","resolve","Templates","renderConversationListSimple","roots","treeContainer","root","conversationNumber","conversation_number","conversation_id","isActive","message_count","body","tree","map","idx","newConversationId","new_conversation_id","new_turn_id","r","treeData","conversationTrees","nextNumber","newRoot","is_root","children","parent_turn_id","branch_label","timecreated_str","toLocaleString","addNotification","type"],"mappings":"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"}
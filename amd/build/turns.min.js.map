{"version":3,"file":"turns.min.js","sources":["../src/turns.js"],"sourcesContent":["// Turns-only logic for harpiasurvey chat interface.\n//\n// Extracted from the previous monolithic core_chat.js. Handles turn navigation,\n// branching, locking, tree rendering, and send pipeline for turns behavior.\n\nimport {\n    Templates,\n    Notification,\n    Config,\n    getString,\n    $,\n    currentTurns,\n    conversationTrees,\n    scrollToBottom,\n    addError,\n    getCmid,\n    findRootForTurn,\n    countNodes,\n    calculateTurnNumber,\n    renderConversationList\n} from './common_chat';\nimport {ensureFancytree} from './fancytree_loader';\n\nlet initializedTurns = false;\nlet commonHandlersRegistered = false;\nlet turnHandlersRegistered = false;\nlet treeHandlersRegistered = false;\nconst fancytreeInstances = {};\n\n/**\n * Initialize turns-mode chat for all containers on the page.\n */\nconst initialize = () => {\n    if (initializedTurns) {\n        return;\n    }\n\n    const containers = $('.ai-conversation-container[data-behavior=\"turns\"]');\n    if (containers.length === 0) {\n        return;\n    }\n\n    containers.each(function() {\n        const pageid = parseInt($(this).data('pageid'), 10);\n\n        if (!pageid) {\n            return;\n        }\n\n        const messagesContainer = $(`#chat-messages-page-${pageid}`);\n        let maxTurn = 0;\n        messagesContainer.find('[data-turn-id]').each(function() {\n            const turnId = parseInt($(this).data('turn-id'), 10);\n            if (turnId && turnId > maxTurn) {\n                maxTurn = turnId;\n            }\n        });\n        const calculatedCurrentTurn = maxTurn > 0 ? maxTurn : 1;\n        if (!currentTurns[pageid]) {\n            currentTurns[pageid] = calculatedCurrentTurn;\n        }\n\n        const urlParams = new URLSearchParams(window.location.search);\n        const urlTurn = urlParams.get('turn');\n\n        let initialViewingTurn = currentTurns[pageid];\n        if (urlTurn !== null && urlTurn !== '') {\n            const parsedTurn = parseInt(urlTurn, 10);\n            if (!isNaN(parsedTurn) && parsedTurn > 0) {\n                initialViewingTurn = parsedTurn;\n            }\n        }\n\n        setViewingTurn(pageid, initialViewingTurn);\n        updateTurnDisplay(pageid);\n        updateChatLockState(pageid);\n        \n        // Load conversation tree first, then filter messages (tree is needed to determine pathway).\n        const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n        if (sidebar.length > 0) {\n            sidebar.show();\n            $(`.toggle-tree-btn[data-pageid=\"${pageid}\"]`).addClass('active');\n            // Load tree first, then filter messages once tree is loaded.\n            loadConversationTree(pageid).then(() => {\n                // Tree loaded - now filter messages based on the pathway.\n                filterMessagesByTurn(pageid, initialViewingTurn);\n            }).catch(() => {\n                // If tree loading fails, still filter with just the current turn.\n                filterMessagesByTurn(pageid, initialViewingTurn);\n            });\n        } else {\n            // No sidebar - filter immediately (will only show current turn if tree not available).\n            filterMessagesByTurn(pageid, initialViewingTurn);\n        }\n        \n        updateSubpageVisibility(pageid);\n        setTimeout(() => {\n            ensureTurnEvaluationQuestionsRendered(pageid, initialViewingTurn).then(() => {\n                loadTurnEvaluationResponses(pageid, initialViewingTurn);\n            }).catch((error) => {\n                // eslint-disable-next-line no-console\n                console.error('Error loading turn evaluation questions on init:', error);\n            });\n        }, 100);\n    });\n\n    registerCommonHandlers();\n    registerTreeHandlers();\n    registerTurnHandlers();\n    initializedTurns = true;\n};\n\nexport const init = () => initialize();\nexport const initTurns = () => initialize();\n\n/**\n * Register common chat handlers (send/enter).\n */\nfunction registerCommonHandlers() {\n    if (commonHandlersRegistered) {\n        return;\n    }\n\n    // Handle send button clicks.\n    $(document).on('click', '.chat-send-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const container = button.closest('.ai-conversation-container');\n        if (container.data('behavior') !== 'turns') {\n            return;\n        }\n\n        if (!cmid || !pageid) {\n            Notification.addNotification({\n                message: 'Missing cmid or pageid',\n                type: 'error'\n            });\n            return;\n        }\n\n        const input = $(`#chat-input-page-${pageid}`);\n        if (input.length === 0) {\n            Notification.addNotification({\n                message: 'Chat input not found',\n                type: 'error'\n            });\n            return;\n        }\n\n        const inputValue = input.val();\n        if (!inputValue) {\n            return;\n        }\n\n        const message = inputValue.trim();\n\n        if (!message) {\n            return;\n        }\n\n        // Check if chat is locked (viewing a past turn).\n        const viewingTurn = getViewingTurn(pageid);\n        const currentTurn = getCurrentTurn(pageid);\n        // Ensure both are numbers for comparison.\n        const viewingTurnNum = parseInt(viewingTurn, 10);\n        const currentTurnNum = parseInt(currentTurn, 10);\n\n        // Allow sending if viewing turn >= current turn.\n        // If viewing turn > current turn, backend will create the next turn.\n        // Only block if viewing a past turn (viewingTurn < currentTurn).\n        if (viewingTurnNum < currentTurnNum) {\n            // Viewing a past turn - block it.\n            Notification.addNotification({\n                message: 'Cannot send messages in a locked turn. ' +\n                    'Navigate to the current turn first.',\n                type: 'error'\n            });\n            return;\n        }\n        // If viewingTurn >= currentTurn, allow it - backend will handle creating the right turn.\n\n        // Check max turns limit.\n        const maxTurns = container.data('max-turns');\n        if (maxTurns !== undefined && maxTurns !== null) {\n            const maxTurnsNum = parseInt(maxTurns, 10);\n            const turnCount = getTurnCountForConversation(pageid, viewingTurnNum);\n            // Only block when the active conversation already reached the limit and the turn is complete\n            // (sending would create a new turn).\n            if (turnCount !== null && turnCount >= maxTurnsNum &&\n                isTurnComplete(pageid, viewingTurnNum)) {\n                getString('maxturnsreached', 'mod_harpiasurvey').then((str) => {\n                    Notification.addNotification({\n                        message: str,\n                        type: 'error'\n                    });\n                });\n                return;\n            }\n        }\n\n        // Get model from container data attribute (first available model).\n        const modelsdata = container.data('models');\n        let modelid = null;\n\n        if (modelsdata) {\n            // modelsdata is a comma-separated string, get first one.\n            const modelids = modelsdata.split(',');\n            if (modelids.length > 0) {\n                modelid = parseInt(modelids[0], 10);\n            }\n        }\n\n        if (!modelid) {\n            Notification.addNotification({\n                message: 'No model available',\n                type: 'error'\n            });\n            return;\n        }\n\n        // Disable input and button.\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n\n        // Clear input.\n        input.val('');\n\n        // Display user message with temporary ID (will be updated with real ID from server).\n        const tempId = 'temp-user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n        displayUserMessage(pageid, message, tempId);\n\n        // Show loading indicator.\n        const loading = $(`#chat-loading-page-${pageid}`);\n        loading.show();\n\n        // Send message to AI.\n        sendMessage(cmid, pageid, message, modelid, button, input, loading);\n    });\n\n    // Handle Enter key in textarea (Shift+Enter for new line, Enter to send).\n    $(document).on('keydown', '.chat-input', function(e) {\n        if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault();\n            $(this).closest('.ai-conversation-container').find('.chat-send-btn').click();\n        }\n    });\n\n    // Toggle visibility of previous turn messages in the current path.\n    $(document).on('click', '.toggle-previous-messages-btn', function(e) {\n        e.preventDefault();\n        const btn = $(this);\n        const pageid = parseInt(btn.data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n        const container = $(`#chat-messages-page-${pageid}`);\n        const prevMessages = container.find('.previous-turn-message');\n        if (prevMessages.length === 0) {\n            return;\n        }\n        const currentlyVisible = container.data('show-previous') === true;\n        setPreviousMessagesVisibility(pageid, !currentlyVisible);\n    });\n\n    commonHandlersRegistered = true;\n}\n\n/**\n * Register handlers shared for turn tree/navigation.\n */\nfunction registerTreeHandlers() {\n    if (treeHandlersRegistered) {\n        return;\n    }\n\n    // Handle tree node navigation clicks.\n    $(document).on('click', '.tree-node-content[data-action=\"navigate\"]', function(e) {\n        e.preventDefault();\n        const node = $(this);\n        const turnId = parseInt(node.data('turn-id'), 10);\n        const pageid = node.closest('.conversation-tree-sidebar').attr('id').replace('conversation-tree-sidebar-', '');\n        if (!pageid) {\n            return;\n        }\n        if (turnId) {\n            navigateToTurn(parseInt(pageid, 10), turnId);\n        }\n    });\n\n    // Handle conversation item click (in list view).\n    $(document).on('click', '.conversation-item', function(e) {\n        e.preventDefault();\n        const item = $(this);\n        const rootTurnId = parseInt(item.data('root-turn-id'), 10);\n        const sidebar = item.closest('.conversation-tree-sidebar');\n        const pageid = parseInt(sidebar.attr('id').replace('conversation-tree-sidebar-', ''), 10);\n\n        if (!pageid) {\n            return;\n        }\n\n        if (rootTurnId) {\n            sidebar.data('sidebar-view', 'detail');\n            navigateToTurn(pageid, rootTurnId);\n        }\n    });\n\n    // Handle back to list button click.\n    $(document).on('click', '.back-to-list-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n\n        // Render the list view.\n        const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n        sidebar.data('sidebar-view', 'list'); // Set to list view\n\n        const tree = conversationTrees[pageid];\n        if (tree) {\n            renderConversationList(pageid, tree.roots);\n        } else {\n            loadConversationTree(pageid);\n        }\n    });\n\n    // Handle create branch button clicks (from tree).\n    $(document).on('click', '.create-branch-from-tree-btn', function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const turnId = parseInt(button.data('turn-id'), 10);\n\n        if (!pageid || !cmid || !turnId) {\n            Notification.addNotification({\n                message: 'Missing required data to create turn',\n                type: 'error'\n            });\n            return;\n        }\n        createBranchFromTurn(cmid, pageid, turnId, button);\n    });\n\n    // Ensure clicks on the label/icon also trigger branch creation.\n    $(document).on('click', '.create-branch-from-tree-btn .branch-label, .create-branch-from-tree-btn i', function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        const btn = $(this).closest('.create-branch-from-tree-btn');\n        if (btn.length) {\n            btn.trigger('click');\n        }\n    });\n\n    // Handle \"create direct branch\" button clicks (from sidebar footer or inline).\n    $(document).on('click', '.create-direct-branch-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        // Prefer explicit root-turn-id on the button (sidebar detail footer).\n        let parentTurnId = parseInt(button.data('root-turn-id'), 10);\n        if (!parentTurnId || isNaN(parentTurnId)) {\n            // Fallback to current viewing turn.\n            parentTurnId = getViewingTurn(pageid);\n        }\n\n        if (!pageid || !cmid || !parentTurnId) {\n            Notification.addNotification({\n                message: 'Missing required data to create branch',\n                type: 'error'\n            });\n            return;\n        }\n\n        createBranchFromTurn(cmid, pageid, parentTurnId, button);\n    });\n\n    // Handle create new root button clicks.\n    $(document).on('click', '.create-root-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            Notification.addNotification({\n                message: 'Missing required data to create root',\n                type: 'error'\n            });\n            return;\n        }\n        createNewRoot(cmid, pageid);\n    });\n    \n    // Handle export conversation button clicks.\n    $(document).on('click', '.export-conversation-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            Notification.addNotification({\n                message: 'Missing required data to export conversation',\n                type: 'error'\n            });\n            return;\n        }\n        \n        // Get current viewing turn (for turns mode)\n        const viewingTurn = getViewingTurn(pageid);\n        const container = $(`.ai-conversation-container[data-pageid=\"${pageid}\"]`);\n        const behavior = container.data('behavior') || 'continuous';\n        \n        // Build export URL\n        const params = new URLSearchParams();\n        params.append('action', 'export_conversation');\n        params.append('cmid', cmid);\n        params.append('pageid', pageid);\n        params.append('sesskey', Config.sesskey);\n        \n        if (behavior === 'turns' && viewingTurn) {\n            params.append('turn_id', viewingTurn);\n        } else if (behavior === 'continuous') {\n            // For continuous mode, try to get conversation ID from container\n            const conversationId = container.data('viewing-conversation');\n            if (conversationId) {\n                params.append('conversation_id', conversationId);\n            }\n        }\n        \n        // Open export URL in new window/tab to trigger download\n        window.open(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), '_blank');\n    });\n\n    // Handle toggle children in tree (collapse/expand branches).\n    $(document).on('click', '.toggle-children', function(e) {\n        e.stopPropagation();\n        const icon = $(this);\n        const childrenContainer = icon.closest('.tree-node').find('.tree-children');\n        if (childrenContainer.is(':visible')) {\n            childrenContainer.hide();\n            icon.removeClass('fa-chevron-down').addClass('fa-chevron-right');\n        } else {\n            childrenContainer.show();\n            icon.removeClass('fa-chevron-right').addClass('fa-chevron-down');\n        }\n    });\n\n    // Collapse/expand controls for Fancytree.\n    $(document).on('click', '.tree-toolbar-collapse-all', function(e) {\n        e.preventDefault();\n        const pageid = parseInt($(this).data('pageid'), 10);\n        const tree = fancytreeInstances[pageid];\n        if (tree) {\n            tree.visit(node => node.setExpanded(false));\n        }\n    });\n\n    $(document).on('click', '.tree-toolbar-expand-current', function(e) {\n        e.preventDefault();\n        const pageid = parseInt($(this).data('pageid'), 10);\n        const tree = fancytreeInstances[pageid];\n        if (tree) {\n            const viewingTurn = getViewingTurn(pageid);\n            const node = tree.getNodeByKey(String(viewingTurn));\n            if (node) {\n                node.makeVisible();\n                node.setActive(true);\n            }\n        }\n    });\n\n    treeHandlersRegistered = true;\n}\n\n/**\n * Register any extra turns-specific handlers (placeholder).\n */\nfunction registerTurnHandlers() {\n    if (turnHandlersRegistered) {\n        return;\n    }\n    turnHandlersRegistered = true;\n}\n\n/**\n * Get the current turn for a page (highest turn with messages).\n *\n * @param {number} pageid Page ID\n * @return {number} Current turn number\n */\nconst getCurrentTurn = (pageid) => {\n    return currentTurns[pageid] || 1;\n};\n\n/**\n * Get the viewing turn for a page (which turn is being displayed).\n *\n * @param {number} pageid Page ID\n * @return {number} Viewing turn number\n */\nconst getViewingTurn = (pageid) => {\n    const container = $(`#chat-messages-page-${pageid}`).closest('.ai-conversation-container');\n    return parseInt(container.data('viewing-turn') || getCurrentTurn(pageid), 10);\n};\n\n/**\n * Set the viewing turn (and update URL param).\n *\n * @param {number} pageid Page ID\n * @param {number} turn Turn number\n */\nconst setViewingTurn = (pageid, turn) => {\n    const container = $(`#chat-messages-page-${pageid}`).closest('.ai-conversation-container');\n    container.data('viewing-turn', turn);\n    container.attr('data-viewing-turn', turn);\n};\n\n/**\n * Update current turn display in UI.\n *\n * @param {number} pageid Page ID\n */\nconst updateTurnDisplay = (pageid) => {\n    const viewingTurn = getViewingTurn(pageid);\n    const label = $(`#current-turn-label-${pageid}`);\n    if (label.length > 0) {\n        label.text(viewingTurn);\n    }\n};\n\n/**\n * Check if a turn has any messages.\n *\n * @param {number} pageid Page ID\n * @param {number} turnId Turn ID\n * @return {boolean} True if turn has at least one message\n */\nconst turnHasMessages = (pageid, turnId) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    return messagesContainer.find(`.message[data-turn-id=\"${turnId}\"]`).length > 0;\n};\n\n/**\n * Check if the current turn is complete (last message from AI).\n *\n * @param {number} pageid Page ID\n * @param {number} turnId Turn ID\n * @return {boolean} True if turn is complete\n */\nconst isTurnComplete = (pageid, turnId) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    const turnMessages = messagesContainer.find(`.message[data-turn-id=\"${turnId}\"]`);\n    if (turnMessages.length === 0) {\n        return false;\n    }\n    const lastMessage = turnMessages.last();\n    const role = lastMessage.data('role');\n    return role === 'assistant' || role === 'ai';\n};\n\n/**\n * Get the number of turns in the conversation that contains the given turn.\n *\n * @param {number} pageid Page ID\n * @param {number} turnId Turn ID (or conversation root ID)\n * @return {number|null} Count of turns or null if unknown\n */\nconst getTurnCountForConversation = (pageid, turnId) => {\n    const tree = conversationTrees[pageid];\n    if (!tree || !tree.roots || !turnId) {\n        return null;\n    }\n    const root = findRootForTurn(tree.roots, turnId);\n    if (!root) {\n        return null;\n    }\n    return countNodes(root);\n};\n\n/**\n * Filter messages by turn - shows only messages from the current pathway.\n * All messages from the current pathway remain in the DOM, but only the current turn is visible by default.\n * Previous turns are hidden by default and can be shown via the \"Show previous\" button.\n *\n * @param {number} pageid Page ID\n * @param {number} turnId Turn ID to show\n */\nconst filterMessagesByTurn = (pageid, turnId) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    // Default collapsed unless user toggled to show.\n    const shouldShowPrevious = messagesContainer.data('show-previous') === true;\n    \n    // Build set of allowed turn IDs (current pathway from root to current turn).\n    const tree = conversationTrees[pageid];\n    const root = tree ? findRootForTurn(tree.roots || [], turnId) : null;\n    const allowedTurnIds = new Set();\n    allowedTurnIds.add(turnId);\n    \n    if (root) {\n        // Recursively find the path from root to the target turn.\n        const addPath = (node, targetId, path) => {\n            if (parseInt(node.turn_id, 10) === parseInt(targetId, 10)) {\n                // Found the target - add all turns in the path.\n                path.forEach(id => allowedTurnIds.add(id));\n                allowedTurnIds.add(parseInt(node.turn_id, 10));\n                return true;\n            }\n            // Check direct branches (same level as root).\n            if (node.direct_branches) {\n                for (const db of node.direct_branches) {\n                    if (addPath(db, targetId, [...path, parseInt(node.turn_id, 10)])) {\n                        return true;\n                    }\n                }\n            }\n            // Check children (nested branches).\n            if (node.children) {\n                for (const child of node.children) {\n                    if (addPath(child, targetId, [...path, parseInt(node.turn_id, 10)])) {\n                        return true;\n                    }\n                }\n            }\n            return false;\n        };\n        addPath(root, turnId, []);\n    } else {\n        // If tree not loaded yet, just allow the current turn.\n        // The tree will be loaded and filtering will be re-applied.\n        allowedTurnIds.add(turnId);\n    }\n\n    // Process all messages in the container.\n    // Messages from the current pathway remain in DOM but are shown/hidden based on turn.\n    // Messages from other pathways are hidden.\n    messagesContainer.find('.message').each(function() {\n        const $msg = $(this);\n        const messageTurnId = parseInt($msg.data('turn-id'), 10);\n        \n        if (!messageTurnId || isNaN(messageTurnId)) {\n            // Message without turn_id - hide it (shouldn't happen in turns mode).\n            $msg.removeClass('previous-turn-message').hide();\n            return;\n        }\n        \n        const isCurrentTurn = messageTurnId === parseInt(turnId, 10);\n        const isInPathway = allowedTurnIds.has(messageTurnId);\n        \n        if (isInPathway) {\n            // Message is in the current pathway - keep in DOM.\n            if (isCurrentTurn) {\n                // Current turn - always visible.\n                $msg.removeClass('previous-turn-message').show();\n            } else {\n                // Previous turn in pathway - hide by default, show if toggle is on.\n                $msg.addClass('previous-turn-message');\n                if (shouldShowPrevious) {\n                    $msg.show();\n                } else {\n                    $msg.hide();\n                }\n            }\n        } else {\n            // Message is from a different pathway - hide it.\n            $msg.removeClass('previous-turn-message').hide();\n        }\n    });\n    \n    // Also handle turn separators - show/hide them based on pathway.\n    messagesContainer.find('.turn-separator').each(function() {\n        const $separator = $(this);\n        const separatorTurnId = parseInt($separator.data('turn-separator'), 10);\n        \n        if (!separatorTurnId || isNaN(separatorTurnId)) {\n            $separator.hide();\n            return;\n        }\n        \n        const isInPathway = allowedTurnIds.has(separatorTurnId);\n        if (isInPathway) {\n            $separator.show();\n        } else {\n            $separator.hide();\n        }\n    });\n\n    // Update toggle button state based on whether there are previous messages.\n    const toggleBtn = $(`.toggle-previous-messages-btn[data-pageid=\"${pageid}\"]`);\n    if (toggleBtn.length > 0) {\n        const hasPreviousMessages = messagesContainer.find('.previous-turn-message').length > 0;\n        if (hasPreviousMessages) {\n            toggleBtn.show();\n            toggleBtn.prop('disabled', false);\n            const firstPrevious = messagesContainer.find('.previous-turn-message').first();\n            const isVisible = firstPrevious.is(':visible');\n            updatePreviousToggleLabel(toggleBtn, isVisible);\n        } else {\n            // No previous messages - hide the button.\n            toggleBtn.hide();\n        }\n    }\n\n    // Scroll to bottom after filtering.\n    setTimeout(() => {\n        scrollToBottom(pageid);\n    }, 50);\n};\n\n/**\n * Update chat lock state (disable input if viewing past turn).\n *\n * @param {number} pageid Page ID\n */\nconst updateChatLockState = (pageid) => {\n    const viewingTurn = getViewingTurn(pageid);\n    const currentTurn = getCurrentTurn(pageid);\n    // Ensure both are numbers for comparison.\n    const viewingTurnNum = parseInt(viewingTurn, 10);\n    const currentTurnNum = parseInt(currentTurn, 10);\n    const input = $(`#chat-input-page-${pageid}`);\n    const sendBtn = $(`.chat-send-btn[data-pageid=\"${pageid}\"]`);\n    const lockMessage = $(`#turn-locked-message-${pageid}`);\n    const container = input.closest('.ai-conversation-container');\n    const maxTurns = container.data('max-turns');\n    const maxTurnsNum = (maxTurns !== undefined && maxTurns !== null) ? parseInt(maxTurns, 10) : null;\n    const conversationTurnCount = getTurnCountForConversation(pageid, viewingTurnNum);\n    const hasReachedTurnLimit = maxTurnsNum !== null &&\n        conversationTurnCount !== null &&\n        conversationTurnCount >= maxTurnsNum;\n\n    if (viewingTurnNum < currentTurnNum) {\n        // Viewing a past turn - lock chat.\n        input.prop('disabled', true);\n        sendBtn.prop('disabled', true);\n        if (lockMessage.length > 0) {\n            lockMessage.show();\n        }\n        // Hide direct branch button when viewing past turns.\n        const directBranchContainer = $(`#direct-branch-container-${pageid}`);\n        if (directBranchContainer.length > 0) {\n            directBranchContainer.hide();\n        }\n    } else if (viewingTurnNum === currentTurnNum && isTurnComplete(pageid, viewingTurnNum)) {\n        // Viewing current turn and it's complete - check max turns limit.\n        // Only lock if turn has messages AND max turns is reached.\n        if (hasReachedTurnLimit && turnHasMessages(pageid, viewingTurnNum)) {\n            // Max turns reached - lock chat permanently.\n            input.prop('disabled', true);\n            sendBtn.prop('disabled', true);\n            input.val(''); // Clear input.\n            if (lockMessage.length > 0) {\n                getString('maxturnsreached', 'mod_harpiasurvey').then((str) => {\n                    lockMessage.text(str).show();\n                });\n            }\n            // Hide direct branch button when max turns reached.\n            const directBranchContainer = $(`#direct-branch-container-${pageid}`);\n            if (directBranchContainer.length > 0) {\n                directBranchContainer.hide();\n            }\n        } else {\n            // Turn complete but not at max - lock chat (user must create next turn).\n            input.prop('disabled', true);\n            sendBtn.prop('disabled', true);\n            input.val(''); // Clear input to focus on next turn.\n            if (lockMessage.length > 0) {\n                lockMessage.hide(); // Don't show \"locked\" message, just disable input.\n            }\n            // Show direct branch button.\n            const directBranchContainer = $(`#direct-branch-container-${pageid}`);\n            if (directBranchContainer.length > 0) {\n                directBranchContainer.show();\n            }\n        }\n    } else if (viewingTurnNum === currentTurnNum && !isTurnComplete(pageid, viewingTurnNum)) {\n        // Viewing current turn and it's not complete - check max turns and if we're waiting for AI response.\n        // Check max turns limit first, but only if turn has messages.\n        if (hasReachedTurnLimit && turnHasMessages(pageid, viewingTurnNum)) {\n            // Max turns reached - lock chat permanently.\n            input.prop('disabled', true);\n            sendBtn.prop('disabled', true);\n            input.val(''); // Clear input.\n            if (lockMessage.length > 0) {\n                getString('maxturnsreached', 'mod_harpiasurvey').then((str) => {\n                    lockMessage.text(str).show();\n                });\n            }\n            // Hide direct branch button when max turns reached.\n            const directBranchContainer = $(`#direct-branch-container-${pageid}`);\n            if (directBranchContainer.length > 0) {\n                directBranchContainer.hide();\n            }\n            return;\n        }\n        // If we just sent a message, input should stay disabled until AI responds.\n        // We'll check if there's a loading indicator to determine this.\n        const loading = $(`#chat-loading-page-${pageid}`);\n        if (loading.is(':visible')) {\n            // Waiting for AI response - keep input disabled.\n            input.prop('disabled', true);\n            sendBtn.prop('disabled', true);\n        } else {\n            // Not waiting for response - unlock chat.\n            input.prop('disabled', false);\n            sendBtn.prop('disabled', false);\n        }\n        // Hide direct branch button when turn is not complete.\n        const directBranchContainer = $(`#direct-branch-container-${pageid}`);\n        if (directBranchContainer.length > 0) {\n            directBranchContainer.hide();\n        }\n        if (lockMessage.length > 0) {\n            lockMessage.hide();\n        }\n    } else {\n        // Viewing future turn (shouldn't happen, but unlock just in case).\n        input.prop('disabled', false);\n        sendBtn.prop('disabled', false);\n        // Hide direct branch button when viewing future turns.\n        const directBranchContainer = $(`#direct-branch-container-${pageid}`);\n        if (directBranchContainer.length > 0) {\n            directBranchContainer.hide();\n        }\n        if (lockMessage.length > 0) {\n            lockMessage.hide();\n        }\n    }\n};\n\n/**\n * Send message to AI via AJAX (turns mode).\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {string} message Message content\n * @param {number} modelid Model ID\n * @param {jQuery} button Send button element\n * @param {jQuery} input Input textarea element\n * @param {jQuery} loading Loading indicator element\n */\nconst sendMessage = (cmid, pageid, message, modelid, button, input, loading) => {\n    // Get current viewing turn (for turns mode).\n    const viewingTurn = getViewingTurn(pageid);\n\n    const params = new URLSearchParams({\n        action: 'send_ai_message',\n        cmid: cmid,\n        pageid: pageid,\n        message: message,\n        modelid: modelid,\n        sesskey: Config.sesskey\n    });\n\n    // For turns mode, send the viewing turn so backend can use it.\n    if (viewingTurn) {\n        params.append('turn_id', viewingTurn);\n    }\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then(response => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then(data => {\n        loading.hide();\n\n        if (data.success) {\n            // Display AI response (check for duplicates first).\n            if (data.messageid && data.content) {\n                // displayAIMessage is async, so we need to wait for it to complete\n                // before checking if the turn is complete and updating lock state.\n                displayAIMessage(pageid, data.content, data.messageid, data.turn_id).then(() => {\n                    // Update current turn if a new turn was created.\n                    if (data.turn_id) {\n                        const currentTurn = getCurrentTurn(pageid);\n                        if (data.turn_id > currentTurn) {\n                            currentTurns[pageid] = data.turn_id;\n                            updateTurnDisplay(pageid);\n                            // Update viewing turn to match the new current turn.\n                            setViewingTurn(pageid, data.turn_id);\n                        } else if (data.turn_id === currentTurn + 1) {\n                            // Backend created next turn - update current turn.\n                            currentTurns[pageid] = data.turn_id;\n                            updateTurnDisplay(pageid);\n                            // Update viewing turn to match the new current turn.\n                            setViewingTurn(pageid, data.turn_id);\n                        }\n                    }\n\n                    // Update chat lock state after message is fully rendered in DOM.\n                    // Use a small delay to ensure DOM is completely updated and isTurnComplete can detect the new message.\n                    setTimeout(() => {\n                        updateChatLockState(pageid);\n                    }, 100);\n                }).catch(() => {\n                    // If displayAIMessage fails, still try to update lock state.\n                    setTimeout(() => {\n                        updateChatLockState(pageid);\n                    }, 100);\n                });\n            } else {\n                Notification.addNotification({\n                    message: 'Received response but missing message ID or content',\n                    type: 'error'\n                });\n                // Re-enable input on error.\n                input.prop('disabled', false);\n                button.prop('disabled', false);\n                input.focus();\n            }\n        } else {\n            Notification.addNotification({\n                message: data.message || 'Error sending message',\n                type: 'error'\n            });\n            // Re-enable input on error.\n            input.prop('disabled', false);\n            button.prop('disabled', false);\n            input.focus();\n        }\n    })\n    .catch(error => {\n        loading.hide();\n        // eslint-disable-next-line no-console\n        console.error('Error sending message:', error);\n        Notification.addNotification({\n            message: 'Error sending message: ' + error.message,\n            type: 'error'\n        });\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    });\n};\n\n/**\n * Display user message in the chat.\n *\n * @param {number} pageid Page ID\n * @param {string} message Message content\n * @param {string} messageid Temp/real message ID\n */\nconst displayUserMessage = (pageid, message, messageid) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    messagesContainer.find('.text-center.text-muted').remove();\n    Templates.render('mod_harpiasurvey/chat_user_message', {\n        id: messageid,\n        content: message,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottom(pageid);\n    }).catch(Notification.exception);\n};\n\n/**\n * Display AI message in the chat.\n *\n * @param {number} pageid Page ID\n * @param {string} content Message content\n * @param {string} messageid Message ID\n * @param {number} turnId Turn ID\n * @return {Promise} Promise that resolves when rendered\n */\nconst displayAIMessage = (pageid, content, messageid, turnId) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return Promise.resolve();\n    }\n    return Templates.render('mod_harpiasurvey/chat_ai_message', {\n        id: messageid,\n        content: content,\n        timecreated: Math.floor(Date.now() / 1000),\n        turn_id: turnId\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottom(pageid);\n        return html;\n    }).catch(Notification.exception);\n};\n\n/**\n * Scroll chat to bottom.\n *\n * @param {number} pageid Page ID\n */\nconst scrollToBottomLocal = (pageid) => scrollToBottom(pageid);\n\n/**\n * Ensure turn evaluation questions are rendered for a specific turn.\n * This will render them if they don't exist, or do nothing if they already exist.\n *\n * @param {number} pageid Page ID\n * @param {number} turnId Turn ID\n * @return {Promise} Promise that resolves when questions are rendered\n */\nconst ensureTurnEvaluationQuestionsRendered = (pageid, turnId) => {\n    // Check if questions are already rendered for this turn.\n    // Look in the container below the chat, not inside messages.\n    const containerWrapper = $(`#turn-evaluation-questions-container-${pageid}`);\n    if (containerWrapper.length === 0) {\n        // Container wrapper doesn't exist - not in turns mode or page not loaded yet.\n        return Promise.resolve();\n    }\n\n    const existingContainer = containerWrapper.find(`.turn-evaluation-questions[data-turn-id=\"${turnId}\"]`);\n    if (existingContainer.length > 0 && existingContainer.find('.question-item').length > 0) {\n        // Questions already rendered, return resolved promise.\n        return Promise.resolve();\n    }\n\n    // Render questions for this turn.\n    return getString('loading', 'moodle').then((loadingStr) => {\n        // Show loading indicator.\n        containerWrapper.html('<div class=\"text-center py-3 text-muted\"><i class=\"fa fa-spinner fa-spin\"></i> ' +\n            loadingStr + '</div>');\n\n        const params = new URLSearchParams({\n            action: 'get_turn_questions',\n            pageid: pageid,\n            turn_id: turnId,\n            cmid: $(`#chat-messages-page-${pageid}`).closest('.ai-conversation-container').data('cmid'),\n            sesskey: Config.sesskey\n        });\n\n        return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n            method: 'GET',\n            headers: {\n                'Content-Type': 'application/json'\n            }\n        })\n        .then(response => {\n            if (!response.ok) {\n                throw new Error('HTTP error! status: ' + response.status);\n            }\n            return response.json();\n        })\n        .then(data => {\n            if (data.success && data.html) {\n                containerWrapper.html(data.html);\n            } else {\n                containerWrapper.html('<div class=\"text-center text-muted py-3\">' +\n                    (data.message || 'No questions available for this turn.') + '</div>');\n            }\n        })\n        .catch((error) => {\n            // eslint-disable-next-line no-console\n            console.error('Error loading turn evaluation questions:', error);\n            containerWrapper.html('<div class=\"text-danger text-center py-3\">' +\n                'Error loading questions: ' + error.message + '</div>');\n        });\n    });\n};\n\n/**\n * Load saved responses for a turn.\n *\n * @param {number} pageid Page ID\n * @param {number} turnId Turn ID\n */\nconst loadTurnEvaluationResponses = (pageid, turnId) => {\n    // Placeholder: original logic omitted for brevity, would load responses via AJAX.\n};\n\n/**\n * Clear turn evaluation form (placeholder).\n *\n * @param {number} pageid Page ID\n * @param {number} turnId Turn ID\n */\nconst clearTurnEvaluationForm = (pageid, turnId) => {\n    // Placeholder for clearing any form state if needed.\n};\n\n/**\n * Filter messages by conversation ID (no-op in turns).\n */\nconst filterMessagesByConversation = () => {};\n\n/**\n * Navigate to a specific turn in the conversation.\n *\n * @param {number} pageid Page ID\n * @param {number} turnId Turn ID to navigate to\n * @param {boolean} setAsCurrent Whether to set this turn as the current turn (for new branches)\n */\nconst navigateToTurn = (pageid, turnId, setAsCurrent = false) => {\n    // If this is a new turn (like a branch), set it as current FIRST so chat is unlocked.\n    if (setAsCurrent) {\n        currentTurns[pageid] = turnId;\n    }\n    // Then set viewing turn.\n    setViewingTurn(pageid, turnId);\n    // Update display and lock state.\n    updateTurnDisplay(pageid);\n    updateChatLockState(pageid);\n\n    // Collapse previous separators when navigating forward.\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    messagesContainer.find('.turn-separator').each(function() {\n        const separatorTurnId = $(this).data('turn-separator');\n        if (separatorTurnId) {\n            if (parseInt(separatorTurnId, 10) < turnId) {\n                $(this).data('collapsed', true);\n                const toggleIcon = $(this).find('.toggle-turn-btn').find('.toggle-turn-icon');\n                if (toggleIcon.length > 0) {\n                    toggleIcon.removeClass('fa-chevron-up').addClass('fa-chevron-down');\n                }\n            }\n        }\n    });\n\n    filterMessagesByTurn(pageid, turnId);\n    updateSubpageVisibility(pageid);\n    ensureTurnEvaluationQuestionsRendered(pageid, turnId).then(() => {\n        loadTurnEvaluationResponses(pageid, turnId);\n    });\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (sidebar.length) {\n        sidebar.data('sidebar-view', 'detail');\n        loadConversationTree(pageid);\n    }\n};\n\n/**\n * Update subpage visibility for turns mode.\n *\n * @param {number} pageid Page ID\n */\nconst updateSubpageVisibility = (pageid) => {\n    const viewingTurn = getViewingTurn(pageid);\n    const subpagesContainer = $(`#subpages-container-${pageid}`);\n\n    if (subpagesContainer.length === 0) {\n        return; // No subpages container found.\n    }\n\n    // Update subpage visibility.\n    subpagesContainer.find('.subpage-item').each(function() {\n        const $subpage = $(this);\n        const visibilityType = $subpage.data('visibility-type');\n        const turnNumber = $subpage.data('turn-number');\n\n        let shouldShow = false;\n\n        switch (visibilityType) {\n            case 'all_turns':\n                shouldShow = true;\n                break;\n            case 'first_turn':\n                shouldShow = (viewingTurn === 1);\n                break;\n            case 'specific_turn':\n                shouldShow = (viewingTurn === turnNumber);\n                break;\n            default:\n                shouldShow = false;\n        }\n\n        if (shouldShow) {\n            $subpage.slideDown(200);\n            // Update question visibility within this subpage.\n            updateSubpageQuestionVisibility($subpage, viewingTurn);\n        } else {\n            $subpage.slideUp(200);\n        }\n    });\n};\n\n/**\n * Update question visibility within a subpage based on current turn.\n *\n * @param {jQuery} $subpage Subpage jQuery element\n * @param {number} viewingTurn Current viewing turn\n */\nconst updateSubpageQuestionVisibility = ($subpage, viewingTurn) => {\n    $subpage.find('.question-item').each(function() {\n        const $question = $(this);\n        const visibilityType = $question.data('visibility-type') || 'all_turns';\n        const turnNumber = $question.data('turn-number');\n\n        let shouldShow = false;\n\n        switch (visibilityType) {\n            case 'all_turns':\n                shouldShow = true;\n                break;\n            case 'first_turn':\n                shouldShow = (viewingTurn === 1);\n                break;\n            case 'specific_turn':\n                shouldShow = (viewingTurn === turnNumber);\n                break;\n            default:\n                shouldShow = true; // Default to showing if not set.\n        }\n\n        if (shouldShow) {\n            $question.slideDown(200);\n        } else {\n            $question.slideUp(200);\n        }\n    });\n};\n\n/**\n * Load conversation tree from server and render it.\n *\n * @param {number} pageid Page ID\n * @return {Promise} Promise that resolves when tree is loaded\n */\nconst loadConversationTree = (pageid) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n\n    if (treeContainer.length === 0) {\n        // eslint-disable-next-line no-console\n        console.warn('Tree container not found for pageid:', pageid);\n        return Promise.resolve(null);\n    }\n\n    // Get cmid from the container.\n    const cmid = getCmid(pageid);\n    if (!cmid) {\n        // eslint-disable-next-line no-console\n        console.error('cmid not found for pageid:', pageid);\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error: Course module ID not found. Please refresh the page.</div>');\n        return Promise.resolve(null);\n    }\n\n    const params = new URLSearchParams();\n    params.append('action', 'get_conversation_tree');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n\n    return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        // eslint-disable-next-line no-console\n        console.log('Conversation tree response:', data);\n\n        if (data.success && data.tree) {\n            // Annotate roots with sequential conversation numbers for consistent labels.\n            data.tree.roots = (data.tree.roots || []).map((root, idx) => ({\n                ...root,\n                conversation_number: idx + 1\n            }));\n            // Store tree for message filtering.\n            conversationTrees[pageid] = data.tree;\n\n            const viewingTurn = getViewingTurn(pageid);\n            const cmid = getCmid(pageid);\n\n            // Render using Fancytree for better UX with deep trees.\n            ensureFancytree().then(() => {\n                renderFancyTree(pageid, data.tree.roots, viewingTurn, cmid);\n            }).catch((error) => {\n                // eslint-disable-next-line no-console\n                console.error('Error loading Fancytree:', error);\n                // Fallback to list rendering if Fancytree fails.\n                renderConversationList(pageid, data.tree.roots);\n            });\n\n            // Re-filter messages now that we have the tree, so previous-turn messages are correctly\n            // marked and hidden by default, with the toggle controlling them.\n            filterMessagesByTurn(pageid, viewingTurn);\n\n            // Show create-root button only when in list view (outside a conversation).\n            const rootBtn = sidebar.find('.create-root-btn');\n            if (rootBtn.length) {\n                const viewMode = sidebar.data('sidebar-view');\n                if (!viewMode || viewMode === 'list') {\n                    rootBtn.show();\n                } else {\n                    rootBtn.hide();\n                }\n            }\n\n            return data.tree;\n        } else {\n            // Show message in tree container instead of notification.\n            treeContainer.html('<div class=\"text-muted text-center small py-3\">' +\n                (data.message || 'No conversation tree available yet.') + '</div>');\n            return null;\n        }\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error loading conversation tree:', error);\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error loading conversation tree: ' + error.message + '<br>' +\n            'Please check the browser console for details and refresh the page.</div>');\n        return null;\n    });\n};\n\n/**\n * Convert conversation tree nodes to Fancytree nodes.\n *\n * @param {Object} node Tree node from server\n * @param {number} turnIndex Position among siblings\n * @param {string|null} parentNumber Hierarchical number of parent\n * @param {number} viewingTurn Currently viewed turn\n * @param {number} cmid Course module id\n * @return {Object} Fancytree node\n */\nconst toFancyNode = (node, turnIndex, parentNumber, viewingTurn, cmid) => {\n    const turnNumber = calculateTurnNumber(node, turnIndex, parentNumber);\n    const title = 'Turn ' + turnNumber + (node.branch_label ? ' (' + node.branch_label + ')' : '');\n    const children = [];\n    let childCounter = 0;\n\n    if (node.direct_branches && node.direct_branches.length > 0) {\n        const sortedDirect = [...node.direct_branches].sort((a, b) =>\n            parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n        );\n        sortedDirect.forEach((db) => {\n            children.push(toFancyNode(db, childCounter, turnNumber, viewingTurn, cmid));\n            childCounter++;\n        });\n    }\n\n    if (node.children && node.children.length > 0) {\n        const sortedChildren = [...node.children].sort((a, b) =>\n            parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n        );\n        sortedChildren.forEach((child, idx) => {\n            children.push(toFancyNode(child, idx, turnNumber, viewingTurn, cmid));\n        });\n    }\n\n    const hasChildren = children.length > 0;\n    const extraClasses = [];\n    if (node.is_root) {\n        extraClasses.push('ft-root');\n    } else if (node.is_direct_branch) {\n        extraClasses.push('ft-direct-branch');\n    } else {\n        extraClasses.push('ft-branch');\n    }\n    if (hasChildren) {\n        extraClasses.push('ft-has-children');\n    }\n\n    return {\n        title: title,\n        key: String(node.turn_id),\n        expanded: node.is_root || parseInt(node.turn_id, 10) === parseInt(viewingTurn, 10),\n        active: parseInt(node.turn_id, 10) === parseInt(viewingTurn, 10),\n        extraClasses: extraClasses.join(' '),\n        children: children,\n        data: {\n            turn_id: node.turn_id,\n            is_root: node.is_root || false,\n            is_direct_branch: node.is_direct_branch || false,\n            cmid: cmid,\n            turn_number: turnNumber\n        }\n    };\n};\n\n/**\n * Render sidebar tree using Fancytree.\n *\n * @param {number} pageid Page id\n * @param {Array} roots Roots from server\n * @param {number} viewingTurn Currently viewed turn\n * @param {number} cmid Course module id\n */\nconst renderFancyTree = (pageid, roots, viewingTurn, cmid) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    if (treeContainer.length === 0) {\n        return;\n    }\n\n    // Build data for Fancytree: show only the current conversation tree.\n    const rootForViewing = findRootForTurn(roots || [], viewingTurn);\n    const rootsToRender = rootForViewing ? [rootForViewing] : ((roots && roots.length > 0) ? [roots[0]] : []);\n    const source = rootsToRender.map((root, idx) => toFancyNode(root, idx, null, viewingTurn, cmid));\n    const activeRootTurnId = rootsToRender.length ? rootsToRender[0].turn_id : null;\n\n    // Reset container with a top bar and toolbar.\n    treeContainer.html(\n        '<div class=\"tree-header d-flex align-items-center justify-content-between mb-2\">' +\n            '<div class=\"d-flex align-items-center\">' +\n                '<button class=\"btn btn-link btn-sm p-0 mr-2 back-to-list-btn\" data-pageid=\"' + pageid + '\" title=\"Back to list\">' +\n                    '<i class=\"fa fa-arrow-left\"></i>' +\n                '</button>' +\n                '<span class=\"font-weight-bold text-primary\">Conversations</span>' +\n            '</div>' +\n            '<div class=\"btn-group btn-group-sm tree-toolbar\" role=\"group\">' +\n                '<button class=\"btn btn-outline-secondary tree-toolbar-collapse-all\" data-pageid=\"' + pageid + '\" title=\"Collapse all\">' +\n                    '<i class=\"fa fa-minus-square-o\" aria-hidden=\"true\"></i>' +\n                '</button>' +\n                '<button class=\"btn btn-outline-secondary tree-toolbar-expand-current\" data-pageid=\"' + pageid + '\" title=\"Focus current turn\">' +\n                    '<i class=\"fa fa-bullseye\" aria-hidden=\"true\"></i>' +\n                '</button>' +\n            '</div>' +\n        '</div>' +\n        (activeRootTurnId ? (\n            '<div class=\"mb-2\">' +\n                '<button class=\"btn btn-sm btn-success btn-block create-direct-branch-btn\" ' +\n                    'data-pageid=\"' + pageid + '\" data-cmid=\"' + cmid + '\" data-root-turn-id=\"' + activeRootTurnId + '\">' +\n                    '<i class=\"fa fa-plus-circle\" aria-hidden=\"true\"></i> New turn from root' +\n                '</button>' +\n            '</div>'\n        ) : '') +\n        '<div class=\"fancytree-host fancytree-skin-win8\" id=\"fancytree-host-' + pageid + '\"></div>'\n    );\n    const host = $(`#fancytree-host-${pageid}`);\n\n    host.fancytree({\n        source: source,\n        checkbox: false,\n        selectMode: 1,\n        toggleEffect: false,\n        clickFolderMode: 3,\n        activate: (event, data) => {\n            const turnId = parseInt(data.node.key, 10);\n            if (turnId) {\n                navigateToTurn(pageid, turnId);\n            }\n        },\n        renderNode: (event, data) => {\n            const node = data.node;\n            const turnId = parseInt(node.key, 10);\n\n            // Add a compact branch button inline.\n            $(node.span).find('.ft-branch-btn').remove(); // prevent duplicates on re-render\n            const $btn = $('<button type=\"button\" class=\"btn btn-xs btn-outline-success ml-1 ft-branch-btn\" title=\"Branch\"></button>');\n            $btn.append('<i class=\"fa fa-code-branch\"></i>');\n            $btn.on('click', (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                if (!cmid || !turnId) {\n                    Notification.addNotification({\n                        message: 'Missing data to create branch',\n                        type: 'error'\n                    });\n                    return;\n                }\n                createBranchFromTurn(cmid, pageid, turnId, $btn);\n            });\n\n            $(node.span).find('.fancytree-title').after($btn);\n        }\n    });\n\n    fancytreeInstances[pageid] = host.fancytree('getTree');\n};\n\n/**\n * Find the root node that contains the given turn ID.\n */\nconst getTurnNumberForId = (pageid, turnId) => {\n    const tree = conversationTrees[pageid];\n    if (!tree || !tree.roots) {\n        return null;\n    }\n\n    const root = findRootForTurn(tree.roots, turnId);\n    if (!root) {\n        return null;\n    }\n\n    const findAndNumber = (node, targetId, parentNumber, turnIndex) => {\n        const nodeNumber = calculateTurnNumber(node, turnIndex, parentNumber);\n\n        if (parseInt(node.turn_id, 10) === parseInt(targetId, 10)) {\n            return nodeNumber;\n        }\n\n        // Check direct branches if this is a root.\n        if (node.direct_branches && node.direct_branches.length > 0) {\n            // Sort direct branches by turn_id for consistent ordering.\n            const sortedDB = [...node.direct_branches].sort((a, b) =>\n                parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n            );\n            let dbCounter = turnIndex + 1; // Continue sequential numbering\n            for (const db of sortedDB) {\n                const dbNumber = calculateTurnNumber(db, dbCounter, null);\n                if (parseInt(db.turn_id, 10) === parseInt(targetId, 10)) {\n                    return dbNumber;\n                }\n                // Check children of direct branch (derived branches).\n                if (db.children && db.children.length > 0) {\n                    const sortedChildren = [...db.children].sort((a, b) =>\n                        parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n                    );\n                    for (let i = 0; i < sortedChildren.length; i++) {\n                        const found = findAndNumber(sortedChildren[i], targetId, dbNumber, i);\n                        if (found) {\n                            return found;\n                        }\n                    }\n                }\n                dbCounter++;\n            }\n        }\n\n        // Check children (derived branches).\n        if (node.children && node.children.length > 0) {\n            const sortedChildren = [...node.children].sort((a, b) =>\n                parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n            );\n            for (let i = 0; i < sortedChildren.length; i++) {\n                const found = findAndNumber(sortedChildren[i], targetId, nodeNumber, i);\n                if (found) {\n                    return found;\n                }\n            }\n        }\n\n        return null;\n    };\n\n    // Start from root (turnIndex 0 = turn number 1).\n    return findAndNumber(root, turnId, null, 0);\n};\n\n/**\n * Prepare node data for recursive rendering.\n */\nconst prepareNodeData = (node, level, currentTurnId, pageid, cmid, turnIndex = 0, parentNumber = null) => {\n    const isCurrent = parseInt(node.turn_id, 10) === parseInt(currentTurnId, 10);\n    const hasChildren = node.children && node.children.length > 0;\n    const isDirectBranch = node.is_direct_branch || false;\n    const turnNumber = calculateTurnNumber(node, turnIndex, parentNumber);\n\n    return {\n        turn_id: node.turn_id,\n        conversation_id: node.conversation_id || node.turn_id, // Use conversation_id if available, fallback to turn_id\n        turn_number: turnNumber,\n        is_root: isRoot,\n        is_direct_branch: isDirectBranch,\n        is_current: isCurrent,\n        has_children: hasChildren,\n        branch_label: node.branch_label || null,\n        level: level,\n        expanded: true,\n        pageid: pageid,\n        cmid: cmid,\n        can_create_branch: true, // Turns-only module\n        children: hasChildren ? node.children.map((child, index) =>\n            // Keep descendants at the same visual level as their branch root; only the bifurcation is indented.\n            prepareNodeData(child, isDirectBranch ? level : level + 1, currentTurnId, pageid, cmid, index, turnNumber)) : []\n    };\n};\n\n/**\n * Render conversation detail view (single root tree).\n */\nconst renderConversationDetail = (pageid, root) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    const container = $(`#chat-messages-page-${pageid}`).closest('.ai-conversation-container');\n    const cmid = container.data('cmid');\n\n    const viewingTurn = getViewingTurn(pageid);\n\n    // Calculate turn numbers: root is 1, then direct branches are 2, 3, 4...\n    // All turns at root level (root + direct branches) are numbered sequentially.\n    let turnCounter = 0; // Will be incremented to 1 for root, 2 for first direct branch, etc.\n    const rootNodeData = prepareNodeData(root, 0, viewingTurn, pageid, cmid, turnCounter, null);\n    turnCounter++;\n\n    // Find direct branches of this root (branches where parent is this root).\n    // Direct branches are stored in the root's direct_branches array.\n    const directBranches = [];\n    if (root.direct_branches && root.direct_branches.length > 0) {\n        // Sort direct branches by turn_id to ensure consistent ordering.\n        const sortedDirectBranches = [...root.direct_branches].sort((a, b) =>\n            parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n        );\n        sortedDirectBranches.forEach((node) => {\n            // Direct branches continue sequential numbering: 2, 3, 4...\n            // Level 1 so they render visually indented under the root they forked from.\n            directBranches.push(prepareNodeData(node, 1, viewingTurn, pageid, cmid, turnCounter, null));\n            turnCounter++;\n        });\n    }\n\n    Templates.render('mod_harpiasurvey/conversation_detail', {\n        root_node: rootNodeData,\n        root_turn_id: root.turn_id,\n        direct_branches: directBranches,\n        pageid: pageid,\n        cmid: cmid,\n        conversation_number: root.conversation_number || 1\n    }).then((html) => {\n        treeContainer.html(html);\n    }).catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error rendering conversation detail:', error);\n    });\n};\n\n/**\n * Update turn labels in existing messages (after tree is loaded).\n */\nconst updateMessageTurnLabels = (pageid) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    messagesContainer.find('.message').each(function() {\n        const $msg = $(this);\n        const turnId = parseInt($msg.data('turn-id'), 10);\n        if (turnId) {\n            // Use hierarchical turn number.\n            const turnNumber = getTurnNumberForId(pageid, turnId) || turnId;\n            const turnLabel = 'Turno ' + turnNumber;\n            // Update badge in message - find the badge that contains turn label.\n            const $badge = $msg.find('.badge').filter(function() {\n                // Find badge that's in the position-absolute div (turn label badge).\n                return $(this).closest('.position-absolute').length > 0;\n            });\n            if ($badge.length > 0) {\n                $badge.text(turnLabel);\n            } else {\n                // Fallback: update first badge if position-absolute not found.\n                const $firstBadge = $msg.find('.badge').first();\n                if ($firstBadge.length > 0) {\n                    $firstBadge.text(turnLabel);\n                }\n            }\n        }\n    });\n};\n\n/**\n * Create a branch from a specific turn.\n */\nconst createBranchFromTurn = (cmid, pageid, parentTurnId, buttonEl = null) => {\n    const btn = buttonEl ? $(buttonEl) : null;\n    let originalHtml = null;\n    if (btn && btn.length) {\n        originalHtml = btn.html();\n        btn.prop('disabled', true).addClass('branch-btn-loading');\n        btn.html('<i class=\"fa fa-spinner fa-spin fa-xs\" aria-hidden=\"true\"></i>');\n    }\n\n    const params = new URLSearchParams();\n    params.append('action', 'create_branch');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('parent_turn_id', parentTurnId);\n    params.append('sesskey', Config.sesskey);\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (btn && btn.length) {\n            btn.prop('disabled', false).removeClass('branch-btn-loading');\n            if (originalHtml !== null) {\n                btn.html(originalHtml);\n            }\n        }\n\n        if (data.success) {\n            // Navigate to the new turn and set it as current (this will unlock the chat).\n            navigateToTurn(pageid, data.new_turn_id, true);\n\n            // Optimistically update local tree for immediate visual feedback.\n            addLocalBranchNode(pageid, parentTurnId, data.new_turn_id);\n\n            // Reload conversation tree to show the new branch.\n            const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n            sidebar.data('sidebar-view', 'detail'); // Ensure we're in detail view.\n            loadConversationTree(pageid);\n\n            getString('branchcreated', 'mod_harpiasurvey')\n                .then((msg) => {\n                    Notification.addNotification({\n                        message: msg,\n                        type: 'success'\n                    });\n                })\n                .catch(() => {\n                    Notification.addNotification({\n                        message: 'Branch created successfully',\n                        type: 'success'\n                    });\n                });\n        } else {\n            Notification.addNotification({\n                message: data.message || 'Failed to create turn',\n                type: 'error'\n            });\n        }\n    })\n    .catch((error) => {\n        if (btn && btn.length) {\n            btn.prop('disabled', false).removeClass('branch-btn-loading');\n            if (originalHtml !== null) {\n                btn.html(originalHtml);\n            }\n        }\n\n        // eslint-disable-next-line no-console\n        console.error('Error creating turn:', error);\n        Notification.addNotification({\n            message: 'Error creating turn: ' + error.message,\n            type: 'error'\n        });\n    });\n};\n\n/**\n * Add a branch node locally so the tree shows immediate indentation before reload.\n */\nconst addLocalBranchNode = (pageid, parentTurnId, newTurnId) => {\n    const tree = conversationTrees[pageid];\n    if (!tree || !tree.roots) {\n        return;\n    }\n    const root = findRootForTurn(tree.roots, parentTurnId);\n    if (!root) {\n        return;\n    }\n\n    const newNode = {\n        turn_id: newTurnId,\n        is_root: false,\n        is_direct_branch: false,\n        parent_turn_id: parentTurnId,\n        branch_label: String(newTurnId),\n        children: [],\n        timecreated: Math.floor(Date.now() / 1000),\n        timecreated_str: new Date().toLocaleString()\n    };\n\n    const attach = (node) => {\n        if (parseInt(node.turn_id, 10) === parseInt(parentTurnId, 10)) {\n            if (node.is_root || node.is_direct_branch) {\n                newNode.is_direct_branch = true;\n                if (!node.direct_branches) {\n                    node.direct_branches = [];\n                }\n                node.direct_branches.push(newNode);\n            } else {\n                if (!node.children) {\n                    node.children = [];\n                }\n                node.children.push(newNode);\n            }\n            return true;\n        }\n        if (node.direct_branches) {\n            for (const db of node.direct_branches) {\n                if (attach(db)) {\n                    return true;\n                }\n            }\n        }\n        if (node.children) {\n            for (const child of node.children) {\n                if (attach(child)) {\n                    return true;\n                }\n            }\n        }\n        return false;\n    };\n\n    attach(root);\n};\n\n/**\n * Create a new root conversation.\n */\nconst createNewRoot = (cmid, pageid) => {\n    const container = $(`.ai-conversation-container[data-pageid=\"${pageid}\"]`);\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n\n    const params = new URLSearchParams();\n    params.append('action', 'create_root');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (data.success) {\n            currentTurns[pageid] = data.new_turn_id;\n            setViewingTurn(pageid, data.new_turn_id);\n            updateTurnDisplay(pageid);\n            updateChatLockState(pageid);\n            messagesContainer.html('<div class=\"text-muted text-center small py-3\">' +\n                'New conversation started. Send a message to begin.</div>');\n            $(`#turn-evaluation-questions-container-${pageid}`).empty();\n\n            const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n            sidebar.data('sidebar-view', 'detail');\n            setTimeout(() => {\n                loadConversationTree(pageid);\n            }, 100);\n\n            Notification.addNotification({\n                message: data.message || 'New conversation created successfully',\n                type: 'success'\n            });\n        } else {\n            Notification.addNotification({\n                message: data.message || 'Failed to create new root',\n                type: 'error'\n            });\n        }\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error creating new root:', error);\n        Notification.addNotification({\n            message: 'Error creating new root: ' + error.message,\n            type: 'error'\n        });\n    });\n};\n\nconst setPreviousMessagesVisibility = (pageid, visible) => {\n    const container = $(`#chat-messages-page-${pageid}`);\n    container.data('show-previous', visible === true);\n    const prevMessages = container.find('.previous-turn-message');\n    if (visible) {\n        prevMessages.show();\n    } else {\n        prevMessages.hide();\n    }\n    const toggleBtn = $(`.toggle-previous-messages-btn[data-pageid=\"${pageid}\"]`);\n    if (toggleBtn.length) {\n        updatePreviousToggleLabel(toggleBtn, visible);\n    }\n};\n\nconst updatePreviousToggleLabel = (btn, isVisible) => {\n    if (isVisible) {\n        btn.html('<i class=\"fa fa-history\" aria-hidden=\"true\"></i> Ocultar anteriores');\n        btn.attr('title', 'Ocultar conversas anteriores');\n    } else {\n        btn.html('<i class=\"fa fa-history\" aria-hidden=\"true\"></i> Mostrar anteriores');\n        btn.attr('title', 'Mostrar conversas anteriores');\n    }\n};\n\nexport {\n    updateTurnDisplay,\n    getViewingTurn,\n    getCurrentTurn,\n    setViewingTurn,\n    isTurnComplete,\n    loadConversationTree,\n    navigateToTurn,\n    renderConversationDetail,\n    prepareNodeData,\n    updateMessageTurnLabels,\n    setPreviousMessagesVisibility,\n    scrollToBottom,\n    createBranchFromTurn,\n    createNewRoot\n};\n\nexport default {\n    init,\n    initTurns\n};\n"],"names":["initializedTurns","commonHandlersRegistered","turnHandlersRegistered","treeHandlersRegistered","fancytreeInstances","initialize","containers","length","each","pageid","parseInt","this","data","messagesContainer","maxTurn","find","turnId","calculatedCurrentTurn","currentTurns","urlTurn","URLSearchParams","window","location","search","get","initialViewingTurn","parsedTurn","isNaN","setViewingTurn","updateTurnDisplay","updateChatLockState","sidebar","show","addClass","loadConversationTree","then","filterMessagesByTurn","catch","updateSubpageVisibility","setTimeout","ensureTurnEvaluationQuestionsRendered","loadTurnEvaluationResponses","error","console","document","on","e","preventDefault","button","cmid","container","closest","addNotification","message","type","input","inputValue","val","trim","viewingTurn","getViewingTurn","currentTurn","getCurrentTurn","viewingTurnNum","maxTurns","maxTurnsNum","turnCount","getTurnCountForConversation","isTurnComplete","str","modelsdata","modelid","modelids","split","prop","tempId","Date","now","Math","random","toString","substr","displayUserMessage","loading","sendMessage","key","shiftKey","click","btn","currentlyVisible","setPreviousMessagesVisibility","registerCommonHandlers","node","attr","replace","navigateToTurn","item","rootTurnId","tree","conversationTrees","roots","stopPropagation","createBranchFromTurn","trigger","parentTurnId","createNewRoot","behavior","params","append","Config","sesskey","conversationId","open","wwwroot","icon","childrenContainer","is","hide","removeClass","visit","setExpanded","getNodeByKey","String","makeVisible","setActive","registerTreeHandlers","registerTurnHandlers","init","initTurns","turn","label","text","turnHasMessages","turnMessages","role","last","root","shouldShowPrevious","allowedTurnIds","Set","add","addPath","targetId","path","turn_id","forEach","id","direct_branches","db","children","child","$msg","messageTurnId","isCurrentTurn","has","$separator","separatorTurnId","toggleBtn","isVisible","first","updatePreviousToggleLabel","currentTurnNum","sendBtn","lockMessage","conversationTurnCount","hasReachedTurnLimit","directBranchContainer","action","fetch","method","headers","response","ok","Error","status","json","success","messageid","content","displayAIMessage","focus","remove","render","timecreated","floor","html","Notification","exception","Promise","resolve","Templates","containerWrapper","existingContainer","loadingStr","setAsCurrent","toggleIcon","subpagesContainer","$subpage","visibilityType","turnNumber","shouldShow","slideDown","updateSubpageQuestionVisibility","slideUp","$question","treeContainer","warn","body","log","map","idx","conversation_number","renderFancyTree","rootBtn","viewMode","toFancyNode","turnIndex","parentNumber","title","branch_label","childCounter","sort","a","b","push","hasChildren","extraClasses","is_root","is_direct_branch","expanded","active","join","turn_number","rootForViewing","rootsToRender","source","activeRootTurnId","host","fancytree","checkbox","selectMode","toggleEffect","clickFolderMode","activate","event","renderNode","span","$btn","after","prepareNodeData","level","currentTurnId","isCurrent","isDirectBranch","conversation_id","isRoot","is_current","has_children","can_create_branch","index","turnCounter","rootNodeData","directBranches","root_node","root_turn_id","findAndNumber","nodeNumber","sortedDB","dbCounter","dbNumber","sortedChildren","i","found","getTurnNumberForId","turnLabel","$badge","filter","$firstBadge","buttonEl","originalHtml","new_turn_id","addLocalBranchNode","msg","newTurnId","newNode","parent_turn_id","timecreated_str","toLocaleString","attach","empty","visible","prevMessages"],"mappings":"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"}
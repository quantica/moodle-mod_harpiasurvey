{"version":3,"file":"qa.min.js","sources":["../src/qa.js"],"sourcesContent":["// Q&A-only logic for harpiasurvey chat (single question/answer).\nimport {\n    Templates,\n    Notification,\n    Config,\n    getString,\n    $,\n    scrollToBottom,\n    addError\n} from './common_chat';\n\nlet initialized = false;\nlet handlersRegistered = false;\n\nexport const init = () => initialize();\n\nconst initialize = () => {\n    if (initialized) {\n        return;\n    }\n    const containers = $('.ai-conversation-container[data-behavior=\"qa\"]');\n    if (containers.length === 0) {\n        return;\n    }\n    containers.each(function() {\n        const pageid = parseInt($(this).data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n        const activeId = parseInt($(this).data('qa-active-id'), 10);\n        const messagesContainer = $(`#chat-messages-page-${pageid}`);\n        if (messagesContainer.find('.message[data-role=\"assistant\"]').length > 0) {\n            lockQaInput(pageid);\n        }\n        if (activeId) {\n            selectQaQuestion(pageid, activeId);\n        }\n    });\n    registerHandlers();\n    initialized = true;\n};\n\nfunction registerHandlers() {\n    if (handlersRegistered) {\n        return;\n    }\n\n    $(document).on('click', '.ai-conversation-container[data-behavior=\"qa\"] .chat-send-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const pageid = parseInt(button.data('pageid'), 10);\n        if (!cmid || !pageid) {\n            addError('Missing cmid or pageid');\n            return;\n        }\n        const input = $(`#chat-input-page-${pageid}`);\n        if (input.length === 0) {\n            addError('Chat input not found');\n            return;\n        }\n        const inputValue = input.val();\n        if (!inputValue) {\n            return;\n        }\n        const message = inputValue.trim();\n        if (!message) {\n            return;\n        }\n        const container = button.closest('.ai-conversation-container');\n        const modelsdata = container.data('models');\n        let modelid = null;\n        if (modelsdata) {\n            const modelids = modelsdata.split(',');\n            if (modelids.length > 0) {\n                modelid = parseInt(modelids[0], 10);\n            }\n        }\n        if (!modelid) {\n            addError('No model available');\n            return;\n        }\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n        input.val('');\n        const tempId = 'temp-user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n        displayUserMessage(pageid, message, tempId);\n        addQaQuestionItem(pageid, tempId, message);\n        selectQaQuestion(pageid, tempId);\n        const loading = $(`#chat-loading-page-${pageid}`);\n        loading.show();\n        sendMessage(cmid, pageid, message, modelid, button, input, loading);\n    });\n\n    $(document).on('keydown', '.ai-conversation-container[data-behavior=\"qa\"] .chat-input', function(e) {\n        if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault();\n            $(this).closest('.ai-conversation-container').find('.chat-send-btn').click();\n        }\n    });\n\n    $(document).on('click', '.ai-conversation-container[data-behavior=\"qa\"] .new-question-btn', function(e) {\n        e.preventDefault();\n        const pageid = parseInt($(this).data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n        resetQaView(pageid);\n    });\n\n    $(document).on('click', '.qa-question-item', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const questionId = parseInt(button.data('question-id'), 10);\n        if (!pageid || !questionId) {\n            return;\n        }\n        selectQaQuestion(pageid, questionId);\n    });\n\n    handlersRegistered = true;\n}\n\nconst resetQaView = (pageid) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    messagesContainer.find('.message').hide();\n    const placeholder = messagesContainer.find('.qa-placeholder');\n    if (placeholder.length > 0) {\n        placeholder.show();\n    } else {\n        getString('qaplaceholder', 'mod_harpiasurvey').then((message) => {\n            messagesContainer.append('<div class=\"qa-placeholder text-muted text-center small py-3\">' + message + '</div>');\n        }).catch(() => {\n            messagesContainer.append('<div class=\"qa-placeholder text-muted text-center small py-3\">Ask a new question to get an answer.</div>');\n        });\n    }\n    const input = $(`#chat-input-page-${pageid}`);\n    if (input.length > 0) {\n        input.val('');\n        input.prop('disabled', false);\n        const container = $(`.ai-conversation-container[data-pageid=\"${pageid}\"]`);\n        const inputGroup = container.find('.input-group');\n        if (inputGroup.length > 0) {\n            inputGroup.show();\n        }\n        const sendButton = container.find('.chat-send-btn');\n        sendButton.prop('disabled', false);\n        container.find('.qa-question-item').removeClass('active');\n        input.focus();\n    }\n};\n\nconst sendMessage = (cmid, pageid, message, modelid, button, input, loading) => {\n    const params = new URLSearchParams({\n        action: 'send_ai_message',\n        cmid: cmid,\n        pageid: pageid,\n        message: message,\n        modelid: modelid,\n        sesskey: Config.sesskey\n    });\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then(response => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then(data => {\n        loading.hide();\n        if (data.success) {\n            if (data.messageid && data.content) {\n                const parentid = data.parentid || null;\n                if (parentid) {\n                    const pendingUser = $(`#chat-messages-page-${pageid} .message[data-role=\"user\"]`).last();\n                    if (pendingUser.length > 0) {\n                        pendingUser.attr('data-messageid', parentid);\n                    }\n                    updateQaQuestionItemId(pageid, parentid);\n                }\n                displayAIMessage(pageid, data.content, data.messageid, parentid).then(() => {\n                    scrollToBottom(pageid);\n                    lockQaInput(pageid);\n                    if (parentid) {\n                        selectQaQuestion(pageid, parentid);\n                    }\n                });\n            } else {\n                addError('Received response but missing message ID or content');\n            }\n        } else {\n            addError(data.message || 'Error sending message');\n        }\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    })\n    .catch(error => {\n        loading.hide();\n        // eslint-disable-next-line no-console\n        console.error('Error sending message:', error);\n        addError('Error sending message: ' + error.message);\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    });\n};\n\nconst displayUserMessage = (pageid, message, messageid) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    messagesContainer.find('.text-center.text-muted').remove();\n    Templates.render('mod_harpiasurvey/chat_user_message', {\n        id: messageid,\n        content: message,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottom(pageid);\n    }).catch(Notification.exception);\n};\n\nconst displayAIMessage = (pageid, content, messageid, parentid = null) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return Promise.resolve();\n    }\n    return Templates.render('mod_harpiasurvey/chat_ai_message', {\n        id: messageid,\n        parentid: parentid,\n        content: content,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottom(pageid);\n        return html;\n    }).catch(Notification.exception);\n};\n\nconst selectQaQuestion = (pageid, questionId) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    messagesContainer.find('.qa-placeholder').hide();\n    messagesContainer.find('.message').hide();\n    messagesContainer.find(`.message[data-messageid=\"${questionId}\"], .message[data-parentid=\"${questionId}\"]`).show();\n    const list = $(`.qa-questions-list[data-pageid=\"${pageid}\"]`);\n    list.find('.qa-question-item').removeClass('active');\n    list.find(`.qa-question-item[data-question-id=\"${questionId}\"]`).addClass('active');\n    lockQaInput(pageid);\n};\n\nconst addQaQuestionItem = (pageid, questionId, message) => {\n    const list = $(`.qa-questions-list[data-pageid=\"${pageid}\"]`);\n    if (list.length === 0) {\n        return;\n    }\n    const preview = (message || '').trim().slice(0, 60);\n    const label = message && message.length > 60 ? preview + '...' : preview || ('Question #' + questionId);\n    const button = $('<button>', {\n        type: 'button',\n        class: 'btn btn-sm btn-outline-secondary qa-question-item',\n        'data-pageid': pageid,\n        'data-question-id': questionId,\n        title: label,\n        text: label\n    });\n    list.append(button);\n};\n\nconst updateQaQuestionItemId = (pageid, newId) => {\n    const list = $(`.qa-questions-list[data-pageid=\"${pageid}\"]`);\n    const lastItem = list.find('.qa-question-item').last();\n    if (lastItem.length > 0) {\n        lastItem.attr('data-question-id', newId);\n    }\n};\n\nconst lockQaInput = (pageid) => {\n    const container = $(`.ai-conversation-container[data-pageid=\"${pageid}\"]`);\n    const inputGroup = container.find('.input-group');\n    if (inputGroup.length > 0) {\n        inputGroup.hide();\n    }\n    const input = $(`#chat-input-page-${pageid}`);\n    const sendButton = container.find('.chat-send-btn');\n    input.prop('disabled', true);\n    sendButton.prop('disabled', true);\n};\n"],"names":["initialized","handlersRegistered","initialize","containers","length","each","pageid","parseInt","this","data","activeId","find","lockQaInput","selectQaQuestion","document","on","e","preventDefault","button","cmid","input","inputValue","val","message","trim","modelsdata","closest","modelid","modelids","split","prop","tempId","Date","now","Math","random","toString","substr","displayUserMessage","addQaQuestionItem","loading","show","sendMessage","key","shiftKey","click","resetQaView","questionId","registerHandlers","messagesContainer","hide","placeholder","then","append","catch","container","inputGroup","removeClass","focus","params","URLSearchParams","action","sesskey","Config","fetch","wwwroot","method","headers","response","ok","Error","status","json","success","messageid","content","parentid","pendingUser","last","attr","updateQaQuestionItemId","displayAIMessage","error","console","remove","render","id","timecreated","floor","html","Notification","exception","Promise","resolve","Templates","list","addClass","preview","slice","label","type","class","title","text","newId","lastItem","sendButton"],"mappings":"2KAWIA,aAAc,EACdC,oBAAqB,gBAEL,IAAMC,mBAEpBA,WAAa,QACXF,yBAGEG,YAAa,kBAAE,kDACK,IAAtBA,WAAWC,SAGfD,WAAWE,MAAK,iBACNC,OAASC,UAAS,kBAAEC,MAAMC,KAAK,UAAW,QAC3CH,oBAGCI,SAAWH,UAAS,kBAAEC,MAAMC,KAAK,gBAAiB,KAC9B,kBAAG,uBAAsBH,UAC7BK,KAAK,mCAAmCP,OAAS,GACnEQ,YAAYN,QAEZI,UACAG,iBAAiBP,OAAQI,2BAQ7BT,6CAIFa,UAAUC,GAAG,QAAS,iEAAiE,SAASC,GAC9FA,EAAEC,uBACIC,QAAS,kBAAEV,MACXW,KAAOZ,SAASW,OAAOT,KAAK,QAAS,IACrCH,OAASC,SAASW,OAAOT,KAAK,UAAW,QAC1CU,OAASb,4CACD,gCAGPc,OAAQ,kBAAG,oBAAmBd,aACf,IAAjBc,MAAMhB,4CACG,8BAGPiB,WAAaD,MAAME,UACpBD,wBAGCE,QAAUF,WAAWG,WACtBD,qBAICE,WADYP,OAAOQ,QAAQ,8BACJjB,KAAK,cAC9BkB,QAAU,QACVF,WAAY,OACNG,SAAWH,WAAWI,MAAM,KAC9BD,SAASxB,OAAS,IAClBuB,QAAUpB,SAASqB,SAAS,GAAI,SAGnCD,6CACQ,sBAGbP,MAAMU,KAAK,YAAY,GACvBZ,OAAOY,KAAK,YAAY,GACxBV,MAAME,IAAI,UACJS,OAAS,aAAeC,KAAKC,MAAQ,IAAMC,KAAKC,SAASC,SAAS,IAAIC,OAAO,EAAG,GACtFC,mBAAmBhC,OAAQiB,QAASQ,QACpCQ,kBAAkBjC,OAAQyB,OAAQR,SAClCV,iBAAiBP,OAAQyB,cACnBS,SAAU,kBAAG,sBAAqBlC,UACxCkC,QAAQC,OACRC,YAAYvB,KAAMb,OAAQiB,QAASI,QAAST,OAAQE,MAAOoB,+BAG7D1B,UAAUC,GAAG,UAAW,8DAA8D,SAASC,GAC/E,UAAVA,EAAE2B,KAAoB3B,EAAE4B,WACxB5B,EAAEC,oCACAT,MAAMkB,QAAQ,8BAA8Bf,KAAK,kBAAkBkC,+BAI3E/B,UAAUC,GAAG,QAAS,oEAAoE,SAASC,GACjGA,EAAEC,uBACIX,OAASC,UAAS,kBAAEC,MAAMC,KAAK,UAAW,IAC3CH,QAGLwC,YAAYxC,8BAGdQ,UAAUC,GAAG,QAAS,qBAAqB,SAASC,GAClDA,EAAEC,uBACIC,QAAS,kBAAEV,MACXF,OAASC,SAASW,OAAOT,KAAK,UAAW,IACzCsC,WAAaxC,SAASW,OAAOT,KAAK,eAAgB,IACnDH,QAAWyC,YAGhBlC,iBAAiBP,OAAQyC,eAG7B9C,oBAAqB,EAnFrB+C,GACAhD,aAAc,UAqFZ8C,YAAexC,eACX2C,mBAAoB,kBAAG,uBAAsB3C,aAClB,IAA7B2C,kBAAkB7C,cAGtB6C,kBAAkBtC,KAAK,YAAYuC,aAC7BC,YAAcF,kBAAkBtC,KAAK,mBACvCwC,YAAY/C,OAAS,EACrB+C,YAAYV,kCAEF,gBAAiB,oBAAoBW,MAAM7B,UACjD0B,kBAAkBI,OAAO,iEAAmE9B,QAAU,aACvG+B,OAAM,KACLL,kBAAkBI,OAAO,qHAG3BjC,OAAQ,kBAAG,oBAAmBd,aAChCc,MAAMhB,OAAS,EAAG,CAClBgB,MAAME,IAAI,IACVF,MAAMU,KAAK,YAAY,SACjByB,WAAY,kBAAG,2CAA0CjD,YACzDkD,WAAaD,UAAU5C,KAAK,gBAC9B6C,WAAWpD,OAAS,GACpBoD,WAAWf,OAEIc,UAAU5C,KAAK,kBACvBmB,KAAK,YAAY,GAC5ByB,UAAU5C,KAAK,qBAAqB8C,YAAY,UAChDrC,MAAMsC,UAIRhB,YAAc,CAACvB,KAAMb,OAAQiB,QAASI,QAAST,OAAQE,MAAOoB,iBAC1DmB,OAAS,IAAIC,gBAAgB,CAC/BC,OAAQ,kBACR1C,KAAMA,KACNb,OAAQA,OACRiB,QAASA,QACTI,QAASA,QACTmC,QAASC,oBAAOD,UAGpBE,MAAMD,oBAAOE,QAAU,8BAAgCN,OAAOvB,WAAY,CACtE8B,OAAQ,MACRC,QAAS,gBACW,sBAGvBf,MAAKgB,eACGA,SAASC,SACJ,IAAIC,MAAM,uBAAyBF,SAASG,eAE/CH,SAASI,UAEnBpB,MAAK3C,UACF+B,QAAQU,OACJzC,KAAKgE,WACDhE,KAAKiE,WAAajE,KAAKkE,QAAS,OAC1BC,SAAWnE,KAAKmE,UAAY,QAC9BA,SAAU,OACJC,aAAc,kBAAG,uBAAsBvE,qCAAqCwE,OAC9ED,YAAYzE,OAAS,GACrByE,YAAYE,KAAK,iBAAkBH,UAEvCI,uBAAuB1E,OAAQsE,UAEnCK,iBAAiB3E,OAAQG,KAAKkE,QAASlE,KAAKiE,UAAWE,UAAUxB,MAAK,qCACnD9C,QACfM,YAAYN,QACRsE,UACA/D,iBAAiBP,OAAQsE,2CAIxB,qFAGJnE,KAAKc,SAAW,yBAE7BH,MAAMU,KAAK,YAAY,GACvBZ,OAAOY,KAAK,YAAY,GACxBV,MAAMsC,WAETJ,OAAM4B,QACH1C,QAAQU,OAERiC,QAAQD,MAAM,yBAA0BA,iCAC/B,0BAA4BA,MAAM3D,SAC3CH,MAAMU,KAAK,YAAY,GACvBZ,OAAOY,KAAK,YAAY,GACxBV,MAAMsC,YAIRpB,mBAAqB,CAAChC,OAAQiB,QAASmD,mBACnCzB,mBAAoB,kBAAG,uBAAsB3C,UAClB,IAA7B2C,kBAAkB7C,SAGtB6C,kBAAkBtC,KAAK,2BAA2ByE,gCACxCC,OAAO,qCAAsC,CACnDC,GAAIZ,UACJC,QAASpD,QACTgE,YAAarD,KAAKsD,MAAMxD,KAAKC,MAAQ,OACtCmB,MAAMqC,OACLxC,kBAAkBI,OAAOoC,sCACVnF,WAChBgD,MAAMoC,0BAAaC,aAGpBV,iBAAmB,SAAC3E,OAAQqE,QAASD,eAAWE,gEAAW,WACvD3B,mBAAoB,kBAAG,uBAAsB3C,iBAClB,IAA7B2C,kBAAkB7C,OACXwF,QAAQC,UAEZC,uBAAUT,OAAO,mCAAoC,CACxDC,GAAIZ,UACJE,SAAUA,SACVD,QAASA,QACTY,YAAarD,KAAKsD,MAAMxD,KAAKC,MAAQ,OACtCmB,MAAMqC,OACLxC,kBAAkBI,OAAOoC,sCACVnF,QACRmF,QACRnC,MAAMoC,0BAAaC,YAGpB9E,iBAAmB,CAACP,OAAQyC,oBACxBE,mBAAoB,kBAAG,uBAAsB3C,aAClB,IAA7B2C,kBAAkB7C,cAGtB6C,kBAAkBtC,KAAK,mBAAmBuC,OAC1CD,kBAAkBtC,KAAK,YAAYuC,OACnCD,kBAAkBtC,KAAM,4BAA2BoC,yCAAyCA,gBAAgBN,aACtGsD,MAAO,kBAAG,mCAAkCzF,YAClDyF,KAAKpF,KAAK,qBAAqB8C,YAAY,UAC3CsC,KAAKpF,KAAM,uCAAsCoC,gBAAgBiD,SAAS,UAC1EpF,YAAYN,SAGViC,kBAAoB,CAACjC,OAAQyC,WAAYxB,iBACrCwE,MAAO,kBAAG,mCAAkCzF,eAC9B,IAAhByF,KAAK3F,oBAGH6F,SAAW1E,SAAW,IAAIC,OAAO0E,MAAM,EAAG,IAC1CC,MAAQ5E,SAAWA,QAAQnB,OAAS,GAAK6F,QAAU,MAAQA,SAAY,aAAelD,WACtF7B,QAAS,kBAAE,WAAY,CACzBkF,KAAM,SACNC,MAAO,kEACQ/F,0BACKyC,WACpBuD,MAAOH,MACPI,KAAMJ,QAEVJ,KAAK1C,OAAOnC,SAGV8D,uBAAyB,CAAC1E,OAAQkG,eAE9BC,UADO,kBAAG,mCAAkCnG,YAC5BK,KAAK,qBAAqBmE,OAC5C2B,SAASrG,OAAS,GAClBqG,SAAS1B,KAAK,mBAAoByB,QAIpC5F,YAAeN,eACXiD,WAAY,kBAAG,2CAA0CjD,YACzDkD,WAAaD,UAAU5C,KAAK,gBAC9B6C,WAAWpD,OAAS,GACpBoD,WAAWN,aAET9B,OAAQ,kBAAG,oBAAmBd,UAC9BoG,WAAanD,UAAU5C,KAAK,kBAClCS,MAAMU,KAAK,YAAY,GACvB4E,WAAW5E,KAAK,YAAY"}
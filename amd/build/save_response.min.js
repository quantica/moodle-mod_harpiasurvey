define("mod_harpiasurvey/save_response",["exports","core/notification","core/str","core/config","jquery"],(function(_exports,_notification,_str,_config,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Save response module for harpiasurvey.
   *
   * @module     mod_harpiasurvey/save_response
   * @copyright  2025 Your Name
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_notification=_interopRequireDefault(_notification),_config=_interopRequireDefault(_config),_jquery=_interopRequireDefault(_jquery);let initialized=!1;_exports.init=()=>{initialized||((0,_jquery.default)("select[data-saved-value]").each((function(){const select=(0,_jquery.default)(this),savedValue=select.data("saved-value");savedValue&&select.val(savedValue)})),(0,_jquery.default)(document).on("click",".save-all-responses-btn",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),cmid=parseInt(button.data("cmid"),10),pageid=parseInt(button.data("pageid"),10),statusDiv=(0,_jquery.default)(".save-all-status"),questionsToSave=[];(0,_jquery.default)(".question-item").each((function(){const questionItem=(0,_jquery.default)(this),questionid=parseInt(questionItem.data("questionid"),10),questiontype=questionItem.data("questiontype");if(!questionid||!questiontype)return;let response="";if("singlechoice"===questiontype||"likert"===questiontype){const selected=(0,_jquery.default)(`input[name="question_${questionid}"]:checked`);selected.length>0&&(response=selected.val())}else if("multiplechoice"===questiontype){const selected=(0,_jquery.default)(`input[name="question_${questionid}[]"]:checked`),values=[];selected.each((function(){values.push((0,_jquery.default)(this).val())})),response=JSON.stringify(values)}else if("select"===questiontype){const selected=(0,_jquery.default)(`#question_${questionid}`).val();selected&&(response=selected)}else("number"===questiontype||"shorttext"===questiontype||"longtext"===questiontype)&&(response=(0,_jquery.default)(`#question_${questionid}`).val());questionsToSave.push({questionid:questionid,questiontype:questiontype,response:response})})),0!==questionsToSave.length?saveAllResponses(cmid,pageid,questionsToSave,button,statusDiv):_notification.default.addNotification({message:"No questions to save.",type:"info"})})),initialized=!0)};const saveAllResponses=(cmid,pageid,questionsToSave,button,statusDiv)=>{const originalText=button.text();button.prop("disabled",!0),statusDiv.show().html('<div class="text-info"><i class="fa fa-spinner fa-spin"></i> Saving responses...</div>');const container=(0,_jquery.default)('.ai-conversation-container[data-pageid="'+pageid+'"]');let turnId=null;if(container.length>0){if("turns"===container.data("behavior")){const viewingTurn=container.attr("data-viewing-turn");if(viewingTurn)turnId=parseInt(viewingTurn,10);else{const messagesContainer=container.find(`#chat-messages-page-${pageid}`);if(messagesContainer.length>0){const messages=messagesContainer.find(".message[data-turn-id]");let maxTurn=0;messages.each((function(){const msgTurnId=parseInt((0,_jquery.default)(this).attr("data-turn-id"),10);msgTurnId>maxTurn&&(maxTurn=msgTurnId)})),turnId=maxTurn>0?maxTurn:1}else turnId=1}}}let savedCount=0,failedCount=0;const total=questionsToSave.length;let promiseChain=Promise.resolve();questionsToSave.forEach(((questionData,index)=>{promiseChain=promiseChain.then((()=>new Promise((resolve=>{const savingHtml=`<div class="text-info"><i class="fa fa-spinner fa-spin"></i> Saving ${index+1} of ${total}...</div>`;statusDiv.html(savingHtml);const params=new URLSearchParams({action:"save_response",cmid:cmid,pageid:pageid,questionid:questionData.questionid,response:questionData.response,sesskey:_config.default.sesskey});null!==turnId&&turnId>0&&params.append("turn_id",turnId),fetch(_config.default.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>response.json())).then((data=>{if(data.success){savedCount++;const datetimeStr=(new Date).toLocaleString();(0,_str.get_string)("saved","mod_harpiasurvey").then((savedText=>{(0,_str.get_string)("on","mod_harpiasurvey").then((onText=>{const questionSelector=`.question-item[data-questionid="${questionData.questionid}"]`,savedSelector=`.saved-response-message[data-questionid="${questionData.questionid}"]`,questionItem=(0,_jquery.default)(questionSelector),savedMessage=questionItem.find(savedSelector),icon='<i class="fa fa-check-circle" aria-hidden="true"></i>';if(0===savedMessage.length){const messageHtml=`<div class="mt-2 small text-muted saved-response-message" data-questionid="${questionData.questionid}">${icon} ${savedText} ${onText} ${datetimeStr}</div>`;questionItem.append(messageHtml)}else savedMessage.html(`${icon} ${savedText} ${onText} ${datetimeStr}`)}))}))}else failedCount++;resolve()})).catch((()=>{failedCount++,resolve()}))}))))})),promiseChain.then((()=>{if(button.prop("disabled",!1),button.text(originalText),0===failedCount){button.removeClass("btn-primary").addClass("btn-success");const successHtml=`<div class="text-success"><i class="fa fa-check-circle"></i> All ${savedCount} response(s) saved successfully!</div>`;statusDiv.html(successHtml),setTimeout((()=>{button.removeClass("btn-success").addClass("btn-primary"),statusDiv.fadeOut()}),3e3)}else{button.removeClass("btn-primary").addClass("btn-warning");const warningHtml=`<div class="text-warning"><i class="fa fa-exclamation-triangle"></i> ${savedCount} saved, ${failedCount} failed. Please try again.</div>`;statusDiv.html(warningHtml),setTimeout((()=>{button.removeClass("btn-warning").addClass("btn-primary")}),5e3)}}))}}));

//# sourceMappingURL=save_response.min.js.map
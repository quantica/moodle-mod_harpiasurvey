define("mod_harpiasurvey/save_response",["exports","core/notification","core/str","core/config","jquery"],(function(_exports,_notification,_str,_config,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Save response module for harpiasurvey.
   *
   * @module     mod_harpiasurvey/save_response
   * @copyright  2025 Your Name
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_notification=_interopRequireDefault(_notification),_config=_interopRequireDefault(_config),_jquery=_interopRequireDefault(_jquery);let initialized=!1,editLabel="Edit";const lockQuestionItem=questionItem=>{questionItem.attr("data-response-locked","1"),questionItem.removeAttr("data-response-editing"),questionItem.find("input, select, textarea").prop("disabled",!0)},ensureEditButton=questionItem=>{let controls=questionItem.find(".question-edit-controls");0===controls.length&&(controls=(0,_jquery.default)('<div class="mt-2 question-edit-controls"></div>'),questionItem.append(controls));let button=controls.find(".question-edit-btn");0===button.length&&(button=(0,_jquery.default)('<button type="button" class="btn btn-sm btn-outline-secondary question-edit-btn"></button>'),controls.append(button)),button.text(editLabel),button.show()},getResponseDisplay=(questionItem,questionType)=>{let display="";if("singlechoice"===questionType||"likert"===questionType){const checked=questionItem.find('input[type="radio"]:checked');if(checked.length>0){const id=checked.attr("id");display=(id?questionItem.find(`label[for="${id}"]`).text().trim():"")||checked.val()}}else if("multiplechoice"===questionType){const labels=[];questionItem.find('input[type="checkbox"]:checked').each((function(){const id=(0,_jquery.default)(this).attr("id"),label=id?questionItem.find(`label[for="${id}"]`).text().trim():"";labels.push(label||(0,_jquery.default)(this).val())})),display=labels.join(", ")}else if("select"===questionType){const selected=questionItem.find("select").find("option:selected");display=selected.length?selected.text().trim():""}else if("number"===questionType){display=questionItem.find('input[type="number"]').val()}else if("shorttext"===questionType){display=questionItem.find('input[type="text"]').val()}else if("longtext"===questionType){display=questionItem.find("textarea").val()}return display||"-"};_exports.init=()=>{initialized||((0,_str.get_string)("edit","moodle").then((str=>{editLabel=str})).catch((()=>{editLabel="Edit"})),(0,_jquery.default)("select[data-saved-value]").each((function(){const select=(0,_jquery.default)(this),savedValue=select.data("saved-value");savedValue&&select.val(savedValue)})),(0,_jquery.default)(".question-item").each((function(){const questionItem=(0,_jquery.default)(this);(questionItem=>questionItem.find(".saved-response-message").length>0)(questionItem)&&(lockQuestionItem(questionItem),ensureEditButton(questionItem))})),(0,_jquery.default)(document).on("click",".question-edit-btn",(function(e){e.preventDefault();const questionItem=(0,_jquery.default)(this).closest(".question-item");(questionItem=>{questionItem.attr("data-response-locked","0"),questionItem.attr("data-response-editing","1"),questionItem.find("input, select, textarea").prop("disabled",!1)})(questionItem),(questionItem=>{questionItem.find(".question-edit-btn").hide()})(questionItem);const firstInput=questionItem.find("input, select, textarea").first();firstInput.length>0&&firstInput.focus()})),(0,_jquery.default)(document).on("input",'.question-item[data-questiontype="number"] input[type="number"]',(function(){const input=(0,_jquery.default)(this),sanitized=(value=>{if(null==value)return"";let normalized=String(value).replace(",",".");return normalized=normalized.replace(/[^0-9.\-]/g,""),normalized=normalized.replace(/(?!^)-/g,""),normalized=normalized.replace(/(\..*)\./g,"$1"),normalized})(input.val());input.val()!==sanitized&&input.val(sanitized)})),(0,_jquery.default)(document).on("click",".save-all-responses-btn",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),cmid=parseInt(button.data("cmid"),10),pageid=parseInt(button.data("pageid"),10),container=button.closest(".page-questions"),statusDiv=container.length?container.find(".save-all-status"):(0,_jquery.default)(".save-all-status"),questionsToSave=[];(container.length?container.find(".question-item"):(0,_jquery.default)(".question-item")).each((function(){const questionItem=(0,_jquery.default)(this),questionid=parseInt(questionItem.data("questionid"),10),questiontype=questionItem.data("questiontype");if(!questionid||!questiontype)return;const isLocked="1"===String(questionItem.attr("data-response-locked")),isEditing="1"===String(questionItem.attr("data-response-editing"));if(isLocked&&!isEditing)return;let response="";if("singlechoice"===questiontype||"likert"===questiontype){const selected=questionItem.find('input[type="radio"]:checked');selected.length>0&&(response=selected.val())}else if("multiplechoice"===questiontype){const selected=questionItem.find('input[type="checkbox"]:checked'),values=[];selected.each((function(){values.push((0,_jquery.default)(this).val())})),values.length>0&&(response=JSON.stringify(values))}else if("select"===questiontype){const selected=questionItem.find("select").val();selected&&(response=selected)}else if("number"===questiontype||"shorttext"===questiontype){const value=questionItem.find('input[type="number"], input[type="text"]').val();null!=value&&""!==String(value).trim()&&(response=value)}else if("longtext"===questiontype){const value=questionItem.find("textarea").val();null!=value&&""!==String(value).trim()&&(response=value)}""!==response&&null!=response&&questionsToSave.push({questionid:questionid,questiontype:questiontype,response:response,questionItem:questionItem})})),0!==questionsToSave.length?saveAllResponses(cmid,pageid,questionsToSave,button,statusDiv):_notification.default.addNotification({message:"No editable questions to save. Click Edit on a question first.",type:"info"})})),initialized=!0)};const saveAllResponses=(cmid,pageid,questionsToSave,button,statusDiv)=>{const originalText=button.text();button.prop("disabled",!0),statusDiv.show().html('<div class="text-info"><i class="fa fa-spinner fa-spin"></i> Saving responses...</div>');const container=(0,_jquery.default)('.ai-conversation-container[data-pageid="'+pageid+'"], .multi-model-chat-container[data-pageid="'+pageid+'"]').first();let turnId=null;if(container.length>0){const behavior=container.data("behavior");if("turns"===behavior){const viewingTurn=container.attr("data-viewing-turn");if(viewingTurn)turnId=parseInt(viewingTurn,10);else{const messagesContainer=container.find(`#chat-messages-page-${pageid}`);if(messagesContainer.length>0){const messages=messagesContainer.find(".message[data-turn-id]");let maxTurn=0;messages.each((function(){const msgTurnId=parseInt((0,_jquery.default)(this).attr("data-turn-id"),10);msgTurnId>maxTurn&&(maxTurn=msgTurnId)})),turnId=maxTurn>0?maxTurn:1}else turnId=1}}else if("continuous"===behavior){const viewingConversation=container.data("viewing-conversation")||parseInt(container.attr("data-viewing-conversation"),10);viewingConversation&&!isNaN(viewingConversation)&&(turnId=parseInt(viewingConversation,10))}}let savedCount=0,failedCount=0;const total=questionsToSave.length;let promiseChain=Promise.resolve();questionsToSave.forEach(((questionData,index)=>{promiseChain=promiseChain.then((()=>new Promise((resolve=>{const savingHtml=`<div class="text-info"><i class="fa fa-spinner fa-spin"></i> Saving ${index+1} of ${total}...</div>`;statusDiv.html(savingHtml);const params=new URLSearchParams({action:"save_response",cmid:cmid,pageid:pageid,questionid:questionData.questionid,response:questionData.response,sesskey:_config.default.sesskey});null!==turnId&&turnId>0&&params.append("turn_id",turnId),fetch(_config.default.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>response.json())).then((data=>{if(data.success){savedCount++;const datetimeStr=(new Date).toLocaleString();(0,_str.get_string)("saved","mod_harpiasurvey").then((savedText=>{(0,_str.get_string)("on","mod_harpiasurvey").then((onText=>{const questionItem=questionData.questionItem?(0,_jquery.default)(questionData.questionItem):(0,_jquery.default)(`.question-item[data-questionid="${questionData.questionid}"]`),savedMessage=questionItem.find(`.saved-response-message[data-questionid="${questionData.questionid}"]`),icon='<i class="fa fa-check-circle" aria-hidden="true"></i>';if(0===savedMessage.length){const messageHtml=`<div class="mt-2 small text-muted saved-response-message" data-questionid="${questionData.questionid}">${icon} ${savedText} ${onText} ${datetimeStr}</div>`;questionItem.append(messageHtml)}else savedMessage.html(`${icon} ${savedText} ${onText} ${datetimeStr}`);lockQuestionItem(questionItem),ensureEditButton(questionItem),(0,_str.get_string)("answerhistory","mod_harpiasurvey").then((historyText=>{let history=questionItem.find(`.answer-history[data-questionid="${questionData.questionid}"]`);if(0===history.length){const details=(0,_jquery.default)('<details class="answer-history mt-1 d-none"></details>');details.attr("data-questionid",questionData.questionid),details.append(`<summary>${historyText} (1)</summary>`),details.append('<ul class="list-unstyled mt-2 mb-0"></ul>'),questionItem.append(details),history=details}const list=history.find("ul"),responseDisplay=getResponseDisplay(questionItem,questionData.questiontype);list.prepend(`<li class="mb-1"><span class="text-muted">${datetimeStr}</span> â€” ${(0,_jquery.default)("<div>").text(responseDisplay).html()}</li>`);const count=list.find("li").length;history.find("summary").text(`${historyText} (${count})`),count>1&&history.removeClass("d-none")}))}))}))}else failedCount++;resolve()})).catch((()=>{failedCount++,resolve()}))}))))})),promiseChain.then((()=>{if(button.prop("disabled",!1),button.text(originalText),0===failedCount){button.removeClass("btn-primary").addClass("btn-success");const successHtml=`<div class="text-success"><i class="fa fa-check-circle"></i> All ${savedCount} response(s) saved successfully!</div>`;statusDiv.html(successHtml),setTimeout((()=>{button.removeClass("btn-success").addClass("btn-primary"),statusDiv.fadeOut()}),3e3)}else{button.removeClass("btn-primary").addClass("btn-warning");const warningHtml=`<div class="text-warning"><i class="fa fa-exclamation-triangle"></i> ${savedCount} saved, ${failedCount} failed. Please try again.</div>`;statusDiv.html(warningHtml),setTimeout((()=>{button.removeClass("btn-warning").addClass("btn-primary")}),5e3)}}))}}));

//# sourceMappingURL=save_response.min.js.map
define("mod_harpiasurvey/turns",["exports","./common_chat"],(function(_exports,_common_chat){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.renderConversationDetail=_exports.prepareNodeData=_exports.navigateToTurn=_exports.loadConversationTree=_exports.isTurnComplete=_exports.initTurns=_exports.init=_exports.getViewingTurn=_exports.getCurrentTurn=_exports.default=_exports.createNewRoot=_exports.createBranchFromTurn=void 0,Object.defineProperty(_exports,"scrollToBottom",{enumerable:!0,get:function(){return _common_chat.scrollToBottom}}),_exports.updateTurnDisplay=_exports.updateMessageTurnLabels=_exports.setViewingTurn=_exports.setPreviousMessagesVisibility=void 0;let initializedTurns=!1,commonHandlersRegistered=!1,turnHandlersRegistered=!1,treeHandlersRegistered=!1,editLabel="Edit";const resetQuestionItemToNeutral=questionItem=>{questionItem&&0!==questionItem.length&&(questionItem.removeAttr("data-response-locked"),questionItem.removeAttr("data-response-editing"),questionItem.find(".saved-response-message").remove(),questionItem.find(".answer-history").remove(),questionItem.find(".question-edit-controls").remove(),questionItem.find("input, select, textarea").prop("disabled",!1),questionItem.find('input[type="radio"], input[type="checkbox"]').each((function(){(0,_common_chat.$)(this).prop("checked",Boolean(this.defaultChecked))})),questionItem.find("select").each((function(){const select=(0,_common_chat.$)(this),defaultOption=select.find("option").filter((function(){return this.defaultSelected})).first();defaultOption.length>0?select.val(defaultOption.val()):select.prop("selectedIndex",0)})),questionItem.find('input[type="number"], input[type="text"], textarea').each((function(){(0,_common_chat.$)(this).val(this.defaultValue||"")})))},initialize=()=>{if(initializedTurns)return;(0,_common_chat.getString)("edit","moodle").then((str=>{editLabel=str})).catch((()=>{editLabel="Edit"}));const containers=(0,_common_chat.$)('.ai-conversation-container[data-behavior="turns"]');0!==containers.length&&(containers.each((function(){const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10);if(!pageid)return;const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);let maxTurn=0;messagesContainer.find("[data-turn-id]").each((function(){const turnId=parseInt((0,_common_chat.$)(this).data("turn-id"),10);turnId&&turnId>maxTurn&&(maxTurn=turnId)}));const calculatedCurrentTurn=maxTurn>0?maxTurn:1;_common_chat.currentTurns[pageid]||(_common_chat.currentTurns[pageid]=calculatedCurrentTurn);const urlParams=new URLSearchParams(window.location.search),urlTurn=urlParams.get("turn"),urlBranch=urlParams.get("branch");let initialViewingTurn=_common_chat.currentTurns[pageid];if(null!==urlTurn&&""!==urlTurn){const parsedTurn=parseInt(urlTurn,10);!isNaN(parsedTurn)&&parsedTurn>0&&(initialViewingTurn=parsedTurn)}const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);if(sidebar.length>0&&null!==urlBranch&&""!==urlBranch){const parsedBranchRoot=parseInt(urlBranch,10);!isNaN(parsedBranchRoot)&&parsedBranchRoot>0&&(sidebar.data("sidebar-view","detail"),sidebar.data("branch-root",parsedBranchRoot))}setViewingTurn(pageid,initialViewingTurn),updateTurnDisplay(pageid),updateChatLockState(pageid),sidebar.length>0?(sidebar.show(),(0,_common_chat.$)(`.toggle-tree-btn[data-pageid="${pageid}"]`).addClass("active"),loadConversationTree(pageid).then((()=>{filterMessagesByTurn(pageid,initialViewingTurn)})).catch((()=>{filterMessagesByTurn(pageid,initialViewingTurn)}))):filterMessagesByTurn(pageid,initialViewingTurn),updateSubpageVisibility(pageid),setTimeout((()=>{ensureTurnEvaluationQuestionsRendered(pageid,initialViewingTurn).then((()=>{loadTurnEvaluationResponses(pageid,initialViewingTurn)})).catch((error=>{console.error("Error loading turn evaluation questions on init:",error)}))}),100)})),function(){if(commonHandlersRegistered)return;(0,_common_chat.$)(document).on("click",".chat-send-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),cmid=parseInt(button.data("cmid"),10),pageid=parseInt(button.data("pageid"),10),container=button.closest(".ai-conversation-container");if("turns"!==container.data("behavior"))return;if(!cmid||!pageid)return void _common_chat.Notification.addNotification({message:"Missing cmid or pageid",type:"error"});const input=(0,_common_chat.$)(`#chat-input-page-${pageid}`);if(0===input.length)return void _common_chat.Notification.addNotification({message:"Chat input not found",type:"error"});const inputValue=input.val();if(!inputValue)return;const message=inputValue.trim();if(!message)return;const viewingTurn=getViewingTurn(pageid),currentTurn=getCurrentTurn(pageid),viewingTurnNum=parseInt(viewingTurn,10);if(viewingTurnNum<parseInt(currentTurn,10))return void _common_chat.Notification.addNotification({message:"Cannot send messages in a locked turn. Navigate to the current turn first.",type:"error"});const maxTurns=container.data("max-turns");if(null!=maxTurns){const maxTurnsNum=parseInt(maxTurns,10),turnCount=getTurnCountForConversation(pageid,viewingTurnNum);if(null!==turnCount&&turnCount>=maxTurnsNum&&isTurnComplete(pageid,viewingTurnNum))return void(0,_common_chat.getString)("maxturnsreached","mod_harpiasurvey").then((str=>{_common_chat.Notification.addNotification({message:str,type:"error"})}))}const modelsdata=container.data("models");let modelid=null;if(modelsdata){const modelids=modelsdata.split(",");modelids.length>0&&(modelid=parseInt(modelids[0],10))}if(!modelid)return void _common_chat.Notification.addNotification({message:"No model available",type:"error"});input.prop("disabled",!0),button.prop("disabled",!0),input.val("");const tempId="temp-user-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);displayUserMessage(pageid,message,tempId);const loading=(0,_common_chat.$)(`#chat-loading-page-${pageid}`);loading.show(),sendMessage(cmid,pageid,message,modelid,button,input,loading)})),(0,_common_chat.$)(document).on("keydown",".chat-input",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),(0,_common_chat.$)(this).closest(".ai-conversation-container").find(".chat-send-btn").click())})),(0,_common_chat.$)(document).on("click",".toggle-previous-messages-btn",(function(e){e.preventDefault();const btn=(0,_common_chat.$)(this),pageid=parseInt(btn.data("pageid"),10);if(!pageid)return;const container=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);if(0===container.find(".previous-turn-message").length)return;const currentlyVisible=!0===container.data("show-previous");setPreviousMessagesVisibility(pageid,!currentlyVisible)})),commonHandlersRegistered=!0}(),function(){if(treeHandlersRegistered)return;(0,_common_chat.$)(document).on("click",'.tree-node-content[data-action="navigate"]',(function(e){e.preventDefault();const node=(0,_common_chat.$)(this),turnId=parseInt(node.data("turn-id"),10),pageid=node.closest(".conversation-tree-sidebar").attr("id").replace("conversation-tree-sidebar-","");pageid&&turnId&&navigateToTurn(parseInt(pageid,10),turnId)})),(0,_common_chat.$)(document).on("click",".conversation-item",(function(e){e.preventDefault();const item=(0,_common_chat.$)(this),rootTurnId=parseInt(item.data("root-turn-id"),10),sidebar=item.closest(".conversation-tree-sidebar"),pageid=parseInt(sidebar.attr("id").replace("conversation-tree-sidebar-",""),10);pageid&&rootTurnId&&(sidebar.data("sidebar-view","detail"),navigateToTurn(pageid,rootTurnId))})),(0,_common_chat.$)(document).on("click",".back-to-list-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10);if(!pageid)return;const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);sidebar.data("sidebar-view","list"),sidebar.data("branch-root",null),sidebar.data("branch-stack",[]),syncTurnsUrlState(pageid);const tree=_common_chat.conversationTrees[pageid];tree?(0,_common_chat.renderConversationList)(pageid,tree.roots):loadConversationTree(pageid)})),(0,_common_chat.$)(document).on("click",".back-to-parent-branch-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10);if(!pageid)return;const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);let stack=sidebar.data("branch-stack");if(!Array.isArray(stack)||0===stack.length)return sidebar.data("branch-root",null),sidebar.data("branch-stack",[]),void loadConversationTree(pageid);const previousRoot=stack.pop();sidebar.data("branch-stack",stack),sidebar.data("branch-root",previousRoot||null),sidebar.data("sidebar-view","detail"),syncTurnsUrlState(pageid),loadConversationTree(pageid)})),(0,_common_chat.$)(document).on("click",".enter-branch-btn",(function(e){e.preventDefault(),e.stopPropagation();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),turnId=parseInt(button.data("turn-id"),10);if(!pageid||!turnId)return;const tree=_common_chat.conversationTrees[pageid];if(!tree||!tree.roots)return;const targetNode=findNodeByTurnId(tree.roots,turnId);if(!targetNode||!targetNode.children||0===targetNode.children.length)return;const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);let stack=sidebar.data("branch-stack");Array.isArray(stack)||(stack=[]);const currentRoot=sidebar.data("branch-root");currentRoot&&stack.push(currentRoot),sidebar.data("branch-stack",stack),sidebar.data("branch-root",turnId),sidebar.data("sidebar-view","detail"),navigateToTurn(pageid,turnId)})),(0,_common_chat.$)(document).on("click",".create-branch-from-tree-btn",(function(e){e.preventDefault(),e.stopPropagation();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10),turnId=parseInt(button.data("turn-id"),10),branchMode=button.data("branch-mode");if(pageid&&turnId)if(hasUnsavedTurnEvaluation(pageid,turnId))(0,_common_chat.getString)("turnrequiresave","mod_harpiasurvey").then((message=>{_common_chat.Notification.addNotification({message:message,type:"warning"})})).catch((()=>{_common_chat.Notification.addNotification({message:"Please save the evaluation answers before creating a new turn.",type:"warning"})}));else{if("enter"===branchMode){const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);let stack=sidebar.data("branch-stack");Array.isArray(stack)||(stack=[]);const currentRoot=sidebar.data("branch-root");return currentRoot&&stack.push(currentRoot),sidebar.data("branch-stack",stack),sidebar.data("branch-root",turnId),sidebar.data("sidebar-view","detail"),void navigateToTurn(pageid,turnId)}cmid?createBranchFromTurn(cmid,pageid,turnId,button):_common_chat.Notification.addNotification({message:"Missing required data to create turn",type:"error"})}else _common_chat.Notification.addNotification({message:"Missing required data to create turn",type:"error"})})),(0,_common_chat.$)(document).on("click",".create-branch-from-tree-btn .branch-label, .create-branch-from-tree-btn i",(function(e){e.preventDefault(),e.stopPropagation();const btn=(0,_common_chat.$)(this).closest(".create-branch-from-tree-btn");btn.length&&btn.trigger("click")})),(0,_common_chat.$)(document).on("click",".create-direct-branch-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);let parentTurnId=parseInt(button.data("root-turn-id"),10);parentTurnId&&!isNaN(parentTurnId)||(parentTurnId=getViewingTurn(pageid)),pageid&&cmid&&parentTurnId?hasUnsavedTurnEvaluation(pageid,parentTurnId)?(0,_common_chat.getString)("turnrequiresave","mod_harpiasurvey").then((message=>{_common_chat.Notification.addNotification({message:message,type:"warning"})})).catch((()=>{_common_chat.Notification.addNotification({message:"Please save the evaluation answers before creating a new turn.",type:"warning"})})):createBranchFromTurn(cmid,pageid,parentTurnId,button):_common_chat.Notification.addNotification({message:"Missing required data to create branch",type:"error"})})),(0,_common_chat.$)(document).on("click",".create-root-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);pageid&&cmid?createNewRoot(cmid,pageid):_common_chat.Notification.addNotification({message:"Missing required data to create root",type:"error"})})),(0,_common_chat.$)(document).on("click",".export-conversation-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);if(!pageid||!cmid)return void _common_chat.Notification.addNotification({message:"Missing required data to export conversation",type:"error"});const viewingTurn=getViewingTurn(pageid),container=(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`),behavior=container.data("behavior")||"continuous",params=new URLSearchParams;if(params.append("action","export_conversation"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),"turns"===behavior&&viewingTurn)params.append("turn_id",viewingTurn);else if("continuous"===behavior){const conversationId=container.data("viewing-conversation");conversationId&&params.append("conversation_id",conversationId)}window.open(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),"_blank")})),treeHandlersRegistered=!0}(),function(){if(turnHandlersRegistered)return;(0,_common_chat.$)(document).on("click",'.ai-conversation-container[data-behavior="turns"] .turn-evaluation-questions .save-turn-evaluation-questions-btn',(function(e){e.preventDefault(),e.stopPropagation();const button=(0,_common_chat.$)(this),turnId=parseInt(button.data("turn-id"),10),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);if(!turnId||!pageid||!cmid)return void _common_chat.Notification.addNotification({message:"Missing required data to save responses.",type:"error"});const evaluationContainer=button.closest(".turn-evaluation-questions");if(0===evaluationContainer.length)return;const responses=collectTurnEvaluationResponses(evaluationContainer);if(0===Object.keys(responses).length)return void _common_chat.Notification.addNotification({message:"No editable questions to save. Click Edit on a question first.",type:"info"});const originalText=button.text();button.prop("disabled",!0),button.text("Saving..."),saveTurnEvaluationResponses(cmid,pageid,turnId,responses,button,originalText)})),turnHandlersRegistered=!0}(),initializedTurns=!0)},init=()=>initialize();_exports.init=init;const initTurns=()=>initialize();_exports.initTurns=initTurns;const collectTurnEvaluationResponses=evaluationContainer=>{const responses={};return evaluationContainer.find("[data-questionid]").each((function(){const item=(0,_common_chat.$)(this),isLocked="1"===String(item.attr("data-response-locked")),isEditing="1"===String(item.attr("data-response-editing"));if(isLocked&&!isEditing)return;const questionId=item.data("questionid"),questionType=item.data("questiontype");let responseValue=null;if("multiplechoice"===questionType){const checked=item.find(`input[name="question_${questionId}_turn[]"]:checked`),values=[];checked.each((function(){values.push((0,_common_chat.$)(this).val())})),responseValue=values.length>0?JSON.stringify(values):null}else if("select"===questionType){const selected=item.find(`select[name="question_${questionId}_turn"]`);responseValue=selected.length>0?selected.val():null}else if("singlechoice"===questionType||"likert"===questionType){const selected=item.find(`input[name="question_${questionId}_turn"]:checked`);responseValue=selected.length>0?selected.val():null}else if("number"===questionType||"shorttext"===questionType){const input=item.find(`input[name="question_${questionId}_turn"]`);responseValue=input.length>0?input.val():null}else if("longtext"===questionType){const textarea=item.find(`textarea[name="question_${questionId}_turn"]`);responseValue=textarea.length>0?textarea.val():null}null!==responseValue&&""!==responseValue&&(responses[questionId]=responseValue)})),responses},saveTurnEvaluationResponses=(cmid,pageid,turnId,responses,button,originalText)=>{const entries=Object.entries(responses);let failedCount=0,promiseChain=Promise.resolve();entries.forEach((_ref=>{let[questionId,response]=_ref;promiseChain=promiseChain.then((()=>{const params=new URLSearchParams({action:"save_response",cmid:cmid,pageid:pageid,questionid:questionId,response:response,turn_id:turnId,sesskey:_common_chat.Config.sesskey});return fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((res=>res.json())).then((data=>{data.success||failedCount++})).catch((()=>{failedCount++}))}))})),promiseChain.then((()=>{button.prop("disabled",!1),button.text(originalText),0===failedCount?_common_chat.Notification.addNotification({message:"Responses saved.",type:"success"}):_common_chat.Notification.addNotification({message:"Some responses failed to save.",type:"warning"}),loadTurnEvaluationResponses(pageid,turnId)}))},getCurrentTurn=pageid=>_common_chat.currentTurns[pageid]||1;_exports.getCurrentTurn=getCurrentTurn;const getViewingTurn=pageid=>{const container=(0,_common_chat.$)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container");return parseInt(container.data("viewing-turn")||getCurrentTurn(pageid),10)};_exports.getViewingTurn=getViewingTurn;const syncTurnsUrlState=function(pageid){let turnOverride=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const turn=null!==turnOverride?parseInt(turnOverride,10):getViewingTurn(pageid);if(!turn||isNaN(turn))return;const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`),branchRoot=parseInt(sidebar.data("branch-root"),10),viewMode=sidebar.data("sidebar-view"),urlParams=new URLSearchParams(window.location.search);urlParams.set("turn",turn),viewMode&&"list"!==viewMode&&branchRoot&&!isNaN(branchRoot)?urlParams.set("branch",branchRoot):urlParams.delete("branch");const newUrl=window.location.pathname+"?"+urlParams.toString();window.history.replaceState({},"",newUrl)},setViewingTurn=(pageid,turn)=>{const container=(0,_common_chat.$)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container");container.data("viewing-turn",turn),container.attr("data-viewing-turn",turn),syncTurnsUrlState(pageid,turn)};_exports.setViewingTurn=setViewingTurn;const updateTurnDisplay=pageid=>{const viewingTurn=getViewingTurn(pageid),label=(0,_common_chat.$)(`#current-turn-label-${pageid}`);label.length>0&&label.text(viewingTurn)};_exports.updateTurnDisplay=updateTurnDisplay;const turnHasMessages=(pageid,turnId)=>(0,_common_chat.$)(`#chat-messages-page-${pageid}`).find(`.message[data-turn-id="${turnId}"]`).length>0,isTurnComplete=(pageid,turnId)=>{const turnMessages=(0,_common_chat.$)(`#chat-messages-page-${pageid}`).find(`.message[data-turn-id="${turnId}"]`);if(0===turnMessages.length)return!1;const role=turnMessages.last().data("role");return"assistant"===role||"ai"===role};_exports.isTurnComplete=isTurnComplete;const getTurnCountForConversation=(pageid,turnId)=>{const tree=_common_chat.conversationTrees[pageid];if(!tree||!tree.roots||!turnId)return null;const root=(0,_common_chat.findRootForTurn)(tree.roots,turnId);return root?(0,_common_chat.countNodes)(root):null},filterMessagesByTurn=(pageid,turnId)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`),shouldShowPrevious=!0===messagesContainer.data("show-previous"),tree=_common_chat.conversationTrees[pageid],root=tree?(0,_common_chat.findRootForTurn)(tree.roots||[],turnId):null,allowedTurnIds=new Set;if(allowedTurnIds.add(turnId),root){const addPath=(node,targetId,path)=>{if(parseInt(node.turn_id,10)===parseInt(targetId,10))return path.forEach((id=>allowedTurnIds.add(id))),allowedTurnIds.add(parseInt(node.turn_id,10)),!0;if(node.direct_branches)for(const db of node.direct_branches)if(addPath(db,targetId,[...path,parseInt(node.turn_id,10)]))return!0;if(node.children)for(const child of node.children)if(addPath(child,targetId,[...path,parseInt(node.turn_id,10)]))return!0;return!1};addPath(root,turnId,[])}else allowedTurnIds.add(turnId);messagesContainer.find(".message").each((function(){const $msg=(0,_common_chat.$)(this),messageTurnId=parseInt($msg.data("turn-id"),10);if(!messageTurnId||isNaN(messageTurnId))return void $msg.removeClass("previous-turn-message").hide();const isCurrentTurn=messageTurnId===parseInt(turnId,10);allowedTurnIds.has(messageTurnId)?isCurrentTurn?$msg.removeClass("previous-turn-message").show():($msg.addClass("previous-turn-message"),shouldShowPrevious?$msg.show():$msg.hide()):$msg.removeClass("previous-turn-message").hide()})),messagesContainer.find(".turn-separator").each((function(){const $separator=(0,_common_chat.$)(this),separatorTurnId=parseInt($separator.data("turn-separator"),10);if(!separatorTurnId||isNaN(separatorTurnId))return void $separator.hide();allowedTurnIds.has(separatorTurnId)?$separator.show():$separator.hide()}));const toggleBtn=(0,_common_chat.$)(`.toggle-previous-messages-btn[data-pageid="${pageid}"]`);if(toggleBtn.length>0){if(messagesContainer.find(".previous-turn-message").length>0){toggleBtn.show(),toggleBtn.prop("disabled",!1);const isVisible=messagesContainer.find(".previous-turn-message").first().is(":visible");updatePreviousToggleLabel(toggleBtn,isVisible)}else toggleBtn.hide()}setTimeout((()=>{(0,_common_chat.scrollToBottom)(pageid)}),50)},updateChatLockState=pageid=>{const viewingTurn=getViewingTurn(pageid),currentTurn=getCurrentTurn(pageid),viewingTurnNum=parseInt(viewingTurn,10),currentTurnNum=parseInt(currentTurn,10),input=(0,_common_chat.$)(`#chat-input-page-${pageid}`),sendBtn=(0,_common_chat.$)(`.chat-send-btn[data-pageid="${pageid}"]`),lockMessage=(0,_common_chat.$)(`#turn-locked-message-${pageid}`),maxTurns=input.closest(".ai-conversation-container").data("max-turns"),maxTurnsNum=null!=maxTurns?parseInt(maxTurns,10):null,conversationTurnCount=getTurnCountForConversation(pageid,viewingTurnNum),hasReachedTurnLimit=null!==maxTurnsNum&&null!==conversationTurnCount&&conversationTurnCount>=maxTurnsNum;if(viewingTurnNum<currentTurnNum){input.prop("disabled",!0),sendBtn.prop("disabled",!0),lockMessage.length>0&&lockMessage.show();const directBranchContainer=(0,_common_chat.$)(`#direct-branch-container-${pageid}`);directBranchContainer.length>0&&directBranchContainer.hide()}else if(viewingTurnNum===currentTurnNum&&isTurnComplete(pageid,viewingTurnNum))if(hasReachedTurnLimit&&turnHasMessages(pageid,viewingTurnNum)){input.prop("disabled",!0),sendBtn.prop("disabled",!0),input.val(""),lockMessage.length>0&&(0,_common_chat.getString)("maxturnsreached","mod_harpiasurvey").then((str=>{lockMessage.text(str).show()}));const directBranchContainer=(0,_common_chat.$)(`#direct-branch-container-${pageid}`);directBranchContainer.length>0&&directBranchContainer.hide()}else{input.prop("disabled",!0),sendBtn.prop("disabled",!0),input.val(""),lockMessage.length>0&&lockMessage.hide();const directBranchContainer=(0,_common_chat.$)(`#direct-branch-container-${pageid}`);directBranchContainer.length>0&&directBranchContainer.show()}else if(viewingTurnNum!==currentTurnNum||isTurnComplete(pageid,viewingTurnNum)){input.prop("disabled",!1),sendBtn.prop("disabled",!1);const directBranchContainer=(0,_common_chat.$)(`#direct-branch-container-${pageid}`);directBranchContainer.length>0&&directBranchContainer.hide(),lockMessage.length>0&&lockMessage.hide()}else{if(hasReachedTurnLimit&&turnHasMessages(pageid,viewingTurnNum)){input.prop("disabled",!0),sendBtn.prop("disabled",!0),input.val(""),lockMessage.length>0&&(0,_common_chat.getString)("maxturnsreached","mod_harpiasurvey").then((str=>{lockMessage.text(str).show()}));const directBranchContainer=(0,_common_chat.$)(`#direct-branch-container-${pageid}`);return void(directBranchContainer.length>0&&directBranchContainer.hide())}(0,_common_chat.$)(`#chat-loading-page-${pageid}`).is(":visible")?(input.prop("disabled",!0),sendBtn.prop("disabled",!0)):(input.prop("disabled",!1),sendBtn.prop("disabled",!1));const directBranchContainer=(0,_common_chat.$)(`#direct-branch-container-${pageid}`);directBranchContainer.length>0&&directBranchContainer.hide(),lockMessage.length>0&&lockMessage.hide()}},sendMessage=(cmid,pageid,message,modelid,button,input,loading)=>{const viewingTurn=getViewingTurn(pageid),params=new URLSearchParams({action:"send_ai_message",cmid:cmid,pageid:pageid,message:message,modelid:modelid,sesskey:_common_chat.Config.sesskey});viewingTurn&&params.append("turn_id",viewingTurn),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{loading.hide(),data.success?data.messageid&&data.content?displayAIMessage(pageid,data.content,data.messageid,data.turn_id).then((()=>{if(data.turn_id){const currentTurn=getCurrentTurn(pageid);(data.turn_id>currentTurn||data.turn_id===currentTurn+1)&&(_common_chat.currentTurns[pageid]=data.turn_id,updateTurnDisplay(pageid),setViewingTurn(pageid,data.turn_id))}setTimeout((()=>{updateChatLockState(pageid)}),100)})).catch((()=>{setTimeout((()=>{updateChatLockState(pageid)}),100)})):(_common_chat.Notification.addNotification({message:"Received response but missing message ID or content",type:"error"}),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()):(_common_chat.Notification.addNotification({message:data.message||"Error sending message",type:"error"}),input.prop("disabled",!1),button.prop("disabled",!1),input.focus())})).catch((error=>{loading.hide(),console.error("Error sending message:",error),_common_chat.Notification.addNotification({message:"Error sending message: "+error.message,type:"error"}),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()}))},displayUserMessage=(pageid,message,messageid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);0!==messagesContainer.length&&(messagesContainer.find(".text-center.text-muted").remove(),_common_chat.Templates.render("mod_harpiasurvey/chat_user_message",{id:messageid,content:message,timecreated:Math.floor(Date.now()/1e3)}).then((html=>{messagesContainer.append(html),(0,_common_chat.scrollToBottom)(pageid)})).catch(_common_chat.Notification.exception))},displayAIMessage=(pageid,content,messageid,turnId)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);return 0===messagesContainer.length?Promise.resolve():_common_chat.Templates.render("mod_harpiasurvey/chat_ai_message",{id:messageid,content:content,timecreated:Math.floor(Date.now()/1e3),turn_id:turnId}).then((html=>(messagesContainer.append(html),(0,_common_chat.scrollToBottom)(pageid),html))).catch(_common_chat.Notification.exception)},ensureTurnEvaluationQuestionsRendered=(pageid,turnId)=>{const containerWrapper=(0,_common_chat.$)(`#turn-evaluation-questions-container-${pageid}`);if(0===containerWrapper.length)return Promise.resolve();const existingContainer=containerWrapper.find(`.turn-evaluation-questions[data-turn-id="${turnId}"]`);return existingContainer.length>0&&existingContainer.find(".question-item").length>0?Promise.resolve():(0,_common_chat.getString)("loading","moodle").then((loadingStr=>{containerWrapper.html('<div class="text-center py-3 text-muted"><i class="fa fa-spinner fa-spin"></i> '+loadingStr+"</div>");const params=new URLSearchParams({action:"get_turn_questions",pageid:pageid,turn_id:turnId,cmid:(0,_common_chat.$)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container").data("cmid"),sesskey:_common_chat.Config.sesskey});return fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{data.success&&data.html?containerWrapper.html(data.html):containerWrapper.html('<div class="text-center text-muted py-3">'+(data.message||"No questions available for this turn.")+"</div>")})).catch((error=>{console.error("Error loading turn evaluation questions:",error),containerWrapper.html('<div class="text-danger text-center py-3">Error loading questions: '+error.message+"</div>")}))}))},loadTurnEvaluationResponses=(pageid,turnId)=>{const cmid=(0,_common_chat.getCmid)(pageid);if(!cmid)return;const containerWrapper=(0,_common_chat.$)(`#turn-evaluation-questions-container-${pageid}`);if(0===containerWrapper.length)return;let container=containerWrapper.find(`.turn-evaluation-questions[data-turn-id="${turnId}"]`);0===container.length&&(container=containerWrapper),container.find(".question-item").each((function(){resetQuestionItemToNeutral((0,_common_chat.$)(this))}));const params=new URLSearchParams({action:"get_turn_responses",cmid:cmid,pageid:pageid,turn_id:turnId,sesskey:_common_chat.Config.sesskey});fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{data.success&&data.responses&&0!==Object.keys(data.responses).length&&Object.keys(data.responses).forEach((questionId=>{const responseData=data.responses[questionId],questionItem=container.find(`.question-item[data-questionid="${questionId}"]`);if(0===questionItem.length)return;const questionType=questionItem.data("questiontype"),value=responseData.response;if("singlechoice"===questionType||"likert"===questionType)questionItem.find('input[type="radio"]').prop("checked",!1),questionItem.find(`input[type="radio"][value="${value}"]`).prop("checked",!0);else if("multiplechoice"===questionType){questionItem.find('input[type="checkbox"]').prop("checked",!1);try{const values=JSON.parse(value);Array.isArray(values)&&values.forEach((val=>{questionItem.find(`input[type="checkbox"][value="${val}"]`).prop("checked",!0)}))}catch(e){}}else"select"===questionType?questionItem.find("select").val(value):"number"===questionType?questionItem.find('input[type="number"]').val(value):"shorttext"===questionType?questionItem.find('input[type="text"]').val(value):"longtext"===questionType&&questionItem.find("textarea").val(value);responseData.saved_datetime&&(0,_common_chat.getString)("saved","mod_harpiasurvey").then((savedText=>{(0,_common_chat.getString)("on","mod_harpiasurvey").then((onText=>{const icon='<i class="fa fa-check-circle" aria-hidden="true"></i>';let savedMessage=questionItem.find(".saved-response-message");if(0===savedMessage.length){const messageHtml=`<div class="mt-2 small text-muted saved-response-message">${icon} ${savedText} ${onText} ${responseData.saved_datetime}</div>`;questionItem.append(messageHtml)}else savedMessage.html(`${icon} ${savedText} ${onText} ${responseData.saved_datetime}`)}))})),(questionItem=>{questionItem.attr("data-response-locked","1"),questionItem.removeAttr("data-response-editing"),questionItem.find("input, select, textarea").prop("disabled",!0)})(questionItem),(questionItem=>{let controls=questionItem.find(".question-edit-controls");0===controls.length&&(controls=(0,_common_chat.$)('<div class="mt-2 question-edit-controls"></div>'),questionItem.append(controls));let button=controls.find(".question-edit-btn");0===button.length&&(button=(0,_common_chat.$)('<button type="button" class="btn btn-sm btn-outline-secondary question-edit-btn"></button>'),controls.append(button)),button.text(editLabel),button.show()})(questionItem),(0,_common_chat.getString)("answerhistory","mod_harpiasurvey").then((historyText=>{let history=questionItem.find(".answer-history");if(!history.length&&responseData.history_count>1){const details=(0,_common_chat.$)('<details class="answer-history mt-1"></details>');details.append(`<summary>${historyText} (${responseData.history_count})</summary>`),details.append('<ul class="list-unstyled mt-2 mb-0"></ul>'),questionItem.append(details),history=details}if(history.length){const list=history.find("ul");list.empty(),(responseData.history_items||[]).forEach((item=>{list.append(`<li class="mb-1"><span class="text-muted">${item.time}</span> â€” ${item.response}</li>`)})),history.find("summary").text(`${historyText} (${responseData.history_count||0})`),(responseData.history_count||0)>1?history.show():history.hide()}}))}))})).catch((error=>{console.error("Error loading turn responses:",error)}))},clearTurnEvaluationForm=(pageid,turnId)=>{const containerWrapper=(0,_common_chat.$)(`#turn-evaluation-questions-container-${pageid}`);if(0===containerWrapper.length)return;let container=containerWrapper.find(`.turn-evaluation-questions[data-turn-id="${turnId}"]`);0===container.length&&(container=containerWrapper),container.find(".question-item").each((function(){resetQuestionItemToNeutral((0,_common_chat.$)(this))}))},hasUnsavedTurnEvaluation=(pageid,turnId)=>{const containerWrapper=(0,_common_chat.$)(`#turn-evaluation-questions-container-${pageid}`);if(0===containerWrapper.length)return!1;const container=containerWrapper.find(`.turn-evaluation-questions[data-turn-id="${turnId}"]`);if(0===container.length)return!1;const requiredQuestions=container.find('.question-item[data-required="1"]');if(0===requiredQuestions.length)return!1;return requiredQuestions.filter((function(){return(0,_common_chat.$)(this).find(".saved-response-message").length>0})).length!==requiredQuestions.length},navigateToTurn=function(pageid,turnId){let setAsCurrent=arguments.length>2&&void 0!==arguments[2]&&arguments[2];setAsCurrent&&(_common_chat.currentTurns[pageid]=turnId),setViewingTurn(pageid,turnId),updateTurnDisplay(pageid),updateChatLockState(pageid);const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);messagesContainer.find(".turn-separator").each((function(){const separatorTurnId=(0,_common_chat.$)(this).data("turn-separator");if(separatorTurnId&&parseInt(separatorTurnId,10)<turnId){(0,_common_chat.$)(this).data("collapsed",!0);const toggleIcon=(0,_common_chat.$)(this).find(".toggle-turn-btn").find(".toggle-turn-icon");toggleIcon.length>0&&toggleIcon.removeClass("fa-chevron-up").addClass("fa-chevron-down")}})),filterMessagesByTurn(pageid,turnId),updateSubpageVisibility(pageid),ensureTurnEvaluationQuestionsRendered(pageid,turnId).then((()=>{clearTurnEvaluationForm(pageid,turnId),loadTurnEvaluationResponses(pageid,turnId)}));const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);sidebar.length&&(sidebar.data("sidebar-view","detail"),loadConversationTree(pageid))};_exports.navigateToTurn=navigateToTurn;const updateSubpageVisibility=pageid=>{const viewingTurn=getViewingTurn(pageid),subpagesContainer=(0,_common_chat.$)(`#subpages-container-${pageid}`);0!==subpagesContainer.length&&subpagesContainer.find(".subpage-item").each((function(){const $subpage=(0,_common_chat.$)(this),visibilityType=$subpage.data("visibility-type"),turnNumber=$subpage.data("turn-number");let shouldShow=!1;switch(visibilityType){case"all_turns":shouldShow=!0;break;case"first_turn":shouldShow=1===viewingTurn;break;case"specific_turn":shouldShow=viewingTurn===turnNumber;break;default:shouldShow=!1}shouldShow?($subpage.slideDown(200),updateSubpageQuestionVisibility($subpage,viewingTurn)):$subpage.slideUp(200)}))},updateSubpageQuestionVisibility=($subpage,viewingTurn)=>{$subpage.find(".question-item").each((function(){const $question=(0,_common_chat.$)(this),visibilityType=$question.data("visibility-type")||"all_turns",turnNumber=$question.data("turn-number");let shouldShow=!1;switch(visibilityType){case"all_turns":default:shouldShow=!0;break;case"first_turn":shouldShow=1===viewingTurn;break;case"specific_turn":shouldShow=viewingTurn===turnNumber}shouldShow?$question.slideDown(200):$question.slideUp(200)}))},loadConversationTree=pageid=>{const treeContainer=(0,_common_chat.$)(`#conversation-tree-${pageid}`),sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);if(0===treeContainer.length)return console.warn("Tree container not found for pageid:",pageid),Promise.resolve(null);const cmid=(0,_common_chat.getCmid)(pageid);if(!cmid)return console.error("cmid not found for pageid:",pageid),treeContainer.html('<div class="text-danger text-center small py-3">Error: Course module ID not found. Please refresh the page.</div>'),Promise.resolve(null);const params=new URLSearchParams;return params.append("action","get_conversation_tree"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(console.log("Conversation tree response:",data),data.success&&data.tree){data.tree.roots=(data.tree.roots||[]).map(((root,idx)=>({...root,conversation_number:idx+1}))),_common_chat.conversationTrees[pageid]=data.tree;const viewingTurn=getViewingTurn(pageid),viewMode=sidebar.data("sidebar-view"),branchRootId=sidebar.data("branch-root");if(viewMode&&"list"!==viewMode){const root=branchRootId?findNodeByTurnId(data.tree.roots||[],branchRootId):(0,_common_chat.findRootForTurn)(data.tree.roots||[],viewingTurn);root?renderConversationDetail(pageid,root):(0,_common_chat.renderConversationList)(pageid,data.tree.roots)}else(0,_common_chat.renderConversationList)(pageid,data.tree.roots);syncTurnsUrlState(pageid,viewingTurn),filterMessagesByTurn(pageid,viewingTurn);const rootBtn=sidebar.find(".create-root-btn");if(rootBtn.length){const viewMode=sidebar.data("sidebar-view");viewMode&&"list"!==viewMode?rootBtn.hide():rootBtn.show()}return data.tree}return treeContainer.html('<div class="text-muted text-center small py-3">'+(data.message||"No conversation tree available yet.")+"</div>"),null})).catch((error=>(console.error("Error loading conversation tree:",error),treeContainer.html('<div class="text-danger text-center small py-3">Error loading conversation tree: '+error.message+"<br>Please check the browser console for details and refresh the page.</div>"),null)))};_exports.loadConversationTree=loadConversationTree;const getTurnNumberForId=(pageid,turnId)=>{const tree=_common_chat.conversationTrees[pageid];if(!tree||!tree.roots)return null;const root=(0,_common_chat.findRootForTurn)(tree.roots,turnId);if(!root)return null;const findAndNumber=(node,targetId,parentNumber,turnIndex)=>{const nodeNumber=(0,_common_chat.calculateTurnNumber)(node,turnIndex,parentNumber);if(parseInt(node.turn_id,10)===parseInt(targetId,10))return nodeNumber;if(node.direct_branches&&node.direct_branches.length>0){const sortedDB=[...node.direct_branches].sort(((a,b)=>parseInt(a.turn_id,10)-parseInt(b.turn_id,10)));let dbCounter=turnIndex+1;for(const db of sortedDB){const dbNumber=(0,_common_chat.calculateTurnNumber)(db,dbCounter,null);if(parseInt(db.turn_id,10)===parseInt(targetId,10))return dbNumber;if(db.children&&db.children.length>0){const sortedChildren=[...db.children].sort(((a,b)=>parseInt(a.turn_id,10)-parseInt(b.turn_id,10)));for(let i=0;i<sortedChildren.length;i++){const found=findAndNumber(sortedChildren[i],targetId,dbNumber,i);if(found)return found}}dbCounter++}}if(node.children&&node.children.length>0){const sortedChildren=[...node.children].sort(((a,b)=>parseInt(a.turn_id,10)-parseInt(b.turn_id,10)));for(let i=0;i<sortedChildren.length;i++){const found=findAndNumber(sortedChildren[i],targetId,nodeNumber,i);if(found)return found}}return null};return findAndNumber(root,turnId,null,0)},prepareNodeData=function(node,level,currentTurnId,pageid,cmid){let turnIndex=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,parentNumber=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,includeChildren=!(arguments.length>7&&void 0!==arguments[7])||arguments[7],forcedTurnNumber=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null;const isCurrent=parseInt(node.turn_id,10)===parseInt(currentTurnId,10),hasChildren=node.children&&node.children.length>0,isDirectBranch=node.is_direct_branch||!1,isRoot=node.is_root||!1,turnNumber=null!==forcedTurnNumber?String(forcedTurnNumber):(0,_common_chat.calculateTurnNumber)(node,turnIndex,parentNumber);return{turn_id:node.turn_id,conversation_id:node.conversation_id||node.turn_id,turn_number:turnNumber,is_root:isRoot,is_direct_branch:isDirectBranch,is_current:isCurrent,has_children:hasChildren,branch_label:node.branch_label||null,level:level,expanded:!0,pageid:pageid,cmid:cmid,can_create_branch:!0,children:includeChildren&&hasChildren?node.children.map(((child,index)=>prepareNodeData(child,isDirectBranch?level:level+1,currentTurnId,pageid,cmid,index,turnNumber,includeChildren))):[]}};_exports.prepareNodeData=prepareNodeData;const renderConversationDetail=(pageid,root)=>{const treeContainer=(0,_common_chat.$)(`#conversation-tree-${pageid}`),cmid=(0,_common_chat.$)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container").data("cmid"),sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`),viewingTurn=getViewingTurn(pageid),branchStack=sidebar.data("branch-stack"),showBranchBack=Array.isArray(branchStack)&&branchStack.length>0,isBranchRoot=!root.is_root;sidebar.data("branch-root",root.turn_id);let turnCounter=0;const rootTurnNumber=getTurnNumberForId(pageid,root.turn_id)||"1",rootNodeData=prepareNodeData(root,0,viewingTurn,pageid,cmid,turnCounter,null,!1,rootTurnNumber);turnCounter++;const directBranches=[],childBranches=root.is_root?root.direct_branches||[]:root.children||[];if(childBranches.length>0){[...childBranches].sort(((a,b)=>parseInt(a.turn_id,10)-parseInt(b.turn_id,10))).forEach((node=>{const childTurnNumber=getTurnNumberForId(pageid,node.turn_id)||(0,_common_chat.calculateTurnNumber)(node,turnCounter,null);directBranches.push(prepareNodeData(node,0,viewingTurn,pageid,cmid,turnCounter,null,!1,childTurnNumber)),turnCounter++}))}_common_chat.Templates.render("mod_harpiasurvey/conversation_detail",{root_node:rootNodeData,root_turn_id:root.turn_id,direct_branches:directBranches,pageid:pageid,cmid:cmid,conversation_number:root.conversation_number||1,show_branch_back:showBranchBack,branch_root_turn:isBranchRoot?root.turn_id:null}).then((html=>{treeContainer.html(html),treeContainer.find('[data-toggle="popover"]').popover({trigger:"hover",placement:"top",container:"body"})})).catch((error=>{console.error("Error rendering conversation detail:",error)}))};_exports.renderConversationDetail=renderConversationDetail;const findNodeByTurnId=(roots,turnId)=>{if(!roots||!turnId)return null;const target=parseInt(turnId,10),queue=[...roots];for(;queue.length;){const node=queue.shift();if(node){if(parseInt(node.turn_id,10)===target)return node;node.direct_branches&&node.direct_branches.length&&queue.push(...node.direct_branches),node.children&&node.children.length&&queue.push(...node.children)}}return null};_exports.updateMessageTurnLabels=pageid=>{(0,_common_chat.$)(`#chat-messages-page-${pageid}`).find(".message").each((function(){const $msg=(0,_common_chat.$)(this),turnId=parseInt($msg.data("turn-id"),10);if(turnId){const turnLabel="Turno "+(getTurnNumberForId(pageid,turnId)||turnId),$badge=$msg.find(".badge").filter((function(){return(0,_common_chat.$)(this).closest(".position-absolute").length>0}));if($badge.length>0)$badge.text(turnLabel);else{const $firstBadge=$msg.find(".badge").first();$firstBadge.length>0&&$firstBadge.text(turnLabel)}}}))};const createBranchFromTurn=function(cmid,pageid,parentTurnId){let buttonEl=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const btn=buttonEl?(0,_common_chat.$)(buttonEl):null;let originalHtml=null;btn&&btn.length&&(originalHtml=btn.html(),btn.prop("disabled",!0).addClass("branch-btn-loading"),btn.html('<i class="fa fa-spinner fa-spin fa-xs" aria-hidden="true"></i>'));const params=new URLSearchParams;params.append("action","create_branch"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("parent_turn_id",parentTurnId),params.append("sesskey",_common_chat.Config.sesskey),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(btn&&btn.length&&(btn.prop("disabled",!1).removeClass("branch-btn-loading"),null!==originalHtml&&btn.html(originalHtml)),data.success){const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);if(sidebar.length){let stack=sidebar.data("branch-stack");Array.isArray(stack)||(stack=[]);const currentRoot=sidebar.data("branch-root");currentRoot&&stack.push(currentRoot),sidebar.data("branch-stack",stack),sidebar.data("branch-root",parentTurnId),sidebar.data("sidebar-view","detail")}navigateToTurn(pageid,data.new_turn_id,!0),addLocalBranchNode(pageid,parentTurnId,data.new_turn_id),loadConversationTree(pageid),(0,_common_chat.getString)("branchcreated","mod_harpiasurvey").then((msg=>{_common_chat.Notification.addNotification({message:msg,type:"success"})})).catch((()=>{_common_chat.Notification.addNotification({message:"Branch created successfully",type:"success"})}))}else _common_chat.Notification.addNotification({message:data.message||"Failed to create turn",type:"error"})})).catch((error=>{btn&&btn.length&&(btn.prop("disabled",!1).removeClass("branch-btn-loading"),null!==originalHtml&&btn.html(originalHtml)),console.error("Error creating turn:",error),_common_chat.Notification.addNotification({message:"Error creating turn: "+error.message,type:"error"})}))};_exports.createBranchFromTurn=createBranchFromTurn;const addLocalBranchNode=(pageid,parentTurnId,newTurnId)=>{const tree=_common_chat.conversationTrees[pageid];if(!tree||!tree.roots)return;const root=(0,_common_chat.findRootForTurn)(tree.roots,parentTurnId);if(!root)return;const newNode={turn_id:newTurnId,is_root:!1,is_direct_branch:!1,parent_turn_id:parentTurnId,branch_label:String(newTurnId),children:[],timecreated:Math.floor(Date.now()/1e3),timecreated_str:(new Date).toLocaleString()},attach=node=>{if(parseInt(node.turn_id,10)===parseInt(parentTurnId,10))return node.is_root||node.is_direct_branch?(newNode.is_direct_branch=!0,node.direct_branches||(node.direct_branches=[]),node.direct_branches.push(newNode)):(node.children||(node.children=[]),node.children.push(newNode)),!0;if(node.direct_branches)for(const db of node.direct_branches)if(attach(db))return!0;if(node.children)for(const child of node.children)if(attach(child))return!0;return!1};attach(root)},createNewRoot=(cmid,pageid)=>{(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`);const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`),params=new URLSearchParams;params.append("action","create_root"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(data.success){_common_chat.currentTurns[pageid]=data.new_turn_id,setViewingTurn(pageid,data.new_turn_id),updateTurnDisplay(pageid),updateChatLockState(pageid),messagesContainer.html('<div class="text-muted text-center small py-3">New conversation started. Send a message to begin.</div>'),(0,_common_chat.$)(`#turn-evaluation-questions-container-${pageid}`).empty();(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`).data("sidebar-view","detail"),setTimeout((()=>{loadConversationTree(pageid)}),100),_common_chat.Notification.addNotification({message:data.message||"New conversation created successfully",type:"success"})}else _common_chat.Notification.addNotification({message:data.message||"Failed to create new root",type:"error"})})).catch((error=>{console.error("Error creating new root:",error),_common_chat.Notification.addNotification({message:"Error creating new root: "+error.message,type:"error"})}))};_exports.createNewRoot=createNewRoot;const setPreviousMessagesVisibility=(pageid,visible)=>{const container=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);container.data("show-previous",!0===visible);const prevMessages=container.find(".previous-turn-message");visible?prevMessages.show():prevMessages.hide();const toggleBtn=(0,_common_chat.$)(`.toggle-previous-messages-btn[data-pageid="${pageid}"]`);toggleBtn.length&&updatePreviousToggleLabel(toggleBtn,visible)};_exports.setPreviousMessagesVisibility=setPreviousMessagesVisibility;const updatePreviousToggleLabel=(btn,isVisible)=>{isVisible?(btn.html('<i class="fa fa-history" aria-hidden="true"></i> Ocultar anteriores'),btn.attr("title","Ocultar conversas anteriores")):(btn.html('<i class="fa fa-history" aria-hidden="true"></i> Mostrar anteriores'),btn.attr("title","Mostrar conversas anteriores"))};var _default={init:init,initTurns:initTurns};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=turns.min.js.map
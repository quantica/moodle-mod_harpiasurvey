define("mod_harpiasurvey/multi_model_qa",["exports","./common_chat"],(function(_exports,_common_chat){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;let initialized=!1,handlersRegistered=!1;const qaEvaluationSaved={};let editLabel="Edit";const resetQuestionItemToNeutral=questionItem=>{questionItem&&0!==questionItem.length&&(questionItem.removeAttr("data-response-locked"),questionItem.removeAttr("data-response-editing"),questionItem.find(".saved-response-message").remove(),questionItem.find(".answer-history").remove(),questionItem.find(".question-edit-controls").remove(),questionItem.find("input, select, textarea").prop("disabled",!1),questionItem.find('input[type="radio"], input[type="checkbox"]').each((function(){(0,_common_chat.$)(this).prop("checked",Boolean(this.defaultChecked))})),questionItem.find("select").each((function(){const select=(0,_common_chat.$)(this),defaultOption=select.find("option").filter((function(){return this.defaultSelected})).first();defaultOption.length>0?select.val(defaultOption.val()):select.prop("selectedIndex",0)})),questionItem.find('input[type="number"], input[type="text"], textarea').each((function(){(0,_common_chat.$)(this).val(this.defaultValue||"")})))};_exports.init=()=>initialize();const stateKey=(pageid,modelid)=>`${pageid}_${modelid}`,initialize=()=>{if(initialized)return;(0,_common_chat.getString)("edit","moodle").then((str=>{editLabel=str})).catch((()=>{editLabel="Edit"}));const containers=(0,_common_chat.$)('.multi-model-chat-container[data-behavior="qa"]');0!==containers.length&&(containers.each((function(){const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10);pageid&&(0,_common_chat.$)(this).find(".tab-pane[data-model-id]").each((function(){const pane=(0,_common_chat.$)(this),modelid=parseInt(pane.data("model-id"),10);if(!modelid)return;(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`).find('.message[data-role="assistant"]').length>0&&lockQaInput(pageid,modelid);const activeId=parseInt(pane.data("qa-active-id"),10);activeId&&selectQaQuestion(pageid,modelid,activeId)}))})),function(){if(handlersRegistered)return;(0,_common_chat.$)(document).on("click",'.multi-model-chat-container[data-behavior="qa"] .chat-send-btn',(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),cmid=parseInt(button.data("cmid"),10),pageid=parseInt(button.data("pageid"),10),modelid=parseInt(button.data("model-id")||button.data("modelId"),10);if(!cmid||!pageid||!modelid)return void(0,_common_chat.addError)("Missing cmid, pageid or modelid");if(hasUnsavedQaEvaluation(pageid,modelid))return void(0,_common_chat.getString)("qarequiresave","mod_harpiasurvey").then((message=>{_common_chat.Notification.addNotification({message:message,type:"warning"})})).catch((()=>{_common_chat.Notification.addNotification({message:"Please save the evaluation answers before starting a new question.",type:"warning"})}));const input=(0,_common_chat.$)(`#chat-input-model-${modelid}-${pageid}`);if(0===input.length)return void(0,_common_chat.addError)("Chat input not found");const inputValue=input.val();if(!inputValue)return;const message=inputValue.trim();if(!message)return;input.prop("disabled",!0),button.prop("disabled",!0),input.val("");const tempId="temp-user-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);displayUserMessage(pageid,modelid,message,tempId),addQaQuestionItem(pageid,modelid,tempId,message),selectQaQuestion(pageid,modelid,tempId);const loading=(0,_common_chat.$)(`#chat-loading-model-${modelid}-${pageid}`);loading.show(),sendMessage(cmid,pageid,modelid,message,button,input,loading)})),(0,_common_chat.$)(document).on("keydown",'.multi-model-chat-container[data-behavior="qa"] .chat-input',(function(e){if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const input=(0,_common_chat.$)(this),pageid=parseInt(input.data("pageid"),10),modelid=parseInt(input.data("model-id")||input.data("modelId"),10);(0,_common_chat.$)(`#send-message-btn-model-${modelid}-${pageid}`).click()}})),(0,_common_chat.$)(document).on("click",'.multi-model-chat-container[data-behavior="qa"] .new-question-btn',(function(e){e.preventDefault();const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10),modelid=parseInt((0,_common_chat.$)(this).data("model-id")||(0,_common_chat.$)(this).data("modelId"),10);pageid&&modelid&&(hasUnsavedQaEvaluation(pageid,modelid)?(0,_common_chat.getString)("qarequiresave","mod_harpiasurvey").then((message=>{_common_chat.Notification.addNotification({message:message,type:"warning"})})).catch((()=>{_common_chat.Notification.addNotification({message:"Please save the evaluation answers before starting a new question.",type:"warning"})})):resetQaView(pageid,modelid))})),(0,_common_chat.$)(document).on("click",'.multi-model-chat-container[data-behavior="qa"] .qa-question-item',(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),modelid=parseInt(button.data("model-id")||button.data("modelId"),10),questionId=button.data("question-id");pageid&&modelid&&questionId&&selectQaQuestion(pageid,modelid,questionId)})),(0,_common_chat.$)(document).on("click",'.multi-model-chat-container[data-behavior="qa"] .qa-evaluation-questions-container .save-turn-evaluation-questions-btn',(function(e){e.preventDefault(),e.stopPropagation();const button=(0,_common_chat.$)(this),turnId=parseInt(button.data("turn-id"),10),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10),modelid=parseInt(button.closest(".tab-pane[data-model-id]").data("model-id"),10);if(!(turnId&&pageid&&cmid&&modelid))return void _common_chat.Notification.addNotification({message:"Missing required data to save responses.",type:"error"});const evaluationContainer=button.closest(".turn-evaluation-questions");if(0===evaluationContainer.length)return;const responses={};if(evaluationContainer.find("[data-questionid]").each((function(){const item=(0,_common_chat.$)(this),isLocked="1"===String(item.attr("data-response-locked")),isEditing="1"===String(item.attr("data-response-editing"));if(isLocked&&!isEditing)return;const questionId=(0,_common_chat.$)(this).data("questionid"),questionType=(0,_common_chat.$)(this).data("questiontype");let responseValue=null;if("multiplechoice"===questionType){const checked=evaluationContainer.find(`input[name="question_${questionId}_turn[]"]:checked`),values=[];checked.each((function(){values.push((0,_common_chat.$)(this).val())})),responseValue=values.length>0?JSON.stringify(values):null}else if("select"===questionType||"singlechoice"===questionType||"likert"===questionType){const selectSelector=`select[name="question_${questionId}_turn"]`,inputSelector=`input[name="question_${questionId}_turn"]:checked`,selected=evaluationContainer.find(`${selectSelector}, ${inputSelector}`);responseValue=selected.length>0?selected.val():null}else if("number"===questionType||"shorttext"===questionType){const input=evaluationContainer.find(`input[name="question_${questionId}_turn"]`);responseValue=input.length>0?input.val():null}else if("longtext"===questionType){const textarea=evaluationContainer.find(`textarea[name="question_${questionId}_turn"]`);responseValue=textarea.length>0?textarea.val():null}null!==responseValue&&""!==responseValue&&(responses[questionId]=responseValue)})),0===Object.keys(responses).length)return void _common_chat.Notification.addNotification({message:"No responses to save.",type:"info"});const originalText=button.text();button.prop("disabled",!0),button.text("Saving..."),saveQaEvaluationResponses(cmid,pageid,modelid,turnId,responses,button,originalText)})),handlersRegistered=!0}(),initialized=!0)};const resetQaView=(pageid,modelid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);if(0===messagesContainer.length)return;messagesContainer.find(".message").hide();const placeholder=messagesContainer.find(".qa-placeholder");placeholder.length>0?placeholder.show():(0,_common_chat.getString)("qaplaceholder","mod_harpiasurvey").then((message=>{messagesContainer.append('<div class="qa-placeholder text-muted text-center small py-3">'+message+"</div>")})).catch((()=>{messagesContainer.append('<div class="qa-placeholder text-muted text-center small py-3">Ask a new question to get an answer.</div>')}));const input=(0,_common_chat.$)(`#chat-input-model-${modelid}-${pageid}`);if(input.length>0){input.val(""),input.prop("disabled",!1);const pane=(0,_common_chat.$)(`#model-pane-${modelid}-${pageid}`);pane.find(".input-group").show();(0,_common_chat.$)(`#send-message-btn-model-${modelid}-${pageid}`).prop("disabled",!1),pane.find(".qa-question-item").removeClass("active"),input.focus()}const evalContainer=(0,_common_chat.$)(`#qa-evaluation-questions-container-model-${modelid}-${pageid}`);evalContainer.length>0&&evalContainer.empty()},sendMessage=(cmid,pageid,modelid,message,button,input,loading)=>{const params=new URLSearchParams({action:"send_ai_message",cmid:cmid,pageid:pageid,message:message,modelid:modelid,sesskey:_common_chat.Config.sesskey});fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(loading.hide(),data.success)if(data.messageid&&data.content){const parentid=data.parentid||null;if(parentid){const pendingUser=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid} .message[data-role="user"]`).last();pendingUser.length>0&&pendingUser.attr("data-messageid",parentid),updateQaQuestionItemId(pageid,modelid,parentid)}displayAIMessage(pageid,modelid,data.content,data.messageid,parentid).then((()=>{lockQaInput(pageid,modelid),parentid&&selectQaQuestion(pageid,modelid,parentid)}))}else(0,_common_chat.addError)("Received response but missing message ID or content");else(0,_common_chat.addError)(data.message||"Error sending message");input.prop("disabled",!1),button.prop("disabled",!1),input.focus()})).catch((error=>{loading.hide(),console.error("Error sending message:",error),(0,_common_chat.addError)("Error sending message: "+error.message),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()}))},displayUserMessage=(pageid,modelid,message,messageid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);0!==messagesContainer.length&&(messagesContainer.find(".text-center.text-muted").remove(),messagesContainer.find(".qa-placeholder").remove(),_common_chat.Templates.render("mod_harpiasurvey/chat_user_message",{id:messageid,content:message,timecreated:Math.floor(Date.now()/1e3)}).then((html=>{messagesContainer.append(html),scrollToBottom(pageid,modelid)})).catch(_common_chat.Notification.exception))},displayAIMessage=function(pageid,modelid,content,messageid){let parentid=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);return 0===messagesContainer.length?Promise.resolve():_common_chat.Templates.render("mod_harpiasurvey/chat_ai_message",{id:messageid,parentid:parentid,content:content,timecreated:Math.floor(Date.now()/1e3)}).then((html=>(messagesContainer.append(html),scrollToBottom(pageid,modelid),html))).catch(_common_chat.Notification.exception)},selectQaQuestion=(pageid,modelid,questionId)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);if(0===messagesContainer.length)return;const pane=(0,_common_chat.$)(`#model-pane-${modelid}-${pageid}`);pane.attr("data-qa-active-id",questionId),pane.data("qa-active-id",questionId),messagesContainer.find(".qa-placeholder").hide(),messagesContainer.find(".message").hide(),messagesContainer.find(`.message[data-messageid="${questionId}"], .message[data-parentid="${questionId}"]`).show();const list=(0,_common_chat.$)(`.qa-questions-list[data-pageid="${pageid}"][data-model-id="${modelid}"]`);list.find(".qa-question-item").removeClass("active"),list.find(`.qa-question-item[data-question-id="${questionId}"]`).addClass("active"),lockQaInput(pageid,modelid);const evalId=parseInt(questionId,10);isNaN(evalId)||renderQaEvaluationQuestions(pageid,modelid,evalId).then((()=>{loadQaEvaluationResponses(pageid,modelid,evalId)}))},addQaQuestionItem=(pageid,modelid,questionId,message)=>{const list=(0,_common_chat.$)(`.qa-questions-list[data-pageid="${pageid}"][data-model-id="${modelid}"]`);if(0===list.length)return;const preview=(message||"").trim().slice(0,60),label=message&&message.length>60?preview+"...":preview||"Question #"+questionId,button=(0,_common_chat.$)("<button>",{type:"button",class:"btn btn-sm btn-outline-secondary qa-question-item","data-pageid":pageid,"data-model-id":modelid,"data-question-id":questionId,title:label,text:label});list.append(button),list[0]&&list.scrollTop(list[0].scrollHeight)},updateQaQuestionItemId=(pageid,modelid,newId)=>{const lastItem=(0,_common_chat.$)(`.qa-questions-list[data-pageid="${pageid}"][data-model-id="${modelid}"]`).find(".qa-question-item").last();lastItem.length>0&&lastItem.attr("data-question-id",newId)},lockQaInput=(pageid,modelid)=>{const inputGroup=(0,_common_chat.$)(`#model-pane-${modelid}-${pageid}`).find(".input-group");inputGroup.length>0&&inputGroup.hide();const input=(0,_common_chat.$)(`#chat-input-model-${modelid}-${pageid}`),sendButton=(0,_common_chat.$)(`#send-message-btn-model-${modelid}-${pageid}`);input.prop("disabled",!0),sendButton.prop("disabled",!0)},hasUnsavedQaEvaluation=(pageid,modelid)=>{const key=stateKey(pageid,modelid),activeId=(0,_common_chat.$)(`#model-pane-${modelid}-${pageid}`).data("qa-active-id");if(!activeId)return!1;if(qaEvaluationSaved[key]||(qaEvaluationSaved[key]={}),!0===qaEvaluationSaved[key][activeId])return!1;const container=(0,_common_chat.$)(`#qa-evaluation-questions-container-model-${modelid}-${pageid}`);if(0===container.length)return!1;const requiredQuestions=container.find('.question-item[data-required="1"]');if(0===requiredQuestions.length)return qaEvaluationSaved[key][activeId]=!0,!1;let missing=!1;return requiredQuestions.each((function(){if(0===(0,_common_chat.$)(this).find(".saved-response-message").length)return missing=!0,!1})),qaEvaluationSaved[key][activeId]=!missing,missing},renderQaEvaluationQuestions=(pageid,modelid,questionId)=>{const containerWrapper=(0,_common_chat.$)(`#qa-evaluation-questions-container-model-${modelid}-${pageid}`);if(0===containerWrapper.length)return Promise.resolve();const key=stateKey(pageid,modelid);return qaEvaluationSaved[key]||(qaEvaluationSaved[key]={}),qaEvaluationSaved[key][questionId]=!1,(0,_common_chat.getString)("loading","moodle").then((loadingStr=>{containerWrapper.html('<div class="text-center py-3 text-muted"><i class="fa fa-spinner fa-spin"></i> '+loadingStr+"</div>");const container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`),cmid=parseInt(container.data("cmid")||container.attr("data-cmid"),10),params=new URLSearchParams({action:"get_turn_questions",pageid:pageid,turn_id:questionId,cmid:cmid,sesskey:_common_chat.Config.sesskey});return fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{data.success&&data.html?containerWrapper.html(data.html):containerWrapper.html('<div class="text-center text-muted py-3">'+(data.message||"No questions available for this entry.")+"</div>")})).catch((error=>{console.error("Error loading evaluation questions:",error),containerWrapper.html('<div class="text-danger text-center py-3">Error loading questions: '+error.message+"</div>")}))}))},loadQaEvaluationResponses=(pageid,modelid,questionId)=>{const containerWrapper=(0,_common_chat.$)(`#qa-evaluation-questions-container-model-${modelid}-${pageid}`);if(0===containerWrapper.length)return;let container=containerWrapper.find(`.turn-evaluation-questions[data-turn-id="${questionId}"]`);0===container.length&&(container=containerWrapper),container.find(".question-item").each((function(){resetQuestionItemToNeutral((0,_common_chat.$)(this))}));const chatContainer=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`),cmid=parseInt(chatContainer.data("cmid")||chatContainer.attr("data-cmid"),10),params=new URLSearchParams({action:"get_turn_responses",cmid:cmid,pageid:pageid,turn_id:questionId,sesskey:_common_chat.Config.sesskey});fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(!data.success||!data.responses||0===Object.keys(data.responses).length){const key=stateKey(pageid,modelid);return qaEvaluationSaved[key]||(qaEvaluationSaved[key]={}),void(qaEvaluationSaved[key][questionId]=!1)}Object.keys(data.responses).forEach((qid=>{const responseData=data.responses[qid],questionItem=container.find(`.question-item[data-questionid="${qid}"]`);if(0===questionItem.length)return;const questionType=questionItem.data("questiontype"),value=responseData.response;if("singlechoice"===questionType||"likert"===questionType)questionItem.find('input[type="radio"]').prop("checked",!1),questionItem.find(`input[type="radio"][value="${value}"]`).prop("checked",!0);else if("multiplechoice"===questionType){questionItem.find('input[type="checkbox"]').prop("checked",!1);try{const values=JSON.parse(value);Array.isArray(values)&&values.forEach((val=>{questionItem.find(`input[type="checkbox"][value="${val}"]`).prop("checked",!0)}))}catch(e){}}else"select"===questionType?questionItem.find("select").val(value):"number"===questionType?questionItem.find('input[type="number"]').val(value):"shorttext"===questionType?questionItem.find('input[type="text"]').val(value):"longtext"===questionType&&questionItem.find("textarea").val(value);responseData.saved_datetime&&(0,_common_chat.getString)("saved","mod_harpiasurvey").then((savedText=>{(0,_common_chat.getString)("on","mod_harpiasurvey").then((onText=>{const icon='<i class="fa fa-check-circle" aria-hidden="true"></i>';let savedMessage=questionItem.find(".saved-response-message");if(0===savedMessage.length){const messageHtml=`<div class="mt-2 small text-muted saved-response-message">${icon} ${savedText} ${onText} ${responseData.saved_datetime}</div>`;questionItem.append(messageHtml)}else savedMessage.html(`${icon} ${savedText} ${onText} ${responseData.saved_datetime}`);(questionItem=>{questionItem.attr("data-response-locked","1"),questionItem.removeAttr("data-response-editing"),questionItem.find("input, select, textarea").prop("disabled",!0)})(questionItem),(questionItem=>{let controls=questionItem.find(".question-edit-controls");0===controls.length&&(controls=(0,_common_chat.$)('<div class="mt-2 question-edit-controls"></div>'),questionItem.append(controls));let button=controls.find(".question-edit-btn");0===button.length&&(button=(0,_common_chat.$)('<button type="button" class="btn btn-sm btn-outline-secondary question-edit-btn"></button>'),controls.append(button)),button.text(editLabel),button.show()})(questionItem)}))})),(0,_common_chat.getString)("answerhistory","mod_harpiasurvey").then((historyText=>{let history=questionItem.find(".answer-history");if(!history.length&&responseData.history_count>1){const details=(0,_common_chat.$)('<details class="answer-history mt-1"></details>');details.append(`<summary>${historyText} (${responseData.history_count})</summary>`),details.append('<ul class="list-unstyled mt-2 mb-0"></ul>'),questionItem.append(details),history=details}if(history.length){const list=history.find("ul");list.empty(),(responseData.history_items||[]).forEach((item=>{list.append(`<li class="mb-1"><span class="text-muted">${item.time}</span> â€” ${item.response}</li>`)})),history.find("summary").text(`${historyText} (${responseData.history_count||0})`),(responseData.history_count||0)>1?history.show():history.hide()}}))}));const key=stateKey(pageid,modelid);qaEvaluationSaved[key]||(qaEvaluationSaved[key]={});const requiredQuestions=container.find('.question-item[data-required="1"]');if(0===requiredQuestions.length)return void(qaEvaluationSaved[key][questionId]=!0);const requiredCount=requiredQuestions.length,savedRequired=requiredQuestions.filter((function(){return(0,_common_chat.$)(this).find(".saved-response-message").length>0})).length;qaEvaluationSaved[key][questionId]=requiredCount>0&&savedRequired===requiredCount})).catch((error=>{console.error("Error loading evaluation responses:",error)}))},saveQaEvaluationResponses=(cmid,pageid,modelid,questionId,responses,button,originalText)=>{const entries=Object.entries(responses);let failedCount=0,promiseChain=Promise.resolve();entries.forEach((_ref=>{let[qid,response]=_ref;promiseChain=promiseChain.then((()=>{const params=new URLSearchParams({action:"save_response",cmid:cmid,pageid:pageid,questionid:qid,response:response,turn_id:questionId,sesskey:_common_chat.Config.sesskey});return fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((res=>res.json())).then((data=>{data.success||failedCount++})).catch((()=>{failedCount++}))}))})),promiseChain.then((()=>{button.prop("disabled",!1),button.text(originalText),0===failedCount?_common_chat.Notification.addNotification({message:"Responses saved.",type:"success"}):_common_chat.Notification.addNotification({message:"Some responses failed to save.",type:"warning"});const key=stateKey(pageid,modelid);qaEvaluationSaved[key]||(qaEvaluationSaved[key]={}),qaEvaluationSaved[key][questionId]=!1,loadQaEvaluationResponses(pageid,modelid,questionId)}))},scrollToBottom=(pageid,modelid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);messagesContainer.length>0&&messagesContainer.scrollTop(messagesContainer[0].scrollHeight)}}));

//# sourceMappingURL=multi_model_qa.min.js.map
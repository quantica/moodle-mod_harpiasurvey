define("mod_harpiasurvey/multi_model_continuous",["exports","./common_chat"],(function(_exports,_common_chat){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;let initialized=!1,handlersRegistered=!1,treeHandlersRegistered=!1;_exports.init=()=>initialize();const initialize=()=>{if(initialized)return;!function(){if(handlersRegistered)return;(0,_common_chat.$)(document).on("click",".multi-model-chat-container .chat-send-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),container=button.closest(".multi-model-chat-container"),cmid=parseInt(container.attr("data-cmid")||container.data("cmid"),10),pageid=parseInt(container.attr("data-pageid")||container.data("pageid"),10),modelid=parseInt(button.attr("data-model-id")||button.data("modelId")||button.data("model-id"),10);var _container$,_container$$outerHTML,_button$,_button$$outerHTML;if(!cmid||!pageid||!modelid)return console.error("Missing data attributes:",{cmid:container.attr("data-cmid"),pageid:container.attr("data-pageid"),modelid:button.attr("data-model-id"),containerHtml:null===(_container$=container[0])||void 0===_container$||null===(_container$$outerHTML=_container$.outerHTML)||void 0===_container$$outerHTML?void 0:_container$$outerHTML.substring(0,200),buttonHtml:null===(_button$=button[0])||void 0===_button$||null===(_button$$outerHTML=_button$.outerHTML)||void 0===_button$$outerHTML?void 0:_button$$outerHTML.substring(0,200)}),void(0,_common_chat.addError)("Missing cmid, pageid, or model-id");let input=(0,_common_chat.$)(`#chat-input-model-${modelid}-${pageid}`);if(0===input.length&&(input=container.find(`textarea.chat-input[data-model-id="${modelid}"]`)),0===input.length){input=container.find(".tab-pane.active").find(`textarea.chat-input[data-model-id="${modelid}"]`)}if(0===input.length)return console.error("Chat input not found:",{modelid:modelid,pageid:pageid,expectedId:`chat-input-model-${modelid}-${pageid}`,foundInputs:container.find("textarea.chat-input").map((function(){const $el=(0,_common_chat.$)(this);return{id:$el.attr("id"),modelId:$el.attr("data-model-id"),pageId:$el.attr("data-pageid")}})).get(),allTextareas:container.find("textarea").length}),void(0,_common_chat.addError)("Chat input not found for model "+modelid);const inputValue=input.val();if(!inputValue||!inputValue.trim())return;const message=inputValue.trim();input.prop("disabled",!0),button.prop("disabled",!0),input.val("");const tempId="temp-user-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);displayUserMessage(pageid,modelid,message,tempId);const loading=(0,_common_chat.$)(`#chat-loading-model-${modelid}-${pageid}`);loading.show(),sendMessage(cmid,pageid,message,modelid,button,input,loading)})),(0,_common_chat.$)(document).on("keydown",".multi-model-chat-container .chat-input",(function(e){if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const input=(0,_common_chat.$)(this),container=input.closest(".multi-model-chat-container"),pageid=parseInt(container.attr("data-pageid")||container.data("pageid"),10),modelid=parseInt(input.attr("data-model-id")||input.data("modelId")||input.data("model-id"),10);(0,_common_chat.$)(`#send-message-btn-model-${modelid}-${pageid}`).click()}})),(0,_common_chat.$)(document).on("shown.bs.tab",'.multi-model-chat-container .nav-link[data-bs-toggle="tab"]',(function(){const tab=(0,_common_chat.$)(this),targetId=tab.data("bs-target"),pane=(0,_common_chat.$)(targetId),modelid=parseInt(pane.data("model-id"),10),pageid=parseInt(tab.closest(".multi-model-chat-container").data("pageid"),10);modelid&&pageid&&setTimeout((()=>{scrollToBottomForModel(pageid,modelid)}),100)})),handlersRegistered=!0}(),function(){if(treeHandlersRegistered)return;(0,_common_chat.$)(document).on("click",".conversation-item",(function(e){e.preventDefault();const item=(0,_common_chat.$)(this),conversationId=parseInt(item.data("conversation-id"),10),sidebarId=item.closest(".conversation-tree-sidebar").attr("id"),pageid=parseInt(sidebarId.replace("conversation-tree-sidebar-",""),10);pageid&&navigateToConversation(pageid,conversationId)})),(0,_common_chat.$)(document).on("click",".create-root-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);pageid&&cmid?createNewRoot(cmid,pageid):(0,_common_chat.addError)("Missing required data to create root")})),(0,_common_chat.$)(document).on("click",".export-conversation-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);if(!pageid||!cmid)return void(0,_common_chat.addError)("Missing required data to export conversation");const container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`),conversationId=container.data("viewing-conversation")||parseInt(container.attr("data-viewing-conversation"),10),params=new URLSearchParams;params.append("action","export_conversation"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),conversationId&&params.append("conversation_id",conversationId),window.open(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),"_blank")})),treeHandlersRegistered=!0}();const containers=(0,_common_chat.$)('.multi-model-chat-container[data-behavior="continuous"]');0!==containers.length?(containers.each((function(){const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10);pageid&&initMultiModelPage(pageid)})),initialized=!0):initialized=!0},initMultiModelPage=pageid=>{const container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`);(container=>{if(container.find(".nav-link.active").length>0&&container.find(".tab-pane.active").length>0)return;const firstTab=container.find(".nav-link[data-model-id]").first(),firstPane=container.find(".tab-pane[data-model-id]").first();0!==firstTab.length&&0!==firstPane.length&&(container.find(".nav-link[data-model-id]").removeClass("active").attr("aria-selected","false"),container.find(".tab-pane[data-model-id]").removeClass("show active"),firstTab.addClass("active").attr("aria-selected","true"),firstPane.addClass("show active"))})(container);const tabPanes=container.find(".tab-pane[data-model-id]"),globalParentMap=new Map;tabPanes.each((function(){const modelId=parseInt((0,_common_chat.$)(this).data("model-id"),10);(0,_common_chat.$)(`#chat-messages-model-${modelId}-${pageid}`).find(".message").each((function(){const msgId=parseInt((0,_common_chat.$)(this).data("messageid"),10),parentId=parseInt((0,_common_chat.$)(this).data("parentid"),10);msgId&&!isNaN(msgId)&&globalParentMap.set(msgId,parentId&&!isNaN(parentId)?parentId:null)}))}));let sharedRootId=null;tabPanes.each((function(){const modelId=parseInt((0,_common_chat.$)(this).data("model-id"),10),messages=(0,_common_chat.$)(`#chat-messages-model-${modelId}-${pageid}`).find(".message");if(messages.length>0){const lastMessage=messages.last(),lastMessageId=parseInt(lastMessage.data("messageid"),10);if(lastMessageId&&!isNaN(lastMessageId)){let rootId=lastMessageId,currentId=lastMessageId,found=!1;for(;currentId&&!found;){const parentId=globalParentMap.get(currentId);parentId?currentId=parentId:(rootId=currentId,found=!0)}found&&(container.data(`viewing-conversation-${modelId}`,rootId),sharedRootId||(sharedRootId=rootId))}}})),sharedRootId&&(container.data("viewing-conversation",sharedRootId),container.attr("data-viewing-conversation",sharedRootId));const activeTab=container.find(".tab-pane.active");if(activeTab.length>0){const activeModelId=parseInt(activeTab.data("model-id"),10);setTimeout((()=>{scrollToBottomForModel(pageid,activeModelId)}),100)}const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);sidebar.length>0&&(sidebar.show(),loadConversationTreeForMultiModel(pageid).then((()=>{const selectedConversation=container.data("viewing-conversation")||parseInt(container.attr("data-viewing-conversation"),10);selectedConversation&&tabPanes.each((function(){const modelId=parseInt((0,_common_chat.$)(this).data("model-id"),10);filterMessagesByConversationForModel(pageid,modelId,selectedConversation)}))})))};const sendMessage=(cmid,pageid,message,modelid,button,input,loading)=>{const container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`),viewingConversation=container.data("viewing-conversation"),messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);let parentid=null;if(viewingConversation){const visibleMessages=messagesContainer.find(".message:visible");if(visibleMessages.length>0){const lastMessage=visibleMessages.last(),lastMessageId=parseInt(lastMessage.data("messageid"),10);lastMessageId&&!isNaN(lastMessageId)&&(parentid=lastMessageId)}else parentid=parseInt(viewingConversation,10)}else parentid=null;const params=new URLSearchParams({action:"send_ai_message",cmid:cmid,pageid:pageid,message:message,modelid:modelid,sesskey:_common_chat.Config.sesskey});parentid&&params.append("parentid",parentid),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{loading.hide(),data.success?(data.root_conversation_id&&(container.data("viewing-conversation",data.root_conversation_id),container.attr("data-viewing-conversation",data.root_conversation_id),container.data(`viewing-conversation-${modelid}`,data.root_conversation_id)),data.messageid&&data.content?displayAIMessage(pageid,modelid,data.content,data.messageid,data.turn_id).then((()=>{setTimeout((()=>{scrollToBottomForModel(pageid,modelid)}),100),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()})):((0,_common_chat.addError)("Received response but missing message ID or content"),input.prop("disabled",!1),button.prop("disabled",!1),input.focus())):((0,_common_chat.addError)(data.message||"Error sending message"),input.prop("disabled",!1),button.prop("disabled",!1),input.focus())})).catch((error=>{loading.hide(),console.error("Error sending message:",error),(0,_common_chat.addError)("Error sending message: "+error.message),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()}))},displayUserMessage=(pageid,modelid,message,messageid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);0!==messagesContainer.length&&(messagesContainer.find(".text-center.text-muted").remove(),_common_chat.Templates.render("mod_harpiasurvey/chat_user_message",{id:messageid,content:message,timecreated:Math.floor(Date.now()/1e3)}).then((html=>{messagesContainer.append(html),scrollToBottomForModel(pageid,modelid)})).catch(_common_chat.Notification.exception))},displayAIMessage=(pageid,modelid,content,messageid,turnId)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);return 0===messagesContainer.length?Promise.resolve():_common_chat.Templates.render("mod_harpiasurvey/chat_ai_message",{id:messageid,content:content,turn_id:turnId||null,timecreated:Math.floor(Date.now()/1e3)}).then((html=>(messagesContainer.append(html),scrollToBottomForModel(pageid,modelid),html))).catch(_common_chat.Notification.exception)},scrollToBottomForModel=(pageid,modelid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);messagesContainer.length>0&&messagesContainer.scrollTop(messagesContainer[0].scrollHeight)},loadConversationTreeForMultiModel=pageid=>{const treeContainer=(0,_common_chat.$)(`#conversation-tree-${pageid}`),sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);if(0===treeContainer.length)return Promise.resolve(null);const container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`),cmid=parseInt(container.attr("data-cmid")||container.data("cmid"),10);if(!cmid)return treeContainer.html('<div class="text-danger text-center small py-3">Error: Course module ID not found. Please refresh the page.</div>'),Promise.resolve(null);const params=new URLSearchParams;return params.append("action","get_conversation_tree"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>data.success&&data.tree?(data.tree.roots=(data.tree.roots||[]).map(((root,idx)=>({...root,conversation_number:idx+1}))),_common_chat.conversationTrees[pageid]=data.tree,sidebar.data("sidebar-view","list"),renderConversationList(pageid,data.tree.roots),data.tree):(treeContainer.html('<div class="text-muted text-center small py-3">'+(data.message||"No conversation tree available yet.")+"</div>"),null))).catch((error=>(console.error("Error loading conversation tree:",error),treeContainer.html('<div class="text-danger text-center small py-3">Error loading conversation tree: '+error.message+"<br>Please check the browser console for details and refresh the page.</div>"),null)))},renderConversationList=(pageid,roots)=>{const treeContainer=(0,_common_chat.$)(`#conversation-tree-${pageid}`);if(0===treeContainer.length)return;if(0===roots.length)return void treeContainer.html('<div class="text-muted text-center small py-3">No conversations yet. Click "New conversation" to start.</div>');const container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`),viewingConversation=container.data("viewing-conversation")||parseInt(container.attr("data-viewing-conversation"),10);let html='<ul class="list-group list-group-flush">';roots.forEach((root=>{const conversationNumber=root.conversation_number||"",conversationId=root.id||root.conversation_id||root.turn_id,isActive=viewingConversation&&parseInt(conversationId,10)===parseInt(viewingConversation,10);html+=`<li class="list-group-item conversation-item ${isActive?"active bg-primary text-white":""}" data-conversation-id="${conversationId}" style="cursor: pointer;">`,html+='<div class="d-flex justify-content-between align-items-center">',html+=`<span class="font-weight-bold">Conversation ${conversationNumber}</span>`,html+=`<small class="${isActive?"text-white-50":"text-muted"}">${root.message_count||0} messages</small>`,html+="</div>",html+="</li>"})),html+="</ul>",treeContainer.html(html)};const navigateToConversation=(pageid,conversationId)=>{const container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`);if(0===container.length)return void console.error("Container not found for pageid:",pageid);container.data("viewing-conversation",conversationId),container.attr("data-viewing-conversation",conversationId);container.find(".tab-pane[data-model-id]").each((function(){const modelId=parseInt((0,_common_chat.$)(this).data("model-id"),10);filterMessagesByConversationForModel(pageid,modelId,conversationId)})),loadConversationTreeForMultiModel(pageid)},filterMessagesByConversationForModel=(pageid,modelId,conversationId)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelId}-${pageid}`);if(0===messagesContainer.length)return;const conversationMessageIds=new Set;conversationMessageIds.add(conversationId);const messageParentMap=new Map;(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`).find(".tab-pane[data-model-id]").each((function(){(0,_common_chat.$)(this).find(".chat-messages").find(".message").each((function(){const messageId=parseInt((0,_common_chat.$)(this).data("messageid"),10),parentId=parseInt((0,_common_chat.$)(this).data("parentid"),10);messageId&&!isNaN(messageId)&&messageParentMap.set(messageId,parentId&&!isNaN(parentId)?parentId:null)}))}));const toProcess=[conversationId];for(;toProcess.length>0;){const currentId=toProcess.shift();messageParentMap.forEach(((parentId,messageId)=>{parentId===currentId&&(conversationMessageIds.add(messageId),toProcess.push(messageId))}))}let hasVisibleMessages=!1;messagesContainer.find(".message").each((function(){const messageId=parseInt((0,_common_chat.$)(this).data("messageid"),10);conversationMessageIds.has(messageId)?((0,_common_chat.$)(this).show(),hasVisibleMessages=!0):(0,_common_chat.$)(this).hide()}));const placeholder=messagesContainer.find(".text-center.text-muted");hasVisibleMessages?placeholder.hide():0===placeholder.length?messagesContainer.prepend('<div class="text-center text-muted py-4"><p>No messages yet. Send a message to start the conversation.</p></div>'):placeholder.show(),setTimeout((()=>{scrollToBottomForModel(pageid,modelId)}),50)},createNewRoot=(cmid,pageid)=>{const params=new URLSearchParams;return params.append("action","create_root"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{data.success?loadConversationTreeForMultiModel(pageid).then((()=>{if(data.root_id){(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`).find(".tab-pane[data-model-id]").each((function(){const modelId=parseInt((0,_common_chat.$)(this).data("model-id"),10),messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelId}-${pageid}`);messagesContainer.find(".message").hide();let placeholder=messagesContainer.find(".text-center.text-muted");0===placeholder.length?messagesContainer.prepend('<div class="text-center text-muted py-4"><p>No messages yet. Send a message to start the conversation.</p></div>'):placeholder.show()})),navigateToConversation(pageid,data.root_id)}})):(0,_common_chat.addError)(data.message||"Error creating new conversation")})).catch((error=>{console.error("Error creating new root:",error),(0,_common_chat.addError)("Error creating new conversation: "+error.message)}))}}));

//# sourceMappingURL=multi_model_continuous.min.js.map
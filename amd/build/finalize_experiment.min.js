define("mod_harpiasurvey/finalize_experiment",["exports","core/notification","core/config","core/str","jquery"],(function(_exports,_notification,_config,_str,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_notification=_interopRequireDefault(_notification),_config=_interopRequireDefault(_config),_jquery=_interopRequireDefault(_jquery);let initialized=!1,state={cmid:0,experimentid:0,finalized:!1};const ajaxUrl=()=>_config.default.wwwroot+"/mod/harpiasurvey/ajax.php",applyReadOnlyMode=()=>{if(state.finalized){if(0===(0,_jquery.default)(".harpiasurvey-finalized-banner").length){const banner=(0,_jquery.default)('<div class="alert alert-secondary harpiasurvey-finalized-banner mb-3"></div>');(0,_str.get_string)("experimentreadonlybanner","mod_harpiasurvey").then((txt=>{banner.text(txt)})).catch((()=>{banner.text("This experiment has been finalized and is now read-only.")})),(0,_jquery.default)(".card-body").first().prepend(banner)}(0,_jquery.default)(".question-item input, .question-item textarea, .question-item select").prop("disabled",!0),(0,_jquery.default)(".chat-input, .chat-send-btn").prop("disabled",!0),[".save-all-responses-btn",".save-turn-evaluation-questions-btn",".question-edit-btn",".new-question-btn",".create-direct-branch-btn",".create-branch-from-tree-btn",".new-conversation-btn",".create-root-btn",".branch-btn",".chat-send-btn"].forEach((selector=>{(0,_jquery.default)(selector).prop("disabled",!0).addClass("disabled")}))}},updateConfirmState=(container,summary,finalized)=>{const confirmBtn=container.find('[data-role="confirm-finalize-btn"]'),certify=container.find('[data-role="certify-checkbox"]'),requiredWarning=container.find('[data-role="required-warning"]'),requiredUnanswered=parseInt((null==summary?void 0:summary.requiredunanswered)||0,10),canFinalize=!(null==summary||!summary.canfinalize)&&0===requiredUnanswered;if(finalized)return certify.prop("checked",!1).prop("disabled",!0),confirmBtn.prop("disabled",!0),void requiredWarning.addClass("d-none");certify.prop("disabled",!1),requiredWarning.toggleClass("d-none",0===requiredUnanswered);const certified=certify.is(":checked");confirmBtn.prop("disabled",!(certified&&canFinalize))},renderSummary=(container,payload)=>{const summary=payload.summary||{},content=container.find(".finalize-summary-content"),loading=container.find(".finalize-summary-loading");container.find('[data-field="answered"]').text(summary.answered||0),container.find('[data-field="unanswered"]').text(summary.unanswered||0),container.find('[data-field="requiredunanswered"]').text(summary.requiredunanswered||0);const details=container.find('[data-role="page-details"]');details.empty(),(summary.pages||[]).forEach((page=>{const row=(0,_jquery.default)('<div class="d-flex justify-content-between small py-1 border-bottom"></div>'),left=(0,_jquery.default)("<div></div>"),right=(0,_jquery.default)('<div class="text-nowrap ml-2"></div>');left.text(`${page.title}`),right.text(`${page.unanswered||0}`),row.append(left).append(right),details.append(row)})),summary.pages&&0!==summary.pages.length||details.append('<div class="text-muted small">-</div>'),loading.addClass("d-none"),content.removeClass("d-none"),updateConfirmState(container,summary,!!payload.finalized)},bindFinalizeUI=()=>{(0,_jquery.default)(document).on("click",'.harpiasurvey-finalize-modal [data-role="finalize-cancel-btn"]',(function(e){e.preventDefault();(0,_jquery.default)(this).closest(".harpiasurvey-finalize-modal").modal("hide")})),(0,_jquery.default)(document).on("click",".save-all-responses-btn, .save-turn-evaluation-questions-btn, .chat-send-btn, .new-question-btn, .create-direct-branch-btn, .create-branch-from-tree-btn, .new-conversation-btn, .create-root-btn, .question-edit-btn",(function(e){state.finalized&&(e.preventDefault(),e.stopPropagation(),(0,_str.get_string)("experimentfinalizedreadonly","mod_harpiasurvey").then((msg=>{_notification.default.addNotification({message:msg,type:"info"})})).catch((()=>{_notification.default.addNotification({message:"This experiment is read-only.",type:"info"})})))})),(0,_jquery.default)(document).on("click",'[data-action="open-finalize-modal"]',(function(e){e.preventDefault();const wrapper=(0,_jquery.default)(this).closest(".harpiasurvey-finalize-page"),modal=wrapper.find(".harpiasurvey-finalize-modal");modal.find('[data-role="certify-checkbox"]').prop("checked",!1),modal.modal("show"),(wrapper=>{const modal=wrapper.find(".harpiasurvey-finalize-modal");modal.find(".finalize-summary-loading").removeClass("d-none"),modal.find(".finalize-summary-content").addClass("d-none"),modal.find('[data-role="confirm-finalize-btn"]').prop("disabled",!0);const params=new URLSearchParams({action:"get_finalize_summary",cmid:String(state.cmid),experimentid:String(state.experimentid),sesskey:_config.default.sesskey,_:String(Date.now())});fetch(ajaxUrl(),{method:"POST",cache:"no-store",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((r=>r.json())).then((data=>{if(!data.success)throw new Error(data.message||"Failed to load summary");state.finalized=!!data.finalized,wrapper.attr("data-finalized",state.finalized?"1":"0"),renderSummary(modal,data),state.finalized&&applyReadOnlyMode()})).catch((e=>{modal.find(".finalize-summary-loading").addClass("d-none"),_notification.default.addNotification({message:e.message||"Failed to load finalization summary.",type:"error"})}))})(wrapper)})),(0,_jquery.default)(document).on("change",'.harpiasurvey-finalize-modal [data-role="certify-checkbox"]',(function(){const modal=(0,_jquery.default)(this).closest(".harpiasurvey-finalize-modal"),summary={canfinalize:0===parseInt(modal.find('[data-field="requiredunanswered"]').text(),10),requiredunanswered:parseInt(modal.find('[data-field="requiredunanswered"]').text(),10)||0};updateConfirmState(modal,summary,state.finalized)})),(0,_jquery.default)(document).on("click",'.harpiasurvey-finalize-modal [data-role="confirm-finalize-btn"]',(function(){const btn=(0,_jquery.default)(this),modal=btn.closest(".harpiasurvey-finalize-modal"),certified=modal.find('[data-role="certify-checkbox"]').is(":checked")?1:0;btn.prop("disabled",!0);const params=new URLSearchParams({action:"confirm_finalize_experiment",cmid:String(state.cmid),experimentid:String(state.experimentid),certified:String(certified),sesskey:_config.default.sesskey});fetch(ajaxUrl(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((r=>r.json())).then((data=>{if(!data.success)return _notification.default.addNotification({message:data.message||"Could not finalize experiment.",type:"warning"}),void renderSummary(modal,data);state.finalized=!0,_notification.default.addNotification({message:data.message||"Experiment finalized successfully.",type:"success"}),modal.modal("hide"),window.location.reload()})).catch((e=>{_notification.default.addNotification({message:e.message||"Could not finalize experiment.",type:"error"}),btn.prop("disabled",!1)}))}))};_exports.init=function(cmid,experimentid){let finalized=arguments.length>2&&void 0!==arguments[2]&&arguments[2];state.cmid=parseInt(cmid,10)||0,state.experimentid=parseInt(experimentid,10)||0,state.finalized=!0===finalized||1===finalized||"1"===finalized,initialized||(bindFinalizeUI(),initialized=!0),applyReadOnlyMode()}}));

//# sourceMappingURL=finalize_experiment.min.js.map
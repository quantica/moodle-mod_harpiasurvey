{"version":3,"file":"stats_table.min.js","sources":["../src/stats_table.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Stats table functionality for expanding/collapsing long answers.\n *\n * @module     mod_harpiasurvey/stats_table\n * @copyright  2025 Your Name\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery'], function($) {\n    'use strict';\n\n    /**\n     * Render answer items as HTML tags.\n     *\n     * @param {Array} answerItems Array of answer item objects\n     * @return {string} HTML string\n     */\n    function renderAnswerItems(answerItems) {\n        let html = '';\n        answerItems.forEach(function(item) {\n            if (item.isoption) {\n                html += '<span class=\"badge badge-secondary answer-tag mr-1 mb-1\">';\n                html += '<span class=\"answer-text\">' + $('<div>').text(item.text).html() + '</span>';\n                html += '</span>';\n            } else {\n                html += '<span class=\"answer-text-plain\">' + $('<div>').text(item.text).html() + '</span>';\n            }\n        });\n        return html;\n    }\n\n    /**\n     * Initialize stats table functionality.\n     */\n    function init() {\n        // Handle expand/collapse for conversations.\n        $(document).on('click', '.expand-conversation-btn', function() {\n            const button = $(this);\n            const conversationId = button.data('conversation-id');\n            const messagesDiv = $('.conversation-messages[data-conversation-id=\"' + conversationId + '\"]');\n            const expandText = button.find('.expand-text');\n            const collapseText = button.find('.collapse-text');\n\n            if (messagesDiv.is(':visible')) {\n                // Collapse\n                messagesDiv.slideUp();\n                expandText.show();\n                collapseText.hide();\n            } else {\n                // Expand\n                messagesDiv.slideDown();\n                expandText.hide();\n                collapseText.show();\n            }\n        });\n\n        // Handle expand/collapse button clicks for answers.\n        $(document).on('click', '.expand-answer-btn', function() {\n            const button = $(this);\n            const responseId = button.data('response-id');\n            const answerContainer = $('.answer-container[data-response-id=\"' + responseId + '\"]');\n            const answerItemsDiv = answerContainer.find('.answer-items');\n            const expandText = button.find('.expand-text');\n            const collapseText = button.find('.collapse-text');\n            const answerItemsJson = answerContainer.data('answer-items');\n\n            if (!answerItemsJson) {\n                return;\n            }\n\n            let answerItems;\n            try {\n                answerItems = JSON.parse(answerItemsJson);\n            } catch (e) {\n                // eslint-disable-next-line no-console\n                console.error('Error parsing answer items:', e);\n                return;\n            }\n\n            if (answerContainer.data('expanded')) {\n                // Collapse - show truncated version (first item only if multiple, or truncated text).\n                let displayItems = [];\n                let totalLength = 0;\n                for (let i = 0; i < answerItems.length; i++) {\n                    const item = answerItems[i];\n                    const itemText = item.text || '';\n                    if (totalLength + itemText.length > 100 && i > 0) {\n                        break;\n                    }\n                    if (itemText.length > 100) {\n                        // Truncate this item.\n                        displayItems.push({\n                            text: itemText.substring(0, 100) + '...',\n                            number: item.number,\n                            isoption: item.isoption\n                        });\n                        break;\n                    } else {\n                        displayItems.push(item);\n                        totalLength += itemText.length;\n                    }\n                }\n                answerItemsDiv.html(renderAnswerItems(displayItems));\n                answerContainer.data('expanded', false);\n                expandText.show();\n                collapseText.hide();\n            } else {\n                // Expand - show all answer items.\n                answerItemsDiv.html(renderAnswerItems(answerItems));\n                answerContainer.data('expanded', true);\n                expandText.hide();\n                collapseText.show();\n            }\n        });\n\n        // Handle modal for evaluation messages.\n        $(document).on('click', '.view-eval-messages-btn', function() {\n            const button = $(this);\n            const messagesJson = button.attr('data-messages');\n            let messages = [];\n            if (messagesJson) {\n                try {\n                    messages = JSON.parse(messagesJson);\n                } catch (e) {\n                    // eslint-disable-next-line no-console\n                    console.error('Error parsing messages JSON:', e);\n                }\n            }\n\n            const modalBody = $('#harpiasurvey-messages-modal-body');\n            if (messages.length === 0) {\n                modalBody.html('<div class=\"text-muted text-center py-3\">No messages yet.</div>');\n            } else {\n                let html = '<div class=\"border rounded p-3\" style=\"background-color: #f8f9fa; max-height: 60vh; overflow-y: auto;\">';\n                messages.forEach(function(msg) {\n                    const time = msg.timecreated || '';\n                    const model = msg.modelname ? (' <small class=\"text-muted\">(' + $('<div>').text(msg.modelname).html() + ')</small>') : '';\n                    if (msg.role && msg.role.user) {\n                        html += '<div class=\"message mb-3 text-right\">';\n                        html += '<div class=\"d-inline-block p-2 rounded bg-primary text-white\" style=\"max-width: 80%;\">';\n                        html += '<div class=\"message-content\">' + (msg.content || '') + '</div>';\n                        html += '<small class=\"text-white-50 d-block mt-1\">' + $('<div>').text(time).html() + model + '</small>';\n                        html += '</div></div>';\n                    } else if (msg.role && msg.role.assistant) {\n                        html += '<div class=\"message mb-3 text-left\">';\n                        html += '<div class=\"d-inline-block p-2 rounded bg-light border\" style=\"max-width: 80%;\">';\n                        html += '<div class=\"message-content\">' + (msg.content || '') + '</div>';\n                        html += '<small class=\"text-muted d-block mt-1\">' + $('<div>').text(time).html() + model + '</small>';\n                        html += '</div></div>';\n                    }\n                });\n                html += '</div>';\n                modalBody.html(html);\n            }\n\n            $('#harpiasurvey-messages-modal').modal('show');\n        });\n    }\n\n    return {\n        init: init\n    };\n});\n"],"names":["define","$","renderAnswerItems","answerItems","html","forEach","item","isoption","text","init","document","on","button","this","conversationId","data","messagesDiv","expandText","find","collapseText","is","slideUp","show","hide","slideDown","responseId","answerContainer","answerItemsDiv","answerItemsJson","JSON","parse","e","console","error","displayItems","totalLength","i","length","itemText","push","substring","number","messagesJson","attr","messages","modalBody","msg","time","timecreated","model","modelname","role","user","content","assistant","modal"],"mappings":"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"}
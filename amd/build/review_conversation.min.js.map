{"version":3,"file":"review_conversation.min.js","sources":["../src/review_conversation.js"],"sourcesContent":["// Review conversation mode for Harpia Survey.\nimport Config from 'core/config';\nimport Notification from 'core/notification';\nimport $ from 'jquery';\n\nlet initialized = false;\n\nconst ajaxPost = (params) => {\n    return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded',\n        },\n        body: params.toString(),\n    }).then((response) => response.json());\n};\n\nconst clearQuestionInputs = (pageid) => {\n    const root = $(`.page-view .page-questions .question-item`);\n    root.each(function() {\n        const item = $(this);\n        const questiontype = item.data('questiontype');\n        if (questiontype === 'singlechoice' || questiontype === 'likert') {\n            item.find('input[type=\"radio\"]').prop('checked', false);\n        } else if (questiontype === 'multiplechoice') {\n            item.find('input[type=\"checkbox\"]').prop('checked', false);\n        } else if (questiontype === 'select') {\n            item.find('select').val('');\n        } else if (questiontype === 'number' || questiontype === 'shorttext') {\n            item.find('input').val('');\n        } else if (questiontype === 'longtext') {\n            item.find('textarea').val('');\n        }\n        item.attr('data-response-locked', '0');\n        item.attr('data-response-editing', '1');\n        item.find('.saved-response-message').remove();\n        item.find('.answer-history').remove();\n        item.find('.question-edit-btn').hide();\n        item.find('input, select, textarea').prop('disabled', false);\n    });\n\n    const statusDiv = $(`.page-view .page-questions .save-all-status`);\n    statusDiv.hide().empty();\n\n    // Keep save button style consistent after target switch.\n    const saveBtn = $(`.save-all-responses-btn[data-pageid=\"${pageid}\"]`);\n    saveBtn.removeClass('btn-success btn-warning').addClass('btn-primary');\n};\n\nconst setQuestionValue = (questionItem, questionType, responseValue) => {\n    if (responseValue === null || responseValue === undefined || responseValue === '') {\n        return;\n    }\n    if (questionType === 'singlechoice' || questionType === 'likert') {\n        questionItem.find(`input[type=\"radio\"][value=\"${responseValue}\"]`).prop('checked', true);\n        return;\n    }\n    if (questionType === 'multiplechoice') {\n        let values = [];\n        try {\n            values = JSON.parse(responseValue);\n        } catch (e) {\n            values = [];\n        }\n        if (!Array.isArray(values)) {\n            values = [];\n        }\n        values.forEach((value) => {\n            questionItem.find(`input[type=\"checkbox\"][value=\"${value}\"]`).prop('checked', true);\n        });\n        return;\n    }\n    if (questionType === 'select') {\n        questionItem.find('select').val(String(responseValue));\n        return;\n    }\n    if (questionType === 'number' || questionType === 'shorttext') {\n        questionItem.find('input').val(responseValue);\n        return;\n    }\n    if (questionType === 'longtext') {\n        questionItem.find('textarea').val(responseValue);\n    }\n};\n\nconst renderMessages = (pageid, messages) => {\n    const container = $(`#review-thread-messages-${pageid}`);\n    container.empty();\n\n    if (!messages || messages.length === 0) {\n        container.html('<div class=\"text-muted text-center small py-3\">No messages in this conversation.</div>');\n        return;\n    }\n\n    messages.forEach((msg) => {\n        const roleClass = msg.role === 'assistant' ? 'border-primary' : 'border-secondary';\n        const roleLabel = msg.role ? msg.role.charAt(0).toUpperCase() + msg.role.slice(1) : 'Message';\n        const row = $('<div class=\"review-message-item border rounded p-2 mb-2 bg-white\"></div>');\n        row.addClass(roleClass);\n        row.append(`<div class=\"small text-muted mb-1\"><strong>${roleLabel}</strong>${msg.timecreated ? ` â€¢ ${msg.timecreated}` : ''}</div>`);\n        row.append(`<div class=\"review-message-content\">${msg.content || ''}</div>`);\n        container.append(row);\n    });\n    container.scrollTop(0);\n};\n\nconst loadEvaluationResponses = (cmid, pageid, threadid) => {\n    const responseParams = new URLSearchParams({\n        action: 'get_review_evaluation_responses',\n        cmid: String(cmid),\n        pageid: String(pageid),\n        threadid: String(threadid),\n        sesskey: Config.sesskey,\n    });\n    return ajaxPost(responseParams).then((response) => {\n        if (!response.success) {\n            throw new Error(response.message || 'Failed to load review evaluation responses.');\n        }\n\n        clearQuestionInputs(pageid);\n\n        const reviewContainer = $(`.review-conversation-container[data-pageid=\"${pageid}\"]`);\n        reviewContainer.attr('data-review-target-id', String(response.targetid || ''));\n        const aiContainer = $(`.ai-conversation-container[data-pageid=\"${pageid}\"]`);\n        aiContainer.attr('data-review-target-id', String(response.targetid || ''));\n\n        const responses = response.responses || {};\n        Object.keys(responses).forEach((questionid) => {\n            const questionItem = $(`.page-view .page-questions .question-item[data-questionid=\"${questionid}\"]`);\n            if (!questionItem.length) {\n                return;\n            }\n            setQuestionValue(questionItem, questionItem.data('questiontype'), responses[questionid].response);\n        });\n    });\n};\n\nconst loadThread = (cmid, pageid, threadid) => {\n    const params = new URLSearchParams({\n        action: 'get_review_thread_messages',\n        cmid: String(cmid),\n        pageid: String(pageid),\n        threadid: String(threadid),\n        sesskey: Config.sesskey,\n    });\n    return ajaxPost(params).then((response) => {\n        if (!response.success) {\n            throw new Error(response.message || 'Failed to load review conversation.');\n        }\n        renderMessages(pageid, response.messages || []);\n        return loadEvaluationResponses(cmid, pageid, threadid);\n    }).catch((error) => {\n        Notification.addNotification({\n            message: error.message || 'Failed to load review conversation.',\n            type: 'error',\n        });\n    });\n};\n\nconst bindHandlers = () => {\n    $(document).on('click', '.review-thread-item', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const threadid = parseInt(button.data('thread-id'), 10);\n        const container = $(`.review-conversation-container[data-pageid=\"${pageid}\"]`);\n        const cmid = parseInt(container.data('cmid'), 10);\n\n        if (!pageid || !threadid || !cmid) {\n            return;\n        }\n\n        $(`.review-thread-item[data-pageid=\"${pageid}\"]`).removeClass('active');\n        button.addClass('active');\n        loadThread(cmid, pageid, threadid);\n    });\n};\n\nexport const init = () => {\n    if (!initialized) {\n        bindHandlers();\n        initialized = true;\n    }\n\n    $('.review-conversation-container').each(function() {\n        const container = $(this);\n        const pageid = parseInt(container.data('pageid'), 10);\n        const cmid = parseInt(container.data('cmid'), 10);\n        const defaultthread = parseInt(container.data('review-default-thread-id'), 10);\n        if (!pageid || !cmid || !defaultthread) {\n            return;\n        }\n        const defaultButton = container.find(`.review-thread-item[data-thread-id=\"${defaultthread}\"]`);\n        if (defaultButton.length) {\n            defaultButton.trigger('click');\n        }\n    });\n};\n\n"],"names":["initialized","ajaxPost","params","fetch","Config","wwwroot","method","headers","body","toString","then","response","json","clearQuestionInputs","pageid","each","item","this","questiontype","data","find","prop","val","attr","remove","hide","empty","removeClass","addClass","loadEvaluationResponses","cmid","threadid","responseParams","URLSearchParams","action","String","sesskey","success","Error","message","targetid","responses","Object","keys","forEach","questionid","questionItem","length","questionType","responseValue","values","JSON","parse","e","Array","isArray","value","setQuestionValue","loadThread","messages","container","msg","roleClass","role","roleLabel","charAt","toUpperCase","slice","row","append","timecreated","content","scrollTop","html","renderMessages","catch","error","addNotification","type","bindHandlers","document","on","preventDefault","button","parseInt","defaultthread","defaultButton","trigger"],"mappings":"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"}
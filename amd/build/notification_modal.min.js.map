{"version":3,"file":"notification_modal.min.js","sources":["../src/notification_modal.js"],"sourcesContent":["import {get_string as getString} from 'core/str';\nimport Notification from 'core/notification';\nimport $ from 'jquery';\n\nconst MODAL_ID = 'harpiasurvey-notification-modal';\nlet cachedStrings = null;\nlet observerStarted = false;\nlet notificationPatched = false;\n\nconst getType = (node) => {\n    const el = $(node);\n    if (el.hasClass('alert-danger') || el.hasClass('alert-error')) {\n        return 'danger';\n    }\n    if (el.hasClass('alert-success')) {\n        return 'success';\n    }\n    if (el.hasClass('alert-warning')) {\n        return 'warning';\n    }\n    return 'info';\n};\n\nconst getStrings = () => {\n    if (cachedStrings) {\n        return Promise.resolve(cachedStrings);\n    }\n\n    return Promise.all([\n        getString('notifications', 'mod_harpiasurvey').catch(() => 'Notifications'),\n        getString('close', 'moodle').catch(() => 'Close'),\n        getString('success', 'moodle').catch(() => 'Success'),\n        getString('error', 'moodle').catch(() => 'Error'),\n        getString('warning', 'moodle').catch(() => 'Warning'),\n        getString('info', 'moodle').catch(() => 'Info')\n    ]).then((strings) => {\n        cachedStrings = {\n            title: strings[0],\n            closeLabel: strings[1],\n            labels: {\n                success: strings[2],\n                danger: strings[3],\n                warning: strings[4],\n                info: strings[5]\n            }\n        };\n        return cachedStrings;\n    });\n};\n\nconst buildModal = (title, closeLabel, items) => {\n    const bodyItems = items.map((item) => {\n        const badgeClass = item.type === 'danger' ? 'danger' :\n            (item.type === 'success' ? 'success' : (item.type === 'warning' ? 'warning' : 'info'));\n        return `\n            <div class=\"alert alert-${item.type} mb-2\" role=\"alert\">\n                <span class=\"badge badge-${badgeClass} mr-2\">${item.label}</span>\n                <span>${item.html}</span>\n            </div>\n        `;\n    }).join('');\n\n    return `\n        <div class=\"modal fade\" id=\"${MODAL_ID}\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog modal-dialog-centered\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header\">\n                        <h5 class=\"modal-title\">${title}</h5>\n                        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"${closeLabel}\"></button>\n                    </div>\n                    <div class=\"modal-body\">\n                        ${bodyItems}\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-primary\" data-bs-dismiss=\"modal\">${closeLabel}</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n};\n\nconst collectAlerts = (root) => {\n    const notices = root.find('.alert').filter(function() {\n        const el = $(this);\n        return el.text().trim().length > 0 && !el.attr('data-harpia-notification-handled');\n    });\n    return notices;\n};\n\nconst showItemsInModal = (items) => {\n    if (!items || !items.length) {\n        return;\n    }\n\n    getStrings().then((strings) => {\n        const normalized = items.map((item) => {\n            const type = item.type || 'info';\n            return {\n                type: type,\n                label: strings.labels[type] || strings.labels.info,\n                html: item.html || ''\n            };\n        }).filter((item) => item.html.trim() !== '');\n\n        if (!normalized.length) {\n            return;\n        }\n\n        const existing = $(`#${MODAL_ID}`);\n        if (existing.length) {\n            existing.remove();\n        }\n\n        $('body').append(buildModal(strings.title, strings.closeLabel, normalized));\n        const root = $('#user-notifications');\n        if (root.length) {\n            root.hide();\n        }\n\n        const modalElement = document.getElementById(MODAL_ID);\n        if (!modalElement) {\n            return;\n        }\n        const modal = new window.bootstrap.Modal(modalElement);\n        modal.show();\n    });\n};\n\nconst showAlertsInModal = (root) => {\n    const notices = collectAlerts(root);\n    if (!notices.length) {\n        return;\n    }\n\n    getStrings().then((strings) => {\n        const items = [];\n        notices.each(function() {\n            const el = $(this);\n            const type = getType(this);\n            items.push({\n                type: type,\n                label: strings.labels[type] || strings.labels.info,\n                html: el.html()\n            });\n            el.attr('data-harpia-notification-handled', '1');\n            el.remove();\n        });\n\n        if (!items.length) {\n            return;\n        }\n\n        showItemsInModal(items);\n    });\n};\n\nconst startObserver = (root) => {\n    if (observerStarted) {\n        return;\n    }\n    observerStarted = true;\n\n    const observer = new MutationObserver(() => {\n        showAlertsInModal(root);\n    });\n\n    if (root.length && root[0]) {\n        observer.observe(root[0], {\n            childList: true,\n            subtree: true\n        });\n    }\n};\n\nconst patchCoreNotifications = () => {\n    if (notificationPatched || !Notification || typeof Notification.addNotification !== 'function') {\n        return;\n    }\n\n    const originalAddNotification = Notification.addNotification.bind(Notification);\n    Notification.addNotification = (data = {}) => {\n        const message = data.message;\n        const html = Array.isArray(message) ? message.join('<br>') : String(message || '');\n\n        if (!html.trim()) {\n            return originalAddNotification(data);\n        }\n\n        showItemsInModal([{\n            type: data.type || 'info',\n            html: html\n        }]);\n\n        // Prevent top-of-page duplicate notifications for Harpia pages.\n        return Promise.resolve();\n    };\n\n    notificationPatched = true;\n};\n\nexport const init = () => {\n    if (!window.bootstrap || !window.bootstrap.Modal) {\n        return;\n    }\n    const root = $('#user-notifications');\n    if (!root.length) {\n        return;\n    }\n\n    showAlertsInModal(root);\n    startObserver(root);\n    patchCoreNotifications();\n};\n"],"names":["MODAL_ID","cachedStrings","observerStarted","notificationPatched","getStrings","Promise","resolve","all","catch","then","strings","title","closeLabel","labels","success","danger","warning","info","collectAlerts","root","find","filter","el","this","text","trim","length","attr","showItemsInModal","items","normalized","map","item","type","label","html","existing","remove","append","bodyItems","badgeClass","join","buildModal","hide","modalElement","document","getElementById","window","bootstrap","Modal","show","showAlertsInModal","notices","each","node","hasClass","getType","push","observer","MutationObserver","observe","childList","subtree","startObserver","Notification","addNotification","originalAddNotification","bind","data","message","Array","isArray","String","patchCoreNotifications"],"mappings":"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"}
{"version":3,"file":"notification_modal.min.js","sources":["../src/notification_modal.js"],"sourcesContent":["import {get_string as getString} from 'core/str';\nimport Notification from 'core/notification';\nimport $ from 'jquery';\n\nconst MODAL_ID = 'harpiasurvey-notification-modal';\nlet cachedStrings = null;\nlet observerStarted = false;\nlet notificationPatched = false;\nlet modalInitialized = false;\n\nconst getType = (node) => {\n    const el = $(node);\n    if (el.hasClass('alert-danger') || el.hasClass('alert-error')) {\n        return 'danger';\n    }\n    if (el.hasClass('alert-success')) {\n        return 'success';\n    }\n    if (el.hasClass('alert-warning')) {\n        return 'warning';\n    }\n    return 'info';\n};\n\nconst getStrings = () => {\n    if (cachedStrings) {\n        return Promise.resolve(cachedStrings);\n    }\n\n    return Promise.all([\n        getString('notifications', 'mod_harpiasurvey').catch(() => 'Notifications'),\n        getString('notificationclose', 'mod_harpiasurvey').catch(() => 'Close'),\n        getString('notificationsuccess', 'mod_harpiasurvey').catch(() => 'Success'),\n        getString('notificationerror', 'mod_harpiasurvey').catch(() => 'Error'),\n        getString('notificationwarning', 'mod_harpiasurvey').catch(() => 'Warning'),\n        getString('notificationinfo', 'mod_harpiasurvey').catch(() => 'Info')\n    ]).then((strings) => {\n        cachedStrings = {\n            title: strings[0],\n            closeLabel: strings[1],\n            labels: {\n                success: strings[2],\n                danger: strings[3],\n                warning: strings[4],\n                info: strings[5]\n            }\n        };\n        return cachedStrings;\n    });\n};\n\nconst buildModal = (title, closeLabel, items) => {\n    const bodyItems = items.map((item) => {\n        const badgeClass = item.type === 'danger' ? 'danger' :\n            (item.type === 'success' ? 'success' : (item.type === 'warning' ? 'warning' : 'info'));\n        return `\n            <div class=\"alert alert-${item.type} mb-2\" role=\"alert\">\n                <span class=\"badge badge-${badgeClass} d-inline-block mb-1\">${item.label}</span>\n                <div>${item.html}</div>\n            </div>\n        `;\n    }).join('');\n\n    return `\n        <div class=\"modal fade\" id=\"${MODAL_ID}\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog modal-dialog-centered\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header\">\n                        <h5 class=\"modal-title\">${title}</h5>\n                        <button type=\"button\" class=\"close ml-auto ms-auto\" data-dismiss=\"modal\" data-bs-dismiss=\"modal\" aria-label=\"${closeLabel}\">\n                            <span aria-hidden=\"true\">&times;</span>\n                        </button>\n                    </div>\n                    <div class=\"modal-body\">\n                        ${bodyItems}\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-primary\" data-dismiss=\"modal\" data-bs-dismiss=\"modal\">${closeLabel}</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n};\n\nconst showModal = (modalElement) => {\n    if (!modalElement) {\n        return;\n    }\n\n    if (window.bootstrap && window.bootstrap.Modal) {\n        const modal = window.bootstrap.Modal.getOrCreateInstance(modalElement);\n        modal.show();\n        return;\n    }\n\n    if (typeof $ !== 'undefined' && $.fn && typeof $.fn.modal === 'function') {\n        $(modalElement).modal('show');\n    }\n};\n\nconst collectAlerts = (root) => {\n    const notices = root.find('.alert').filter(function() {\n        const el = $(this);\n        return el.text().trim().length > 0 && !el.attr('data-harpia-notification-handled');\n    });\n    return notices;\n};\n\nconst showItemsInModal = (items) => {\n    if (!items || !items.length) {\n        return;\n    }\n\n    getStrings().then((strings) => {\n        const normalized = items.map((item) => {\n            const type = item.type || 'info';\n            return {\n                type: type,\n                label: strings.labels[type] || strings.labels.info,\n                html: item.html || ''\n            };\n        }).filter((item) => item.html.trim() !== '');\n\n        if (!normalized.length) {\n            return;\n        }\n\n        const existing = $(`#${MODAL_ID}`);\n        if (existing.length === 0) {\n            $('body').append(buildModal(strings.title, strings.closeLabel, normalized));\n            modalInitialized = true;\n        } else if (!modalInitialized) {\n            existing.replaceWith(buildModal(strings.title, strings.closeLabel, normalized));\n            modalInitialized = true;\n        } else {\n            existing.find('.modal-title').text(strings.title);\n            existing.find('.modal-body').html(normalized.map((item) => {\n                const badgeClass = item.type === 'danger' ? 'danger' :\n                    (item.type === 'success' ? 'success' : (item.type === 'warning' ? 'warning' : 'info'));\n                return `\n                    <div class=\"alert alert-${item.type} mb-2\" role=\"alert\">\n                        <span class=\"badge badge-${badgeClass} d-inline-block mb-1\">${item.label}</span>\n                        <div>${item.html}</div>\n                    </div>\n                `;\n            }).join(''));\n        }\n        const root = $('#user-notifications');\n        if (root.length) {\n            root.hide();\n        }\n\n        const modalElement = document.getElementById(MODAL_ID);\n        showModal(modalElement);\n    });\n};\n\nconst showAlertsInModal = (root) => {\n    const notices = collectAlerts(root);\n    if (!notices.length) {\n        return;\n    }\n\n    getStrings().then((strings) => {\n        const items = [];\n        notices.each(function() {\n            const el = $(this);\n            const type = getType(this);\n            items.push({\n                type: type,\n                label: strings.labels[type] || strings.labels.info,\n                html: el.html()\n            });\n            el.attr('data-harpia-notification-handled', '1');\n            el.remove();\n        });\n\n        if (!items.length) {\n            return;\n        }\n\n        showItemsInModal(items);\n    });\n};\n\nconst startObserver = (root) => {\n    if (observerStarted) {\n        return;\n    }\n    observerStarted = true;\n\n    const observer = new MutationObserver(() => {\n        showAlertsInModal(root);\n    });\n\n    if (root.length && root[0]) {\n        observer.observe(root[0], {\n            childList: true,\n            subtree: true\n        });\n    }\n};\n\nconst patchCoreNotifications = () => {\n    if (notificationPatched || !Notification || typeof Notification.addNotification !== 'function') {\n        return;\n    }\n\n    const originalAddNotification = Notification.addNotification.bind(Notification);\n    Notification.addNotification = (data = {}) => {\n        const message = data.message;\n        const html = Array.isArray(message) ? message.join('<br>') : String(message || '');\n\n        if (!html.trim()) {\n            return originalAddNotification(data);\n        }\n\n        showItemsInModal([{\n            type: data.type || 'info',\n            html: html\n        }]);\n\n        // Prevent top-of-page duplicate notifications for Harpia pages.\n        return Promise.resolve();\n    };\n\n    notificationPatched = true;\n};\n\nexport const init = () => {\n    patchCoreNotifications();\n\n    const root = $('#user-notifications');\n    if (root.length) {\n        showAlertsInModal(root);\n        startObserver(root);\n    }\n};\n"],"names":["MODAL_ID","cachedStrings","observerStarted","notificationPatched","modalInitialized","getStrings","Promise","resolve","all","catch","then","strings","title","closeLabel","labels","success","danger","warning","info","buildModal","items","bodyItems","map","item","badgeClass","type","label","html","join","collectAlerts","root","find","filter","el","this","text","trim","length","attr","showItemsInModal","normalized","existing","append","replaceWith","hide","modalElement","window","bootstrap","Modal","getOrCreateInstance","show","$","fn","modal","showModal","document","getElementById","showAlertsInModal","notices","each","node","hasClass","getType","push","remove","Notification","addNotification","originalAddNotification","bind","data","message","Array","isArray","String","patchCoreNotifications","observer","MutationObserver","observe","childList","subtree","startObserver"],"mappings":"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"}
{"version":3,"file":"common_chat.min.js","sources":["../src/common_chat.js"],"sourcesContent":["// Shared utilities and state for harpiasurvey chat modules.\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport Config from 'core/config';\nimport {get_string as getString} from 'core/str';\nimport $ from 'jquery';\n\n// Shared state\nconst currentTurns = {};\nconst conversationTrees = {};\n\n// Expose shared dependencies\nexport {Templates, Notification, Config, getString, $};\nexport {currentTurns, conversationTrees};\n\n// Helper: scroll to bottom\nexport const scrollToBottom = (pageid) => {\n    const messagesContainer = $(`#chat-messages-page-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    requestAnimationFrame(() => {\n        const container = messagesContainer[0];\n        if (container) {\n            container.scrollTop = container.scrollHeight;\n        }\n    });\n};\n\n// Helper: add a notification\nexport const addError = (message) => {\n    Notification.addNotification({message, type: 'error'});\n};\n\n// Helper: get cmid for a page\nexport const getCmid = (pageid) => {\n    const container = $(`#chat-messages-page-${pageid}`).closest('.ai-conversation-container');\n    return container.data('cmid');\n};\n\n// Helper: find root node containing a turn\nexport const findRootForTurn = (roots, turnId) => {\n    const findInNode = (node, targetId) => {\n        if (parseInt(node.turn_id, 10) === parseInt(targetId, 10)) {\n            return true;\n        }\n        if (node.direct_branches) {\n            for (const db of node.direct_branches) {\n                if (parseInt(db.turn_id, 10) === parseInt(targetId, 10)) {\n                    return true;\n                }\n                if (db.children) {\n                    for (const child of db.children) {\n                        if (findInNode(child, targetId)) {\n                            return true;\n                        }\n                    }\n                }\n            }\n        }\n        if (node.children) {\n            for (const child of node.children) {\n                if (findInNode(child, targetId)) {\n                    return true;\n                }\n            }\n        }\n        return false;\n    };\n    for (const root of roots) {\n        if (findInNode(root, turnId)) {\n            return root;\n        }\n    }\n    return null;\n};\n\n// Helper: count nodes (including direct branches)\nexport const countNodes = (node) => {\n    let count = 1;\n    if (node.direct_branches) {\n        node.direct_branches.forEach(branch => {\n            count += countNodes(branch);\n        });\n    }\n    if (node.children) {\n        node.children.forEach(child => {\n            count += countNodes(child);\n        });\n    }\n    return count;\n};\n\n// Helper: calculate hierarchical turn number\nexport const calculateTurnNumber = (node, turnIndex, parentNumber) => {\n    if (node.is_root || node.is_direct_branch) {\n        return String(turnIndex + 1);\n    }\n    const branchIndex = turnIndex + 1;\n    return parentNumber ? `${parentNumber}.${branchIndex}` : String(branchIndex);\n};\n\n// Helper: render conversation list\nexport const renderConversationList = (pageid, roots) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    const rootsWithCount = roots.map((root, idx) => ({\n        ...root,\n        conversation_id: root.conversation_id || root.turn_id,\n        turn_count: countNodes(root),\n        conversation_number: root.conversation_number || idx + 1\n    }));\n    Templates.render('mod_harpiasurvey/conversation_list', {\n        roots: rootsWithCount,\n        pageid: pageid\n    }).then((html) => {\n        treeContainer.html(html);\n    }).catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error rendering conversation list:', error);\n    });\n};\n"],"names":["pageid","messagesContainer","length","requestAnimationFrame","container","scrollTop","scrollHeight","message","addNotification","type","closest","data","roots","turnId","findInNode","node","targetId","parseInt","turn_id","direct_branches","db","children","child","root","countNodes","count","forEach","branch","turnIndex","parentNumber","is_root","is_direct_branch","String","branchIndex","treeContainer","rootsWithCount","map","idx","conversation_id","turn_count","conversation_number","render","then","html","catch","error","console"],"mappings":"iuCAQqB,8BACK,2BAOKA,eACrBC,mBAAoB,mBAAG,uBAAsBD,UAClB,IAA7BC,kBAAkBC,QAGtBC,uBAAsB,WACZC,UAAYH,kBAAkB,GAChCG,YACAA,UAAUC,UAAYD,UAAUE,oCAMnBC,gCACRC,gBAAgB,CAACD,QAAAA,QAASE,KAAM,4BAIzBT,SACF,mBAAG,uBAAsBA,UAAUU,QAAQ,8BAC5CC,KAAK,iCAIK,CAACC,MAAOC,gBAC7BC,WAAa,CAACC,KAAMC,eAClBC,SAASF,KAAKG,QAAS,MAAQD,SAASD,SAAU,WAC3C,KAEPD,KAAKI,oBACA,MAAMC,MAAML,KAAKI,gBAAiB,IAC/BF,SAASG,GAAGF,QAAS,MAAQD,SAASD,SAAU,WACzC,KAEPI,GAAGC,aACE,MAAMC,SAASF,GAAGC,YACfP,WAAWQ,MAAON,iBACX,KAMvBD,KAAKM,aACA,MAAMC,SAASP,KAAKM,YACjBP,WAAWQ,MAAON,iBACX,SAIZ,OAEN,MAAMO,QAAQX,SACXE,WAAWS,KAAMV,eACVU,YAGR,YAIEC,WAAcT,WACnBU,MAAQ,SACRV,KAAKI,iBACLJ,KAAKI,gBAAgBO,SAAQC,SACzBF,OAASD,WAAWG,WAGxBZ,KAAKM,UACLN,KAAKM,SAASK,SAAQJ,QAClBG,OAASD,WAAWF,UAGrBG,mEAIwB,CAACV,KAAMa,UAAWC,mBAC7Cd,KAAKe,SAAWf,KAAKgB,wBACdC,OAAOJ,UAAY,SAExBK,YAAcL,UAAY,SACzBC,aAAgB,GAAEA,gBAAgBI,cAAgBD,OAAOC,8CAI9B,CAACjC,OAAQY,eACrCsB,eAAgB,mBAAG,sBAAqBlC,UACxCmC,eAAiBvB,MAAMwB,KAAI,CAACb,KAAMc,WACjCd,KACHe,gBAAiBf,KAAKe,iBAAmBf,KAAKL,QAC9CqB,WAAYf,WAAWD,MACvBiB,oBAAqBjB,KAAKiB,qBAAuBH,IAAM,yBAEjDI,OAAO,qCAAsC,CACnD7B,MAAOuB,eACPnC,OAAQA,SACT0C,MAAMC,OACLT,cAAcS,KAAKA,SACpBC,OAAOC,QAENC,QAAQD,MAAM,qCAAsCA"}
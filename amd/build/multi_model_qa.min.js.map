{"version":3,"file":"multi_model_qa.min.js","sources":["../src/multi_model_qa.js"],"sourcesContent":["// Q&A logic for multi-model tabs.\nimport {\n    Templates,\n    Notification,\n    Config,\n    getString,\n    $,\n    addError\n} from './common_chat';\n\nlet initialized = false;\nlet handlersRegistered = false;\nconst qaEvaluationSaved = {};\nlet editLabel = 'Edit';\n\nconst getMultiQaContainer = (pageid) => $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n\nconst getQaQuestionCount = (pageid, modelid) => {\n    const list = $(`.qa-questions-list[data-pageid=\"${pageid}\"][data-model-id=\"${modelid}\"]`);\n    if (list.length === 0) {\n        return 0;\n    }\n    return list.find('.qa-question-item').length;\n};\n\nconst getQaMaxQuestions = (pageid) => {\n    const container = getMultiQaContainer(pageid);\n    if (container.length === 0) {\n        return null;\n    }\n    const value = parseInt(container.data('max-qa-questions') || container.attr('data-max-qa-questions'), 10);\n    return Number.isFinite(value) && value > 0 ? value : null;\n};\n\nconst isQaQuestionLimitReached = (pageid, modelid) => {\n    const maxQuestions = getQaMaxQuestions(pageid);\n    if (!maxQuestions) {\n        return false;\n    }\n    return getQaQuestionCount(pageid, modelid) >= maxQuestions;\n};\n\nconst notifyQaMaxQuestionsReached = () => {\n    getString('maxqaquestionsreached', 'mod_harpiasurvey').then((message) => {\n        Notification.addNotification({\n            message: message,\n            type: 'warning'\n        });\n    }).catch(() => {\n        Notification.addNotification({\n            message: 'Maximum number of questions reached. You cannot add more questions.',\n            type: 'warning'\n        });\n    });\n};\n\nconst lockQuestionItem = (questionItem) => {\n    questionItem.attr('data-response-locked', '1');\n    questionItem.removeAttr('data-response-editing');\n    questionItem.find('input, select, textarea').prop('disabled', true);\n};\n\nconst ensureEditButton = (questionItem) => {\n    let controls = questionItem.find('.question-edit-controls');\n    if (controls.length === 0) {\n        controls = $('<div class=\"mt-2 question-edit-controls\"></div>');\n        questionItem.append(controls);\n    }\n    let button = controls.find('.question-edit-btn');\n    if (button.length === 0) {\n        button = $('<button type=\"button\" class=\"btn btn-sm btn-outline-secondary question-edit-btn\"></button>');\n        controls.append(button);\n    }\n    button.text(editLabel);\n    button.show();\n};\n\nconst resetQuestionItemToNeutral = (questionItem) => {\n    if (!questionItem || questionItem.length === 0) {\n        return;\n    }\n\n    questionItem.removeAttr('data-response-locked');\n    questionItem.removeAttr('data-response-editing');\n    questionItem.find('.saved-response-message').remove();\n    questionItem.find('.answer-history').remove();\n    questionItem.find('.question-edit-controls').remove();\n\n    questionItem.find('input, select, textarea').prop('disabled', false);\n\n    questionItem.find('input[type=\"radio\"], input[type=\"checkbox\"]').each(function() {\n        $(this).prop('checked', Boolean(this.defaultChecked));\n    });\n\n    questionItem.find('select').each(function() {\n        const select = $(this);\n        const defaultOption = select.find('option').filter(function() {\n            return this.defaultSelected;\n        }).first();\n        if (defaultOption.length > 0) {\n            select.val(defaultOption.val());\n        } else {\n            select.prop('selectedIndex', 0);\n        }\n    });\n\n    questionItem.find('input[type=\"number\"], input[type=\"text\"], textarea').each(function() {\n        $(this).val(this.defaultValue || '');\n    });\n};\n\nexport const init = () => initialize();\n\nconst stateKey = (pageid, modelid) => `${pageid}_${modelid}`;\n\nconst initialize = () => {\n    if (initialized) {\n        return;\n    }\n    getString('edit', 'moodle').then((str) => {\n        editLabel = str;\n    }).catch(() => {\n        editLabel = 'Edit';\n    });\n\n    const containers = $('.multi-model-chat-container[data-behavior=\"qa\"]');\n    if (containers.length === 0) {\n        return;\n    }\n\n    containers.each(function() {\n        const pageid = parseInt($(this).data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n\n        $(this).find('.tab-pane[data-model-id]').each(function() {\n            const pane = $(this);\n            const modelid = parseInt(pane.data('model-id'), 10);\n            if (!modelid) {\n                return;\n            }\n\n            const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n            if (messagesContainer.find('.message[data-role=\"assistant\"]').length > 0) {\n                lockQaInput(pageid, modelid);\n            }\n            if (isQaQuestionLimitReached(pageid, modelid)) {\n                lockQaInput(pageid, modelid);\n            }\n\n            const activeId = parseInt(pane.data('qa-active-id'), 10);\n            if (activeId) {\n                selectQaQuestion(pageid, modelid, activeId);\n            }\n        });\n    });\n\n    registerHandlers();\n    initialized = true;\n};\n\nfunction registerHandlers() {\n    if (handlersRegistered) {\n        return;\n    }\n\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"qa\"] .chat-send-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const modelid = parseInt(button.data('model-id') || button.data('modelId'), 10);\n\n        if (!cmid || !pageid || !modelid) {\n            addError('Missing cmid, pageid or modelid');\n            return;\n        }\n        if (isQaQuestionLimitReached(pageid, modelid)) {\n            notifyQaMaxQuestionsReached();\n            return;\n        }\n\n        if (hasUnsavedQaEvaluation(pageid, modelid)) {\n            getString('qarequiresave', 'mod_harpiasurvey').then((message) => {\n                Notification.addNotification({\n                    message: message,\n                    type: 'warning'\n                });\n            }).catch(() => {\n                Notification.addNotification({\n                    message: 'Please save the evaluation answers before starting a new question.',\n                    type: 'warning'\n                });\n            });\n            return;\n        }\n\n        const input = $(`#chat-input-model-${modelid}-${pageid}`);\n        if (input.length === 0) {\n            addError('Chat input not found');\n            return;\n        }\n\n        const inputValue = input.val();\n        if (!inputValue) {\n            return;\n        }\n\n        const message = inputValue.trim();\n        if (!message) {\n            return;\n        }\n\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n        input.val('');\n\n        const tempId = 'temp-user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n        displayUserMessage(pageid, modelid, message, tempId);\n        addQaQuestionItem(pageid, modelid, tempId, message);\n        selectQaQuestion(pageid, modelid, tempId);\n\n        const loading = $(`#chat-loading-model-${modelid}-${pageid}`);\n        loading.show();\n        sendMessage(cmid, pageid, modelid, message, button, input, loading);\n    });\n\n    $(document).on('keydown', '.multi-model-chat-container[data-behavior=\"qa\"] .chat-input', function(e) {\n        if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault();\n            const input = $(this);\n            const pageid = parseInt(input.data('pageid'), 10);\n            const modelid = parseInt(input.data('model-id') || input.data('modelId'), 10);\n            $(`#send-message-btn-model-${modelid}-${pageid}`).click();\n        }\n    });\n\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"qa\"] .new-question-btn', function(e) {\n        e.preventDefault();\n        const pageid = parseInt($(this).data('pageid'), 10);\n        const modelid = parseInt($(this).data('model-id') || $(this).data('modelId'), 10);\n        if (!pageid || !modelid) {\n            return;\n        }\n        if (isQaQuestionLimitReached(pageid, modelid)) {\n            notifyQaMaxQuestionsReached();\n            return;\n        }\n\n        if (hasUnsavedQaEvaluation(pageid, modelid)) {\n            getString('qarequiresave', 'mod_harpiasurvey').then((message) => {\n                Notification.addNotification({\n                    message: message,\n                    type: 'warning'\n                });\n            }).catch(() => {\n                Notification.addNotification({\n                    message: 'Please save the evaluation answers before starting a new question.',\n                    type: 'warning'\n                });\n            });\n            return;\n        }\n\n        resetQaView(pageid, modelid);\n    });\n\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"qa\"] .qa-question-item', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const modelid = parseInt(button.data('model-id') || button.data('modelId'), 10);\n        const questionId = button.data('question-id');\n        if (!pageid || !modelid || !questionId) {\n            return;\n        }\n        selectQaQuestion(pageid, modelid, questionId);\n    });\n\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"qa\"] .export-conversation-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const modelid = parseInt(button.data('model-id') || button.data('modelId'), 10);\n        if (!pageid || !cmid) {\n            addError('Missing required data to export conversation');\n            return;\n        }\n\n        const pane = $(`#model-pane-${modelid}-${pageid}`);\n        const activeId = parseInt(pane.data('qa-active-id') || pane.attr('data-qa-active-id'), 10);\n\n        const params = new URLSearchParams();\n        params.append('action', 'export_conversation');\n        params.append('cmid', cmid);\n        params.append('pageid', pageid);\n        params.append('sesskey', Config.sesskey);\n        if (modelid && !isNaN(modelid)) {\n            params.append('modelid', modelid);\n        }\n        if (activeId && !isNaN(activeId)) {\n            params.append('turn_id', activeId);\n        }\n\n        window.open(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), '_blank');\n    });\n\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"qa\"] .qa-evaluation-questions-container .save-turn-evaluation-questions-btn', function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const button = $(this);\n        const turnId = parseInt(button.data('turn-id'), 10);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const modelid = parseInt(button.closest('.tab-pane[data-model-id]').data('model-id'), 10);\n\n        if (!turnId || !pageid || !cmid || !modelid) {\n            Notification.addNotification({\n                message: 'Missing required data to save responses.',\n                type: 'error'\n            });\n            return;\n        }\n\n        const evaluationContainer = button.closest('.turn-evaluation-questions');\n        if (evaluationContainer.length === 0) {\n            return;\n        }\n\n        const responses = {};\n        evaluationContainer.find('[data-questionid]').each(function() {\n            const item = $(this);\n            const isLocked = String(item.attr('data-response-locked')) === '1';\n            const isEditing = String(item.attr('data-response-editing')) === '1';\n            if (isLocked && !isEditing) {\n                return;\n            }\n            const questionId = $(this).data('questionid');\n            const questionType = $(this).data('questiontype');\n            let responseValue = null;\n\n            if (questionType === 'multiplechoice') {\n                const checked = evaluationContainer.find(`input[name=\"question_${questionId}_turn[]\"]:checked`);\n                const values = [];\n                checked.each(function() {\n                    values.push($(this).val());\n                });\n                responseValue = values.length > 0 ? JSON.stringify(values) : null;\n            } else if (questionType === 'select' || questionType === 'singlechoice' || questionType === 'likert') {\n                const selectSelector = `select[name=\"question_${questionId}_turn\"]`;\n                const inputSelector = `input[name=\"question_${questionId}_turn\"]:checked`;\n                const selected = evaluationContainer.find(`${selectSelector}, ${inputSelector}`);\n                responseValue = selected.length > 0 ? selected.val() : null;\n            } else if (questionType === 'number' || questionType === 'shorttext') {\n                const input = evaluationContainer.find(`input[name=\"question_${questionId}_turn\"]`);\n                responseValue = input.length > 0 ? input.val() : null;\n            } else if (questionType === 'longtext') {\n                const textarea = evaluationContainer.find(`textarea[name=\"question_${questionId}_turn\"]`);\n                responseValue = textarea.length > 0 ? textarea.val() : null;\n            }\n\n            if (responseValue !== null && responseValue !== '') {\n                responses[questionId] = responseValue;\n            }\n        });\n\n        if (Object.keys(responses).length === 0) {\n            Notification.addNotification({\n                message: 'No responses to save.',\n                type: 'info'\n            });\n            return;\n        }\n\n        const originalText = button.text();\n        button.prop('disabled', true);\n        button.text('Saving...');\n        saveQaEvaluationResponses(cmid, pageid, modelid, turnId, responses, button, originalText);\n    });\n\n    handlersRegistered = true;\n}\n\nconst resetQaView = (pageid, modelid) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n\n    messagesContainer.find('.message').hide();\n    const placeholder = messagesContainer.find('.qa-placeholder');\n    if (placeholder.length > 0) {\n        placeholder.show();\n    } else {\n        getString('qaplaceholder', 'mod_harpiasurvey').then((message) => {\n            messagesContainer.append('<div class=\"qa-placeholder text-muted text-center small py-3\">' + message + '</div>');\n        }).catch(() => {\n            messagesContainer.append('<div class=\"qa-placeholder text-muted text-center small py-3\">Ask a new question to get an answer.</div>');\n        });\n    }\n\n    const input = $(`#chat-input-model-${modelid}-${pageid}`);\n    if (input.length > 0) {\n        input.val('');\n        const limitReached = isQaQuestionLimitReached(pageid, modelid);\n        input.prop('disabled', limitReached);\n        const pane = $(`#model-pane-${modelid}-${pageid}`);\n        if (limitReached) {\n            pane.find('.input-group').hide();\n        } else {\n            pane.find('.input-group').show();\n        }\n        const sendButton = $(`#send-message-btn-model-${modelid}-${pageid}`);\n        sendButton.prop('disabled', limitReached);\n        pane.find('.qa-question-item').removeClass('active');\n        if (!limitReached) {\n            input.focus();\n        }\n    }\n\n    const evalContainer = $(`#qa-evaluation-questions-container-model-${modelid}-${pageid}`);\n    if (evalContainer.length > 0) {\n        evalContainer.empty();\n    }\n};\n\nconst sendMessage = (cmid, pageid, modelid, message, button, input, loading) => {\n    const params = new URLSearchParams({\n        action: 'send_ai_message',\n        cmid: cmid,\n        pageid: pageid,\n        message: message,\n        modelid: modelid,\n        sesskey: Config.sesskey\n    });\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then(response => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then(data => {\n        loading.hide();\n        if (data.success) {\n            if (data.messageid && data.content) {\n                const parentid = data.parentid || null;\n                if (parentid) {\n                    const pendingUser = $(`#chat-messages-model-${modelid}-${pageid} .message[data-role=\"user\"]`).last();\n                    if (pendingUser.length > 0) {\n                        pendingUser.attr('data-messageid', parentid);\n                    }\n                    updateQaQuestionItemId(pageid, modelid, parentid);\n                }\n                displayAIMessage(pageid, modelid, data.content, data.messageid, parentid).then(() => {\n                    lockQaInput(pageid, modelid);\n                    if (parentid) {\n                        selectQaQuestion(pageid, modelid, parentid);\n                    }\n                });\n            } else {\n                addError('Received response but missing message ID or content');\n            }\n        } else {\n            addError(data.message || 'Error sending message');\n        }\n\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    })\n    .catch(error => {\n        loading.hide();\n        // eslint-disable-next-line no-console\n        console.error('Error sending message:', error);\n        addError('Error sending message: ' + error.message);\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    });\n};\n\nconst displayUserMessage = (pageid, modelid, message, messageid) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    messagesContainer.find('.text-center.text-muted').remove();\n    messagesContainer.find('.qa-placeholder').remove();\n    Templates.render('mod_harpiasurvey/chat_user_message', {\n        id: messageid,\n        content: message,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottom(pageid, modelid);\n    }).catch(Notification.exception);\n};\n\nconst displayAIMessage = (pageid, modelid, content, messageid, parentid = null) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return Promise.resolve();\n    }\n    return Templates.render('mod_harpiasurvey/chat_ai_message', {\n        id: messageid,\n        parentid: parentid,\n        content: content,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottom(pageid, modelid);\n        return html;\n    }).catch(Notification.exception);\n};\n\nconst selectQaQuestion = (pageid, modelid, questionId) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n\n    const pane = $(`#model-pane-${modelid}-${pageid}`);\n    pane.attr('data-qa-active-id', questionId);\n    pane.data('qa-active-id', questionId);\n\n    messagesContainer.find('.qa-placeholder').hide();\n    messagesContainer.find('.message').hide();\n    messagesContainer.find(`.message[data-messageid=\"${questionId}\"], .message[data-parentid=\"${questionId}\"]`).show();\n\n    const list = $(`.qa-questions-list[data-pageid=\"${pageid}\"][data-model-id=\"${modelid}\"]`);\n    list.find('.qa-question-item').removeClass('active');\n    list.find(`.qa-question-item[data-question-id=\"${questionId}\"]`).addClass('active');\n\n    lockQaInput(pageid, modelid);\n    const evalId = parseInt(questionId, 10);\n    if (!isNaN(evalId)) {\n        renderQaEvaluationQuestions(pageid, modelid, evalId).then(() => {\n            loadQaEvaluationResponses(pageid, modelid, evalId);\n        });\n    } else {\n        const evalContainer = $(`#qa-evaluation-questions-container-model-${modelid}-${pageid}`);\n        if (evalContainer.length > 0) {\n            evalContainer.html('<div class=\"text-muted small py-2\">Evaluation will be available after the model response is received.</div>');\n        }\n    }\n};\n\nconst addQaQuestionItem = (pageid, modelid, questionId, message) => {\n    const list = $(`.qa-questions-list[data-pageid=\"${pageid}\"][data-model-id=\"${modelid}\"]`);\n    if (list.length === 0) {\n        return;\n    }\n    const preview = (message || '').trim().slice(0, 60);\n    const label = message && message.length > 60 ? preview + '...' : preview || ('Question #' + questionId);\n    const button = $('<button>', {\n        type: 'button',\n        class: 'btn btn-sm btn-outline-secondary qa-question-item',\n        'data-pageid': pageid,\n        'data-model-id': modelid,\n        'data-question-id': questionId,\n        title: label,\n        text: label\n    });\n    list.append(button);\n    if (list[0]) {\n        list.scrollTop(list[0].scrollHeight);\n    }\n};\n\nconst updateQaQuestionItemId = (pageid, modelid, newId) => {\n    const list = $(`.qa-questions-list[data-pageid=\"${pageid}\"][data-model-id=\"${modelid}\"]`);\n    const lastItem = list.find('.qa-question-item').last();\n    if (lastItem.length > 0) {\n        lastItem.attr('data-question-id', newId);\n        lastItem.data('question-id', newId);\n    }\n};\n\nconst lockQaInput = (pageid, modelid) => {\n    const pane = $(`#model-pane-${modelid}-${pageid}`);\n    const inputGroup = pane.find('.input-group');\n    if (inputGroup.length > 0) {\n        inputGroup.hide();\n    }\n    const input = $(`#chat-input-model-${modelid}-${pageid}`);\n    const sendButton = $(`#send-message-btn-model-${modelid}-${pageid}`);\n    input.prop('disabled', true);\n    sendButton.prop('disabled', true);\n};\n\nconst hasUnsavedQaEvaluation = (pageid, modelid) => {\n    const key = stateKey(pageid, modelid);\n    const pane = $(`#model-pane-${modelid}-${pageid}`);\n    const activeId = pane.data('qa-active-id');\n    if (!activeId) {\n        return false;\n    }\n    if (!qaEvaluationSaved[key]) {\n        qaEvaluationSaved[key] = {};\n    }\n    if (qaEvaluationSaved[key][activeId] === true) {\n        return false;\n    }\n    const container = $(`#qa-evaluation-questions-container-model-${modelid}-${pageid}`);\n    if (container.length === 0) {\n        return false;\n    }\n    const requiredQuestions = container.find('.question-item[data-required=\"1\"]');\n    if (requiredQuestions.length === 0) {\n        qaEvaluationSaved[key][activeId] = true;\n        return false;\n    }\n    let missing = false;\n    requiredQuestions.each(function() {\n        const item = $(this);\n        if (item.find('.saved-response-message').length === 0) {\n            missing = true;\n            return false;\n        }\n        return undefined;\n    });\n    qaEvaluationSaved[key][activeId] = !missing;\n    return missing;\n};\n\nconst renderQaEvaluationQuestions = (pageid, modelid, questionId) => {\n    const containerWrapper = $(`#qa-evaluation-questions-container-model-${modelid}-${pageid}`);\n    if (containerWrapper.length === 0) {\n        return Promise.resolve();\n    }\n\n    const key = stateKey(pageid, modelid);\n    if (!qaEvaluationSaved[key]) {\n        qaEvaluationSaved[key] = {};\n    }\n    qaEvaluationSaved[key][questionId] = false;\n\n    return getString('loading', 'moodle').then((loadingStr) => {\n        containerWrapper.html('<div class=\"text-center py-3 text-muted\"><i class=\"fa fa-spinner fa-spin\"></i> ' +\n            loadingStr + '</div>');\n\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        const cmid = parseInt(container.data('cmid') || container.attr('data-cmid'), 10);\n        const params = new URLSearchParams({\n            action: 'get_turn_questions',\n            pageid: pageid,\n            turn_id: questionId,\n            cmid: cmid,\n            sesskey: Config.sesskey\n        });\n\n        return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n            method: 'GET',\n            headers: {\n                'Content-Type': 'application/json'\n            }\n        })\n        .then(response => {\n            if (!response.ok) {\n                throw new Error('HTTP error! status: ' + response.status);\n            }\n            return response.json();\n        })\n        .then(data => {\n            if (data.success && data.html) {\n                containerWrapper.html(data.html);\n            } else {\n                containerWrapper.html('<div class=\"text-center text-muted py-3\">' +\n                    (data.message || 'No questions available for this entry.') + '</div>');\n            }\n        })\n        .catch((error) => {\n            // eslint-disable-next-line no-console\n            console.error('Error loading evaluation questions:', error);\n            containerWrapper.html('<div class=\"text-danger text-center py-3\">' +\n                'Error loading questions: ' + error.message + '</div>');\n        });\n    });\n};\n\nconst loadQaEvaluationResponses = (pageid, modelid, questionId) => {\n    const containerWrapper = $(`#qa-evaluation-questions-container-model-${modelid}-${pageid}`);\n    if (containerWrapper.length === 0) {\n        return;\n    }\n    let container = containerWrapper.find(`.turn-evaluation-questions[data-turn-id=\"${questionId}\"]`);\n    if (container.length === 0) {\n        container = containerWrapper;\n    }\n    container.find('.question-item').each(function() {\n        resetQuestionItemToNeutral($(this));\n    });\n\n    const chatContainer = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const cmid = parseInt(chatContainer.data('cmid') || chatContainer.attr('data-cmid'), 10);\n    const params = new URLSearchParams({\n        action: 'get_turn_responses',\n        cmid: cmid,\n        pageid: pageid,\n        turn_id: questionId,\n        sesskey: Config.sesskey\n    });\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then(response => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then(data => {\n        if (!data.success || !data.responses || Object.keys(data.responses).length === 0) {\n            const key = stateKey(pageid, modelid);\n            if (!qaEvaluationSaved[key]) {\n                qaEvaluationSaved[key] = {};\n            }\n            qaEvaluationSaved[key][questionId] = false;\n            return;\n        }\n        Object.keys(data.responses).forEach((qid) => {\n            const responseData = data.responses[qid];\n            const questionItem = container.find(`.question-item[data-questionid=\"${qid}\"]`);\n            if (questionItem.length === 0) {\n                return;\n            }\n            const questionType = questionItem.data('questiontype');\n            const value = responseData.response;\n\n            if (questionType === 'singlechoice' || questionType === 'likert') {\n                questionItem.find('input[type=\"radio\"]').prop('checked', false);\n                questionItem.find(`input[type=\"radio\"][value=\"${value}\"]`).prop('checked', true);\n            } else if (questionType === 'multiplechoice') {\n                questionItem.find('input[type=\"checkbox\"]').prop('checked', false);\n                try {\n                    const values = JSON.parse(value);\n                    if (Array.isArray(values)) {\n                        values.forEach((val) => {\n                            questionItem.find(`input[type=\"checkbox\"][value=\"${val}\"]`).prop('checked', true);\n                        });\n                    }\n                } catch (e) {\n                    // ignore invalid JSON\n                }\n            } else if (questionType === 'select') {\n                questionItem.find('select').val(value);\n            } else if (questionType === 'number') {\n                questionItem.find('input[type=\"number\"]').val(value);\n            } else if (questionType === 'shorttext') {\n                questionItem.find('input[type=\"text\"]').val(value);\n            } else if (questionType === 'longtext') {\n                questionItem.find('textarea').val(value);\n            }\n\n            if (responseData.saved_datetime) {\n                getString('saved', 'mod_harpiasurvey').then((savedText) => {\n                    getString('on', 'mod_harpiasurvey').then((onText) => {\n                        const icon = '<i class=\"fa fa-check-circle\" aria-hidden=\"true\"></i>';\n                        let savedMessage = questionItem.find('.saved-response-message');\n                        if (savedMessage.length === 0) {\n                            const messageHtml = '<div class=\"mt-2 small text-muted saved-response-message\">' +\n                                `${icon} ${savedText} ${onText} ${responseData.saved_datetime}</div>`;\n                            questionItem.append(messageHtml);\n                        } else {\n                            savedMessage.html(`${icon} ${savedText} ${onText} ${responseData.saved_datetime}`);\n                        }\n                        lockQuestionItem(questionItem);\n                        ensureEditButton(questionItem);\n                    });\n                });\n            }\n\n            getString('answerhistory', 'mod_harpiasurvey').then((historyText) => {\n                let history = questionItem.find('.answer-history');\n                if (!history.length && responseData.history_count > 1) {\n                    const details = $('<details class=\"answer-history mt-1\"></details>');\n                    details.append(`<summary>${historyText} (${responseData.history_count})</summary>`);\n                    details.append('<ul class=\"list-unstyled mt-2 mb-0\"></ul>');\n                    questionItem.append(details);\n                    history = details;\n                }\n                if (history.length) {\n                    const list = history.find('ul');\n                    list.empty();\n                    (responseData.history_items || []).forEach((item) => {\n                        list.append(`<li class=\"mb-1\"><span class=\"text-muted\">${item.time}</span> â€” ${item.response}</li>`);\n                    });\n                    history.find('summary').text(`${historyText} (${responseData.history_count || 0})`);\n                    if ((responseData.history_count || 0) > 1) {\n                        history.show();\n                    } else {\n                        history.hide();\n                    }\n                }\n            });\n        });\n\n        const key = stateKey(pageid, modelid);\n        if (!qaEvaluationSaved[key]) {\n            qaEvaluationSaved[key] = {};\n        }\n        const requiredQuestions = container.find('.question-item[data-required=\"1\"]');\n        if (requiredQuestions.length === 0) {\n            qaEvaluationSaved[key][questionId] = true;\n            return;\n        }\n        const requiredCount = requiredQuestions.length;\n        const savedRequired = requiredQuestions.filter(function() {\n            return $(this).find('.saved-response-message').length > 0;\n        }).length;\n        qaEvaluationSaved[key][questionId] = (requiredCount > 0 && savedRequired === requiredCount);\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error loading evaluation responses:', error);\n    });\n};\n\nconst saveQaEvaluationResponses = (cmid, pageid, modelid, questionId, responses, button, originalText) => {\n    const entries = Object.entries(responses);\n    let failedCount = 0;\n\n    let promiseChain = Promise.resolve();\n    entries.forEach(([qid, response]) => {\n        promiseChain = promiseChain.then(() => {\n            const params = new URLSearchParams({\n                action: 'save_response',\n                cmid: cmid,\n                pageid: pageid,\n                questionid: qid,\n                response: response,\n                turn_id: questionId,\n                sesskey: Config.sesskey\n            });\n\n            return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n                method: 'GET',\n                headers: {\n                    'Content-Type': 'application/json'\n                }\n            })\n            .then(res => res.json())\n            .then(data => {\n                if (!data.success) {\n                    failedCount++;\n                }\n            })\n            .catch(() => {\n                failedCount++;\n            });\n        });\n    });\n\n    promiseChain.then(() => {\n        button.prop('disabled', false);\n        button.text(originalText);\n        if (failedCount === 0) {\n            Notification.addNotification({\n                message: 'Responses saved.',\n                type: 'success'\n            });\n        } else {\n            Notification.addNotification({\n                message: 'Some responses failed to save.',\n                type: 'warning'\n            });\n        }\n        const key = stateKey(pageid, modelid);\n        if (!qaEvaluationSaved[key]) {\n            qaEvaluationSaved[key] = {};\n        }\n        qaEvaluationSaved[key][questionId] = false;\n        loadQaEvaluationResponses(pageid, modelid, questionId);\n    });\n};\n\nconst scrollToBottom = (pageid, modelid) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length > 0) {\n        messagesContainer.scrollTop(messagesContainer[0].scrollHeight);\n    }\n};\n"],"names":["initialized","handlersRegistered","qaEvaluationSaved","editLabel","getQaMaxQuestions","pageid","container","getMultiQaContainer","length","value","parseInt","data","attr","Number","isFinite","isQaQuestionLimitReached","modelid","maxQuestions","list","find","getQaQuestionCount","notifyQaMaxQuestionsReached","then","message","addNotification","type","catch","resetQuestionItemToNeutral","questionItem","removeAttr","remove","prop","each","this","Boolean","defaultChecked","select","defaultOption","filter","defaultSelected","first","val","defaultValue","initialize","stateKey","str","containers","pane","lockQaInput","activeId","selectQaQuestion","document","on","e","preventDefault","button","cmid","hasUnsavedQaEvaluation","input","inputValue","trim","tempId","Date","now","Math","random","toString","substr","displayUserMessage","addQaQuestionItem","loading","show","sendMessage","key","shiftKey","click","resetQaView","questionId","params","URLSearchParams","append","Config","sesskey","isNaN","window","open","wwwroot","stopPropagation","turnId","closest","evaluationContainer","responses","item","isLocked","String","isEditing","questionType","responseValue","checked","values","push","JSON","stringify","selectSelector","inputSelector","selected","textarea","Object","keys","originalText","text","saveQaEvaluationResponses","registerHandlers","messagesContainer","hide","placeholder","limitReached","removeClass","focus","evalContainer","empty","action","fetch","method","headers","response","ok","Error","status","json","success","messageid","content","parentid","pendingUser","last","updateQaQuestionItemId","displayAIMessage","error","console","render","id","timecreated","floor","html","scrollToBottom","Notification","exception","Promise","resolve","Templates","addClass","evalId","renderQaEvaluationQuestions","loadQaEvaluationResponses","preview","slice","label","class","title","scrollTop","scrollHeight","newId","lastItem","inputGroup","sendButton","requiredQuestions","missing","containerWrapper","loadingStr","turn_id","chatContainer","forEach","qid","responseData","parse","Array","isArray","saved_datetime","savedText","onText","icon","savedMessage","messageHtml","lockQuestionItem","controls","ensureEditButton","historyText","history","history_count","details","history_items","time","requiredCount","savedRequired","entries","failedCount","promiseChain","_ref","questionid","res"],"mappings":"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"}
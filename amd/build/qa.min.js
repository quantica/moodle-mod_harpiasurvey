define("mod_harpiasurvey/qa",["exports","./common_chat"],(function(_exports,_common_chat){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;let initialized=!1,handlersRegistered=!1;const qaEvaluationSaved={};let editLabel="Edit";_exports.init=()=>initialize();const initialize=()=>{if(initialized)return;(0,_common_chat.getString)("edit","moodle").then((str=>{editLabel=str})).catch((()=>{editLabel="Edit"}));const containers=(0,_common_chat.$)('.ai-conversation-container[data-behavior="qa"]');0!==containers.length&&(containers.each((function(){const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10);if(!pageid)return;const activeId=parseInt((0,_common_chat.$)(this).data("qa-active-id"),10);(0,_common_chat.$)(`#chat-messages-page-${pageid}`).find('.message[data-role="assistant"]').length>0&&lockQaInput(pageid),activeId&&selectQaQuestion(pageid,activeId)})),function(){if(handlersRegistered)return;(0,_common_chat.$)(document).on("click",'.ai-conversation-container[data-behavior="qa"] .chat-send-btn',(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),cmid=parseInt(button.data("cmid"),10),pageid=parseInt(button.data("pageid"),10);if(!cmid||!pageid)return void(0,_common_chat.addError)("Missing cmid or pageid");if(hasUnsavedQaEvaluation(pageid))return void(0,_common_chat.getString)("qarequiresave","mod_harpiasurvey").then((message=>{_common_chat.Notification.addNotification({message:message,type:"warning"})})).catch((()=>{_common_chat.Notification.addNotification({message:"Please save the evaluation answers before starting a new question.",type:"warning"})}));const input=(0,_common_chat.$)(`#chat-input-page-${pageid}`);if(0===input.length)return void(0,_common_chat.addError)("Chat input not found");const inputValue=input.val();if(!inputValue)return;const message=inputValue.trim();if(!message)return;const modelsdata=button.closest(".ai-conversation-container").data("models");let modelid=null;if(modelsdata){const modelids=modelsdata.split(",");modelids.length>0&&(modelid=parseInt(modelids[0],10))}if(!modelid)return void(0,_common_chat.addError)("No model available");input.prop("disabled",!0),button.prop("disabled",!0),input.val("");const tempId="temp-user-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);displayUserMessage(pageid,message,tempId),addQaQuestionItem(pageid,tempId,message),selectQaQuestion(pageid,tempId);const loading=(0,_common_chat.$)(`#chat-loading-page-${pageid}`);loading.show(),sendMessage(cmid,pageid,message,modelid,button,input,loading)})),(0,_common_chat.$)(document).on("keydown",'.ai-conversation-container[data-behavior="qa"] .chat-input',(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),(0,_common_chat.$)(this).closest(".ai-conversation-container").find(".chat-send-btn").click())})),(0,_common_chat.$)(document).on("click",'.ai-conversation-container[data-behavior="qa"] .new-question-btn',(function(e){e.preventDefault();const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10);pageid&&(hasUnsavedQaEvaluation(pageid)?(0,_common_chat.getString)("qarequiresave","mod_harpiasurvey").then((message=>{_common_chat.Notification.addNotification({message:message,type:"warning"})})).catch((()=>{_common_chat.Notification.addNotification({message:"Please save the evaluation answers before starting a new question.",type:"warning"})})):resetQaView(pageid))})),(0,_common_chat.$)(document).on("click",".qa-question-item",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),questionId=button.data("question-id");pageid&&questionId&&selectQaQuestion(pageid,questionId)})),(0,_common_chat.$)(document).on("click",".qa-evaluation-questions-container .save-turn-evaluation-questions-btn",(function(e){e.preventDefault(),e.stopPropagation();const button=(0,_common_chat.$)(this),turnId=parseInt(button.data("turn-id"),10),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);if(!turnId||!pageid||!cmid)return void _common_chat.Notification.addNotification({message:"Missing required data to save responses.",type:"error"});const evaluationContainer=button.closest(".turn-evaluation-questions");if(0===evaluationContainer.length)return;const responses={};if(evaluationContainer.find("[data-questionid]").each((function(){const item=(0,_common_chat.$)(this),isLocked="1"===String(item.attr("data-response-locked")),isEditing="1"===String(item.attr("data-response-editing"));if(isLocked&&!isEditing)return;const questionId=(0,_common_chat.$)(this).data("questionid"),questionType=(0,_common_chat.$)(this).data("questiontype");let responseValue=null;if("multiplechoice"===questionType){const checked=evaluationContainer.find(`input[name="question_${questionId}_turn[]"]:checked`),values=[];checked.each((function(){values.push((0,_common_chat.$)(this).val())})),responseValue=values.length>0?JSON.stringify(values):null}else if("select"===questionType||"singlechoice"===questionType||"likert"===questionType){const selectSelector=`select[name="question_${questionId}_turn"]`,inputSelector=`input[name="question_${questionId}_turn"]:checked`,selected=evaluationContainer.find(`${selectSelector}, ${inputSelector}`);responseValue=selected.length>0?selected.val():null}else if("number"===questionType||"shorttext"===questionType){const input=evaluationContainer.find(`input[name="question_${questionId}_turn"]`);responseValue=input.length>0?input.val():null}else if("longtext"===questionType){const textarea=evaluationContainer.find(`textarea[name="question_${questionId}_turn"]`);responseValue=textarea.length>0?textarea.val():null}null!==responseValue&&""!==responseValue&&(responses[questionId]=responseValue)})),0===Object.keys(responses).length)return void _common_chat.Notification.addNotification({message:"No responses to save.",type:"info"});const originalText=button.text();button.prop("disabled",!0),button.text("Saving..."),saveQaEvaluationResponses(cmid,pageid,turnId,responses,button,originalText)})),handlersRegistered=!0}(),initialized=!0)};const resetQaView=pageid=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);if(0===messagesContainer.length)return;messagesContainer.find(".message").hide();const placeholder=messagesContainer.find(".qa-placeholder");placeholder.length>0?placeholder.show():(0,_common_chat.getString)("qaplaceholder","mod_harpiasurvey").then((message=>{messagesContainer.append('<div class="qa-placeholder text-muted text-center small py-3">'+message+"</div>")})).catch((()=>{messagesContainer.append('<div class="qa-placeholder text-muted text-center small py-3">Ask a new question to get an answer.</div>')}));const input=(0,_common_chat.$)(`#chat-input-page-${pageid}`);if(input.length>0){input.val(""),input.prop("disabled",!1);const container=(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`),inputGroup=container.find(".input-group");inputGroup.length>0&&inputGroup.show();container.find(".chat-send-btn").prop("disabled",!1),container.find(".qa-question-item").removeClass("active"),input.focus()}const evalContainer=(0,_common_chat.$)(`#qa-evaluation-questions-container-${pageid}`);evalContainer.length>0&&evalContainer.empty()},sendMessage=(cmid,pageid,message,modelid,button,input,loading)=>{const params=new URLSearchParams({action:"send_ai_message",cmid:cmid,pageid:pageid,message:message,modelid:modelid,sesskey:_common_chat.Config.sesskey});fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(loading.hide(),data.success)if(data.messageid&&data.content){const parentid=data.parentid||null;if(parentid){const pendingUser=(0,_common_chat.$)(`#chat-messages-page-${pageid} .message[data-role="user"]`).last();pendingUser.length>0&&pendingUser.attr("data-messageid",parentid),updateQaQuestionItemId(pageid,parentid)}displayAIMessage(pageid,data.content,data.messageid,parentid).then((()=>{(0,_common_chat.scrollToBottom)(pageid),lockQaInput(pageid),parentid&&selectQaQuestion(pageid,parentid)}))}else(0,_common_chat.addError)("Received response but missing message ID or content");else(0,_common_chat.addError)(data.message||"Error sending message");input.prop("disabled",!1),button.prop("disabled",!1),input.focus()})).catch((error=>{loading.hide(),console.error("Error sending message:",error),(0,_common_chat.addError)("Error sending message: "+error.message),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()}))},displayUserMessage=(pageid,message,messageid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);0!==messagesContainer.length&&(messagesContainer.find(".text-center.text-muted").remove(),_common_chat.Templates.render("mod_harpiasurvey/chat_user_message",{id:messageid,content:message,timecreated:Math.floor(Date.now()/1e3)}).then((html=>{messagesContainer.append(html),(0,_common_chat.scrollToBottom)(pageid)})).catch(_common_chat.Notification.exception))},displayAIMessage=function(pageid,content,messageid){let parentid=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);return 0===messagesContainer.length?Promise.resolve():_common_chat.Templates.render("mod_harpiasurvey/chat_ai_message",{id:messageid,parentid:parentid,content:content,timecreated:Math.floor(Date.now()/1e3)}).then((html=>(messagesContainer.append(html),(0,_common_chat.scrollToBottom)(pageid),html))).catch(_common_chat.Notification.exception)},selectQaQuestion=(pageid,questionId)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);if(0===messagesContainer.length)return;const container=(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`);container.attr("data-qa-active-id",questionId),container.data("qa-active-id",questionId),messagesContainer.find(".qa-placeholder").hide(),messagesContainer.find(".message").hide(),messagesContainer.find(`.message[data-messageid="${questionId}"], .message[data-parentid="${questionId}"]`).show();const list=(0,_common_chat.$)(`.qa-questions-list[data-pageid="${pageid}"]`);list.find(".qa-question-item").removeClass("active"),list.find(`.qa-question-item[data-question-id="${questionId}"]`).addClass("active"),lockQaInput(pageid);const evalId=parseInt(questionId,10);isNaN(evalId)||renderQaEvaluationQuestions(pageid,evalId).then((()=>{loadQaEvaluationResponses(pageid,evalId)}))},addQaQuestionItem=(pageid,questionId,message)=>{const list=(0,_common_chat.$)(`.qa-questions-list[data-pageid="${pageid}"]`);if(0===list.length)return;const preview=(message||"").trim().slice(0,60),label=message&&message.length>60?preview+"...":preview||"Question #"+questionId,button=(0,_common_chat.$)("<button>",{type:"button",class:"btn btn-sm btn-outline-secondary qa-question-item","data-pageid":pageid,"data-question-id":questionId,title:label,text:label});list.append(button),list[0]&&list.scrollTop(list[0].scrollHeight)},updateQaQuestionItemId=(pageid,newId)=>{const lastItem=(0,_common_chat.$)(`.qa-questions-list[data-pageid="${pageid}"]`).find(".qa-question-item").last();lastItem.length>0&&lastItem.attr("data-question-id",newId)},lockQaInput=pageid=>{const container=(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`),inputGroup=container.find(".input-group");inputGroup.length>0&&inputGroup.hide();const input=(0,_common_chat.$)(`#chat-input-page-${pageid}`),sendButton=container.find(".chat-send-btn");input.prop("disabled",!0),sendButton.prop("disabled",!0)},hasUnsavedQaEvaluation=pageid=>{const activeId=(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`).data("qa-active-id");if(!activeId)return!1;if(qaEvaluationSaved[pageid]||(qaEvaluationSaved[pageid]={}),!0===qaEvaluationSaved[pageid][activeId])return!1;const container=(0,_common_chat.$)(`#qa-evaluation-questions-container-${pageid}`);if(0===container.length)return!1;const requiredQuestions=container.find('.question-item[data-required="1"]');if(0===requiredQuestions.length)return qaEvaluationSaved[pageid][activeId]=!0,!1;let missing=!1;return requiredQuestions.each((function(){if(0===(0,_common_chat.$)(this).find(".saved-response-message").length)return missing=!0,!1})),qaEvaluationSaved[pageid][activeId]=!missing,missing},renderQaEvaluationQuestions=(pageid,questionId)=>{const containerWrapper=(0,_common_chat.$)(`#qa-evaluation-questions-container-${pageid}`);return 0===containerWrapper.length?Promise.resolve():(qaEvaluationSaved[pageid]||(qaEvaluationSaved[pageid]={}),qaEvaluationSaved[pageid][questionId]=!1,(0,_common_chat.getString)("loading","moodle").then((loadingStr=>{containerWrapper.html('<div class="text-center py-3 text-muted"><i class="fa fa-spinner fa-spin"></i> '+loadingStr+"</div>");const params=new URLSearchParams({action:"get_turn_questions",pageid:pageid,turn_id:questionId,cmid:(0,_common_chat.$)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container").data("cmid"),sesskey:_common_chat.Config.sesskey});return fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{data.success&&data.html?containerWrapper.html(data.html):containerWrapper.html('<div class="text-center text-muted py-3">'+(data.message||"No questions available for this entry.")+"</div>")})).catch((error=>{console.error("Error loading evaluation questions:",error),containerWrapper.html('<div class="text-danger text-center py-3">Error loading questions: '+error.message+"</div>")}))})))},loadQaEvaluationResponses=(pageid,questionId)=>{const containerWrapper=(0,_common_chat.$)(`#qa-evaluation-questions-container-${pageid}`);if(0===containerWrapper.length)return;let container=containerWrapper.find(`.turn-evaluation-questions[data-turn-id="${questionId}"]`);0===container.length&&(container=containerWrapper);const params=new URLSearchParams({action:"get_turn_responses",cmid:(0,_common_chat.$)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container").data("cmid"),pageid:pageid,turn_id:questionId,sesskey:_common_chat.Config.sesskey});fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(!data.success||!data.responses)return;Object.keys(data.responses).forEach((questionId=>{const responseData=data.responses[questionId],questionItem=container.find(`.question-item[data-questionid="${questionId}"]`);if(0===questionItem.length)return;const questionType=questionItem.data("questiontype"),value=responseData.response;if("singlechoice"===questionType||"likert"===questionType)questionItem.find('input[type="radio"]').prop("checked",!1),questionItem.find(`input[type="radio"][value="${value}"]`).prop("checked",!0);else if("multiplechoice"===questionType){questionItem.find('input[type="checkbox"]').prop("checked",!1);try{const values=JSON.parse(value);Array.isArray(values)&&values.forEach((val=>{questionItem.find(`input[type="checkbox"][value="${val}"]`).prop("checked",!0)}))}catch(e){}}else"select"===questionType?questionItem.find("select").val(value):"number"===questionType?questionItem.find('input[type="number"]').val(value):"shorttext"===questionType?questionItem.find('input[type="text"]').val(value):"longtext"===questionType&&questionItem.find("textarea").val(value);responseData.saved_datetime&&(0,_common_chat.getString)("saved","mod_harpiasurvey").then((savedText=>{(0,_common_chat.getString)("on","mod_harpiasurvey").then((onText=>{const icon='<i class="fa fa-check-circle" aria-hidden="true"></i>';let savedMessage=questionItem.find(".saved-response-message");if(0===savedMessage.length){const messageHtml=`<div class="mt-2 small text-muted saved-response-message">${icon} ${savedText} ${onText} ${responseData.saved_datetime}</div>`;questionItem.append(messageHtml)}else savedMessage.html(`${icon} ${savedText} ${onText} ${responseData.saved_datetime}`);(questionItem=>{questionItem.attr("data-response-locked","1"),questionItem.removeAttr("data-response-editing"),questionItem.find("input, select, textarea").prop("disabled",!0)})(questionItem),(questionItem=>{let controls=questionItem.find(".question-edit-controls");0===controls.length&&(controls=(0,_common_chat.$)('<div class="mt-2 question-edit-controls"></div>'),questionItem.append(controls));let button=controls.find(".question-edit-btn");0===button.length&&(button=(0,_common_chat.$)('<button type="button" class="btn btn-sm btn-outline-secondary question-edit-btn"></button>'),controls.append(button)),button.text(editLabel),button.show()})(questionItem)}))})),(0,_common_chat.getString)("answerhistory","mod_harpiasurvey").then((historyText=>{let history=questionItem.find(".answer-history");if(!history.length&&responseData.history_count>1){const details=(0,_common_chat.$)('<details class="answer-history mt-1"></details>');details.append(`<summary>${historyText} (${responseData.history_count})</summary>`),details.append('<ul class="list-unstyled mt-2 mb-0"></ul>'),questionItem.append(details),history=details}if(history.length){const list=history.find("ul");list.empty(),(responseData.history_items||[]).forEach((item=>{list.append(`<li class="mb-1"><span class="text-muted">${item.time}</span> â€” ${item.response}</li>`)})),history.find("summary").text(`${historyText} (${responseData.history_count||0})`),(responseData.history_count||0)>1?history.show():history.hide()}}))})),qaEvaluationSaved[pageid]||(qaEvaluationSaved[pageid]={});const requiredQuestions=container.find('.question-item[data-required="1"]');if(0===requiredQuestions.length)return void(qaEvaluationSaved[pageid][questionId]=!0);const requiredSet=requiredQuestions,requiredCount=requiredSet.length,savedRequired=requiredSet.filter((function(){return(0,_common_chat.$)(this).find(".saved-response-message").length>0})).length;qaEvaluationSaved[pageid][questionId]=requiredCount>0&&savedRequired===requiredCount})).catch((error=>{console.error("Error loading evaluation responses:",error)}))},saveQaEvaluationResponses=(cmid,pageid,questionId,responses,button,originalText)=>{const entries=Object.entries(responses);let failedCount=0,promiseChain=Promise.resolve();entries.forEach((_ref=>{let[qid,response]=_ref;promiseChain=promiseChain.then((()=>{const params=new URLSearchParams({action:"save_response",cmid:cmid,pageid:pageid,questionid:qid,response:response,turn_id:questionId,sesskey:_common_chat.Config.sesskey});return fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((res=>res.json())).then((data=>{data.success||failedCount++})).catch((()=>{failedCount++}))}))})),promiseChain.then((()=>{button.prop("disabled",!1),button.text(originalText),0===failedCount?_common_chat.Notification.addNotification({message:"Responses saved.",type:"success"}):_common_chat.Notification.addNotification({message:"Some responses failed to save.",type:"warning"}),qaEvaluationSaved[pageid]||(qaEvaluationSaved[pageid]={}),qaEvaluationSaved[pageid][questionId]=!1,loadQaEvaluationResponses(pageid,questionId)}))}}));

//# sourceMappingURL=qa.min.js.map
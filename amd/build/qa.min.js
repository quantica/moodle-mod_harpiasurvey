define("mod_harpiasurvey/qa",["exports","./common_chat"],(function(_exports,_common_chat){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;let initialized=!1,handlersRegistered=!1;_exports.init=()=>initialize();const initialize=()=>{if(initialized)return;const containers=(0,_common_chat.$)('.ai-conversation-container[data-behavior="qa"]');0!==containers.length&&(containers.each((function(){const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10);if(!pageid)return;const activeId=parseInt((0,_common_chat.$)(this).data("qa-active-id"),10);(0,_common_chat.$)(`#chat-messages-page-${pageid}`).find('.message[data-role="assistant"]').length>0&&lockQaInput(pageid),activeId&&selectQaQuestion(pageid,activeId)})),function(){if(handlersRegistered)return;(0,_common_chat.$)(document).on("click",'.ai-conversation-container[data-behavior="qa"] .chat-send-btn',(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),cmid=parseInt(button.data("cmid"),10),pageid=parseInt(button.data("pageid"),10);if(!cmid||!pageid)return void(0,_common_chat.addError)("Missing cmid or pageid");const input=(0,_common_chat.$)(`#chat-input-page-${pageid}`);if(0===input.length)return void(0,_common_chat.addError)("Chat input not found");const inputValue=input.val();if(!inputValue)return;const message=inputValue.trim();if(!message)return;const modelsdata=button.closest(".ai-conversation-container").data("models");let modelid=null;if(modelsdata){const modelids=modelsdata.split(",");modelids.length>0&&(modelid=parseInt(modelids[0],10))}if(!modelid)return void(0,_common_chat.addError)("No model available");input.prop("disabled",!0),button.prop("disabled",!0),input.val("");const tempId="temp-user-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);displayUserMessage(pageid,message,tempId),addQaQuestionItem(pageid,tempId,message),selectQaQuestion(pageid,tempId);const loading=(0,_common_chat.$)(`#chat-loading-page-${pageid}`);loading.show(),sendMessage(cmid,pageid,message,modelid,button,input,loading)})),(0,_common_chat.$)(document).on("keydown",'.ai-conversation-container[data-behavior="qa"] .chat-input',(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),(0,_common_chat.$)(this).closest(".ai-conversation-container").find(".chat-send-btn").click())})),(0,_common_chat.$)(document).on("click",'.ai-conversation-container[data-behavior="qa"] .new-question-btn',(function(e){e.preventDefault();const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10);pageid&&resetQaView(pageid)})),(0,_common_chat.$)(document).on("click",".qa-question-item",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),questionId=parseInt(button.data("question-id"),10);pageid&&questionId&&selectQaQuestion(pageid,questionId)})),handlersRegistered=!0}(),initialized=!0)};const resetQaView=pageid=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);if(0===messagesContainer.length)return;messagesContainer.find(".message").hide();const placeholder=messagesContainer.find(".qa-placeholder");placeholder.length>0?placeholder.show():(0,_common_chat.getString)("qaplaceholder","mod_harpiasurvey").then((message=>{messagesContainer.append('<div class="qa-placeholder text-muted text-center small py-3">'+message+"</div>")})).catch((()=>{messagesContainer.append('<div class="qa-placeholder text-muted text-center small py-3">Ask a new question to get an answer.</div>')}));const input=(0,_common_chat.$)(`#chat-input-page-${pageid}`);if(input.length>0){input.val(""),input.prop("disabled",!1);const container=(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`),inputGroup=container.find(".input-group");inputGroup.length>0&&inputGroup.show();container.find(".chat-send-btn").prop("disabled",!1),container.find(".qa-question-item").removeClass("active"),input.focus()}},sendMessage=(cmid,pageid,message,modelid,button,input,loading)=>{const params=new URLSearchParams({action:"send_ai_message",cmid:cmid,pageid:pageid,message:message,modelid:modelid,sesskey:_common_chat.Config.sesskey});fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(loading.hide(),data.success)if(data.messageid&&data.content){const parentid=data.parentid||null;if(parentid){const pendingUser=(0,_common_chat.$)(`#chat-messages-page-${pageid} .message[data-role="user"]`).last();pendingUser.length>0&&pendingUser.attr("data-messageid",parentid),updateQaQuestionItemId(pageid,parentid)}displayAIMessage(pageid,data.content,data.messageid,parentid).then((()=>{(0,_common_chat.scrollToBottom)(pageid),lockQaInput(pageid),parentid&&selectQaQuestion(pageid,parentid)}))}else(0,_common_chat.addError)("Received response but missing message ID or content");else(0,_common_chat.addError)(data.message||"Error sending message");input.prop("disabled",!1),button.prop("disabled",!1),input.focus()})).catch((error=>{loading.hide(),console.error("Error sending message:",error),(0,_common_chat.addError)("Error sending message: "+error.message),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()}))},displayUserMessage=(pageid,message,messageid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);0!==messagesContainer.length&&(messagesContainer.find(".text-center.text-muted").remove(),_common_chat.Templates.render("mod_harpiasurvey/chat_user_message",{id:messageid,content:message,timecreated:Math.floor(Date.now()/1e3)}).then((html=>{messagesContainer.append(html),(0,_common_chat.scrollToBottom)(pageid)})).catch(_common_chat.Notification.exception))},displayAIMessage=function(pageid,content,messageid){let parentid=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);return 0===messagesContainer.length?Promise.resolve():_common_chat.Templates.render("mod_harpiasurvey/chat_ai_message",{id:messageid,parentid:parentid,content:content,timecreated:Math.floor(Date.now()/1e3)}).then((html=>(messagesContainer.append(html),(0,_common_chat.scrollToBottom)(pageid),html))).catch(_common_chat.Notification.exception)},selectQaQuestion=(pageid,questionId)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);if(0===messagesContainer.length)return;messagesContainer.find(".qa-placeholder").hide(),messagesContainer.find(".message").hide(),messagesContainer.find(`.message[data-messageid="${questionId}"], .message[data-parentid="${questionId}"]`).show();const list=(0,_common_chat.$)(`.qa-questions-list[data-pageid="${pageid}"]`);list.find(".qa-question-item").removeClass("active"),list.find(`.qa-question-item[data-question-id="${questionId}"]`).addClass("active"),lockQaInput(pageid)},addQaQuestionItem=(pageid,questionId,message)=>{const list=(0,_common_chat.$)(`.qa-questions-list[data-pageid="${pageid}"]`);if(0===list.length)return;const preview=(message||"").trim().slice(0,60),label=message&&message.length>60?preview+"...":preview||"Question #"+questionId,button=(0,_common_chat.$)("<button>",{type:"button",class:"btn btn-sm btn-outline-secondary qa-question-item","data-pageid":pageid,"data-question-id":questionId,title:label,text:label});list.append(button)},updateQaQuestionItemId=(pageid,newId)=>{const lastItem=(0,_common_chat.$)(`.qa-questions-list[data-pageid="${pageid}"]`).find(".qa-question-item").last();lastItem.length>0&&lastItem.attr("data-question-id",newId)},lockQaInput=pageid=>{const container=(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`),inputGroup=container.find(".input-group");inputGroup.length>0&&inputGroup.hide();const input=(0,_common_chat.$)(`#chat-input-page-${pageid}`),sendButton=container.find(".chat-send-btn");input.prop("disabled",!0),sendButton.prop("disabled",!0)}}));

//# sourceMappingURL=qa.min.js.map
define("mod_harpiasurvey/common_chat",["exports","core/templates","core/notification","core/config","core/str","jquery"],(function(_exports,_templates,_notification,_config,_str,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),Object.defineProperty(_exports,"$",{enumerable:!0,get:function(){return _jquery.default}}),Object.defineProperty(_exports,"Config",{enumerable:!0,get:function(){return _config.default}}),Object.defineProperty(_exports,"Notification",{enumerable:!0,get:function(){return _notification.default}}),Object.defineProperty(_exports,"Templates",{enumerable:!0,get:function(){return _templates.default}}),_exports.getCmid=_exports.findRootForTurn=_exports.currentTurns=_exports.countNodes=_exports.conversationTrees=_exports.calculateTurnNumber=_exports.addError=void 0,Object.defineProperty(_exports,"getString",{enumerable:!0,get:function(){return _str.get_string}}),_exports.scrollToBottom=_exports.renderConversationList=void 0,_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_config=_interopRequireDefault(_config),_jquery=_interopRequireDefault(_jquery);_exports.currentTurns={};_exports.conversationTrees={};_exports.scrollToBottom=pageid=>{const messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`);0!==messagesContainer.length&&requestAnimationFrame((()=>{const container=messagesContainer[0];container&&(container.scrollTop=container.scrollHeight)}))};_exports.addError=message=>{_notification.default.addNotification({message:message,type:"error"})};_exports.getCmid=pageid=>(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container").data("cmid");_exports.findRootForTurn=(roots,turnId)=>{const findInNode=(node,targetId)=>{if(parseInt(node.turn_id,10)===parseInt(targetId,10))return!0;if(node.direct_branches)for(const db of node.direct_branches){if(parseInt(db.turn_id,10)===parseInt(targetId,10))return!0;if(db.children)for(const child of db.children)if(findInNode(child,targetId))return!0}if(node.children)for(const child of node.children)if(findInNode(child,targetId))return!0;return!1};for(const root of roots)if(findInNode(root,turnId))return root;return null};const countNodes=node=>{let count=1;return node.direct_branches&&node.direct_branches.forEach((branch=>{count+=countNodes(branch)})),node.children&&node.children.forEach((child=>{count+=countNodes(child)})),count};_exports.countNodes=countNodes;_exports.calculateTurnNumber=(node,turnIndex,parentNumber)=>{if(node.is_root||node.is_direct_branch)return String(turnIndex+1);const branchIndex=turnIndex+1;return parentNumber?`${parentNumber}.${branchIndex}`:String(branchIndex)};_exports.renderConversationList=(pageid,roots)=>{const treeContainer=(0,_jquery.default)(`#conversation-tree-${pageid}`),rootsWithCount=roots.map(((root,idx)=>({...root,conversation_id:root.conversation_id||root.turn_id,turn_count:countNodes(root),conversation_number:root.conversation_number||idx+1})));_templates.default.render("mod_harpiasurvey/conversation_list",{roots:rootsWithCount,pageid:pageid}).then((html=>{treeContainer.html(html)})).catch((error=>{console.error("Error rendering conversation list:",error)}))}}));

//# sourceMappingURL=common_chat.min.js.map
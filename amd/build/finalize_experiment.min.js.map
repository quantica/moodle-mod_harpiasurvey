{"version":3,"file":"finalize_experiment.min.js","sources":["../src/finalize_experiment.js"],"sourcesContent":["import Notification from 'core/notification';\nimport Config from 'core/config';\nimport {get_string as getString} from 'core/str';\nimport $ from 'jquery';\n\nlet initialized = false;\nlet state = {\n    cmid: 0,\n    experimentid: 0,\n    finalized: false,\n};\n\nconst ajaxUrl = () => Config.wwwroot + '/mod/harpiasurvey/ajax.php';\n\nconst applyReadOnlyMode = () => {\n    if (!state.finalized) {\n        return;\n    }\n\n    if ($('.harpiasurvey-finalized-banner').length === 0) {\n        const banner = $('<div class=\"alert alert-secondary harpiasurvey-finalized-banner mb-3\"></div>');\n        getString('experimentreadonlybanner', 'mod_harpiasurvey').then((txt) => {\n            banner.text(txt);\n        }).catch(() => {\n            banner.text('This experiment has been finalized and is now read-only.');\n        });\n        $('.card-body').first().prepend(banner);\n    }\n\n    $('.question-item input, .question-item textarea, .question-item select').prop('disabled', true);\n    $('.chat-input, .chat-send-btn').prop('disabled', true);\n\n    [\n        '.save-all-responses-btn',\n        '.save-turn-evaluation-questions-btn',\n        '.question-edit-btn',\n        '.new-question-btn',\n        '.create-direct-branch-btn',\n        '.create-branch-from-tree-btn',\n        '.new-conversation-btn',\n        '.create-root-btn',\n        '.branch-btn',\n        '.chat-send-btn',\n    ].forEach((selector) => {\n        $(selector).prop('disabled', true).addClass('disabled');\n    });\n};\n\nconst updateConfirmState = (container, summary, finalized) => {\n    const confirmBtn = container.find('[data-role=\"confirm-finalize-btn\"]');\n    const certify = container.find('[data-role=\"certify-checkbox\"]');\n    const requiredWarning = container.find('[data-role=\"required-warning\"]');\n    const requiredUnanswered = parseInt(summary?.requiredunanswered || 0, 10);\n    const canFinalize = !!summary?.canfinalize && requiredUnanswered === 0;\n\n    if (finalized) {\n        certify.prop('checked', false).prop('disabled', true);\n        confirmBtn.prop('disabled', true);\n        requiredWarning.addClass('d-none');\n        return;\n    }\n\n    certify.prop('disabled', false);\n    requiredWarning.toggleClass('d-none', requiredUnanswered === 0);\n    const certified = certify.is(':checked');\n    confirmBtn.prop('disabled', !(certified && canFinalize));\n};\n\nconst renderSummary = (container, payload) => {\n    const summary = payload.summary || {};\n    const content = container.find('.finalize-summary-content');\n    const loading = container.find('.finalize-summary-loading');\n\n    container.find('[data-field=\"answered\"]').text(summary.answered || 0);\n    container.find('[data-field=\"unanswered\"]').text(summary.unanswered || 0);\n    container.find('[data-field=\"requiredunanswered\"]').text(summary.requiredunanswered || 0);\n\n    const details = container.find('[data-role=\"page-details\"]');\n    details.empty();\n    (summary.pages || []).forEach((page) => {\n        const row = $('<div class=\"d-flex justify-content-between small py-1 border-bottom\"></div>');\n        const left = $('<div></div>');\n        const right = $('<div class=\"text-nowrap ml-2\"></div>');\n        left.text(`${page.title}`);\n        right.text(`${page.unanswered || 0}`);\n        row.append(left).append(right);\n        details.append(row);\n    });\n    if (!summary.pages || summary.pages.length === 0) {\n        details.append('<div class=\"text-muted small\">-</div>');\n    }\n\n    loading.addClass('d-none');\n    content.removeClass('d-none');\n    updateConfirmState(container, summary, !!payload.finalized);\n};\n\nconst loadSummary = (wrapper) => {\n    const modal = wrapper.find('.harpiasurvey-finalize-modal');\n    modal.find('.finalize-summary-loading').removeClass('d-none');\n    modal.find('.finalize-summary-content').addClass('d-none');\n    modal.find('[data-role=\"confirm-finalize-btn\"]').prop('disabled', true);\n\n    const params = new URLSearchParams({\n        action: 'get_finalize_summary',\n        cmid: String(state.cmid),\n        experimentid: String(state.experimentid),\n        sesskey: Config.sesskey,\n        _: String(Date.now()),\n    });\n\n    fetch(ajaxUrl(), {\n        method: 'POST',\n        cache: 'no-store',\n        headers: {'Content-Type': 'application/x-www-form-urlencoded'},\n        body: params.toString(),\n    }).then((r) => r.json()).then((data) => {\n        if (!data.success) {\n            throw new Error(data.message || 'Failed to load summary');\n        }\n        state.finalized = !!data.finalized;\n        wrapper.attr('data-finalized', state.finalized ? '1' : '0');\n        renderSummary(modal, data);\n        if (state.finalized) {\n            applyReadOnlyMode();\n        }\n    }).catch((e) => {\n        modal.find('.finalize-summary-loading').addClass('d-none');\n        Notification.addNotification({\n            message: e.message || 'Failed to load finalization summary.',\n            type: 'error',\n        });\n    });\n};\n\nconst bindFinalizeUI = () => {\n    $(document).on('click', '.harpiasurvey-finalize-modal [data-role=\"finalize-cancel-btn\"]', function(e) {\n        e.preventDefault();\n        const modal = $(this).closest('.harpiasurvey-finalize-modal');\n        modal.modal('hide');\n    });\n\n    $(document).on('click', '.save-all-responses-btn, .save-turn-evaluation-questions-btn, .chat-send-btn, .new-question-btn, .create-direct-branch-btn, .create-branch-from-tree-btn, .new-conversation-btn, .create-root-btn, .question-edit-btn', function(e) {\n        if (!state.finalized) {\n            return;\n        }\n        e.preventDefault();\n        e.stopPropagation();\n        getString('experimentfinalizedreadonly', 'mod_harpiasurvey').then((msg) => {\n            Notification.addNotification({message: msg, type: 'info'});\n        }).catch(() => {\n            Notification.addNotification({message: 'This experiment is read-only.', type: 'info'});\n        });\n    });\n\n    $(document).on('click', '[data-action=\"open-finalize-modal\"]', function(e) {\n        e.preventDefault();\n        const wrapper = $(this).closest('.harpiasurvey-finalize-page');\n        const modal = wrapper.find('.harpiasurvey-finalize-modal');\n        modal.find('[data-role=\"certify-checkbox\"]').prop('checked', false);\n        modal.modal('show');\n        loadSummary(wrapper);\n    });\n\n    $(document).on('change', '.harpiasurvey-finalize-modal [data-role=\"certify-checkbox\"]', function() {\n        const modal = $(this).closest('.harpiasurvey-finalize-modal');\n        const summary = {\n            canfinalize: parseInt(modal.find('[data-field=\"requiredunanswered\"]').text(), 10) === 0,\n            requiredunanswered: parseInt(modal.find('[data-field=\"requiredunanswered\"]').text(), 10) || 0,\n        };\n        updateConfirmState(modal, summary, state.finalized);\n    });\n\n    $(document).on('click', '.harpiasurvey-finalize-modal [data-role=\"confirm-finalize-btn\"]', function() {\n        const btn = $(this);\n        const modal = btn.closest('.harpiasurvey-finalize-modal');\n        const certified = modal.find('[data-role=\"certify-checkbox\"]').is(':checked') ? 1 : 0;\n        btn.prop('disabled', true);\n\n        const params = new URLSearchParams({\n            action: 'confirm_finalize_experiment',\n            cmid: String(state.cmid),\n            experimentid: String(state.experimentid),\n            certified: String(certified),\n            sesskey: Config.sesskey,\n        });\n\n        fetch(ajaxUrl(), {\n            method: 'POST',\n            headers: {'Content-Type': 'application/x-www-form-urlencoded'},\n            body: params.toString(),\n        }).then((r) => r.json()).then((data) => {\n            if (!data.success) {\n                Notification.addNotification({\n                    message: data.message || 'Could not finalize experiment.',\n                    type: 'warning',\n                });\n                renderSummary(modal, data);\n                return;\n            }\n            state.finalized = true;\n            Notification.addNotification({\n                message: data.message || 'Experiment finalized successfully.',\n                type: 'success',\n            });\n            modal.modal('hide');\n            // Reload keeps URL/page context and guarantees all modules reload in read-only mode.\n            window.location.reload();\n        }).catch((e) => {\n            Notification.addNotification({\n                message: e.message || 'Could not finalize experiment.',\n                type: 'error',\n            });\n            btn.prop('disabled', false);\n        });\n    });\n};\n\nexport const init = (cmid, experimentid, finalized = false) => {\n    state.cmid = parseInt(cmid, 10) || 0;\n    state.experimentid = parseInt(experimentid, 10) || 0;\n    state.finalized = finalized === true || finalized === 1 || finalized === '1';\n\n    if (!initialized) {\n        bindFinalizeUI();\n        initialized = true;\n    }\n\n    applyReadOnlyMode();\n};\n"],"names":["initialized","state","cmid","experimentid","finalized","ajaxUrl","Config","wwwroot","applyReadOnlyMode","length","banner","then","txt","text","catch","first","prepend","prop","forEach","selector","addClass","updateConfirmState","container","summary","confirmBtn","find","certify","requiredWarning","requiredUnanswered","parseInt","requiredunanswered","canFinalize","canfinalize","toggleClass","certified","is","renderSummary","payload","content","loading","answered","unanswered","details","empty","pages","page","row","left","right","title","append","removeClass","bindFinalizeUI","document","on","e","preventDefault","this","closest","modal","stopPropagation","msg","addNotification","message","type","wrapper","params","URLSearchParams","action","String","sesskey","_","Date","now","fetch","method","cache","headers","body","toString","r","json","data","success","Error","attr","loadSummary","btn","window","location","reload"],"mappings":"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"}
{"version":3,"file":"multi_model_turns.min.js","sources":["../src/multi_model_turns.js"],"sourcesContent":["// Multi-model turns conversation logic for harpiasurvey chat.\n// Combines multi-model tabs with turn-based navigation and branching.\nimport {\n    Templates,\n    Notification,\n    Config,\n    getString,\n    $,\n    currentTurns,\n    conversationTrees,\n    scrollToBottom,\n    addError,\n    getCmid,\n    findRootForTurn,\n    countNodes,\n    calculateTurnNumber,\n    renderConversationList\n} from './common_chat';\nimport {ensureFancytree} from './fancytree_loader';\n\nlet initialized = false;\nlet handlersRegistered = false;\nlet treeHandlersRegistered = false;\nlet turnHandlersRegistered = false;\nconst fancytreeInstances = {};\n\n// Store turn state per model: {pageid: {modelid: turnNumber}}\nconst modelTurns = {};\n\nexport const init = () => initialize();\n\n/**\n * Initialize multi-model turns-mode chat containers.\n */\nconst initialize = () => {\n    if (initialized) {\n        return;\n    }\n    // Register handlers first, before initializing pages\n    registerHandlers();\n    registerTreeHandlers();\n    registerTurnHandlers();\n    const containers = $('.multi-model-chat-container[data-behavior=\"turns\"]');\n    if (containers.length === 0) {\n        initialized = true;\n        return;\n    }\n    containers.each(function() {\n        const pageid = parseInt($(this).data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n        initMultiModelTurnsPage(pageid);\n    });\n    initialized = true;\n};\n\n/**\n * Initialize a specific multi-model turns chat page.\n *\n * @param {number} pageid Page ID\n */\nconst initMultiModelTurnsPage = (pageid) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const tabPanes = container.find('.tab-pane[data-model-id]');\n    \n    // Initialize turn state for each model\n    if (!modelTurns[pageid]) {\n        modelTurns[pageid] = {};\n    }\n    \n    // Get URL params once\n    const urlParams = new URLSearchParams(window.location.search);\n    const urlTurn = urlParams.get('turn');\n    const urlModel = urlParams.get('model');\n    \n    // First, ensure all messages from backend have correct data attributes\n    tabPanes.each(function() {\n        const modelid = parseInt($(this).data('model-id'), 10);\n        const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n        \n        // Add data-model-id to all messages that don't have it\n        // Messages might be wrapped in a div with data-model-id, or directly in the container\n        messagesContainer.find('.message, [data-model-id] .message').each(function() {\n            const $msg = $(this);\n            // Check if message is inside a wrapper div with data-model-id\n            const wrapper = $msg.closest('[data-model-id]');\n            const wrapperModelId = wrapper.length ? parseInt(wrapper.data('model-id'), 10) : null;\n            \n            if (!$msg.attr('data-model-id')) {\n                // Use wrapper's model-id if available, otherwise use tab's modelid\n                $msg.attr('data-model-id', wrapperModelId || modelid);\n            }\n            \n            // Also ensure the message element itself has the attribute (not just wrapper)\n            if ($msg.attr('data-model-id') !== String(modelid) && wrapperModelId !== modelid) {\n                $msg.attr('data-model-id', modelid);\n            }\n        });\n        \n        // Calculate initial turn for this model based on messages\n        let maxTurn = 0;\n        messagesContainer.find('[data-turn-id]').each(function() {\n            const turnId = parseInt($(this).data('turn-id'), 10);\n            if (turnId && turnId > maxTurn) {\n                maxTurn = turnId;\n            }\n        });\n        const calculatedCurrentTurn = maxTurn > 0 ? maxTurn : 1;\n        \n        if (!modelTurns[pageid][modelid]) {\n            modelTurns[pageid][modelid] = calculatedCurrentTurn;\n        }\n        \n        // Get initial viewing turn from URL or use calculated\n        let initialViewingTurn = modelTurns[pageid][modelid];\n        \n        // If URL has model param, only apply turn to that model\n        // Otherwise, apply turn to all models (for backward compatibility)\n        if (urlTurn !== null && urlTurn !== '') {\n            const parsedTurn = parseInt(urlTurn, 10);\n            if (!isNaN(parsedTurn) && parsedTurn > 0) {\n                if (urlModel === null || urlModel === '' || parseInt(urlModel, 10) === modelid) {\n                    initialViewingTurn = parsedTurn;\n                }\n            }\n        }\n        \n        setViewingTurnForModel(pageid, modelid, initialViewingTurn);\n        updateTurnDisplayForModel(pageid, modelid);\n        updateChatLockStateForModel(pageid, modelid);\n    });\n    \n    // Activate the model tab from URL if specified\n    if (urlModel !== null && urlModel !== '') {\n        const modelIdFromUrl = parseInt(urlModel, 10);\n        if (!isNaN(modelIdFromUrl)) {\n            const tabButton = $(`#model-tab-${modelIdFromUrl}-${pageid}`);\n            if (tabButton.length > 0) {\n                tabButton.tab('show');\n            }\n        }\n    }\n    \n    // Load conversation tree (shared across models for turns mode)\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (sidebar.length > 0) {\n        sidebar.show();\n        const firstModel = tabPanes.first().data('model-id');\n        $(`.toggle-tree-btn[data-pageid=\"${pageid}\"][data-model-id=\"${firstModel}\"]`).addClass('active');\n        loadConversationTree(pageid).then(() => {\n            // Filter messages for all models after tree loads\n            tabPanes.each(function() {\n                const modelid = parseInt($(this).data('model-id'), 10);\n                const viewingTurn = getViewingTurnForModel(pageid, modelid);\n                filterMessagesByTurnForModel(pageid, modelid, viewingTurn);\n            });\n        }).catch(() => {\n            // If tree loading fails, still filter\n            tabPanes.each(function() {\n                const modelid = parseInt($(this).data('model-id'), 10);\n                const viewingTurn = getViewingTurnForModel(pageid, modelid);\n                filterMessagesByTurnForModel(pageid, modelid, viewingTurn);\n            });\n        });\n    } else {\n        // No sidebar - filter immediately\n        tabPanes.each(function() {\n            const modelid = parseInt($(this).data('model-id'), 10);\n            const viewingTurn = getViewingTurnForModel(pageid, modelid);\n            filterMessagesByTurnForModel(pageid, modelid, viewingTurn);\n        });\n    }\n    \n    // Load turn evaluation questions\n    setTimeout(() => {\n        tabPanes.each(function() {\n            const modelid = parseInt($(this).data('model-id'), 10);\n            const viewingTurn = getViewingTurnForModel(pageid, modelid);\n            ensureTurnEvaluationQuestionsRenderedForModel(pageid, modelid, viewingTurn).then(() => {\n                loadTurnEvaluationResponsesForModel(pageid, modelid, viewingTurn);\n            }).catch((error) => {\n                // eslint-disable-next-line no-console\n                console.error('Error loading turn evaluation questions on init:', error);\n            });\n        });\n    }, 100);\n};\n\n/**\n * Get viewing turn for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @return {number} Viewing turn number\n */\nconst getViewingTurnForModel = (pageid, modelid) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const key = `viewing-turn-${modelid}`;\n    return parseInt(container.data(key) || modelTurns[pageid]?.[modelid] || 1, 10);\n};\n\n/**\n * Set viewing turn for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turn Turn number\n */\nconst setViewingTurnForModel = (pageid, modelid, turn) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const key = `viewing-turn-${modelid}`;\n    container.data(key, turn);\n    if (!modelTurns[pageid]) {\n        modelTurns[pageid] = {};\n    }\n    modelTurns[pageid][modelid] = turn;\n    \n    // Update URL with turn and model parameters\n    const urlParams = new URLSearchParams(window.location.search);\n    urlParams.set('turn', turn);\n    urlParams.set('model', modelid);\n    const newUrl = window.location.pathname + '?' + urlParams.toString();\n    window.history.replaceState({}, '', newUrl);\n    \n    // Activate the correct model tab\n    const tabButton = $(`#model-tab-${modelid}-${pageid}`);\n    if (tabButton.length > 0) {\n        tabButton.tab('show');\n    }\n};\n\n/**\n * Get current turn for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @return {number} Current turn number\n */\nconst getCurrentTurnForModel = (pageid, modelid) => {\n    return modelTurns[pageid]?.[modelid] || 1;\n};\n\n/**\n * Update turn display for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n */\nconst updateTurnDisplayForModel = (pageid, modelid) => {\n    const viewingTurn = getViewingTurnForModel(pageid, modelid);\n    const badge = $(`#current-turn-badge-model-${modelid}-${pageid}`);\n    const numberSpan = $(`#current-turn-number-model-${modelid}-${pageid}`);\n    if (badge.length && numberSpan.length) {\n        getString('turn', 'mod_harpiasurvey').then((turnStr) => {\n            numberSpan.text(`${turnStr} ${viewingTurn}`);\n        });\n    }\n};\n\n/**\n * Update chat lock state for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n */\nconst updateChatLockStateForModel = (pageid, modelid) => {\n    const viewingTurn = getViewingTurnForModel(pageid, modelid);\n    const currentTurn = getCurrentTurnForModel(pageid, modelid);\n    const input = $(`#chat-input-model-${modelid}-${pageid}`);\n    const button = $(`#send-message-btn-model-${modelid}-${pageid}`);\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    \n    // Check max turns\n    const maxTurns = container.data('max-turns');\n    const minTurns = container.data('min-turns');\n    \n    let shouldLock = false;\n    if (viewingTurn < currentTurn) {\n        // Viewing a past turn - lock it\n        shouldLock = true;\n    } else if (maxTurns !== undefined && maxTurns !== null) {\n        const maxTurnsNum = parseInt(maxTurns, 10);\n        const turnCount = getTurnCountForConversationForModel(pageid, modelid, viewingTurn);\n        if (turnCount !== null && turnCount >= maxTurnsNum) {\n            // Check if current turn is complete\n            if (isTurnCompleteForModel(pageid, modelid, viewingTurn)) {\n                shouldLock = true;\n            }\n        }\n    }\n    \n    if (shouldLock) {\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n        getString('chatlocked', 'mod_harpiasurvey').then((str) => {\n            input.attr('placeholder', str);\n        });\n    } else {\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        getString('typeyourmessage', 'mod_harpiasurvey').then((str) => {\n            input.attr('placeholder', str);\n        });\n    }\n};\n\n/**\n * Filter messages by turn for a specific model.\n * Shows only messages from the current pathway (conversation tree).\n * All messages from the current pathway remain in the DOM, but only the current turn is visible by default.\n * Previous turns are hidden by default and can be shown via the \"Show previous\" button.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} viewingTurn Turn ID to show\n */\nconst filterMessagesByTurnForModel = (pageid, modelid, viewingTurn) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    \n    // Default collapsed unless user toggled to show.\n    const shouldShowPrevious = messagesContainer.data('show-previous') === true;\n    \n    // Build set of allowed turn IDs (current pathway from root to current turn).\n    const tree = conversationTrees[pageid];\n    const root = tree ? findRootForTurn(tree.roots || [], viewingTurn) : null;\n    const allowedTurnIds = new Set();\n    allowedTurnIds.add(parseInt(viewingTurn, 10));\n    \n    if (root) {\n        // Recursively find the path from root to the target turn.\n        const addPath = (node, targetId, path) => {\n            if (parseInt(node.turn_id, 10) === parseInt(targetId, 10)) {\n                // Found the target - add all turns in the path.\n                path.forEach(id => allowedTurnIds.add(id));\n                allowedTurnIds.add(parseInt(node.turn_id, 10));\n                return true;\n            }\n            // Check direct branches (same level as root).\n            if (node.direct_branches) {\n                for (const db of node.direct_branches) {\n                    if (addPath(db, targetId, [...path, parseInt(node.turn_id, 10)])) {\n                        return true;\n                    }\n                }\n            }\n            // Check children (nested branches).\n            if (node.children) {\n                for (const child of node.children) {\n                    if (addPath(child, targetId, [...path, parseInt(node.turn_id, 10)])) {\n                        return true;\n                    }\n                }\n            }\n            return false;\n        };\n        addPath(root, viewingTurn, []);\n    } else {\n        // If tree not loaded yet, just allow the current turn.\n        // The tree will be loaded and filtering will be re-applied.\n        allowedTurnIds.add(parseInt(viewingTurn, 10));\n    }\n\n    // Process all messages in the container.\n    // Messages from the current pathway remain in DOM but are shown/hidden based on turn.\n    // Messages from other pathways are hidden.\n    messagesContainer.find('.message').each(function() {\n        const $msg = $(this);\n        const messageTurnId = parseInt($msg.data('turn-id'), 10);\n        const msgModelId = parseInt($msg.data('model-id'), 10);\n        \n        // First check if message belongs to this model\n        if (msgModelId !== modelid) {\n            // Message from different model - hide it\n            $msg.removeClass('previous-turn-message').hide();\n            return;\n        }\n        \n        if (!messageTurnId || isNaN(messageTurnId)) {\n            // Message without turn_id - hide it (shouldn't happen in turns mode).\n            $msg.removeClass('previous-turn-message').hide();\n            return;\n        }\n        \n        const isCurrentTurn = messageTurnId === parseInt(viewingTurn, 10);\n        const isInPathway = allowedTurnIds.has(messageTurnId);\n        \n        if (isInPathway) {\n            // Message is in the current pathway - keep in DOM.\n            if (isCurrentTurn) {\n                // Current turn - always visible.\n                $msg.removeClass('previous-turn-message').show();\n            } else {\n                // Previous turn in pathway - hide by default, show if toggle is on.\n                $msg.addClass('previous-turn-message');\n                if (shouldShowPrevious) {\n                    $msg.show();\n                } else {\n                    $msg.hide();\n                }\n            }\n        } else {\n            // Message is from a different pathway - hide it.\n            $msg.removeClass('previous-turn-message').hide();\n        }\n    });\n    \n    // Update toggle button state based on whether there are previous messages.\n    const toggleBtn = $(`.toggle-previous-messages-btn[data-pageid=\"${pageid}\"][data-model-id=\"${modelid}\"]`);\n    if (toggleBtn.length > 0) {\n        const hasPreviousMessages = messagesContainer.find('.previous-turn-message').length > 0;\n        if (hasPreviousMessages) {\n            toggleBtn.show();\n            toggleBtn.prop('disabled', false);\n            const firstPrevious = messagesContainer.find('.previous-turn-message').first();\n            const isVisible = firstPrevious.is(':visible');\n            updatePreviousToggleLabelForModel(toggleBtn, isVisible);\n        } else {\n            // No previous messages - hide the button.\n            toggleBtn.hide();\n        }\n    }\n\n    // Scroll to bottom after filtering.\n    setTimeout(() => {\n        scrollToBottomForModel(pageid, modelid);\n    }, 50);\n};\n\n/**\n * Update previous messages toggle button label for a model.\n *\n * @param {jQuery} button Toggle button element\n * @param {boolean} isVisible Whether previous messages are currently visible\n */\nconst updatePreviousToggleLabelForModel = (button, isVisible) => {\n    if (isVisible) {\n        getString('hideprevious', 'mod_harpiasurvey').then((str) => {\n            button.html('<i class=\"fa fa-eye-slash\" aria-hidden=\"true\"></i> ' + str);\n        });\n    } else {\n        getString('showprevious', 'mod_harpiasurvey').then((str) => {\n            button.html('<i class=\"fa fa-history\" aria-hidden=\"true\"></i> ' + str);\n        });\n    }\n};\n\n/**\n * Scroll to bottom for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n */\nconst scrollToBottomForModel = (pageid, modelid) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    requestAnimationFrame(() => {\n        const container = messagesContainer[0];\n        if (container) {\n            container.scrollTop = container.scrollHeight;\n        }\n    });\n};\n\n/**\n * Get turn count for conversation for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turnId Turn ID\n * @return {number|null} Turn count or null\n */\nconst getTurnCountForConversationForModel = (pageid, modelid, turnId) => {\n    const tree = conversationTrees[pageid];\n    if (!tree || !tree.roots) {\n        return null;\n    }\n    const root = findRootForTurn(tree.roots, turnId);\n    if (!root) {\n        return null;\n    }\n    return countNodes(root);\n};\n\n/**\n * Check if turn is complete for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turnId Turn ID\n * @return {boolean} True if turn is complete\n */\nconst isTurnCompleteForModel = (pageid, modelid, turnId) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    let hasUser = false;\n    let hasAssistant = false;\n    \n    messagesContainer.find(`.message[data-turn-id=\"${turnId}\"]`).each(function() {\n        const role = $(this).data('role');\n        if (role === 'user') {\n            hasUser = true;\n        } else if (role === 'assistant') {\n            hasAssistant = true;\n        }\n    });\n    \n    return hasUser && hasAssistant;\n};\n\n/**\n * Ensure turn evaluation questions are rendered for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turn Turn number\n * @return {Promise} Promise that resolves when questions are rendered\n */\nconst ensureTurnEvaluationQuestionsRenderedForModel = (pageid, modelid, turn) => {\n    const scriptEl = $(`#turn-evaluation-questions-data-${pageid}`);\n    if (scriptEl.length === 0) {\n        return Promise.resolve();\n    }\n    \n    try {\n        const questionsData = JSON.parse(scriptEl.text());\n        const tabPane = $(`#model-pane-${modelid}-${pageid}`);\n        const questionsContainer = tabPane.find('.turn-evaluation-questions');\n        \n        if (questionsContainer.length === 0) {\n            // Create container if it doesn't exist\n            const container = $('<div class=\"turn-evaluation-questions mt-4\"></div>');\n            tabPane.append(container);\n            questionsContainer = container;\n        }\n        \n        // Filter questions for this turn\n        const filteredQuestions = questionsData.filter(q => {\n            if (q.show_only_turn !== null && q.show_only_turn !== undefined) {\n                return parseInt(q.show_only_turn, 10) === turn;\n            }\n            if (q.hide_on_turn !== null && q.hide_on_turn !== undefined) {\n                return parseInt(q.hide_on_turn, 10) !== turn;\n            }\n            return true;\n        });\n        \n        if (filteredQuestions.length === 0) {\n            questionsContainer.empty();\n            return Promise.resolve();\n        }\n        \n        // Render questions (similar to turns.js logic)\n        return Templates.render('mod_harpiasurvey/turn_evaluation_questions', {\n            questions: filteredQuestions,\n            pageid: pageid,\n            modelid: modelid,\n            turn: turn\n        }).then((html) => {\n            questionsContainer.html(html);\n        });\n    } catch (error) {\n        // eslint-disable-next-line no-console\n        console.error('Error parsing turn evaluation questions:', error);\n        return Promise.resolve();\n    }\n};\n\n/**\n * Load turn evaluation responses for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turn Turn number\n */\nconst loadTurnEvaluationResponsesForModel = (pageid, modelid, turn) => {\n    // Similar to turns.js - load saved responses\n    // Implementation would go here\n};\n\n/**\n * Register common handlers (send/enter).\n */\nfunction registerHandlers() {\n    if (handlersRegistered) {\n        return;\n    }\n    \n    // Handle send button clicks for multi-model turns\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"turns\"] .chat-send-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const modelid = parseInt(button.data('model-id'), 10);\n        const container = button.closest('.multi-model-chat-container');\n        \n        if (container.data('behavior') !== 'turns') {\n            return;\n        }\n        \n        if (!cmid || !pageid || !modelid) {\n            addError('Missing cmid, pageid, or model-id');\n            return;\n        }\n        \n        const input = $(`#chat-input-model-${modelid}-${pageid}`);\n        if (input.length === 0) {\n            addError('Chat input not found');\n            return;\n        }\n        \n        const inputValue = input.val();\n        if (!inputValue || !inputValue.trim()) {\n            return;\n        }\n        \n        const message = inputValue.trim();\n        \n        // Check if chat is locked\n        const viewingTurn = getViewingTurnForModel(pageid, modelid);\n        const currentTurn = getCurrentTurnForModel(pageid, modelid);\n        const viewingTurnNum = parseInt(viewingTurn, 10);\n        const currentTurnNum = parseInt(currentTurn, 10);\n        \n        if (viewingTurnNum < currentTurnNum) {\n            getString('chatlocked', 'mod_harpiasurvey').then((str) => {\n                Notification.addNotification({\n                    message: str + ' Navigate to the current turn first.',\n                    type: 'error'\n                });\n            });\n            return;\n        }\n        \n        // Check max turns\n        const maxTurns = container.data('max-turns');\n        if (maxTurns !== undefined && maxTurns !== null) {\n            const maxTurnsNum = parseInt(maxTurns, 10);\n            const turnCount = getTurnCountForConversationForModel(pageid, modelid, viewingTurnNum);\n            if (turnCount !== null && turnCount >= maxTurnsNum &&\n                isTurnCompleteForModel(pageid, modelid, viewingTurnNum)) {\n                getString('maxturnsreached', 'mod_harpiasurvey').then((str) => {\n                    Notification.addNotification({\n                        message: str,\n                        type: 'error'\n                    });\n                });\n                return;\n            }\n        }\n        \n        // Disable input and button\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n        input.val('');\n        \n        // Display user message\n        const tempId = 'temp-user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n        displayUserMessageForModel(pageid, modelid, message, tempId);\n        \n        const loading = $(`#chat-loading-model-${modelid}-${pageid}`);\n        loading.show();\n        \n        sendMessageForModel(cmid, pageid, message, modelid, button, input, loading);\n    });\n    \n    // Handle Enter key\n    $(document).on('keydown', '.multi-model-chat-container[data-behavior=\"turns\"] .chat-input', function(e) {\n        if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault();\n            const input = $(this);\n            const modelid = parseInt(input.data('model-id'), 10);\n            const pageid = parseInt(input.data('pageid'), 10);\n            $(`#send-message-btn-model-${modelid}-${pageid}`).click();\n        }\n    });\n    \n    handlersRegistered = true;\n}\n\n/**\n * Display user message for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {string} message Message content\n * @param {number} messageid Message ID\n */\nconst displayUserMessageForModel = (pageid, modelid, message, messageid) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    messagesContainer.find('.text-center.text-muted').remove();\n    const viewingTurn = getViewingTurnForModel(pageid, modelid);\n    Templates.render('mod_harpiasurvey/chat_user_message', {\n        id: messageid,\n        content: message,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        const $html = $(html);\n        // Ensure the message has the correct data attributes\n        $html.attr('data-messageid', messageid);\n        $html.attr('data-model-id', modelid);\n        if (viewingTurn) {\n            $html.attr('data-turn-id', viewingTurn);\n        }\n        $html.attr('data-role', 'user');\n        messagesContainer.append($html);\n        scrollToBottomForModel(pageid, modelid);\n    }).catch(Notification.exception);\n};\n\n/**\n * Send message for a specific model.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {string} message Message content\n * @param {number} modelid Model ID\n * @param {jQuery} button Send button\n * @param {jQuery} input Input field\n * @param {jQuery} loading Loading indicator\n */\nconst sendMessageForModel = (cmid, pageid, message, modelid, button, input, loading) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const viewingTurn = getViewingTurnForModel(pageid, modelid);\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    \n    let parentid = null;\n    const visibleMessages = messagesContainer.find('.message:visible');\n    if (visibleMessages.length > 0) {\n        const lastMessage = visibleMessages.last();\n        const lastMessageId = parseInt(lastMessage.data('messageid'), 10);\n        if (lastMessageId && !isNaN(lastMessageId)) {\n            parentid = lastMessageId;\n        }\n    }\n    \n    const params = new URLSearchParams({\n        action: 'send_ai_message',\n        cmid: cmid,\n        pageid: pageid,\n        message: message,\n        modelid: modelid,\n        sesskey: Config.sesskey\n    });\n    \n    if (parentid) {\n        params.append('parentid', parentid);\n    }\n    \n    // Add turn_id if we're in a specific turn\n    if (viewingTurn) {\n        params.append('turn_id', viewingTurn);\n    }\n    \n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then(response => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then(data => {\n        loading.hide();\n        if (data.success) {\n            if (data.messageid && data.content) {\n                // Update turn state if new turn was created (before displaying message)\n                const newTurnId = data.turn_id ? parseInt(data.turn_id, 10) : viewingTurn;\n                if (newTurnId > viewingTurn) {\n                    setViewingTurnForModel(pageid, modelid, newTurnId);\n                    modelTurns[pageid][modelid] = newTurnId;\n                    updateTurnDisplayForModel(pageid, modelid);\n                }\n                \n                // Display AI message with correct turn_id\n                displayAIMessageForModel(pageid, modelid, data.content, data.messageid, newTurnId).then(() => {\n                    // Reload tree and filter messages - use the turn_id from response\n                    const turnToView = newTurnId || viewingTurn;\n                    loadConversationTree(pageid).then(() => {\n                        // After tree loads, filter messages for the correct turn\n                        filterMessagesByTurnForModel(pageid, modelid, turnToView);\n                        updateChatLockStateForModel(pageid, modelid);\n                        setTimeout(() => {\n                            scrollToBottomForModel(pageid, modelid);\n                        }, 100);\n                    }).catch(() => {\n                        // If tree reload fails, still filter and scroll\n                        filterMessagesByTurnForModel(pageid, modelid, turnToView);\n                        updateChatLockStateForModel(pageid, modelid);\n                        setTimeout(() => {\n                            scrollToBottomForModel(pageid, modelid);\n                        }, 100);\n                    });\n                });\n            } else {\n                addError('Received response but missing message ID or content');\n                input.prop('disabled', false);\n                button.prop('disabled', false);\n                input.focus();\n            }\n        } else {\n            addError(data.message || 'Error sending message');\n            input.prop('disabled', false);\n            button.prop('disabled', false);\n            input.focus();\n        }\n    })\n    .catch(error => {\n        loading.hide();\n        // eslint-disable-next-line no-console\n        console.error('Error sending message:', error);\n        addError('Error sending message: ' + error.message);\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    });\n};\n\n/**\n * Display AI message for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {string} content Message content\n * @param {number} messageid Message ID\n * @param {number} turnId Turn ID\n * @return {Promise} Promise that resolves when message is displayed\n */\nconst displayAIMessageForModel = (pageid, modelid, content, messageid, turnId) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return Promise.resolve();\n    }\n    return Templates.render('mod_harpiasurvey/chat_ai_message', {\n        id: messageid,\n        content: content,\n        timecreated: Math.floor(Date.now() / 1000),\n        turn_id: turnId,\n        modelid: modelid\n    }).then((html) => {\n        const $html = $(html);\n        // Ensure the message has the correct data attributes\n        $html.attr('data-messageid', messageid);\n        $html.attr('data-model-id', modelid);\n        if (turnId) {\n            $html.attr('data-turn-id', turnId);\n        }\n        $html.attr('data-role', 'assistant');\n        messagesContainer.append($html);\n        scrollToBottomForModel(pageid, modelid);\n        return $html[0].outerHTML;\n    }).catch(Notification.exception);\n};\n\n/**\n * Load conversation tree (shared across models for turns mode).\n *\n * @param {number} pageid Page ID\n * @return {Promise} Promise that resolves when tree is loaded\n */\nconst loadConversationTree = (pageid) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (treeContainer.length === 0) {\n        return Promise.resolve(null);\n    }\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const cmid = parseInt(container.attr('data-cmid') || container.data('cmid'), 10);\n    if (!cmid) {\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error: Course module ID not found. Please refresh the page.</div>');\n        return Promise.resolve(null);\n    }\n    const params = new URLSearchParams();\n    params.append('action', 'get_conversation_tree');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n    return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (data.success && data.tree) {\n            data.tree.roots = (data.tree.roots || []).map((root, idx) => ({\n                ...root,\n                conversation_number: idx + 1\n            }));\n            conversationTrees[pageid] = data.tree;\n            \n            // Get viewing turn from the active model tab (or first model)\n            // Note: container is already declared at the top of this function (line 879)\n            const activeTab = container.find('.tab-pane.active');\n            let activeModelId = parseInt(activeTab.data('model-id'), 10);\n            if (!activeModelId || isNaN(activeModelId)) {\n                activeModelId = parseInt(container.find('.tab-pane[data-model-id]').first().data('model-id'), 10);\n            }\n            const viewingTurn = activeModelId ? getViewingTurnForModel(pageid, activeModelId) : \n                (data.tree.roots && data.tree.roots.length > 0 ? parseInt(data.tree.roots[0].turn_id, 10) : 1);\n            const cmid = getCmid(pageid);\n            \n            // Check if we're in list view or detail view\n            const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n            const viewMode = sidebar.data('sidebar-view') || 'list';\n            \n            if (viewMode === 'list') {\n                // Render simple list\n                renderConversationList(pageid, data.tree.roots);\n            } else {\n                // Render using Fancytree for detail view\n                ensureFancytree().then(() => {\n                    renderFancyTree(pageid, data.tree.roots, viewingTurn, cmid);\n                }).catch((error) => {\n                    // eslint-disable-next-line no-console\n                    console.error('Error loading Fancytree:', error);\n                    renderConversationList(pageid, data.tree.roots);\n                });\n            }\n            \n            return data.tree;\n        } else {\n            treeContainer.html('<div class=\"text-muted text-center small py-3\">' +\n                (data.message || 'No conversation tree available yet.') + '</div>');\n            return null;\n        }\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error loading conversation tree:', error);\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error loading conversation tree: ' + error.message + '<br>' +\n            'Please check the browser console for details and refresh the page.</div>');\n        return null;\n    });\n};\n\n/**\n * Convert conversation tree nodes to Fancytree nodes.\n *\n * @param {Object} node Node from server\n * @param {number} idx Index\n * @param {string|null} parentNumber Parent number for hierarchical numbering\n * @param {number} viewingTurn Currently viewed turn\n * @param {number} cmid Course module ID\n * @return {Object} Fancytree node\n */\nconst toFancyNode = (node, idx, parentNumber, viewingTurn, cmid) => {\n    const turnNumber = calculateTurnNumber(node, idx, parentNumber);\n    const title = 'Turn ' + turnNumber + (node.branch_label ? ' (' + node.branch_label + ')' : '');\n    const children = [];\n    let childCounter = 0;\n\n    if (node.direct_branches && node.direct_branches.length > 0) {\n        const sortedDirect = [...node.direct_branches].sort((a, b) =>\n            parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n        );\n        sortedDirect.forEach((db) => {\n            children.push(toFancyNode(db, childCounter, turnNumber, viewingTurn, cmid));\n            childCounter++;\n        });\n    }\n\n    if (node.children && node.children.length > 0) {\n        const sortedChildren = [...node.children].sort((a, b) =>\n            parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n        );\n        sortedChildren.forEach((child, childIdx) => {\n            children.push(toFancyNode(child, childIdx, turnNumber, viewingTurn, cmid));\n        });\n    }\n\n    const hasChildren = children.length > 0;\n    const extraClasses = [];\n    if (node.is_root) {\n        extraClasses.push('ft-root');\n    } else if (node.is_direct_branch) {\n        extraClasses.push('ft-direct-branch');\n    } else {\n        extraClasses.push('ft-branch');\n    }\n    if (hasChildren) {\n        extraClasses.push('ft-has-children');\n    }\n\n    return {\n        title: title,\n        key: String(node.turn_id),\n        expanded: node.is_root || parseInt(node.turn_id, 10) === parseInt(viewingTurn, 10),\n        active: parseInt(node.turn_id, 10) === parseInt(viewingTurn, 10),\n        extraClasses: extraClasses.join(' '),\n        children: children,\n        data: {\n            turn_id: node.turn_id,\n            is_root: node.is_root || false,\n            is_direct_branch: node.is_direct_branch || false,\n            cmid: cmid,\n            turn_number: turnNumber\n        }\n    };\n};\n\n/**\n * Render Fancytree (similar to turns.js).\n *\n * @param {number} pageid Page ID\n * @param {Array} roots Root nodes\n * @param {number} viewingTurn Viewing turn number\n * @param {number} cmid Course module ID\n */\nconst renderFancyTree = (pageid, roots, viewingTurn, cmid) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    if (treeContainer.length === 0) {\n        return;\n    }\n\n    // Build data for Fancytree: show only the current conversation tree.\n    const rootForViewing = findRootForTurn(roots || [], viewingTurn);\n    const rootsToRender = rootForViewing ? [rootForViewing] : ((roots && roots.length > 0) ? [roots[0]] : []);\n    const source = rootsToRender.map((root, idx) => toFancyNode(root, idx, null, viewingTurn, cmid));\n    const activeRootTurnId = rootsToRender.length ? rootsToRender[0].turn_id : null;\n\n    // Reset container with a top bar and toolbar.\n    treeContainer.html(\n        '<div class=\"tree-header d-flex align-items-center justify-content-between mb-2\">' +\n            '<div class=\"d-flex align-items-center\">' +\n                '<button class=\"btn btn-link btn-sm p-0 mr-2 back-to-list-btn\" data-pageid=\"' + pageid + '\" title=\"Back to list\">' +\n                    '<i class=\"fa fa-arrow-left\"></i>' +\n                '</button>' +\n                '<span class=\"font-weight-bold text-primary\">Conversations</span>' +\n            '</div>' +\n            '<div class=\"btn-group btn-group-sm tree-toolbar\" role=\"group\">' +\n                '<button class=\"btn btn-outline-secondary tree-toolbar-collapse-all\" data-pageid=\"' + pageid + '\" title=\"Collapse all\">' +\n                    '<i class=\"fa fa-minus-square-o\" aria-hidden=\"true\"></i>' +\n                '</button>' +\n                '<button class=\"btn btn-outline-secondary tree-toolbar-expand-current\" data-pageid=\"' + pageid + '\" title=\"Focus current turn\">' +\n                    '<i class=\"fa fa-bullseye\" aria-hidden=\"true\"></i>' +\n                '</button>' +\n            '</div>' +\n        '</div>' +\n        (activeRootTurnId ? (\n            '<div class=\"mb-2\">' +\n                '<button class=\"btn btn-sm btn-success btn-block create-direct-branch-btn\" ' +\n                    'data-pageid=\"' + pageid + '\" data-cmid=\"' + cmid + '\" data-root-turn-id=\"' + activeRootTurnId + '\">' +\n                    '<i class=\"fa fa-plus-circle\" aria-hidden=\"true\"></i> New turn from root' +\n                '</button>' +\n            '</div>'\n        ) : '') +\n        '<div class=\"fancytree-host fancytree-skin-win8\" id=\"fancytree-host-' + pageid + '\"></div>'\n    );\n    const host = $(`#fancytree-host-${pageid}`);\n\n    host.fancytree({\n        source: source,\n        checkbox: false,\n        selectMode: 1,\n        toggleEffect: false,\n        clickFolderMode: 3,\n        activate: (event, data) => {\n            const turnId = parseInt(data.node.key, 10);\n            if (turnId) {\n                // Navigate to turn for the active model\n                const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n                const activeTab = container.find('.tab-pane.active');\n                const activeModelId = parseInt(activeTab.data('model-id'), 10);\n                if (activeModelId) {\n                    navigateToTurnForModel(pageid, activeModelId, turnId);\n                }\n            }\n        },\n        renderNode: (event, data) => {\n            const node = data.node;\n            const turnId = parseInt(node.key, 10);\n\n            // Add a compact branch button inline.\n            $(node.span).find('.ft-branch-btn').remove(); // prevent duplicates on re-render\n            const $btn = $('<button type=\"button\" class=\"btn btn-xs btn-outline-success ml-1 ft-branch-btn\" title=\"Branch\"></button>');\n            $btn.append('<i class=\"fa fa-code-branch\"></i>');\n            $btn.on('click', (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                if (!cmid || !turnId) {\n                    Notification.addNotification({\n                        message: 'Missing data to create branch',\n                        type: 'error'\n                    });\n                    return;\n                }\n                createBranchFromTurnForModel(cmid, pageid, turnId, $btn);\n            });\n\n            $(node.span).find('.fancytree-title').after($btn);\n        }\n    });\n\n    fancytreeInstances[pageid] = host.fancytree('getTree');\n};\n\n/**\n * Navigate to a specific turn for a model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turnId Turn ID\n */\nconst navigateToTurnForModel = (pageid, modelid, turnId) => {\n    setViewingTurnForModel(pageid, modelid, turnId);\n    updateTurnDisplayForModel(pageid, modelid);\n    updateChatLockStateForModel(pageid, modelid);\n    filterMessagesByTurnForModel(pageid, modelid, turnId);\n    \n    // Load turn evaluation questions\n    ensureTurnEvaluationQuestionsRenderedForModel(pageid, modelid, turnId).then(() => {\n        loadTurnEvaluationResponsesForModel(pageid, modelid, turnId);\n    });\n};\n\n/**\n * Create branch from turn for a model.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {number} turnId Turn ID\n * @param {jQuery} button Button element\n */\nconst createBranchFromTurnForModel = (cmid, pageid, turnId, button) => {\n    // Similar to turns.js createBranchFromTurn\n    // Implementation would create a new branch from the specified turn\n    // For now, use a simplified version\n    const params = new URLSearchParams();\n    params.append('action', 'create_branch');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('parent_turn_id', turnId);\n    params.append('sesskey', Config.sesskey);\n    \n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then(response => response.json())\n    .then(data => {\n        if (data.success) {\n            loadConversationTree(pageid);\n            Notification.addNotification({\n                message: data.message || 'Branch created successfully',\n                type: 'success'\n            });\n        } else {\n            addError(data.message || 'Failed to create branch');\n        }\n    })\n    .catch(error => {\n        // eslint-disable-next-line no-console\n        console.error('Error creating branch:', error);\n        addError('Error creating branch: ' + error.message);\n    });\n};\n\n/**\n * Register tree handlers.\n */\nfunction registerTreeHandlers() {\n    if (treeHandlersRegistered) {\n        return;\n    }\n    \n    // Handle tree node navigation clicks (for list view).\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"turns\"] ~ .conversation-tree-sidebar .conversation-item, .conversation-tree-sidebar .conversation-item', function(e) {\n        e.preventDefault();\n        const item = $(this);\n        // Try multiple possible ID fields\n        let rootTurnId = parseInt(item.data('root-turn-id'), 10);\n        if (!rootTurnId || isNaN(rootTurnId)) {\n            rootTurnId = parseInt(item.data('conversation-id'), 10);\n        }\n        if (!rootTurnId || isNaN(rootTurnId)) {\n            rootTurnId = parseInt(item.data('turn-id'), 10);\n        }\n        \n        const sidebar = item.closest('.conversation-tree-sidebar');\n        const pageid = parseInt(sidebar.attr('id').replace('conversation-tree-sidebar-', ''), 10);\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        \n        if (!pageid || container.length === 0) {\n            return;\n        }\n        \n        const activeTab = container.find('.tab-pane.active');\n        const activeModelId = parseInt(activeTab.data('model-id'), 10);\n\n        if (!activeModelId) {\n            // If no active tab, use the first model\n            const firstTab = container.find('.tab-pane[data-model-id]').first();\n            const firstModelId = parseInt(firstTab.data('model-id'), 10);\n            if (firstModelId) {\n                if (rootTurnId) {\n                    sidebar.data('sidebar-view', 'detail');\n                    navigateToTurnForModel(pageid, firstModelId, rootTurnId);\n                }\n            }\n            return;\n        }\n\n        if (rootTurnId) {\n            sidebar.data('sidebar-view', 'detail');\n            navigateToTurnForModel(pageid, activeModelId, rootTurnId);\n        }\n    });\n\n    // Handle back to list button click.\n    $(document).on('click', '.back-to-list-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n\n        const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n        sidebar.data('sidebar-view', 'list');\n\n        const tree = conversationTrees[pageid];\n        if (tree) {\n            renderConversationList(pageid, tree.roots);\n        } else {\n            loadConversationTree(pageid).then(() => {\n                const tree = conversationTrees[pageid];\n                if (tree) {\n                    renderConversationList(pageid, tree.roots);\n                }\n            });\n        }\n    });\n\n    // Handle create branch button clicks.\n    $(document).on('click', '.create-branch-from-tree-btn, .ft-branch-btn', function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid') || button.closest('[data-pageid]').data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid') || button.closest('[data-cmid]').data('cmid'), 10);\n        const turnId = parseInt(button.data('turn-id') || button.closest('[data-turn-id]').data('turn-id'), 10);\n\n        if (!pageid || !cmid || !turnId) {\n            addError('Missing required data to create branch');\n            return;\n        }\n        createBranchFromTurnForModel(cmid, pageid, turnId, button);\n    });\n\n    // Handle \"create direct branch\" button clicks.\n    $(document).on('click', '.create-direct-branch-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        let parentTurnId = parseInt(button.data('root-turn-id'), 10);\n        if (!parentTurnId || isNaN(parentTurnId)) {\n            const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n            const activeTab = container.find('.tab-pane.active');\n            const activeModelId = parseInt(activeTab.data('model-id'), 10);\n            parentTurnId = getViewingTurnForModel(pageid, activeModelId);\n        }\n\n        if (!pageid || !cmid || !parentTurnId) {\n            addError('Missing required data to create branch');\n            return;\n        }\n\n        createBranchFromTurnForModel(cmid, pageid, parentTurnId, button);\n    });\n\n    // Handle create new root button clicks.\n    $(document).on('click', '.create-root-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            addError('Missing required data to create root');\n            return;\n        }\n        createNewRootForModel(cmid, pageid);\n    });\n    \n    // Handle export conversation button clicks.\n    $(document).on('click', '.export-conversation-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            addError('Missing required data to export conversation');\n            return;\n        }\n        \n        // Get current viewing turn for the active model\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        const activeTab = container.find('.tab-pane.active');\n        const activeModelId = parseInt(activeTab.data('model-id'), 10);\n        const viewingTurn = activeModelId ? getViewingTurnForModel(pageid, activeModelId) : null;\n        \n        // Build export URL\n        const params = new URLSearchParams();\n        params.append('action', 'export_conversation');\n        params.append('cmid', cmid);\n        params.append('pageid', pageid);\n        params.append('sesskey', Config.sesskey);\n        \n        if (viewingTurn) {\n            params.append('turn_id', viewingTurn);\n        }\n        \n        // Open export URL in new window/tab to trigger download\n        window.open(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), '_blank');\n    });\n\n    // Collapse/expand controls for Fancytree.\n    $(document).on('click', '.tree-toolbar-collapse-all', function(e) {\n        e.preventDefault();\n        const pageid = parseInt($(this).data('pageid'), 10);\n        const tree = fancytreeInstances[pageid];\n        if (tree) {\n            tree.visit(node => node.setExpanded(false));\n        }\n    });\n\n    $(document).on('click', '.tree-toolbar-expand-current', function(e) {\n        e.preventDefault();\n        const pageid = parseInt($(this).data('pageid'), 10);\n        const tree = fancytreeInstances[pageid];\n        if (tree) {\n            const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n            const activeTab = container.find('.tab-pane.active');\n            const activeModelId = parseInt(activeTab.data('model-id'), 10);\n            const viewingTurn = getViewingTurnForModel(pageid, activeModelId);\n            const node = tree.getNodeByKey(String(viewingTurn));\n            if (node) {\n                node.makeVisible();\n                node.setActive(true);\n            }\n        }\n    });\n    \n    treeHandlersRegistered = true;\n}\n\n/**\n * Create new root conversation.\n * In multi-model turns, all models share the same conversation tree,\n * so creating a root should navigate all models to the new root.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n */\nconst createNewRootForModel = (cmid, pageid) => {\n    const params = new URLSearchParams();\n    params.append('action', 'create_root');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n    \n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then(response => response.json())\n    .then(data => {\n        if (data.success) {\n            const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n            const activeTab = container.find('.tab-pane.active');\n            const activeModelId = parseInt(activeTab.data('model-id'), 10);\n            \n            // Clear all message containers and show placeholder\n            container.find('.tab-pane[data-model-id]').each(function() {\n                const modelid = parseInt($(this).data('model-id'), 10);\n                const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n                messagesContainer.empty();\n                messagesContainer.html('<div class=\"text-center text-muted py-4\">' +\n                    '<p>{{#str}}nomessagesyet, mod_harpiasurvey{{/str}}</p>' +\n                    '</div>');\n            });\n            \n            // Reload conversation tree\n            loadConversationTree(pageid).then(() => {\n                if (activeModelId && data.turn_id) {\n                    // Navigate active model to the new root\n                    navigateToTurnForModel(pageid, activeModelId, parseInt(data.turn_id, 10), true);\n                } else {\n                    // If no active model, navigate first model\n                    const firstModel = container.find('.tab-pane[data-model-id]').first();\n                    const firstModelId = parseInt(firstModel.data('model-id'), 10);\n                    if (firstModelId && data.turn_id) {\n                        navigateToTurnForModel(pageid, firstModelId, parseInt(data.turn_id, 10), true);\n                    }\n                }\n            });\n            Notification.addNotification({\n                message: data.message || 'New conversation created successfully',\n                type: 'success'\n            });\n        } else {\n            addError(data.message || 'Failed to create new conversation');\n        }\n    })\n    .catch(error => {\n        // eslint-disable-next-line no-console\n        console.error('Error creating new root:', error);\n        addError('Error creating new root: ' + error.message);\n    });\n};\n\n/**\n * Register turn handlers.\n */\nfunction registerTurnHandlers() {\n    if (turnHandlersRegistered) {\n        return;\n    }\n    \n    // Handle toggle previous messages button\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"turns\"] .toggle-previous-messages-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const modelid = parseInt(button.data('model-id'), 10);\n        const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n        \n        const isShowing = messagesContainer.data('show-previous') === true;\n        const newState = !isShowing;\n        messagesContainer.data('show-previous', newState);\n        \n        if (newState) {\n            messagesContainer.find('.previous-turn-message').show();\n            updatePreviousToggleLabelForModel(button, true);\n        } else {\n            messagesContainer.find('.previous-turn-message').hide();\n            updatePreviousToggleLabelForModel(button, false);\n        }\n    });\n    \n    // Handle toggle tree button\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"turns\"] .toggle-tree-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n        \n        if (sidebar.is(':visible')) {\n            sidebar.hide();\n            button.removeClass('active');\n        } else {\n            sidebar.show();\n            button.addClass('active');\n            loadConversationTree(pageid);\n        }\n    });\n    \n    turnHandlersRegistered = true;\n}\n\n"],"names":["initialized","handlersRegistered","treeHandlersRegistered","turnHandlersRegistered","fancytreeInstances","modelTurns","initialize","document","on","e","preventDefault","button","this","cmid","parseInt","data","pageid","modelid","container","closest","input","length","inputValue","val","trim","message","viewingTurn","getViewingTurnForModel","currentTurn","getCurrentTurnForModel","viewingTurnNum","then","str","addNotification","type","maxTurns","maxTurnsNum","turnCount","getTurnCountForConversationForModel","isTurnCompleteForModel","prop","tempId","Date","now","Math","random","toString","substr","displayUserMessageForModel","loading","show","sendMessageForModel","key","shiftKey","click","registerHandlers","item","rootTurnId","isNaN","sidebar","attr","replace","activeTab","find","activeModelId","navigateToTurnForModel","firstTab","first","firstModelId","tree","conversationTrees","roots","loadConversationTree","stopPropagation","turnId","createBranchFromTurnForModel","parentTurnId","createNewRootForModel","params","URLSearchParams","append","Config","sesskey","window","open","wwwroot","visit","node","setExpanded","getNodeByKey","String","makeVisible","setActive","registerTreeHandlers","messagesContainer","newState","updatePreviousToggleLabelForModel","hide","is","removeClass","addClass","registerTurnHandlers","containers","each","initMultiModelTurnsPage","tabPanes","urlParams","location","search","urlTurn","get","urlModel","$msg","wrapper","wrapperModelId","maxTurn","calculatedCurrentTurn","initialViewingTurn","parsedTurn","setViewingTurnForModel","updateTurnDisplayForModel","updateChatLockStateForModel","modelIdFromUrl","tabButton","tab","firstModel","filterMessagesByTurnForModel","catch","setTimeout","ensureTurnEvaluationQuestionsRenderedForModel","loadTurnEvaluationResponsesForModel","error","console","_modelTurns$pageid","turn","set","newUrl","pathname","history","replaceState","badge","numberSpan","turnStr","text","shouldLock","shouldShowPrevious","root","allowedTurnIds","Set","add","addPath","targetId","path","turn_id","forEach","id","direct_branches","db","children","child","messageTurnId","isCurrentTurn","has","toggleBtn","isVisible","scrollToBottomForModel","html","requestAnimationFrame","scrollTop","scrollHeight","hasUser","hasAssistant","role","scriptEl","Promise","resolve","questionsData","JSON","parse","tabPane","questionsContainer","filteredQuestions","filter","q","show_only_turn","undefined","hide_on_turn","empty","Templates","render","questions","messageid","remove","content","timecreated","floor","$html","Notification","exception","parentid","visibleMessages","lastMessage","last","lastMessageId","action","fetch","method","headers","response","ok","Error","status","json","success","newTurnId","displayAIMessageForModel","turnToView","focus","outerHTML","treeContainer","body","map","idx","conversation_number","renderFancyTree","toFancyNode","parentNumber","turnNumber","title","branch_label","childCounter","sort","a","b","push","childIdx","hasChildren","extraClasses","is_root","is_direct_branch","expanded","active","join","turn_number","rootForViewing","rootsToRender","source","activeRootTurnId","host","fancytree","checkbox","selectMode","toggleEffect","clickFolderMode","activate","event","renderNode","span","$btn","after"],"mappings":"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"}
{"version":3,"file":"multi_model_turns.min.js","sources":["../src/multi_model_turns.js"],"sourcesContent":["// Multi-model turns conversation logic for harpiasurvey chat.\n// Combines multi-model tabs with turn-based navigation and branching.\nimport {\n    Templates,\n    Notification,\n    Config,\n    getString,\n    $,\n    currentTurns,\n    conversationTrees,\n    scrollToBottom,\n    addError,\n    getCmid,\n    findRootForTurn,\n    countNodes,\n    calculateTurnNumber,\n    renderConversationList\n} from './common_chat';\n\nlet initialized = false;\nlet handlersRegistered = false;\nlet treeHandlersRegistered = false;\nlet turnHandlersRegistered = false;\nlet editLabel = 'Edit';\n\n// Store turn state per model: {pageid: {modelid: turnNumber}}\nconst modelTurns = {};\n\nconst lockQuestionItem = (questionItem) => {\n    questionItem.attr('data-response-locked', '1');\n    questionItem.removeAttr('data-response-editing');\n    questionItem.find('input, select, textarea').prop('disabled', true);\n};\n\nconst ensureEditButton = (questionItem) => {\n    let controls = questionItem.find('.question-edit-controls');\n    if (controls.length === 0) {\n        controls = $('<div class=\"mt-2 question-edit-controls\"></div>');\n        questionItem.append(controls);\n    }\n    let button = controls.find('.question-edit-btn');\n    if (button.length === 0) {\n        button = $('<button type=\"button\" class=\"btn btn-sm btn-outline-secondary question-edit-btn\"></button>');\n        controls.append(button);\n    }\n    button.text(editLabel);\n    button.show();\n};\n\nconst resetQuestionItemToNeutral = (questionItem) => {\n    if (!questionItem || questionItem.length === 0) {\n        return;\n    }\n\n    questionItem.removeAttr('data-response-locked');\n    questionItem.removeAttr('data-response-editing');\n    questionItem.find('.saved-response-message').remove();\n    questionItem.find('.answer-history').remove();\n    questionItem.find('.question-edit-controls').remove();\n\n    questionItem.find('input, select, textarea').prop('disabled', false);\n\n    questionItem.find('input[type=\"radio\"], input[type=\"checkbox\"]').each(function() {\n        $(this).prop('checked', Boolean(this.defaultChecked));\n    });\n\n    questionItem.find('select').each(function() {\n        const select = $(this);\n        const defaultOption = select.find('option').filter(function() {\n            return this.defaultSelected;\n        }).first();\n        if (defaultOption.length > 0) {\n            select.val(defaultOption.val());\n        } else {\n            select.prop('selectedIndex', 0);\n        }\n    });\n\n    questionItem.find('input[type=\"number\"], input[type=\"text\"], textarea').each(function() {\n        $(this).val(this.defaultValue || '');\n    });\n};\n\nexport const init = () => initialize();\n\n/**\n * Ensure one model tab is active (fallback for inconsistent initial markup/bootstrap state).\n *\n * @param {Object} container jQuery container\n */\nconst ensureFirstTabActive = (container) => {\n    if (container.find('.nav-link.active').length > 0 && container.find('.tab-pane.active').length > 0) {\n        return;\n    }\n\n    const firstTab = container.find('.nav-link[data-model-id]').first();\n    const firstPane = container.find('.tab-pane[data-model-id]').first();\n    if (firstTab.length === 0 || firstPane.length === 0) {\n        return;\n    }\n\n    container.find('.nav-link[data-model-id]').removeClass('active').attr('aria-selected', 'false');\n    container.find('.tab-pane[data-model-id]').removeClass('show active');\n    firstTab.addClass('active').attr('aria-selected', 'true');\n    firstPane.addClass('show active');\n};\n\n/**\n * Initialize multi-model turns-mode chat containers.\n */\nconst initialize = () => {\n    if (initialized) {\n        return;\n    }\n    getString('edit', 'moodle').then((str) => {\n        editLabel = str;\n    }).catch(() => {\n        editLabel = 'Edit';\n    });\n    // Register handlers first, before initializing pages\n    registerHandlers();\n    registerTreeHandlers();\n    registerTurnHandlers();\n    const containers = $('.multi-model-chat-container[data-behavior=\"turns\"]');\n    if (containers.length === 0) {\n        initialized = true;\n        return;\n    }\n    containers.each(function() {\n        const pageid = parseInt($(this).data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n        initMultiModelTurnsPage(pageid);\n    });\n    initialized = true;\n};\n\n/**\n * Initialize a specific multi-model turns chat page.\n *\n * @param {number} pageid Page ID\n */\nconst initMultiModelTurnsPage = (pageid) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const tabPanes = container.find('.tab-pane[data-model-id]');\n    ensureFirstTabActive(container);\n    \n    // Initialize turn state for each model\n    if (!modelTurns[pageid]) {\n        modelTurns[pageid] = {};\n    }\n    \n    // Get URL params once\n    const urlParams = new URLSearchParams(window.location.search);\n    const urlTurn = urlParams.get('turn');\n    const urlModel = urlParams.get('model');\n    const urlBranch = urlParams.get('branch');\n\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (sidebar.length > 0 && urlBranch !== null && urlBranch !== '') {\n        const parsedBranchRoot = parseInt(urlBranch, 10);\n        if (!isNaN(parsedBranchRoot) && parsedBranchRoot > 0) {\n            sidebar.data('sidebar-view', 'detail');\n            sidebar.data('branch-root', parsedBranchRoot);\n        }\n    }\n    \n    const hasExplicitUrlTurn = (() => {\n        if (urlTurn === null || urlTurn === '') {\n            return false;\n        }\n        const parsedTurn = parseInt(urlTurn, 10);\n        return !isNaN(parsedTurn) && parsedTurn > 0;\n    })();\n\n    // First, ensure all messages from backend have correct data attributes\n    tabPanes.each(function() {\n        const modelid = parseInt($(this).data('model-id'), 10);\n        const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n        \n        // Add data-model-id to all messages that don't have it\n        // Messages might be wrapped in a div with data-model-id, or directly in the container\n        messagesContainer.find('.message, [data-model-id] .message').each(function() {\n            const $msg = $(this);\n            // Check if message is inside a wrapper div with data-model-id\n            const wrapper = $msg.closest('[data-model-id]');\n            const wrapperModelId = wrapper.length ? parseInt(wrapper.data('model-id'), 10) : null;\n            \n            if (!$msg.attr('data-model-id')) {\n                // Use wrapper's model-id if available, otherwise use tab's modelid\n                $msg.attr('data-model-id', wrapperModelId || modelid);\n            }\n            \n            // Also ensure the message element itself has the attribute (not just wrapper)\n            if ($msg.attr('data-model-id') !== String(modelid) && wrapperModelId !== modelid) {\n                $msg.attr('data-model-id', modelid);\n            }\n        });\n        \n        // Calculate initial turn for this model based on messages\n        let maxTurn = 0;\n        messagesContainer.find('[data-turn-id]').each(function() {\n            const turnId = parseInt($(this).data('turn-id'), 10);\n            if (turnId && turnId > maxTurn) {\n                maxTurn = turnId;\n            }\n        });\n        const calculatedCurrentTurn = maxTurn > 0 ? maxTurn : 1;\n        \n        if (!modelTurns[pageid][modelid]) {\n            modelTurns[pageid][modelid] = calculatedCurrentTurn;\n        }\n        \n        // Get initial viewing turn from URL or use calculated\n        let initialViewingTurn = modelTurns[pageid][modelid];\n        let hasExplicitInitialTurn = false;\n        \n        // If URL has model param, only apply turn to that model\n        // Otherwise, apply turn to all models (for backward compatibility)\n        if (urlTurn !== null && urlTurn !== '') {\n            const parsedTurn = parseInt(urlTurn, 10);\n            if (!isNaN(parsedTurn) && parsedTurn > 0) {\n                if (urlModel === null || urlModel === '' || parseInt(urlModel, 10) === modelid) {\n                    initialViewingTurn = parsedTurn;\n                    hasExplicitInitialTurn = true;\n                }\n            }\n        }\n\n        const shouldAutoloadSelection = hasExplicitInitialTurn || maxTurn === 0;\n        if (shouldAutoloadSelection) {\n            setViewingTurnForModel(pageid, modelid, initialViewingTurn);\n            updateTurnDisplayForModel(pageid, modelid);\n            updateChatLockStateForModel(pageid, modelid);\n        } else {\n            setNoTurnSelectedStateForModel(pageid, modelid);\n        }\n    });\n    \n    // Activate the model tab from URL if specified\n    if (hasExplicitUrlTurn && urlModel !== null && urlModel !== '') {\n        const modelIdFromUrl = parseInt(urlModel, 10);\n        if (!isNaN(modelIdFromUrl)) {\n            const tabButton = $(`#model-tab-${modelIdFromUrl}-${pageid}`);\n            if (tabButton.length > 0) {\n                tabButton.tab('show');\n            }\n        }\n    }\n    \n    // Load conversation tree (shared across models for turns mode)\n    if (sidebar.length > 0) {\n        sidebar.show();\n        const firstModel = tabPanes.first().data('model-id');\n        $(`.toggle-tree-btn[data-pageid=\"${pageid}\"][data-model-id=\"${firstModel}\"]`).addClass('active');\n        loadConversationTree(pageid).then(() => {\n            // Filter messages for all models after tree loads\n            tabPanes.each(function() {\n                const modelid = parseInt($(this).data('model-id'), 10);\n                const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n                const maxTurnForModel = messagesContainer.find('.message[data-turn-id]').length > 0;\n                if (!hasExplicitUrlTurn && maxTurnForModel) {\n                    return;\n                }\n                const viewingTurn = getViewingTurnForModel(pageid, modelid);\n                filterMessagesByTurnForModel(pageid, modelid, viewingTurn);\n            });\n        }).catch(() => {\n            // If tree loading fails, still filter\n            tabPanes.each(function() {\n                const modelid = parseInt($(this).data('model-id'), 10);\n                const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n                const maxTurnForModel = messagesContainer.find('.message[data-turn-id]').length > 0;\n                if (!hasExplicitUrlTurn && maxTurnForModel) {\n                    return;\n                }\n                const viewingTurn = getViewingTurnForModel(pageid, modelid);\n                filterMessagesByTurnForModel(pageid, modelid, viewingTurn);\n            });\n        });\n    } else {\n        // No sidebar - filter immediately\n        tabPanes.each(function() {\n            const modelid = parseInt($(this).data('model-id'), 10);\n            const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n            const hasHistoryForModel = messagesContainer.find('.message[data-turn-id]').length > 0;\n            if (!hasExplicitUrlTurn && hasHistoryForModel) {\n                return;\n            }\n            const viewingTurn = getViewingTurnForModel(pageid, modelid);\n            filterMessagesByTurnForModel(pageid, modelid, viewingTurn);\n        });\n    }\n    \n    // Load turn evaluation questions\n    setTimeout(() => {\n        tabPanes.each(function() {\n            const modelid = parseInt($(this).data('model-id'), 10);\n            const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n            const hasHistoryForModel = messagesContainer.find('.message[data-turn-id]').length > 0;\n            if (!hasExplicitUrlTurn && hasHistoryForModel) {\n                return;\n            }\n            const viewingTurn = getViewingTurnForModel(pageid, modelid);\n            ensureTurnEvaluationQuestionsRenderedForModel(pageid, modelid, viewingTurn).then(() => {\n                loadTurnEvaluationResponsesForModel(pageid, modelid, viewingTurn);\n            }).catch((error) => {\n                // eslint-disable-next-line no-console\n                console.error('Error loading turn evaluation questions on init:', error);\n            });\n        });\n    }, 100);\n};\n\n/**\n * Get viewing turn for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @return {number} Viewing turn number\n */\nconst getViewingTurnForModel = (pageid, modelid) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const key = `viewing-turn-${modelid}`;\n    return parseInt(container.data(key) || modelTurns[pageid]?.[modelid] || 1, 10);\n};\n\n/**\n * Sync turns URL state for multi-model mode (turn + model + branch root when applicable).\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number|null} turnOverride Turn to persist (defaults to current viewing turn for model)\n */\nconst syncTurnsUrlStateForModel = (pageid, modelid, turnOverride = null) => {\n    if (!modelid || isNaN(modelid)) {\n        return;\n    }\n\n    const turn = turnOverride !== null ? parseInt(turnOverride, 10) : getViewingTurnForModel(pageid, modelid);\n    if (!turn || isNaN(turn)) {\n        return;\n    }\n\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    const branchRoot = parseInt(sidebar.data('branch-root'), 10);\n    const viewMode = sidebar.data('sidebar-view');\n\n    const urlParams = new URLSearchParams(window.location.search);\n    urlParams.set('turn', turn);\n    urlParams.set('model', modelid);\n\n    if (viewMode && viewMode !== 'list' && branchRoot && !isNaN(branchRoot)) {\n        urlParams.set('branch', branchRoot);\n    } else {\n        urlParams.delete('branch');\n    }\n\n    const newUrl = window.location.pathname + '?' + urlParams.toString();\n    window.history.replaceState({}, '', newUrl);\n};\n\n/**\n * Set viewing turn for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turn Turn number\n */\nconst setViewingTurnForModel = (pageid, modelid, turn) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const key = `viewing-turn-${modelid}`;\n    container.data(key, turn);\n    if (!modelTurns[pageid]) {\n        modelTurns[pageid] = {};\n    }\n    modelTurns[pageid][modelid] = turn;\n    \n    syncTurnsUrlStateForModel(pageid, modelid, turn);\n    \n    // Activate the correct model tab\n    const tabButton = $(`#model-tab-${modelid}-${pageid}`);\n    if (tabButton.length > 0) {\n        tabButton.tab('show');\n    }\n};\n\nconst setNoTurnSelectedStateForModel = (pageid, modelid) => {\n    const pane = $(`#model-pane-${modelid}-${pageid}`);\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    messagesContainer.find('.message').hide();\n\n    const evalContainer = $(`#qa-evaluation-questions-container-model-${modelid}-${pageid}, #turn-evaluation-questions-container-model-${modelid}-${pageid}`);\n    if (evalContainer.length > 0) {\n        evalContainer.empty();\n    }\n\n    const badge = $(`#current-turn-badge-model-${modelid}-${pageid}`);\n    if (badge.length) {\n        badge.hide();\n    }\n\n    if (messagesContainer.find('.message[data-turn-id]').length > 0) {\n        const input = $(`#chat-input-model-${modelid}-${pageid}`);\n        const button = $(`#send-message-btn-model-${modelid}-${pageid}`);\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n        pane.removeData(`viewing-turn-${modelid}`);\n    }\n};\n\n/**\n * Get current turn for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @return {number} Current turn number\n */\nconst getCurrentTurnForModel = (pageid, modelid) => {\n    return modelTurns[pageid]?.[modelid] || 1;\n};\n\n/**\n * Update turn display for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n */\nconst updateTurnDisplayForModel = (pageid, modelid) => {\n    const viewingTurn = getViewingTurnForModel(pageid, modelid);\n    const badge = $(`#current-turn-badge-model-${modelid}-${pageid}`);\n    const numberSpan = $(`#current-turn-number-model-${modelid}-${pageid}`);\n    if (badge.length && numberSpan.length) {\n        badge.show();\n        getString('turn', 'mod_harpiasurvey').then((turnStr) => {\n            numberSpan.text(`${turnStr} ${viewingTurn}`);\n        });\n    }\n};\n\n/**\n * Update chat lock state for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n */\nconst updateChatLockStateForModel = (pageid, modelid) => {\n    const viewingTurn = getViewingTurnForModel(pageid, modelid);\n    const currentTurn = getCurrentTurnForModel(pageid, modelid);\n    const input = $(`#chat-input-model-${modelid}-${pageid}`);\n    const button = $(`#send-message-btn-model-${modelid}-${pageid}`);\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    \n    // Check max turns\n    const maxTurns = container.data('max-turns');\n    const maxTurnsNum = (maxTurns !== undefined && maxTurns !== null) ? parseInt(maxTurns, 10) : null;\n    \n    let shouldLock = false;\n    if (viewingTurn < currentTurn) {\n        // Viewing a past turn - lock it\n        shouldLock = true;\n    } else if (isTurnCompleteForModel(pageid, modelid, viewingTurn)) {\n        // One prompt + one answer per turn, regardless of min/max turn constraints.\n        shouldLock = true;\n    } else if (maxTurnsNum !== null && !isNaN(maxTurnsNum)) {\n        const turnCount = getTurnCountForConversationForModel(pageid, modelid, viewingTurn);\n        if (turnCount !== null && turnCount >= maxTurnsNum && isTurnCompleteForModel(pageid, modelid, viewingTurn)) {\n            shouldLock = true;\n        }\n    }\n    \n    if (shouldLock) {\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n        getString('chatlocked', 'mod_harpiasurvey').then((str) => {\n            input.attr('placeholder', str);\n        });\n    } else {\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        getString('typeyourmessage', 'mod_harpiasurvey').then((str) => {\n            input.attr('placeholder', str);\n        });\n    }\n};\n\n/**\n * Filter messages by turn for a specific model.\n * Shows only messages from the current pathway (conversation tree).\n * All messages from the current pathway remain in the DOM, but only the current turn is visible by default.\n * Previous turns are hidden by default and can be shown via the \"Show previous\" button.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} viewingTurn Turn ID to show\n */\nconst filterMessagesByTurnForModel = (pageid, modelid, viewingTurn) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    \n    // Default collapsed unless user toggled to show.\n    const shouldShowPrevious = messagesContainer.data('show-previous') === true;\n    \n    // Build set of allowed turn IDs (current pathway from root to current turn).\n    const tree = conversationTrees[pageid];\n    const root = tree ? findRootForTurn(tree.roots || [], viewingTurn) : null;\n    const allowedTurnIds = new Set();\n    allowedTurnIds.add(parseInt(viewingTurn, 10));\n    \n    if (root) {\n        // Recursively find the path from root to the target turn.\n        const addPath = (node, targetId, path) => {\n            if (parseInt(node.turn_id, 10) === parseInt(targetId, 10)) {\n                // Found the target - add all turns in the path.\n                path.forEach(id => allowedTurnIds.add(id));\n                allowedTurnIds.add(parseInt(node.turn_id, 10));\n                return true;\n            }\n            // Check direct branches (same level as root).\n            if (node.direct_branches) {\n                for (const db of node.direct_branches) {\n                    if (addPath(db, targetId, [...path, parseInt(node.turn_id, 10)])) {\n                        return true;\n                    }\n                }\n            }\n            // Check children (nested branches).\n            if (node.children) {\n                for (const child of node.children) {\n                    if (addPath(child, targetId, [...path, parseInt(node.turn_id, 10)])) {\n                        return true;\n                    }\n                }\n            }\n            return false;\n        };\n        addPath(root, viewingTurn, []);\n    } else {\n        // If tree not loaded yet, just allow the current turn.\n        // The tree will be loaded and filtering will be re-applied.\n        allowedTurnIds.add(parseInt(viewingTurn, 10));\n    }\n\n    // Process all messages in the container.\n    // Messages from the current pathway remain in DOM but are shown/hidden based on turn.\n    // Messages from other pathways are hidden.\n    messagesContainer.find('.message').each(function() {\n        const $msg = $(this);\n        const messageTurnId = parseInt($msg.data('turn-id'), 10);\n        const msgModelId = parseInt($msg.data('model-id'), 10);\n        \n        // First check if message belongs to this model\n        if (msgModelId !== modelid) {\n            // Message from different model - hide it\n            $msg.removeClass('previous-turn-message').hide();\n            return;\n        }\n        \n        if (!messageTurnId || isNaN(messageTurnId)) {\n            // Message without turn_id - hide it (shouldn't happen in turns mode).\n            $msg.removeClass('previous-turn-message').hide();\n            return;\n        }\n        \n        const isCurrentTurn = messageTurnId === parseInt(viewingTurn, 10);\n        const isInPathway = allowedTurnIds.has(messageTurnId);\n        \n        if (isInPathway) {\n            // Message is in the current pathway - keep in DOM.\n            if (isCurrentTurn) {\n                // Current turn - always visible.\n                $msg.removeClass('previous-turn-message').show();\n            } else {\n                // Previous turn in pathway - hide by default, show if toggle is on.\n                $msg.addClass('previous-turn-message');\n                if (shouldShowPrevious) {\n                    $msg.show();\n                } else {\n                    $msg.hide();\n                }\n            }\n        } else {\n            // Message is from a different pathway - hide it.\n            $msg.removeClass('previous-turn-message').hide();\n        }\n    });\n    \n    // Update toggle button state based on whether there are previous messages.\n    const toggleBtn = $(`.toggle-previous-messages-btn[data-pageid=\"${pageid}\"][data-model-id=\"${modelid}\"]`);\n    if (toggleBtn.length > 0) {\n        const hasPreviousMessages = messagesContainer.find('.previous-turn-message').length > 0;\n        if (hasPreviousMessages) {\n            toggleBtn.show();\n            toggleBtn.prop('disabled', false);\n            const firstPrevious = messagesContainer.find('.previous-turn-message').first();\n            const isVisible = firstPrevious.is(':visible');\n            updatePreviousToggleLabelForModel(toggleBtn, isVisible);\n        } else {\n            // No previous messages - hide the button.\n            toggleBtn.hide();\n        }\n    }\n\n    // Scroll to bottom after filtering.\n    setTimeout(() => {\n        scrollToBottomForModel(pageid, modelid);\n    }, 50);\n};\n\n/**\n * Update previous messages toggle button label for a model.\n *\n * @param {jQuery} button Toggle button element\n * @param {boolean} isVisible Whether previous messages are currently visible\n */\nconst updatePreviousToggleLabelForModel = (button, isVisible) => {\n    if (isVisible) {\n        getString('hideprevious', 'mod_harpiasurvey').then((str) => {\n            button.html('<i class=\"fa fa-eye-slash\" aria-hidden=\"true\"></i> ' + str);\n        });\n    } else {\n        getString('showprevious', 'mod_harpiasurvey').then((str) => {\n            button.html('<i class=\"fa fa-history\" aria-hidden=\"true\"></i> ' + str);\n        });\n    }\n};\n\n/**\n * Scroll to bottom for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n */\nconst scrollToBottomForModel = (pageid, modelid) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    requestAnimationFrame(() => {\n        const container = messagesContainer[0];\n        if (container) {\n            container.scrollTop = container.scrollHeight;\n        }\n    });\n};\n\n/**\n * Get turn count for conversation for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turnId Turn ID\n * @return {number|null} Turn count or null\n */\nconst getTurnCountForConversationForModel = (pageid, modelid, turnId) => {\n    const tree = conversationTrees[pageid];\n    if (!tree || !tree.roots) {\n        return null;\n    }\n    const root = findRootForTurn(tree.roots, turnId);\n    if (!root) {\n        return null;\n    }\n    return countNodes(root);\n};\n\n/**\n * Check if turn is complete for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turnId Turn ID\n * @return {boolean} True if turn is complete\n */\nconst isTurnCompleteForModel = (pageid, modelid, turnId) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    let hasUser = false;\n    let hasAssistant = false;\n    \n    messagesContainer.find(`.message[data-turn-id=\"${turnId}\"]`).each(function() {\n        const role = $(this).data('role');\n        if (role === 'user') {\n            hasUser = true;\n        } else if (role === 'assistant') {\n            hasAssistant = true;\n        }\n    });\n    \n    return hasUser && hasAssistant;\n};\n\n/**\n * Ensure turn evaluation questions are rendered for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turn Turn number\n * @return {Promise} Promise that resolves when questions are rendered\n */\nconst ensureTurnEvaluationQuestionsRenderedForModel = (pageid, modelid, turn) => {\n    const scriptEl = $(`#turn-evaluation-questions-data-${pageid}`);\n    if (scriptEl.length === 0) {\n        return Promise.resolve();\n    }\n    \n    try {\n        const questionsData = JSON.parse(scriptEl.text());\n        const tabPane = $(`#model-pane-${modelid}-${pageid}`);\n        let questionsContainer = tabPane.find('.turn-evaluation-questions');\n        \n        if (questionsContainer.length === 0) {\n            // Create container if it doesn't exist\n            const container = $('<div class=\"turn-evaluation-questions mt-4\"></div>');\n            tabPane.append(container);\n            questionsContainer = container;\n        }\n        \n        // Filter questions for this turn\n        const filteredQuestions = questionsData.filter(q => {\n            if (q.show_only_turn !== null && q.show_only_turn !== undefined) {\n                return parseInt(q.show_only_turn, 10) === turn;\n            }\n            if (q.hide_on_turn !== null && q.hide_on_turn !== undefined) {\n                return parseInt(q.hide_on_turn, 10) !== turn;\n            }\n            return true;\n        });\n        \n        if (filteredQuestions.length === 0) {\n            questionsContainer.empty();\n            return Promise.resolve();\n        }\n        \n        // Render questions (similar to turns.js logic)\n        return Templates.render('mod_harpiasurvey/turn_evaluation_questions', {\n            questions: filteredQuestions,\n            pageid: pageid,\n            modelid: modelid,\n            turn_id: turn,\n            cmid: getCmid(pageid)\n        }).then((html) => {\n            questionsContainer.html(html);\n        });\n    } catch (error) {\n        // eslint-disable-next-line no-console\n        console.error('Error parsing turn evaluation questions:', error);\n        return Promise.resolve();\n    }\n};\n\n/**\n * Load turn evaluation responses for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turn Turn number\n */\nconst loadTurnEvaluationResponsesForModel = (pageid, modelid, turn) => {\n    const cmid = getCmid(pageid);\n    if (!cmid) {\n        return;\n    }\n    const tabPane = $(`#model-pane-${modelid}-${pageid}`);\n    if (tabPane.length === 0) {\n        return;\n    }\n    let questionsContainer = tabPane.find('.turn-evaluation-questions');\n    if (questionsContainer.length === 0) {\n        questionsContainer = tabPane.find('.turn-evaluation-questions-content').closest('.turn-evaluation-questions');\n    }\n    if (questionsContainer.length === 0) {\n        return;\n    }\n    questionsContainer.find('.question-item').each(function() {\n        resetQuestionItemToNeutral($(this));\n    });\n\n    const params = new URLSearchParams({\n        action: 'get_turn_responses',\n        cmid: cmid,\n        pageid: pageid,\n        turn_id: turn,\n        sesskey: Config.sesskey\n    });\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then(response => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then(data => {\n        if (!data.success || !data.responses || Object.keys(data.responses).length === 0) {\n            return;\n        }\n        Object.keys(data.responses).forEach((questionId) => {\n            const responseData = data.responses[questionId];\n            const questionItem = questionsContainer.find(`.question-item[data-questionid=\"${questionId}\"]`);\n            if (questionItem.length === 0) {\n                return;\n            }\n            const questionType = questionItem.data('questiontype');\n            const value = responseData.response;\n\n            if (questionType === 'singlechoice' || questionType === 'likert') {\n                questionItem.find('input[type=\"radio\"]').prop('checked', false);\n                questionItem.find(`input[type=\"radio\"][value=\"${value}\"]`).prop('checked', true);\n            } else if (questionType === 'multiplechoice') {\n                questionItem.find('input[type=\"checkbox\"]').prop('checked', false);\n                try {\n                    const values = JSON.parse(value);\n                    if (Array.isArray(values)) {\n                        values.forEach((val) => {\n                            questionItem.find(`input[type=\"checkbox\"][value=\"${val}\"]`).prop('checked', true);\n                        });\n                    }\n                } catch (e) {\n                    // ignore invalid JSON\n                }\n            } else if (questionType === 'select') {\n                questionItem.find('select').val(value);\n            } else if (questionType === 'number') {\n                questionItem.find('input[type=\"number\"]').val(value);\n            } else if (questionType === 'shorttext') {\n                questionItem.find('input[type=\"text\"]').val(value);\n            } else if (questionType === 'longtext') {\n                questionItem.find('textarea').val(value);\n            }\n\n            if (responseData.saved_datetime) {\n                getString('saved', 'mod_harpiasurvey').then((savedText) => {\n                    getString('on', 'mod_harpiasurvey').then((onText) => {\n                        const icon = '<i class=\"fa fa-check-circle\" aria-hidden=\"true\"></i>';\n                        let savedMessage = questionItem.find('.saved-response-message');\n                        if (savedMessage.length === 0) {\n                            const messageHtml = '<div class=\"mt-2 small text-muted saved-response-message\">' +\n                                `${icon} ${savedText} ${onText} ${responseData.saved_datetime}</div>`;\n                            questionItem.append(messageHtml);\n                        } else {\n                            savedMessage.html(`${icon} ${savedText} ${onText} ${responseData.saved_datetime}`);\n                        }\n                    });\n                });\n            }\n\n            lockQuestionItem(questionItem);\n            ensureEditButton(questionItem);\n\n            getString('answerhistory', 'mod_harpiasurvey').then((historyText) => {\n                let history = questionItem.find('.answer-history');\n                if (!history.length && responseData.history_count > 1) {\n                    const details = $('<details class=\"answer-history mt-1\"></details>');\n                    details.append(`<summary>${historyText} (${responseData.history_count})</summary>`);\n                    details.append('<ul class=\"list-unstyled mt-2 mb-0\"></ul>');\n                    questionItem.append(details);\n                    history = details;\n                }\n                if (history.length) {\n                    const list = history.find('ul');\n                    list.empty();\n                    (responseData.history_items || []).forEach((item) => {\n                        list.append(`<li class=\"mb-1\"><span class=\"text-muted\">${item.time}</span> â€” ${item.response}</li>`);\n                    });\n                    history.find('summary').text(`${historyText} (${responseData.history_count || 0})`);\n                    if ((responseData.history_count || 0) > 1) {\n                        history.show();\n                    } else {\n                        history.hide();\n                    }\n                }\n            });\n        });\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error loading turn responses:', error);\n    });\n};\n\n/**\n * Register common handlers (send/enter).\n */\nfunction registerHandlers() {\n    if (handlersRegistered) {\n        return;\n    }\n    \n    // Handle send button clicks for multi-model turns\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"turns\"] .chat-send-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const modelid = parseInt(button.data('model-id'), 10);\n        const container = button.closest('.multi-model-chat-container');\n        \n        if (container.data('behavior') !== 'turns') {\n            return;\n        }\n        \n        if (!cmid || !pageid || !modelid) {\n            addError('Missing cmid, pageid, or model-id');\n            return;\n        }\n        \n        const input = $(`#chat-input-model-${modelid}-${pageid}`);\n        if (input.length === 0) {\n            addError('Chat input not found');\n            return;\n        }\n        \n        const inputValue = input.val();\n        if (!inputValue || !inputValue.trim()) {\n            return;\n        }\n        \n        const message = inputValue.trim();\n        \n        // Check if chat is locked\n        const viewingTurn = getViewingTurnForModel(pageid, modelid);\n        const currentTurn = getCurrentTurnForModel(pageid, modelid);\n        const viewingTurnNum = parseInt(viewingTurn, 10);\n        const currentTurnNum = parseInt(currentTurn, 10);\n        \n        if (viewingTurnNum < currentTurnNum) {\n            getString('chatlocked', 'mod_harpiasurvey').then((str) => {\n                Notification.addNotification({\n                    message: str + ' Navigate to the current turn first.',\n                    type: 'error'\n                });\n            });\n            return;\n        }\n        \n        // Check max turns\n        const maxTurns = container.data('max-turns');\n        if (maxTurns !== undefined && maxTurns !== null) {\n            const maxTurnsNum = parseInt(maxTurns, 10);\n            const turnCount = getTurnCountForConversationForModel(pageid, modelid, viewingTurnNum);\n            if (turnCount !== null && turnCount >= maxTurnsNum &&\n                isTurnCompleteForModel(pageid, modelid, viewingTurnNum)) {\n                getString('maxturnsreached', 'mod_harpiasurvey').then((str) => {\n                    Notification.addNotification({\n                        message: str,\n                        type: 'error'\n                    });\n                });\n                return;\n            }\n        }\n        \n        // Disable input and button\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n        input.val('');\n        \n        // Display user message\n        const tempId = 'temp-user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n        displayUserMessageForModel(pageid, modelid, message, tempId);\n        \n        const loading = $(`#chat-loading-model-${modelid}-${pageid}`);\n        loading.show();\n        \n        sendMessageForModel(cmid, pageid, message, modelid, button, input, loading);\n    });\n    \n    // Handle Enter key\n    $(document).on('keydown', '.multi-model-chat-container[data-behavior=\"turns\"] .chat-input', function(e) {\n        if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault();\n            const input = $(this);\n            const modelid = parseInt(input.data('model-id'), 10);\n            const pageid = parseInt(input.data('pageid'), 10);\n            $(`#send-message-btn-model-${modelid}-${pageid}`).click();\n        }\n    });\n    \n    handlersRegistered = true;\n}\n\n/**\n * Display user message for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {string} message Message content\n * @param {number} messageid Message ID\n */\nconst displayUserMessageForModel = (pageid, modelid, message, messageid) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    messagesContainer.find('.text-center.text-muted').remove();\n    const viewingTurn = getViewingTurnForModel(pageid, modelid);\n    Templates.render('mod_harpiasurvey/chat_user_message', {\n        id: messageid,\n        content: message,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        const $html = $(html);\n        // Ensure the message has the correct data attributes\n        $html.attr('data-messageid', messageid);\n        $html.attr('data-model-id', modelid);\n        if (viewingTurn) {\n            $html.attr('data-turn-id', viewingTurn);\n        }\n        $html.attr('data-role', 'user');\n        messagesContainer.append($html);\n        scrollToBottomForModel(pageid, modelid);\n    }).catch(Notification.exception);\n};\n\n/**\n * Send message for a specific model.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {string} message Message content\n * @param {number} modelid Model ID\n * @param {jQuery} button Send button\n * @param {jQuery} input Input field\n * @param {jQuery} loading Loading indicator\n */\nconst sendMessageForModel = (cmid, pageid, message, modelid, button, input, loading) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const viewingTurn = getViewingTurnForModel(pageid, modelid);\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    \n    let parentid = null;\n    const visibleMessages = messagesContainer.find('.message:visible');\n    if (visibleMessages.length > 0) {\n        const lastMessage = visibleMessages.last();\n        const lastMessageId = parseInt(lastMessage.data('messageid'), 10);\n        if (lastMessageId && !isNaN(lastMessageId)) {\n            parentid = lastMessageId;\n        }\n    }\n    \n    const params = new URLSearchParams({\n        action: 'send_ai_message',\n        cmid: cmid,\n        pageid: pageid,\n        message: message,\n        modelid: modelid,\n        sesskey: Config.sesskey\n    });\n    \n    if (parentid) {\n        params.append('parentid', parentid);\n    }\n    \n    // Add turn_id if we're in a specific turn\n    if (viewingTurn) {\n        params.append('turn_id', viewingTurn);\n    }\n    \n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then(response => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then(data => {\n        loading.hide();\n        if (data.success) {\n            if (data.messageid && data.content) {\n                // Update turn state if new turn was created (before displaying message)\n                const newTurnId = data.turn_id ? parseInt(data.turn_id, 10) : viewingTurn;\n                if (newTurnId > viewingTurn) {\n                    setViewingTurnForModel(pageid, modelid, newTurnId);\n                    modelTurns[pageid][modelid] = newTurnId;\n                    updateTurnDisplayForModel(pageid, modelid);\n                }\n                \n                // Display AI message with correct turn_id\n                displayAIMessageForModel(pageid, modelid, data.content, data.messageid, newTurnId).then(() => {\n                    // Reload tree and filter messages - use the turn_id from response\n                    const turnToView = newTurnId || viewingTurn;\n                    loadConversationTree(pageid).then(() => {\n                        // After tree loads, filter messages for the correct turn\n                        filterMessagesByTurnForModel(pageid, modelid, turnToView);\n                        updateChatLockStateForModel(pageid, modelid);\n                        setTimeout(() => {\n                            scrollToBottomForModel(pageid, modelid);\n                        }, 100);\n                    }).catch(() => {\n                        // If tree reload fails, still filter and scroll\n                        filterMessagesByTurnForModel(pageid, modelid, turnToView);\n                        updateChatLockStateForModel(pageid, modelid);\n                        setTimeout(() => {\n                            scrollToBottomForModel(pageid, modelid);\n                        }, 100);\n                    });\n                });\n            } else {\n                addError('Received response but missing message ID or content');\n                input.prop('disabled', false);\n                button.prop('disabled', false);\n                input.focus();\n            }\n        } else {\n            addError(data.message || 'Error sending message');\n            input.prop('disabled', false);\n            button.prop('disabled', false);\n            input.focus();\n        }\n    })\n    .catch(error => {\n        loading.hide();\n        // eslint-disable-next-line no-console\n        console.error('Error sending message:', error);\n        addError('Error sending message: ' + error.message);\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    });\n};\n\n/**\n * Display AI message for a specific model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {string} content Message content\n * @param {number} messageid Message ID\n * @param {number} turnId Turn ID\n * @return {Promise} Promise that resolves when message is displayed\n */\nconst displayAIMessageForModel = (pageid, modelid, content, messageid, turnId) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return Promise.resolve();\n    }\n    return Templates.render('mod_harpiasurvey/chat_ai_message', {\n        id: messageid,\n        content: content,\n        timecreated: Math.floor(Date.now() / 1000),\n        turn_id: turnId,\n        modelid: modelid\n    }).then((html) => {\n        const $html = $(html);\n        // Ensure the message has the correct data attributes\n        $html.attr('data-messageid', messageid);\n        $html.attr('data-model-id', modelid);\n        if (turnId) {\n            $html.attr('data-turn-id', turnId);\n        }\n        $html.attr('data-role', 'assistant');\n        messagesContainer.append($html);\n        scrollToBottomForModel(pageid, modelid);\n        return $html[0].outerHTML;\n    }).catch(Notification.exception);\n};\n\n/**\n * Load conversation tree (shared across models for turns mode).\n *\n * @param {number} pageid Page ID\n * @return {Promise} Promise that resolves when tree is loaded\n */\nconst loadConversationTree = (pageid) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (treeContainer.length === 0) {\n        return Promise.resolve(null);\n    }\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const cmid = parseInt(container.attr('data-cmid') || container.data('cmid'), 10);\n    if (!cmid) {\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error: Course module ID not found. Please refresh the page.</div>');\n        return Promise.resolve(null);\n    }\n    const params = new URLSearchParams();\n    params.append('action', 'get_conversation_tree');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n    return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (data.success && data.tree) {\n            data.tree.roots = (data.tree.roots || []).map((root, idx) => ({\n                ...root,\n                conversation_number: idx + 1\n            }));\n            conversationTrees[pageid] = data.tree;\n            \n            // Get viewing turn from the active model tab (or first model)\n            // Note: container is already declared at the top of this function (line 879)\n            const activeTab = container.find('.tab-pane.active');\n            let activeModelId = parseInt(activeTab.data('model-id'), 10);\n            if (!activeModelId || isNaN(activeModelId)) {\n                activeModelId = parseInt(container.find('.tab-pane[data-model-id]').first().data('model-id'), 10);\n            }\n            const viewingTurnKey = activeModelId ? `viewing-turn-${activeModelId}` : null;\n            const hasExplicitViewingTurn = !!(activeModelId && typeof container.data(viewingTurnKey) !== 'undefined');\n            const viewingTurn = (activeModelId && hasExplicitViewingTurn) ? getViewingTurnForModel(pageid, activeModelId) : null;\n            // Check if we're in list view or detail view\n            const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n            const viewMode = sidebar.data('sidebar-view') || 'list';\n            const branchRootId = sidebar.data('branch-root');\n            \n            if (viewMode === 'list') {\n                // Render simple list\n                renderConversationList(pageid, data.tree.roots);\n            } else {\n                const root = branchRootId ? findNodeByTurnId(data.tree.roots || [], branchRootId) :\n                    (viewingTurn ? findRootForTurn(data.tree.roots || [], viewingTurn) : null);\n                if (root) {\n                    renderConversationDetail(pageid, root, viewingTurn);\n                } else {\n                    renderConversationList(pageid, data.tree.roots);\n                }\n            }\n            if (activeModelId && hasExplicitViewingTurn && viewingTurn) {\n                syncTurnsUrlStateForModel(pageid, activeModelId, viewingTurn);\n            }\n            \n            return data.tree;\n        } else {\n            treeContainer.html('<div class=\"text-muted text-center small py-3\">' +\n                (data.message || 'No conversation tree available yet.') + '</div>');\n            return null;\n        }\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error loading conversation tree:', error);\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error loading conversation tree: ' + error.message + '<br>' +\n            'Please check the browser console for details and refresh the page.</div>');\n        return null;\n    });\n};\n\n/**\n * Resolve hierarchical turn number for a specific turn ID.\n * Resets per root conversation (1,2,3...) and uses dotted numbering for branches (2.1, 2.2).\n *\n * @param {number} pageid Page ID\n * @param {number} turnId Turn ID\n * @return {string|null} Hierarchical turn number\n */\nconst getTurnNumberForId = (pageid, turnId) => {\n    const tree = conversationTrees[pageid];\n    if (!tree || !tree.roots) {\n        return null;\n    }\n\n    const root = findRootForTurn(tree.roots, turnId);\n    if (!root) {\n        return null;\n    }\n\n    const findAndNumber = (node, targetId, parentNumber, turnIndex) => {\n        const nodeNumber = calculateTurnNumber(node, turnIndex, parentNumber);\n\n        if (parseInt(node.turn_id, 10) === parseInt(targetId, 10)) {\n            return nodeNumber;\n        }\n\n        if (node.direct_branches && node.direct_branches.length > 0) {\n            const sortedDB = [...node.direct_branches].sort((a, b) =>\n                parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n            );\n            for (let i = 0; i < sortedDB.length; i++) {\n                const db = sortedDB[i];\n                const dbNumber = calculateTurnNumber(db, i, nodeNumber);\n                if (parseInt(db.turn_id, 10) === parseInt(targetId, 10)) {\n                    return dbNumber;\n                }\n                if (db.children && db.children.length > 0) {\n                    const sortedChildren = [...db.children].sort((a, b) =>\n                        parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n                    );\n                    for (let i = 0; i < sortedChildren.length; i++) {\n                        const found = findAndNumber(sortedChildren[i], targetId, dbNumber, i);\n                        if (found) {\n                            return found;\n                        }\n                    }\n                }\n            }\n        }\n\n        if (node.children && node.children.length > 0) {\n            const sortedChildren = [...node.children].sort((a, b) =>\n                parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n            );\n            for (let i = 0; i < sortedChildren.length; i++) {\n                const found = findAndNumber(sortedChildren[i], targetId, nodeNumber, i);\n                if (found) {\n                    return found;\n                }\n            }\n        }\n\n        return null;\n    };\n\n    return findAndNumber(root, turnId, null, 0);\n};\n\n/**\n * Prepare node data for recursive rendering.\n */\nconst prepareNodeData = (node, level, currentTurnId, pageid, cmid, turnIndex = 0, parentNumber = null,\n    includeChildren = true, forcedTurnNumber = null) => {\n    const isCurrent = parseInt(node.turn_id, 10) === parseInt(currentTurnId, 10);\n    const hasChildren = node.children && node.children.length > 0;\n    const isDirectBranch = node.is_direct_branch || false;\n    const isRoot = node.is_root || false;\n    const turnNumber = forcedTurnNumber !== null ? String(forcedTurnNumber) : calculateTurnNumber(node, turnIndex, parentNumber);\n\n    return {\n        turn_id: node.turn_id,\n        conversation_id: node.conversation_id || node.turn_id,\n        turn_number: turnNumber,\n        is_root: isRoot,\n        is_direct_branch: isDirectBranch,\n        is_current: isCurrent,\n        has_children: hasChildren,\n        branch_label: node.branch_label || null,\n        level: level,\n        expanded: true,\n        pageid: pageid,\n        cmid: cmid,\n        can_create_branch: true,\n        children: (includeChildren && hasChildren) ? node.children.map((child, index) =>\n            prepareNodeData(child, isDirectBranch ? level : level + 1, currentTurnId, pageid, cmid, index, turnNumber, includeChildren)) : []\n    };\n};\n\n/**\n * Render conversation detail view (single root tree).\n */\nconst renderConversationDetail = (pageid, root, viewingTurn = null) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const cmid = getCmid(pageid);\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n\n    let activeTurn = viewingTurn;\n    if (!activeTurn) {\n        const activeTab = container.find('.tab-pane.active');\n        const activeModelId = parseInt(activeTab.data('model-id'), 10);\n        if (activeModelId) {\n            activeTurn = getViewingTurnForModel(pageid, activeModelId);\n        }\n    }\n\n    if (!activeTurn) {\n        activeTurn = root.turn_id;\n    }\n\n    const branchStack = sidebar.data('branch-stack');\n    const showBranchBack = Array.isArray(branchStack) && branchStack.length > 0;\n    const isBranchRoot = !root.is_root;\n\n    sidebar.data('branch-root', root.turn_id);\n\n    let turnCounter = 0;\n    const rootTurnNumber = getTurnNumberForId(pageid, root.turn_id) || '1';\n    const rootNodeData = prepareNodeData(root, 0, activeTurn, pageid, cmid, turnCounter, null, false, rootTurnNumber);\n    rootNodeData.suppress_inline_branch_button = true; // First turn in conversation.\n    turnCounter++;\n\n    const directBranches = [];\n    const childBranches = root.is_root ? (root.direct_branches || []) : (root.children || []);\n    if (childBranches.length > 0) {\n        const sortedDirectBranches = [...childBranches].sort((a, b) =>\n            parseInt(a.turn_id, 10) - parseInt(b.turn_id, 10)\n        );\n        sortedDirectBranches.forEach((node, index) => {\n            const childTurnNumber = getTurnNumberForId(pageid, node.turn_id) ||\n                calculateTurnNumber(node, index, rootTurnNumber);\n            directBranches.push(prepareNodeData(\n                node,\n                0,\n                activeTurn,\n                pageid,\n                cmid,\n                index,\n                rootTurnNumber,\n                false,\n                childTurnNumber\n            ));\n            turnCounter++;\n        });\n        if (directBranches.length > 0) {\n            directBranches[directBranches.length - 1].suppress_inline_branch_button = true; // Last turn in conversation.\n        }\n    }\n\n    Templates.render('mod_harpiasurvey/conversation_detail', {\n        root_node: rootNodeData,\n        root_turn_id: root.turn_id,\n        direct_branches: directBranches,\n        pageid: pageid,\n        cmid: cmid,\n        conversation_number: root.conversation_number || 1,\n        show_branch_back: showBranchBack,\n        branch_root_turn: isBranchRoot ? root.turn_id : null\n    }).then((html) => {\n        treeContainer.html(html);\n        treeContainer.find('[data-toggle=\"popover\"]').popover({\n            trigger: 'hover',\n            placement: 'top',\n            container: 'body'\n        });\n    }).catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error rendering conversation detail:', error);\n    });\n};\n\nconst findNodeByTurnId = (roots, turnId) => {\n    if (!roots || !turnId) {\n        return null;\n    }\n    const target = parseInt(turnId, 10);\n    const queue = [...roots];\n    while (queue.length) {\n        const node = queue.shift();\n        if (!node) {\n            continue;\n        }\n        if (parseInt(node.turn_id, 10) === target) {\n            return node;\n        }\n        if (node.direct_branches && node.direct_branches.length) {\n            queue.push(...node.direct_branches);\n        }\n        if (node.children && node.children.length) {\n            queue.push(...node.children);\n        }\n    }\n    return null;\n};\n\nconst hasUnsavedTurnEvaluationForModel = (pageid, modelid, turnId) => {\n    const tabPane = $(`#model-pane-${modelid}-${pageid}`);\n    if (tabPane.length === 0) {\n        return false;\n    }\n    const container = tabPane.find('.turn-evaluation-questions');\n    if (container.length === 0) {\n        return false;\n    }\n    const requiredQuestions = container.find('.question-item[data-required=\"1\"]');\n    if (requiredQuestions.length === 0) {\n        return false;\n    }\n    const savedRequired = requiredQuestions.filter(function() {\n        return $(this).find('.saved-response-message').length > 0;\n    }).length;\n    return savedRequired !== requiredQuestions.length;\n};\n\n/**\n * Navigate to a specific turn for a model.\n *\n * @param {number} pageid Page ID\n * @param {number} modelid Model ID\n * @param {number} turnId Turn ID\n */\nconst navigateToTurnForModel = (pageid, modelid, turnId) => {\n    if (!modelTurns[pageid]) {\n        modelTurns[pageid] = {};\n    }\n    modelTurns[pageid][modelid] = turnId;\n\n    setViewingTurnForModel(pageid, modelid, turnId);\n    updateTurnDisplayForModel(pageid, modelid);\n    updateChatLockStateForModel(pageid, modelid);\n    filterMessagesByTurnForModel(pageid, modelid, turnId);\n    \n    // Load turn evaluation questions\n    ensureTurnEvaluationQuestionsRenderedForModel(pageid, modelid, turnId).then(() => {\n        const tabPane = $(`#model-pane-${modelid}-${pageid}`);\n        tabPane.find('.turn-evaluation-questions .question-item').each(function() {\n            resetQuestionItemToNeutral($(this));\n        });\n        loadTurnEvaluationResponsesForModel(pageid, modelid, turnId);\n    });\n\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (sidebar.length) {\n        sidebar.data('sidebar-view', 'detail');\n        loadConversationTree(pageid);\n    }\n};\n\n/**\n * Create branch from turn for a model.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {number} turnId Turn ID\n * @param {jQuery} button Button element\n */\nconst createBranchFromTurnForModel = (cmid, pageid, turnId, button) => {\n    // Similar to turns.js createBranchFromTurn\n    // Implementation would create a new branch from the specified turn\n    // For now, use a simplified version\n    const params = new URLSearchParams();\n    params.append('action', 'create_branch');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('parent_turn_id', turnId);\n    params.append('sesskey', Config.sesskey);\n    \n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then(response => response.json())\n    .then(data => {\n        if (data.success) {\n            const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n            if (sidebar.length) {\n                let stack = sidebar.data('branch-stack');\n                if (!Array.isArray(stack)) {\n                    stack = [];\n                }\n                const currentRoot = sidebar.data('branch-root');\n                if (currentRoot) {\n                    stack.push(currentRoot);\n                }\n                sidebar.data('branch-stack', stack);\n                sidebar.data('branch-root', turnId);\n                sidebar.data('sidebar-view', 'detail');\n            }\n\n            const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n            const activeModelId = parseInt(container.find('.tab-pane.active').data('model-id'), 10);\n            if (activeModelId && data.new_turn_id) {\n                navigateToTurnForModel(pageid, activeModelId, parseInt(data.new_turn_id, 10));\n            } else {\n                loadConversationTree(pageid);\n            }\n            Notification.addNotification({\n                message: data.message || 'Turn created successfully',\n                type: 'success'\n            });\n        } else {\n            addError(data.message || 'Failed to create branch');\n        }\n    })\n    .catch(error => {\n        // eslint-disable-next-line no-console\n        console.error('Error creating branch:', error);\n        addError('Error creating branch: ' + error.message);\n    });\n};\n\n/**\n * Register tree handlers.\n */\nfunction registerTreeHandlers() {\n    if (treeHandlersRegistered) {\n        return;\n    }\n\n    // Handle turn-card navigation clicks (detail view).\n    $(document).on('click', '.tree-node-content[data-action=\"navigate\"]', function(e) {\n        e.preventDefault();\n        const node = $(this);\n        const turnId = parseInt(node.data('turn-id'), 10);\n        const pageid = parseInt(node.closest('.conversation-tree-sidebar').attr('id').replace('conversation-tree-sidebar-', ''), 10);\n        if (!pageid || !turnId) {\n            return;\n        }\n\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        let activeModelId = parseInt(container.find('.tab-pane.active').data('model-id'), 10);\n        if (!activeModelId || isNaN(activeModelId)) {\n            activeModelId = parseInt(container.find('.tab-pane[data-model-id]').first().data('model-id'), 10);\n        }\n        if (activeModelId) {\n            navigateToTurnForModel(pageid, activeModelId, turnId);\n        }\n    });\n    \n    // Handle tree node navigation clicks (for list view).\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"turns\"] ~ .conversation-tree-sidebar .conversation-item, .conversation-tree-sidebar .conversation-item', function(e) {\n        e.preventDefault();\n        const item = $(this);\n        // Try multiple possible ID fields\n        let rootTurnId = parseInt(item.data('root-turn-id'), 10);\n        if (!rootTurnId || isNaN(rootTurnId)) {\n            rootTurnId = parseInt(item.data('conversation-id'), 10);\n        }\n        if (!rootTurnId || isNaN(rootTurnId)) {\n            rootTurnId = parseInt(item.data('turn-id'), 10);\n        }\n        \n        const sidebar = item.closest('.conversation-tree-sidebar');\n        const pageid = parseInt(sidebar.attr('id').replace('conversation-tree-sidebar-', ''), 10);\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        \n        if (!pageid || container.length === 0) {\n            return;\n        }\n        \n        const activeTab = container.find('.tab-pane.active');\n        const activeModelId = parseInt(activeTab.data('model-id'), 10);\n\n        if (!activeModelId) {\n            // If no active tab, use the first model\n            const firstTab = container.find('.tab-pane[data-model-id]').first();\n            const firstModelId = parseInt(firstTab.data('model-id'), 10);\n            if (firstModelId) {\n                if (rootTurnId) {\n                    sidebar.data('sidebar-view', 'detail');\n                    navigateToTurnForModel(pageid, firstModelId, rootTurnId);\n                }\n            }\n            return;\n        }\n\n        if (rootTurnId) {\n            sidebar.data('sidebar-view', 'detail');\n            navigateToTurnForModel(pageid, activeModelId, rootTurnId);\n        }\n    });\n\n    // Handle back to list button click.\n    $(document).on('click', '.back-to-list-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n\n        const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n        sidebar.data('sidebar-view', 'list');\n        sidebar.data('branch-root', null);\n        sidebar.data('branch-stack', []);\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        const activeModelId = parseInt(container.find('.tab-pane.active').data('model-id'), 10);\n        if (activeModelId) {\n            syncTurnsUrlStateForModel(pageid, activeModelId);\n        }\n\n        const tree = conversationTrees[pageid];\n        if (tree) {\n            renderConversationList(pageid, tree.roots);\n        } else {\n            loadConversationTree(pageid).then(() => {\n                const tree = conversationTrees[pageid];\n                if (tree) {\n                    renderConversationList(pageid, tree.roots);\n                }\n            });\n        }\n    });\n\n    // Handle back to parent branch button click.\n    $(document).on('click', '.back-to-parent-branch-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n\n        const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n        let stack = sidebar.data('branch-stack');\n        if (!Array.isArray(stack) || stack.length === 0) {\n            sidebar.data('branch-root', null);\n            sidebar.data('branch-stack', []);\n            loadConversationTree(pageid);\n            return;\n        }\n        const previousRoot = stack.pop();\n        sidebar.data('branch-stack', stack);\n        sidebar.data('branch-root', previousRoot || null);\n        sidebar.data('sidebar-view', 'detail');\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        const activeModelId = parseInt(container.find('.tab-pane.active').data('model-id'), 10);\n        if (activeModelId) {\n            syncTurnsUrlStateForModel(pageid, activeModelId);\n        }\n        loadConversationTree(pageid);\n    });\n\n    // Handle enter branch (subtree) button click.\n    $(document).on('click', '.enter-branch-btn', function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const turnId = parseInt(button.data('turn-id'), 10);\n        if (!pageid || !turnId) {\n            return;\n        }\n        const tree = conversationTrees[pageid];\n        if (!tree || !tree.roots) {\n            return;\n        }\n        const targetNode = findNodeByTurnId(tree.roots, turnId);\n        if (!targetNode || !targetNode.children || targetNode.children.length === 0) {\n            return;\n        }\n        const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n        let stack = sidebar.data('branch-stack');\n        if (!Array.isArray(stack)) {\n            stack = [];\n        }\n        const currentRoot = sidebar.data('branch-root');\n        if (currentRoot) {\n            stack.push(currentRoot);\n        }\n        sidebar.data('branch-stack', stack);\n        sidebar.data('branch-root', turnId);\n        sidebar.data('sidebar-view', 'detail');\n\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        const activeTab = container.find('.tab-pane.active');\n        const activeModelId = parseInt(activeTab.data('model-id'), 10);\n        if (activeModelId) {\n            navigateToTurnForModel(pageid, activeModelId, turnId);\n        } else {\n            loadConversationTree(pageid);\n        }\n    });\n\n    // Handle create branch button clicks.\n    $(document).on('click', '.create-branch-from-tree-btn', function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid') || button.closest('[data-pageid]').data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid') || button.closest('[data-cmid]').data('cmid'), 10);\n        const turnId = parseInt(button.data('turn-id') || button.closest('[data-turn-id]').data('turn-id'), 10);\n        const branchMode = button.data('branch-mode');\n\n        if (!pageid || !turnId) {\n            addError('Missing required data to create branch');\n            return;\n        }\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        const activeTab = container.find('.tab-pane.active');\n        const activeModelId = parseInt(activeTab.data('model-id'), 10);\n        const currentViewingTurn = activeModelId ? getViewingTurnForModel(pageid, activeModelId) : null;\n        if (activeModelId && currentViewingTurn &&\n            hasUnsavedTurnEvaluationForModel(pageid, activeModelId, currentViewingTurn)) {\n            getString('turnrequiresave', 'mod_harpiasurvey').then((message) => {\n                Notification.addNotification({\n                    message: message,\n                    type: 'warning'\n                });\n            }).catch(() => {\n                Notification.addNotification({\n                    message: 'Please save the evaluation answers before creating a new turn.',\n                    type: 'warning'\n                });\n            });\n            return;\n        }\n        if (activeModelId && hasUnsavedTurnEvaluationForModel(pageid, activeModelId, turnId)) {\n            getString('turnrequiresave', 'mod_harpiasurvey').then((message) => {\n                Notification.addNotification({\n                    message: message,\n                    type: 'warning'\n                });\n            }).catch(() => {\n                Notification.addNotification({\n                    message: 'Please save the evaluation answers before creating a new turn.',\n                    type: 'warning'\n                });\n            });\n            return;\n        }\n        if (branchMode === 'enter') {\n            const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n            let stack = sidebar.data('branch-stack');\n            if (!Array.isArray(stack)) {\n                stack = [];\n            }\n            const currentRoot = sidebar.data('branch-root');\n            if (currentRoot) {\n                stack.push(currentRoot);\n            }\n            sidebar.data('branch-stack', stack);\n            sidebar.data('branch-root', turnId);\n            sidebar.data('sidebar-view', 'detail');\n\n            const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n            const activeTab = container.find('.tab-pane.active');\n            const activeModelId = parseInt(activeTab.data('model-id'), 10);\n            if (activeModelId) {\n                navigateToTurnForModel(pageid, activeModelId, turnId);\n            } else {\n                loadConversationTree(pageid);\n            }\n            return;\n        }\n        if (!cmid) {\n            addError('Missing required data to create branch');\n            return;\n        }\n        createBranchFromTurnForModel(cmid, pageid, turnId, button);\n    });\n\n    // Handle \"create direct branch\" button clicks.\n    $(document).on('click', '.create-direct-branch-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        let parentTurnId = parseInt(button.data('root-turn-id'), 10);\n        if (!parentTurnId || isNaN(parentTurnId)) {\n            const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n            const activeTab = container.find('.tab-pane.active');\n            const activeModelId = parseInt(activeTab.data('model-id'), 10);\n            parentTurnId = getViewingTurnForModel(pageid, activeModelId);\n        }\n\n        if (!pageid || !cmid || !parentTurnId) {\n            addError('Missing required data to create branch');\n            return;\n        }\n        const activeTab = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`).find('.tab-pane.active');\n        const activeModelId = parseInt(activeTab.data('model-id'), 10);\n        const currentViewingTurn = activeModelId ? getViewingTurnForModel(pageid, activeModelId) : null;\n        if (activeModelId && currentViewingTurn &&\n            hasUnsavedTurnEvaluationForModel(pageid, activeModelId, currentViewingTurn)) {\n            getString('turnrequiresave', 'mod_harpiasurvey').then((message) => {\n                Notification.addNotification({\n                    message: message,\n                    type: 'warning'\n                });\n            }).catch(() => {\n                Notification.addNotification({\n                    message: 'Please save the evaluation answers before creating a new turn.',\n                    type: 'warning'\n                });\n            });\n            return;\n        }\n        if (activeModelId && hasUnsavedTurnEvaluationForModel(pageid, activeModelId, parentTurnId)) {\n            getString('turnrequiresave', 'mod_harpiasurvey').then((message) => {\n                Notification.addNotification({\n                    message: message,\n                    type: 'warning'\n                });\n            }).catch(() => {\n                Notification.addNotification({\n                    message: 'Please save the evaluation answers before creating a new turn.',\n                    type: 'warning'\n                });\n            });\n            return;\n        }\n\n        createBranchFromTurnForModel(cmid, pageid, parentTurnId, button);\n    });\n\n    // Handle create new root button clicks.\n    $(document).on('click', '.create-root-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            addError('Missing required data to create root');\n            return;\n        }\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        const activeTab = container.find('.tab-pane.active');\n        const activeModelId = parseInt(activeTab.data('model-id'), 10);\n        if (activeModelId) {\n            const viewingTurn = getViewingTurnForModel(pageid, activeModelId);\n            if (viewingTurn && hasUnsavedTurnEvaluationForModel(pageid, activeModelId, viewingTurn)) {\n                getString('turnrequiresave', 'mod_harpiasurvey').then((message) => {\n                    Notification.addNotification({\n                        message: message,\n                        type: 'warning'\n                    });\n                }).catch(() => {\n                    Notification.addNotification({\n                        message: 'Please save the evaluation answers before creating a new turn.',\n                        type: 'warning'\n                    });\n                });\n                return;\n            }\n        }\n        createNewRootForModel(cmid, pageid);\n    });\n\n    // Keep turn context synchronized when switching model tabs.\n    $(document).on('shown.bs.tab', '.multi-model-chat-container[data-behavior=\"turns\"] .nav-link[data-model-id]', function() {\n        const tab = $(this);\n        const modelid = parseInt(tab.data('model-id'), 10);\n        const container = tab.closest('.multi-model-chat-container');\n        const pageid = parseInt(container.data('pageid'), 10);\n        if (!modelid || !pageid) {\n            return;\n        }\n        const viewingTurn = getViewingTurnForModel(pageid, modelid);\n        updateTurnDisplayForModel(pageid, modelid);\n        updateChatLockStateForModel(pageid, modelid);\n        filterMessagesByTurnForModel(pageid, modelid, viewingTurn);\n        ensureTurnEvaluationQuestionsRenderedForModel(pageid, modelid, viewingTurn).then(() => {\n            loadTurnEvaluationResponsesForModel(pageid, modelid, viewingTurn);\n        });\n        syncTurnsUrlStateForModel(pageid, modelid, viewingTurn);\n    });\n    \n    // Handle export conversation button clicks.\n    $(document).on('click', '.export-conversation-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            addError('Missing required data to export conversation');\n            return;\n        }\n        \n        // Get current viewing turn for the active model\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        const activeTab = container.find('.tab-pane.active');\n        const activeModelId = parseInt(activeTab.data('model-id'), 10);\n        const viewingTurn = activeModelId ? getViewingTurnForModel(pageid, activeModelId) : null;\n        \n        // Build export URL\n        const params = new URLSearchParams();\n        params.append('action', 'export_conversation');\n        params.append('cmid', cmid);\n        params.append('pageid', pageid);\n        params.append('sesskey', Config.sesskey);\n        \n        if (viewingTurn) {\n            params.append('turn_id', viewingTurn);\n        }\n        \n        // Open export URL in new window/tab to trigger download\n        window.open(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), '_blank');\n    });\n\n    treeHandlersRegistered = true;\n}\n\n/**\n * Create new root conversation.\n * In multi-model turns, all models share the same conversation tree,\n * so creating a root should navigate all models to the new root.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n */\nconst createNewRootForModel = (cmid, pageid) => {\n    const params = new URLSearchParams();\n    params.append('action', 'create_root');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n    \n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then(response => response.json())\n    .then(data => {\n        if (data.success) {\n            const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n            const activeTab = container.find('.tab-pane.active');\n            const activeModelId = parseInt(activeTab.data('model-id'), 10);\n            \n            // Clear all message containers and show placeholder\n            container.find('.tab-pane[data-model-id]').each(function() {\n                const modelid = parseInt($(this).data('model-id'), 10);\n                const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n                messagesContainer.empty();\n                messagesContainer.html('<div class=\"text-center text-muted py-4\">' +\n                    '<p>{{#str}}nomessagesyet, mod_harpiasurvey{{/str}}</p>' +\n                    '</div>');\n            });\n            \n            // Reload conversation tree\n            loadConversationTree(pageid).then(() => {\n                if (activeModelId && data.turn_id) {\n                    // Navigate active model to the new root\n                    navigateToTurnForModel(pageid, activeModelId, parseInt(data.turn_id, 10), true);\n                } else {\n                    // If no active model, navigate first model\n                    const firstModel = container.find('.tab-pane[data-model-id]').first();\n                    const firstModelId = parseInt(firstModel.data('model-id'), 10);\n                    if (firstModelId && data.turn_id) {\n                        navigateToTurnForModel(pageid, firstModelId, parseInt(data.turn_id, 10), true);\n                    }\n                }\n            });\n            Notification.addNotification({\n                message: data.message || 'New conversation created successfully',\n                type: 'success'\n            });\n        } else {\n            addError(data.message || 'Failed to create new conversation');\n        }\n    })\n    .catch(error => {\n        // eslint-disable-next-line no-console\n        console.error('Error creating new root:', error);\n        addError('Error creating new root: ' + error.message);\n    });\n};\n\n/**\n * Register turn handlers.\n */\nfunction registerTurnHandlers() {\n    if (turnHandlersRegistered) {\n        return;\n    }\n    \n    // Handle toggle previous messages button\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"turns\"] .toggle-previous-messages-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const modelid = parseInt(button.data('model-id'), 10);\n        const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n        \n        const isShowing = messagesContainer.data('show-previous') === true;\n        const newState = !isShowing;\n        messagesContainer.data('show-previous', newState);\n        \n        if (newState) {\n            messagesContainer.find('.previous-turn-message').show();\n            updatePreviousToggleLabelForModel(button, true);\n        } else {\n            messagesContainer.find('.previous-turn-message').hide();\n            updatePreviousToggleLabelForModel(button, false);\n        }\n    });\n    \n    // Handle toggle tree button\n    $(document).on('click', '.multi-model-chat-container[data-behavior=\"turns\"] .toggle-tree-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n        \n        if (sidebar.is(':visible')) {\n            sidebar.hide();\n            button.removeClass('active');\n        } else {\n            sidebar.show();\n            button.addClass('active');\n            loadConversationTree(pageid);\n        }\n    });\n\n    $(document).on(\n        'click',\n        '.multi-model-chat-container[data-behavior=\"turns\"] .turn-evaluation-questions .save-turn-evaluation-questions-btn',\n        function(e) {\n            e.preventDefault();\n            e.stopPropagation();\n\n            const button = $(this);\n            const turnId = parseInt(button.data('turn-id'), 10);\n            const pageid = parseInt(button.data('pageid'), 10);\n            const cmid = parseInt(button.data('cmid'), 10);\n            const tabPane = button.closest('.tab-pane[data-model-id]');\n            const modelid = parseInt(tabPane.data('model-id'), 10);\n\n            if (!turnId || !pageid || !cmid || !modelid) {\n                Notification.addNotification({\n                    message: 'Missing required data to save responses.',\n                    type: 'error'\n                });\n                return;\n            }\n\n            const evaluationContainer = button.closest('.turn-evaluation-questions');\n            if (evaluationContainer.length === 0) {\n                return;\n            }\n\n            const responses = collectTurnEvaluationResponsesForModel(evaluationContainer);\n            if (Object.keys(responses).length === 0) {\n                Notification.addNotification({\n                    message: 'No editable questions to save. Click Edit on a question first.',\n                    type: 'info'\n                });\n                return;\n            }\n\n            const originalText = button.text();\n            button.prop('disabled', true);\n            button.text('Saving...');\n            saveTurnEvaluationResponsesForModel(cmid, pageid, modelid, turnId, responses, button, originalText);\n        }\n    );\n    \n    turnHandlersRegistered = true;\n}\n\nconst collectTurnEvaluationResponsesForModel = (evaluationContainer) => {\n    const responses = {};\n    evaluationContainer.find('[data-questionid]').each(function() {\n        const item = $(this);\n        const isLocked = String(item.attr('data-response-locked')) === '1';\n        const isEditing = String(item.attr('data-response-editing')) === '1';\n        if (isLocked && !isEditing) {\n            return;\n        }\n\n        const questionId = item.data('questionid');\n        const questionType = item.data('questiontype');\n        let responseValue = null;\n\n        if (questionType === 'multiplechoice') {\n            const checked = item.find(`input[name=\"question_${questionId}_turn[]\"]:checked`);\n            const values = [];\n            checked.each(function() {\n                values.push($(this).val());\n            });\n            responseValue = values.length > 0 ? JSON.stringify(values) : null;\n        } else if (questionType === 'select') {\n            const selected = item.find(`select[name=\"question_${questionId}_turn\"]`);\n            responseValue = selected.length > 0 ? selected.val() : null;\n        } else if (questionType === 'singlechoice' || questionType === 'likert') {\n            const selected = item.find(`input[name=\"question_${questionId}_turn\"]:checked`);\n            responseValue = selected.length > 0 ? selected.val() : null;\n        } else if (questionType === 'number' || questionType === 'shorttext') {\n            const input = item.find(`input[name=\"question_${questionId}_turn\"]`);\n            responseValue = input.length > 0 ? input.val() : null;\n        } else if (questionType === 'longtext') {\n            const textarea = item.find(`textarea[name=\"question_${questionId}_turn\"]`);\n            responseValue = textarea.length > 0 ? textarea.val() : null;\n        }\n\n        if (responseValue !== null && responseValue !== '') {\n            responses[questionId] = responseValue;\n        }\n    });\n    return responses;\n};\n\nconst saveTurnEvaluationResponsesForModel = (cmid, pageid, modelid, turnId, responses, button, originalText) => {\n    const entries = Object.entries(responses);\n    let failedCount = 0;\n\n    let promiseChain = Promise.resolve();\n    entries.forEach(([questionId, response]) => {\n        promiseChain = promiseChain.then(() => {\n            const params = new URLSearchParams({\n                action: 'save_response',\n                cmid: cmid,\n                pageid: pageid,\n                questionid: questionId,\n                response: response,\n                turn_id: turnId,\n                sesskey: Config.sesskey\n            });\n\n            return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n                method: 'GET',\n                headers: {\n                    'Content-Type': 'application/json'\n                }\n            })\n            .then((res) => res.json())\n            .then((data) => {\n                if (!data.success) {\n                    failedCount++;\n                }\n            })\n            .catch(() => {\n                failedCount++;\n            });\n        });\n    });\n\n    promiseChain.then(() => {\n        button.prop('disabled', false);\n        button.text(originalText);\n        if (failedCount === 0) {\n            Notification.addNotification({\n                message: 'Responses saved.',\n                type: 'success'\n            });\n        } else {\n            Notification.addNotification({\n                message: 'Some responses failed to save.',\n                type: 'warning'\n            });\n        }\n        loadTurnEvaluationResponsesForModel(pageid, modelid, turnId);\n    });\n};\n"],"names":["initialized","handlersRegistered","treeHandlersRegistered","turnHandlersRegistered","editLabel","modelTurns","resetQuestionItemToNeutral","questionItem","length","removeAttr","find","remove","prop","each","this","Boolean","defaultChecked","select","defaultOption","filter","defaultSelected","first","val","defaultValue","initialize","then","str","catch","document","on","e","preventDefault","button","cmid","parseInt","data","pageid","modelid","container","closest","input","inputValue","trim","message","viewingTurn","getViewingTurnForModel","currentTurn","getCurrentTurnForModel","viewingTurnNum","addNotification","type","maxTurns","maxTurnsNum","turnCount","getTurnCountForConversationForModel","isTurnCompleteForModel","tempId","Date","now","Math","random","toString","substr","displayUserMessageForModel","loading","show","sendMessageForModel","key","shiftKey","click","registerHandlers","node","turnId","attr","replace","activeModelId","isNaN","navigateToTurnForModel","item","rootTurnId","sidebar","activeTab","firstTab","firstModelId","syncTurnsUrlStateForModel","tree","conversationTrees","roots","loadConversationTree","stack","Array","isArray","previousRoot","pop","stopPropagation","targetNode","findNodeByTurnId","children","currentRoot","push","branchMode","currentViewingTurn","hasUnsavedTurnEvaluationForModel","createBranchFromTurnForModel","parentTurnId","createNewRootForModel","tab","updateTurnDisplayForModel","updateChatLockStateForModel","filterMessagesByTurnForModel","ensureTurnEvaluationQuestionsRenderedForModel","loadTurnEvaluationResponsesForModel","params","URLSearchParams","append","Config","sesskey","window","open","wwwroot","registerTreeHandlers","messagesContainer","newState","updatePreviousToggleLabelForModel","hide","is","removeClass","addClass","tabPane","evaluationContainer","responses","collectTurnEvaluationResponsesForModel","Object","keys","originalText","text","saveTurnEvaluationResponsesForModel","registerTurnHandlers","containers","initMultiModelTurnsPage","tabPanes","firstPane","ensureFirstTabActive","urlParams","location","search","urlTurn","get","urlModel","urlBranch","parsedBranchRoot","hasExplicitUrlTurn","parsedTurn","$msg","wrapper","wrapperModelId","String","maxTurn","calculatedCurrentTurn","initialViewingTurn","hasExplicitInitialTurn","setViewingTurnForModel","setNoTurnSelectedStateForModel","modelIdFromUrl","tabButton","firstModel","maxTurnForModel","hasHistoryForModel","setTimeout","error","console","_modelTurns$pageid","turnOverride","turn","branchRoot","viewMode","set","delete","newUrl","pathname","history","replaceState","pane","evalContainer","empty","badge","removeData","numberSpan","turnStr","shouldLock","shouldShowPrevious","root","allowedTurnIds","Set","add","addPath","targetId","path","turn_id","forEach","id","direct_branches","db","child","messageTurnId","isCurrentTurn","has","toggleBtn","isVisible","scrollToBottomForModel","html","requestAnimationFrame","scrollTop","scrollHeight","hasUser","hasAssistant","role","scriptEl","Promise","resolve","questionsData","JSON","parse","questionsContainer","filteredQuestions","q","show_only_turn","undefined","hide_on_turn","Templates","render","questions","action","fetch","method","headers","response","ok","Error","status","json","success","questionId","responseData","questionType","value","values","saved_datetime","savedText","onText","icon","savedMessage","messageHtml","lockQuestionItem","controls","ensureEditButton","historyText","history_count","details","list","history_items","time","messageid","content","timecreated","floor","$html","Notification","exception","parentid","visibleMessages","lastMessage","last","lastMessageId","newTurnId","displayAIMessageForModel","turnToView","focus","outerHTML","treeContainer","body","map","idx","conversation_number","viewingTurnKey","hasExplicitViewingTurn","branchRootId","renderConversationDetail","getTurnNumberForId","findAndNumber","parentNumber","turnIndex","nodeNumber","sortedDB","sort","a","b","i","dbNumber","sortedChildren","found","prepareNodeData","level","currentTurnId","includeChildren","forcedTurnNumber","isCurrent","hasChildren","isDirectBranch","is_direct_branch","isRoot","is_root","turnNumber","conversation_id","turn_number","is_current","has_children","branch_label","expanded","can_create_branch","index","activeTurn","branchStack","showBranchBack","isBranchRoot","turnCounter","rootTurnNumber","rootNodeData","suppress_inline_branch_button","directBranches","childBranches","childTurnNumber","root_node","root_turn_id","show_branch_back","branch_root_turn","popover","trigger","placement","target","queue","shift","requiredQuestions","new_turn_id","isLocked","isEditing","responseValue","checked","stringify","selected","textarea","entries","failedCount","promiseChain","_ref","questionid","res"],"mappings":"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"}
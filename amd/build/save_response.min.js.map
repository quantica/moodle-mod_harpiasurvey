{"version":3,"file":"save_response.min.js","sources":["../src/save_response.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Save response module for harpiasurvey.\n *\n * @module     mod_harpiasurvey/save_response\n * @copyright  2025 Your Name\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport Config from 'core/config';\nimport $ from 'jquery';\n\nlet initialized = false;\n\n/**\n * Initialize the save response functionality.\n *\n */\nexport const init = () => {\n    if (initialized) {\n        return;\n    }\n\n    // Pre-populate select dropdowns with saved values.\n    $('select[data-saved-value]').each(function() {\n        const select = $(this);\n        const savedValue = select.data('saved-value');\n        if (savedValue) {\n            select.val(savedValue);\n        }\n    });\n\n    // Handle save all button click.\n    $(document).on('click', '.save-all-responses-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const statusDiv = $('.save-all-status');\n\n        // Collect all questions and their responses.\n        const questionsToSave = [];\n        $('.question-item').each(function() {\n            const questionItem = $(this);\n\n            const questionid = parseInt(questionItem.data('questionid'), 10);\n            const questiontype = questionItem.data('questiontype');\n\n            if (!questionid || !questiontype) {\n                return; // Skip if we can't find question ID or type.\n            }\n\n            // Get the response value based on question type.\n            let response = '';\n\n            if (questiontype === 'singlechoice' || questiontype === 'likert') {\n                const selected = $(`input[name=\"question_${questionid}\"]:checked`);\n                if (selected.length > 0) {\n                    response = selected.val();\n                }\n            } else if (questiontype === 'multiplechoice') {\n                const selected = $(`input[name=\"question_${questionid}[]\"]:checked`);\n                const values = [];\n                selected.each(function() {\n                    values.push($(this).val());\n                });\n                response = JSON.stringify(values);\n            } else if (questiontype === 'select') {\n                const selected = $(`#question_${questionid}`).val();\n                if (selected) {\n                    response = selected;\n                }\n            } else if (questiontype === 'number' || questiontype === 'shorttext') {\n                response = $(`#question_${questionid}`).val();\n            } else if (questiontype === 'longtext') {\n                response = $(`#question_${questionid}`).val();\n            }\n\n            questionsToSave.push({\n                questionid: questionid,\n                questiontype: questiontype,\n                response: response\n            });\n        });\n\n        if (questionsToSave.length === 0) {\n            Notification.addNotification({\n                message: 'No questions to save.',\n                type: 'info'\n            });\n            return;\n        }\n\n        // Save all responses sequentially.\n        saveAllResponses(cmid, pageid, questionsToSave, button, statusDiv);\n    });\n\n    initialized = true;\n};\n\n/**\n * Save all responses sequentially.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {Array} questionsToSave Array of {questionid, questiontype, response} objects\n * @param {jQuery} button Save button element\n * @param {jQuery} statusDiv Status div element\n */\nconst saveAllResponses = (cmid, pageid, questionsToSave, button, statusDiv) => {\n    const originalText = button.text();\n    button.prop('disabled', true);\n    statusDiv.show().html('<div class=\"text-info\"><i class=\"fa fa-spinner fa-spin\"></i> Saving responses...</div>');\n\n    // Check if this is a turns mode page and get current turn.\n    // The button might be outside the ai-conversation-container, so search from document.\n    const container = $('.ai-conversation-container[data-pageid=\"' + pageid + '\"]');\n    let turnId = null;\n    if (container.length > 0) {\n        const behavior = container.data('behavior');\n        if (behavior === 'turns') {\n            // Get current viewing turn from the container.\n            const viewingTurn = container.attr('data-viewing-turn');\n            if (viewingTurn) {\n                turnId = parseInt(viewingTurn, 10);\n            } else {\n                // If no viewing turn is set, get the current turn (highest turn with messages).\n                const messagesContainer = container.find(`#chat-messages-page-${pageid}`);\n                if (messagesContainer.length > 0) {\n                    const messages = messagesContainer.find('.message[data-turn-id]');\n                    let maxTurn = 0;\n                    messages.each(function() {\n                        const msgTurnId = parseInt($(this).attr('data-turn-id'), 10);\n                        if (msgTurnId > maxTurn) {\n                            maxTurn = msgTurnId;\n                        }\n                    });\n                    if (maxTurn > 0) {\n                        turnId = maxTurn;\n                    } else {\n                        // If no messages yet, default to turn 1 (first turn).\n                        turnId = 1;\n                    }\n                } else {\n                    // If no messages container found, default to turn 1 (first turn).\n                    turnId = 1;\n                }\n            }\n        }\n    }\n\n    let savedCount = 0;\n    let failedCount = 0;\n    const total = questionsToSave.length;\n\n    // Save responses sequentially using Promise chain.\n    let promiseChain = Promise.resolve();\n\n    questionsToSave.forEach((questionData, index) => {\n        promiseChain = promiseChain.then(() => {\n            return new Promise((resolve) => {\n                // Update status.\n                const savingHtml = '<div class=\"text-info\"><i class=\"fa fa-spinner fa-spin\"></i> ' +\n                    `Saving ${index + 1} of ${total}...` +\n                    '</div>';\n                statusDiv.html(savingHtml);\n\n                const params = new URLSearchParams({\n                    action: 'save_response',\n                    cmid: cmid,\n                    pageid: pageid,\n                    questionid: questionData.questionid,\n                    response: questionData.response,\n                    sesskey: Config.sesskey\n                });\n\n                // Add turn_id if this is a turns mode page.\n                if (turnId !== null && turnId > 0) {\n                    params.append('turn_id', turnId);\n                }\n\n                fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n                    method: 'GET',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    }\n                })\n                .then(response => response.json())\n                .then(data => {\n                    if (data.success) {\n                        savedCount++;\n                        // Update saved message for this question.\n                        const now = new Date();\n                        const datetimeStr = now.toLocaleString();\n                        getString('saved', 'mod_harpiasurvey').then((savedText) => {\n                            getString('on', 'mod_harpiasurvey').then((onText) => {\n                                const questionSelector = `.question-item[data-questionid=\"${questionData.questionid}\"]`;\n                                const savedSelector = `.saved-response-message[data-questionid=\"${questionData.questionid}\"]`;\n                                const questionItem = $(questionSelector);\n                                const savedMessage = questionItem.find(savedSelector);\n                                const icon = '<i class=\"fa fa-check-circle\" aria-hidden=\"true\"></i>';\n                                if (savedMessage.length === 0) {\n                                    // Create new message element.\n                                    const messageHtml = '<div class=\"mt-2 small text-muted saved-response-message\" ' +\n                                        `data-questionid=\"${questionData.questionid}\">` +\n                                        `${icon} ${savedText} ${onText} ${datetimeStr}</div>`;\n                                    questionItem.append(messageHtml);\n                                } else {\n                                    // Update existing message timestamp.\n                                    savedMessage.html(`${icon} ${savedText} ${onText} ${datetimeStr}`);\n                                }\n                            });\n                        });\n                    } else {\n                        failedCount++;\n                    }\n                    resolve();\n                })\n                .catch(() => {\n                    failedCount++;\n                    resolve(); // Continue with next question even on error.\n                });\n            });\n        });\n    });\n\n    // After all saves complete.\n    promiseChain.then(() => {\n        button.prop('disabled', false);\n        button.text(originalText);\n\n        if (failedCount === 0) {\n            // All saved successfully.\n            button.removeClass('btn-primary').addClass('btn-success');\n            const successHtml = '<div class=\"text-success\"><i class=\"fa fa-check-circle\"></i> ' +\n                `All ${savedCount} response(s) saved successfully!</div>`;\n            statusDiv.html(successHtml);\n            setTimeout(() => {\n                button.removeClass('btn-success').addClass('btn-primary');\n                statusDiv.fadeOut();\n            }, 3000);\n        } else {\n            // Some failed.\n            button.removeClass('btn-primary').addClass('btn-warning');\n            const warningHtml = '<div class=\"text-warning\"><i class=\"fa fa-exclamation-triangle\"></i> ' +\n                `${savedCount} saved, ${failedCount} failed. Please try again.</div>`;\n            statusDiv.html(warningHtml);\n            setTimeout(() => {\n                button.removeClass('btn-warning').addClass('btn-primary');\n            }, 5000);\n        }\n    });\n};\n"],"names":["initialized","each","select","this","savedValue","data","val","document","on","e","preventDefault","button","cmid","parseInt","pageid","statusDiv","questionsToSave","questionItem","questionid","questiontype","response","selected","length","values","push","JSON","stringify","saveAllResponses","addNotification","message","type","originalText","text","prop","show","html","container","turnId","viewingTurn","attr","messagesContainer","find","messages","maxTurn","msgTurnId","savedCount","failedCount","total","promiseChain","Promise","resolve","forEach","questionData","index","then","savingHtml","params","URLSearchParams","action","sesskey","Config","append","fetch","wwwroot","toString","method","headers","json","success","datetimeStr","Date","toLocaleString","savedText","onText","questionSelector","savedSelector","savedMessage","icon","messageHtml","catch","removeClass","addClass","successHtml","setTimeout","fadeOut","warningHtml"],"mappings":"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"}
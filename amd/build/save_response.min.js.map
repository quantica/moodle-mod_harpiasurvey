{"version":3,"file":"save_response.min.js","sources":["../src/save_response.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Save response module for harpiasurvey.\n *\n * @module     mod_harpiasurvey/save_response\n * @copyright  2025 Your Name\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport Config from 'core/config';\nimport $ from 'jquery';\n\nlet initialized = false;\n\n/**\n * Get a human-readable response display for a question.\n *\n * @param {jQuery} questionItem Question container\n * @param {string} questionType Question type\n * @return {string} Display text\n */\nconst getResponseDisplay = (questionItem, questionType) => {\n    let display = '';\n\n    if (questionType === 'singlechoice' || questionType === 'likert') {\n        const checked = questionItem.find('input[type=\"radio\"]:checked');\n        if (checked.length > 0) {\n            const id = checked.attr('id');\n            const label = id ? questionItem.find(`label[for=\"${id}\"]`).text().trim() : '';\n            display = label || checked.val();\n        }\n    } else if (questionType === 'multiplechoice') {\n        const labels = [];\n        questionItem.find('input[type=\"checkbox\"]:checked').each(function() {\n            const id = $(this).attr('id');\n            const label = id ? questionItem.find(`label[for=\"${id}\"]`).text().trim() : '';\n            labels.push(label || $(this).val());\n        });\n        display = labels.join(', ');\n    } else if (questionType === 'select') {\n        const select = questionItem.find('select');\n        const selected = select.find('option:selected');\n        display = selected.length ? selected.text().trim() : '';\n    } else if (questionType === 'number') {\n        const input = questionItem.find('input[type=\"number\"]');\n        display = input.val();\n    } else if (questionType === 'shorttext') {\n        const input = questionItem.find('input[type=\"text\"]');\n        display = input.val();\n    } else if (questionType === 'longtext') {\n        const textarea = questionItem.find('textarea');\n        display = textarea.val();\n    }\n\n    if (!display) {\n        return '-';\n    }\n\n    return display;\n};\n\n/**\n * Initialize the save response functionality.\n *\n */\nexport const init = () => {\n    if (initialized) {\n        return;\n    }\n\n    // Pre-populate select dropdowns with saved values.\n    $('select[data-saved-value]').each(function() {\n        const select = $(this);\n        const savedValue = select.data('saved-value');\n        if (savedValue) {\n            select.val(savedValue);\n        }\n    });\n\n    // Handle save all button click.\n    $(document).on('click', '.save-all-responses-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const container = button.closest('.page-questions');\n        const statusDiv = container.length ? container.find('.save-all-status') : $('.save-all-status');\n\n        // Collect all questions and their responses.\n        const questionsToSave = [];\n        const questionItems = container.length ? container.find('.question-item') : $('.question-item');\n        questionItems.each(function() {\n            const questionItem = $(this);\n\n            const questionid = parseInt(questionItem.data('questionid'), 10);\n            const questiontype = questionItem.data('questiontype');\n\n            if (!questionid || !questiontype) {\n                return; // Skip if we can't find question ID or type.\n            }\n\n            // Get the response value based on question type.\n            let response = '';\n\n            if (questiontype === 'singlechoice' || questiontype === 'likert') {\n                const selected = questionItem.find('input[type=\"radio\"]:checked');\n                if (selected.length > 0) {\n                    response = selected.val();\n                }\n            } else if (questiontype === 'multiplechoice') {\n                const selected = questionItem.find('input[type=\"checkbox\"]:checked');\n                const values = [];\n                selected.each(function() {\n                    values.push($(this).val());\n                });\n                response = JSON.stringify(values);\n            } else if (questiontype === 'select') {\n                const selected = questionItem.find('select').val();\n                if (selected) {\n                    response = selected;\n                }\n            } else if (questiontype === 'number' || questiontype === 'shorttext') {\n                const input = questionItem.find('input[type=\"number\"], input[type=\"text\"]');\n                response = input.val();\n            } else if (questiontype === 'longtext') {\n                const textarea = questionItem.find('textarea');\n                response = textarea.val();\n            }\n\n            questionsToSave.push({\n                questionid: questionid,\n                questiontype: questiontype,\n                response: response,\n                questionItem: questionItem\n            });\n        });\n\n        if (questionsToSave.length === 0) {\n            Notification.addNotification({\n                message: 'No questions to save.',\n                type: 'info'\n            });\n            return;\n        }\n\n        // Save all responses sequentially.\n        saveAllResponses(cmid, pageid, questionsToSave, button, statusDiv);\n    });\n\n    initialized = true;\n};\n\n/**\n * Save all responses sequentially.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {Array} questionsToSave Array of {questionid, questiontype, response} objects\n * @param {jQuery} button Save button element\n * @param {jQuery} statusDiv Status div element\n */\nconst saveAllResponses = (cmid, pageid, questionsToSave, button, statusDiv) => {\n    const originalText = button.text();\n    button.prop('disabled', true);\n    statusDiv.show().html('<div class=\"text-info\"><i class=\"fa fa-spinner fa-spin\"></i> Saving responses...</div>');\n\n    // Check if this is a turns/continuous mode page and get current iteration.\n    // The button might be outside the ai-conversation-container, so search from document.\n    const container = $('.ai-conversation-container[data-pageid=\"' + pageid + '\"]');\n    let turnId = null;\n    if (container.length > 0) {\n        const behavior = container.data('behavior');\n        if (behavior === 'turns') {\n            // Get current viewing turn from the container.\n            const viewingTurn = container.attr('data-viewing-turn');\n            if (viewingTurn) {\n                turnId = parseInt(viewingTurn, 10);\n            } else {\n                // If no viewing turn is set, get the current turn (highest turn with messages).\n                const messagesContainer = container.find(`#chat-messages-page-${pageid}`);\n                if (messagesContainer.length > 0) {\n                    const messages = messagesContainer.find('.message[data-turn-id]');\n                    let maxTurn = 0;\n                    messages.each(function() {\n                        const msgTurnId = parseInt($(this).attr('data-turn-id'), 10);\n                        if (msgTurnId > maxTurn) {\n                            maxTurn = msgTurnId;\n                        }\n                    });\n                    if (maxTurn > 0) {\n                        turnId = maxTurn;\n                    } else {\n                        // If no messages yet, default to turn 1 (first turn).\n                        turnId = 1;\n                    }\n                } else {\n                    // If no messages container found, default to turn 1 (first turn).\n                    turnId = 1;\n                }\n            }\n        } else if (behavior === 'continuous') {\n            const viewingConversation = container.data('viewing-conversation') ||\n                parseInt(container.attr('data-viewing-conversation'), 10);\n            if (viewingConversation && !isNaN(viewingConversation)) {\n                turnId = parseInt(viewingConversation, 10);\n            }\n        }\n    }\n\n    let savedCount = 0;\n    let failedCount = 0;\n    const total = questionsToSave.length;\n\n    // Save responses sequentially using Promise chain.\n    let promiseChain = Promise.resolve();\n\n    questionsToSave.forEach((questionData, index) => {\n        promiseChain = promiseChain.then(() => {\n            return new Promise((resolve) => {\n                // Update status.\n                const savingHtml = '<div class=\"text-info\"><i class=\"fa fa-spinner fa-spin\"></i> ' +\n                    `Saving ${index + 1} of ${total}...` +\n                    '</div>';\n                statusDiv.html(savingHtml);\n\n                const params = new URLSearchParams({\n                    action: 'save_response',\n                    cmid: cmid,\n                    pageid: pageid,\n                    questionid: questionData.questionid,\n                    response: questionData.response,\n                    sesskey: Config.sesskey\n                });\n\n                // Add turn_id if this is a turns mode page.\n                if (turnId !== null && turnId > 0) {\n                    params.append('turn_id', turnId);\n                }\n\n                fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n                    method: 'GET',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    }\n                })\n                .then(response => response.json())\n                .then(data => {\n                    if (data.success) {\n                        savedCount++;\n                        // Update saved message for this question.\n                        const now = new Date();\n                        const datetimeStr = now.toLocaleString();\n                        getString('saved', 'mod_harpiasurvey').then((savedText) => {\n                            getString('on', 'mod_harpiasurvey').then((onText) => {\n                                const questionItem = questionData.questionItem ? $(questionData.questionItem) :\n                                    $(`.question-item[data-questionid=\"${questionData.questionid}\"]`);\n                                const savedMessage = questionItem.find(`.saved-response-message[data-questionid=\"${questionData.questionid}\"]`);\n                                const icon = '<i class=\"fa fa-check-circle\" aria-hidden=\"true\"></i>';\n                                if (savedMessage.length === 0) {\n                                    // Create new message element.\n                                    const messageHtml = '<div class=\"mt-2 small text-muted saved-response-message\" ' +\n                                        `data-questionid=\"${questionData.questionid}\">` +\n                                        `${icon} ${savedText} ${onText} ${datetimeStr}</div>`;\n                                    questionItem.append(messageHtml);\n                                } else {\n                                    // Update existing message timestamp.\n                                    savedMessage.html(`${icon} ${savedText} ${onText} ${datetimeStr}`);\n                                }\n\n                                // Update history timeline.\n                                getString('answerhistory', 'mod_harpiasurvey').then((historyText) => {\n                                    let history = questionItem.find(`.answer-history[data-questionid=\"${questionData.questionid}\"]`);\n                                    if (history.length === 0) {\n                                        const details = $('<details class=\"answer-history mt-1 d-none\"></details>');\n                                        details.attr('data-questionid', questionData.questionid);\n                                        details.append(`<summary>${historyText} (1)</summary>`);\n                                        details.append('<ul class=\"list-unstyled mt-2 mb-0\"></ul>');\n                                        questionItem.append(details);\n                                        history = details;\n                                    }\n                                    const list = history.find('ul');\n                                    const responseDisplay = getResponseDisplay(questionItem, questionData.questiontype);\n                                    list.prepend(`<li class=\"mb-1\"><span class=\"text-muted\">${datetimeStr}</span> â€” ${$('<div>').text(responseDisplay).html()}</li>`);\n\n                                    const count = list.find('li').length;\n                                    history.find('summary').text(`${historyText} (${count})`);\n                                    if (count > 1) {\n                                        history.removeClass('d-none');\n                                    }\n                                });\n                            });\n                        });\n                    } else {\n                        failedCount++;\n                    }\n                    resolve();\n                })\n                .catch(() => {\n                    failedCount++;\n                    resolve(); // Continue with next question even on error.\n                });\n            });\n        });\n    });\n\n    // After all saves complete.\n    promiseChain.then(() => {\n        button.prop('disabled', false);\n        button.text(originalText);\n\n        if (failedCount === 0) {\n            // All saved successfully.\n            button.removeClass('btn-primary').addClass('btn-success');\n            const successHtml = '<div class=\"text-success\"><i class=\"fa fa-check-circle\"></i> ' +\n                `All ${savedCount} response(s) saved successfully!</div>`;\n            statusDiv.html(successHtml);\n            setTimeout(() => {\n                button.removeClass('btn-success').addClass('btn-primary');\n                statusDiv.fadeOut();\n            }, 3000);\n        } else {\n            // Some failed.\n            button.removeClass('btn-primary').addClass('btn-warning');\n            const warningHtml = '<div class=\"text-warning\"><i class=\"fa fa-exclamation-triangle\"></i> ' +\n                `${savedCount} saved, ${failedCount} failed. Please try again.</div>`;\n            statusDiv.html(warningHtml);\n            setTimeout(() => {\n                button.removeClass('btn-warning').addClass('btn-primary');\n            }, 5000);\n        }\n    });\n};\n"],"names":["initialized","getResponseDisplay","questionItem","questionType","display","checked","find","length","id","attr","text","trim","val","labels","each","this","label","push","join","selected","select","savedValue","data","document","on","e","preventDefault","button","cmid","parseInt","pageid","container","closest","statusDiv","questionsToSave","questionid","questiontype","response","values","JSON","stringify","saveAllResponses","addNotification","message","type","originalText","prop","show","html","turnId","behavior","viewingTurn","messagesContainer","messages","maxTurn","msgTurnId","viewingConversation","isNaN","savedCount","failedCount","total","promiseChain","Promise","resolve","forEach","questionData","index","then","savingHtml","params","URLSearchParams","action","sesskey","Config","append","fetch","wwwroot","toString","method","headers","json","success","datetimeStr","Date","toLocaleString","savedText","onText","savedMessage","icon","messageHtml","historyText","history","details","list","responseDisplay","prepend","count","removeClass","catch","addClass","successHtml","setTimeout","fadeOut","warningHtml"],"mappings":"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"}
define("mod_harpiasurvey/core_chat",["exports","core/templates","core/notification","core/config","core/str","jquery"],(function(_exports,_templates,_notification,_config,_str,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * AMD module for AI conversation chat interface.
   *
   * @module     mod_harpiasurvey/ai_conversation
   * @copyright  2025 Your Name
   * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.initTurns=_exports.initContinuous=_exports.init=void 0,_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_config=_interopRequireDefault(_config),_jquery=_interopRequireDefault(_jquery);let initializedTurns=!1,initializedContinuous=!1,commonHandlersRegistered=!1,turnHandlersRegistered=!1,treeHandlersRegistered=!1;const currentTurns={},conversationTrees={},initialize=function(){let options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const enableTurns=!1!==options.enableTurns,enableContinuous=!1!==options.enableContinuous,needsTurns=enableTurns&&!initializedTurns,needsContinuous=enableContinuous&&!initializedContinuous;if(!needsTurns&&!needsContinuous)return;const containers=(0,_jquery.default)(".ai-conversation-container");if(0!==containers.length){if(enableContinuous){(0,_jquery.default)(".multi-model-chat-container").each((function(){const pageid=parseInt((0,_jquery.default)(this).data("pageid"),10),cmid=parseInt((0,_jquery.default)(this).data("cmid"),10);pageid&&cmid&&initMultiModelChat(pageid,cmid)}))}enableTurns&&(0,_jquery.default)('.ai-conversation-container[data-behavior="turns"]').each((function(){const pageid=parseInt((0,_jquery.default)(this).data("pageid"),10);if(!pageid)return;const messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`);let maxTurn=0;messagesContainer.find("[data-turn-id]").each((function(){const turnId=parseInt((0,_jquery.default)(this).data("turn-id"),10);turnId&&turnId>maxTurn&&(maxTurn=turnId)}));const calculatedCurrentTurn=maxTurn>0?maxTurn:1;currentTurns[pageid]||(currentTurns[pageid]=calculatedCurrentTurn);const urlTurn=new URLSearchParams(window.location.search).get("turn");let initialViewingTurn=currentTurns[pageid];if(null!==urlTurn&&""!==urlTurn){const parsedTurn=parseInt(urlTurn,10);!isNaN(parsedTurn)&&parsedTurn>0&&(initialViewingTurn=parsedTurn)}setViewingTurn(pageid,initialViewingTurn),updateTurnDisplay(pageid),updateChatLockState(pageid),filterMessagesByTurn(pageid,initialViewingTurn),updateSubpageVisibility(pageid),setTimeout((()=>{ensureTurnEvaluationQuestionsRendered(pageid,initialViewingTurn).then((()=>{loadTurnEvaluationResponses(pageid,initialViewingTurn)})).catch((error=>{console.error("Error loading turn evaluation questions on init:",error)}))}),100);const sidebar=(0,_jquery.default)(`#conversation-tree-sidebar-${pageid}`);sidebar.length>0&&(sidebar.show(),(0,_jquery.default)(`.toggle-tree-btn[data-pageid="${pageid}"]`).addClass("active"),loadConversationTree(pageid))})),enableContinuous&&(0,_jquery.default)('.ai-conversation-container[data-behavior="continuous"]').each((function(){const pageid=parseInt((0,_jquery.default)(this).data("pageid"),10),container=(0,_jquery.default)(this);if(!pageid)return;const allMessages=(0,_jquery.default)(`#chat-messages-page-${pageid}`).find(".message");if(allMessages.length>0){const lastMessage=allMessages.last(),lastMessageId=parseInt(lastMessage.data("messageid"),10);if(lastMessageId&&!isNaN(lastMessageId)){let rootId=lastMessageId,currentId=lastMessageId,found=!1;const parentMap=new Map;for(allMessages.each((function(){const msgId=parseInt((0,_jquery.default)(this).data("messageid"),10),parentId=parseInt((0,_jquery.default)(this).data("parentid"),10);msgId&&!isNaN(msgId)&&parentMap.set(msgId,parentId&&!isNaN(parentId)?parentId:null)}));currentId&&!found;){const parentId=parentMap.get(currentId);parentId?currentId=parentId:(rootId=currentId,found=!0)}found&&(container.data("viewing-conversation",rootId),container.attr("data-viewing-conversation",rootId),filterMessagesByConversation(pageid,rootId))}}const sidebar=(0,_jquery.default)(`#conversation-tree-sidebar-${pageid}`);sidebar.length>0&&(sidebar.show(),loadConversationTree(pageid))})),registerCommonHandlers(),registerTreeHandlers(),enableTurns&&registerTurnHandlers(),initializedTurns=initializedTurns||enableTurns,initializedContinuous=initializedContinuous||enableContinuous}};_exports.init=()=>initialize({enableTurns:!0,enableContinuous:!0});_exports.initTurns=()=>initialize({enableTurns:!0,enableContinuous:!1});function registerCommonHandlers(){commonHandlersRegistered||((0,_jquery.default)(document).on("click",".chat-send-btn",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),cmid=parseInt(button.data("cmid"),10),pageid=parseInt(button.data("pageid"),10);if(!cmid||!pageid)return void _notification.default.addNotification({message:"Missing cmid or pageid",type:"error"});const input=(0,_jquery.default)(`#chat-input-page-${pageid}`);if(0===input.length)return void _notification.default.addNotification({message:"Chat input not found",type:"error"});const inputValue=input.val();if(!inputValue)return;const message=inputValue.trim();if(!message)return;const container=button.closest(".ai-conversation-container");if("turns"===container.data("behavior")){const viewingTurn=getViewingTurn(pageid),currentTurn=getCurrentTurn(pageid),viewingTurnNum=parseInt(viewingTurn,10);if(viewingTurnNum<parseInt(currentTurn,10))return void _notification.default.addNotification({message:"Cannot send messages in a locked turn. Navigate to the current turn first.",type:"error"});const maxTurns=container.data("max-turns");if(null!=maxTurns){const maxTurnsNum=parseInt(maxTurns,10),turnCount=getTurnCountForConversation(pageid,viewingTurnNum);if(null!==turnCount&&turnCount>=maxTurnsNum&&isTurnComplete(pageid,viewingTurnNum))return void(0,_str.get_string)("maxturnsreached","mod_harpiasurvey").then((str=>{_notification.default.addNotification({message:str,type:"error"})}))}}const modelsdata=container.data("models");let modelid=null;if(modelsdata){const modelids=modelsdata.split(",");modelids.length>0&&(modelid=parseInt(modelids[0],10))}if(!modelid)return void _notification.default.addNotification({message:"No model available",type:"error"});input.prop("disabled",!0),button.prop("disabled",!0),input.val("");const tempId="temp-user-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);displayUserMessage(pageid,message,tempId);const loading=(0,_jquery.default)(`#chat-loading-page-${pageid}`);loading.show(),sendMessage(cmid,pageid,message,modelid,button,input,loading)})),(0,_jquery.default)(document).on("keydown",".chat-input",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),(0,_jquery.default)(this).closest(".ai-conversation-container").find(".chat-send-btn").click())})),commonHandlersRegistered=!0)}function registerTreeHandlers(){treeHandlersRegistered||((0,_jquery.default)(document).on("click",'.tree-node-content[data-action="navigate"]',(function(e){e.preventDefault();const node=(0,_jquery.default)(this),turnId=parseInt(node.data("turn-id"),10),conversationId=parseInt(node.data("conversation-id"),10),pageid=node.closest(".conversation-tree-sidebar").attr("id").replace("conversation-tree-sidebar-",""),behavior=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container").data("behavior");pageid&&("continuous"===behavior&&conversationId?navigateToConversation(parseInt(pageid,10),conversationId):"turns"===behavior&&turnId&&navigateToTurn(parseInt(pageid,10),turnId))})),(0,_jquery.default)(document).on("click",".conversation-item",(function(e){e.preventDefault();const item=(0,_jquery.default)(this),rootTurnId=parseInt(item.data("root-turn-id"),10),conversationId=parseInt(item.data("conversation-id"),10),sidebar=item.closest(".conversation-tree-sidebar"),pageid=parseInt(sidebar.attr("id").replace("conversation-tree-sidebar-",""),10),behavior=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container").data("behavior");pageid&&("continuous"===behavior&&conversationId?navigateToConversation(pageid,conversationId):"turns"===behavior&&rootTurnId&&(sidebar.data("sidebar-view","detail"),navigateToTurn(pageid,rootTurnId)))})),(0,_jquery.default)(document).on("click",".back-to-list-btn",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),pageid=parseInt(button.data("pageid"),10);if(!pageid)return;(0,_jquery.default)(`#conversation-tree-sidebar-${pageid}`).data("sidebar-view","list");const tree=conversationTrees[pageid];tree?renderConversationList(pageid,tree.roots):loadConversationTree(pageid)})),(0,_jquery.default)(document).on("click",".toggle-children",(function(e){e.stopPropagation();const icon=(0,_jquery.default)(this),childrenContainer=icon.closest(".tree-node").find(".tree-children");childrenContainer.is(":visible")?(childrenContainer.hide(),icon.removeClass("fa-chevron-down").addClass("fa-chevron-right")):(childrenContainer.show(),icon.removeClass("fa-chevron-right").addClass("fa-chevron-down"))})),treeHandlersRegistered=!0)}function registerTurnHandlers(){turnHandlersRegistered||((0,_jquery.default)(document).on("click",".save-turn-evaluation-questions-btn",(function(e){e.preventDefault(),e.stopPropagation(),console.log("=== Save turn evaluation button clicked! ===");const button=(0,_jquery.default)(this),turnId=parseInt(button.data("turn-id"),10),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);if(console.log("Button element:",button[0]),console.log("Button data attributes:",{"data-turn-id":button.attr("data-turn-id"),"data-pageid":button.attr("data-pageid"),"data-cmid":button.attr("data-cmid")}),console.log("Parsed values:",{turnId:turnId,pageid:pageid,cmid:cmid}),!turnId||turnId<1||!pageid||pageid<=0||!cmid||cmid<=0)return console.error("Validation failed:",{turnId:turnId,pageid:pageid,cmid:cmid}),void _notification.default.addNotification({message:"Missing required data (turnId: "+turnId+", pageid: "+pageid+", cmid: "+cmid+")",type:"error"});const evaluationContainer=button.closest(".turn-evaluation-questions"),responses={};evaluationContainer.find("[data-questionid]").each((function(){const questionId=(0,_jquery.default)(this).data("questionid"),questionType=(0,_jquery.default)(this).data("questiontype");let responseValue=null;if("multiplechoice"===questionType){const checked=evaluationContainer.find(`input[name="question_${questionId}_turn[]"]:checked`),values=[];checked.each((function(){values.push((0,_jquery.default)(this).val())})),responseValue=values.length>0?JSON.stringify(values):null}else if("select"===questionType||"singlechoice"===questionType||"likert"===questionType){const selectSelector=`select[name="question_${questionId}_turn"]`,inputSelector=`input[name="question_${questionId}_turn"]:checked`,selected=evaluationContainer.find(selectSelector+", "+inputSelector);responseValue=selected.length>0?selected.val():null}else if("number"===questionType||"shorttext"===questionType){const input=evaluationContainer.find(`input[name="question_${questionId}_turn"]`);responseValue=input.length>0?input.val():null}else if("longtext"===questionType){const textarea=evaluationContainer.find(`textarea[name="question_${questionId}_turn"]`);responseValue=textarea.length>0?textarea.val():null}null!==responseValue&&""!==responseValue&&(responses[questionId]=responseValue)})),button.prop("disabled",!0);const originalText=button.text();button.text("Saving..."),saveTurnEvaluationQuestions(cmid,pageid,turnId,responses,button,originalText)})),(0,_jquery.default)(document).on("click",".next-turn-btn",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);if(!pageid||!cmid)return void _notification.default.addNotification({message:"Missing pageid or cmid",type:"error"});const viewingTurn=getViewingTurn(pageid),currentTurn=getCurrentTurn(pageid);if(viewingTurn<currentTurn)setViewingTurn(pageid,currentTurn),updateTurnDisplay(pageid),updateChatLockState(pageid),filterMessagesByTurn(pageid,currentTurn),updateSubpageVisibility(pageid),ensureTurnEvaluationQuestionsRendered(pageid,currentTurn).then((()=>{loadTurnEvaluationResponses(pageid,currentTurn)})),setTimeout((()=>{loadConversationTree(pageid)}),100);else if(viewingTurn===currentTurn&&isTurnComplete(pageid,viewingTurn)){const maxTurns=(0,_jquery.default)(`.ai-conversation-container[data-pageid="${pageid}"]`).data("max-turns");if(null!=maxTurns){const maxTurnsNum=parseInt(maxTurns,10),turnCount=getTurnCountForConversation(pageid,viewingTurn);if(null!==turnCount&&turnCount>=maxTurnsNum)return void(0,_str.get_string)("maxturnsreached","mod_harpiasurvey").then((str=>{_notification.default.addNotification({message:str,type:"error"})}))}const nextTurn=currentTurn+1;setViewingTurn(pageid,nextTurn),currentTurns[pageid]=nextTurn,updateTurnDisplay(pageid),updateChatLockState(pageid),filterMessagesByTurn(pageid,nextTurn),updateSubpageVisibility(pageid),ensureTurnEvaluationQuestionsRendered(pageid,nextTurn).then((()=>{clearTurnEvaluationForm(pageid,nextTurn)}));const input=(0,_jquery.default)(`#chat-input-page-${pageid}`);input.val(""),input.focus(),setTimeout((()=>{loadConversationTree(pageid)}),100)}})),(0,_jquery.default)(document).on("click",".toggle-tree-btn",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),pageid=parseInt(button.data("pageid"),10);if(!pageid)return;const sidebar=(0,_jquery.default)(`#conversation-tree-sidebar-${pageid}`);sidebar.is(":visible")?(sidebar.hide(),button.removeClass("active")):(sidebar.show(),button.addClass("active"),0===sidebar.find(".conversation-tree").children().length&&loadConversationTree(pageid))})),(0,_jquery.default)(document).on("click",".create-direct-branch-btn",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10),rootTurnId=parseInt(button.data("root-turn-id"),10);if(!pageid||!cmid)return void _notification.default.addNotification({message:"Missing required data to create direct branch",type:"error"});const parentTurnId=rootTurnId||getCurrentTurn(pageid);parentTurnId?createBranchFromTurn(cmid,pageid,parentTurnId):_notification.default.addNotification({message:"No parent turn found",type:"error"})})),(0,_jquery.default)(document).on("click",".close-tree-btn",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),pageid=parseInt(button.data("pageid"),10);if(!pageid)return;(0,_jquery.default)(`#conversation-tree-sidebar-${pageid}`).hide(),(0,_jquery.default)(`.toggle-tree-btn[data-pageid="${pageid}"]`).removeClass("active")})),(0,_jquery.default)(document).on("click",".create-branch-from-tree-btn",(function(e){e.preventDefault(),e.stopPropagation();const button=(0,_jquery.default)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10),turnId=parseInt(button.data("turn-id"),10);pageid&&cmid&&turnId?createBranchFromTurn(cmid,pageid,turnId,button):_notification.default.addNotification({message:"Missing required data to create turn",type:"error"})})),(0,_jquery.default)(document).on("click",".create-root-btn",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);pageid&&cmid?createNewRoot(cmid,pageid):_notification.default.addNotification({message:"Missing required data to create root",type:"error"})})),(0,_jquery.default)(document).on("click",".prev-turn-btn",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),pageid=parseInt(button.data("pageid"),10);if(!pageid)return void _notification.default.addNotification({message:"Missing pageid",type:"error"});const viewingTurn=getViewingTurn(pageid);if(viewingTurn>1){const prevTurn=viewingTurn-1;setViewingTurn(pageid,prevTurn),updateTurnDisplay(pageid),updateChatLockState(pageid),filterMessagesByTurn(pageid,prevTurn),updateSubpageVisibility(pageid),ensureTurnEvaluationQuestionsRendered(pageid,prevTurn).then((()=>{loadTurnEvaluationResponses(pageid,prevTurn)})),setTimeout((()=>{loadConversationTree(pageid)}),100)}})),(0,_jquery.default)(document).on("click",".toggle-turn-btn",(function(e){e.preventDefault(),e.stopPropagation();const button=(0,_jquery.default)(this),turnId=parseInt(button.data("turn-id"),10),pageid=parseInt(button.data("pageid"),10),messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`),separator=button.closest(".turn-separator"),isCollapsed=!0===separator.data("collapsed");separator.data("collapsed",!isCollapsed),messagesContainer.find(".message").each((function(){const messageTurnId=(0,_jquery.default)(this).data("turn-id");messageTurnId&&parseInt(messageTurnId,10)===turnId&&(isCollapsed?(0,_jquery.default)(this).show():(0,_jquery.default)(this).hide())}));const toggleIcon=button.find(".toggle-turn-icon");isCollapsed?toggleIcon.removeClass("fa-chevron-down").addClass("fa-chevron-up"):toggleIcon.removeClass("fa-chevron-up").addClass("fa-chevron-down")})),(0,_jquery.default)(document).on("click",".toggle-previous-messages-btn",(function(e){e.preventDefault(),e.stopPropagation();const button=(0,_jquery.default)(this),pageid=parseInt(button.data("pageid"),10),messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`),previousMessages=messagesContainer.find(".previous-turn-message");if(0===previousMessages.length)return;const viewingTurn=getViewingTurn(pageid);if(previousMessages.length>0&&previousMessages.first().is(":visible"))previousMessages.hide(),messagesContainer.find(".turn-separator").each((function(){const separatorTurnId=(0,_jquery.default)(this).data("turn-separator");if(separatorTurnId){parseInt(separatorTurnId,10)<viewingTurn&&(0,_jquery.default)(this).hide()}})),button.html('<i class="fa fa-history" aria-hidden="true"></i> Mostrar anteriores'),button.attr("title","Mostrar conversas anteriores");else{previousMessages.show();const relevantTurnIds=getRelevantTurnIds(pageid,viewingTurn);messagesContainer.find(".turn-separator").each((function(){const separatorTurnId=(0,_jquery.default)(this).data("turn-separator");if(separatorTurnId){const sepTurn=parseInt(separatorTurnId,10);relevantTurnIds.includes(sepTurn)&&sepTurn<viewingTurn&&(0,_jquery.default)(this).show()}})),button.html('<i class="fa fa-history" aria-hidden="true"></i> Ocultar anteriores'),button.attr("title","Ocultar conversas anteriores")}})),turnHandlersRegistered=!0)}_exports.initContinuous=()=>initialize({enableTurns:!1,enableContinuous:!0});const displayUserMessage=function(pageid,message){let messageid=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`),placeholder=messagesContainer.find(".text-muted.text-center");if(placeholder.length>0&&placeholder.remove(),messageid){if(messagesContainer.find(`[data-messageid="${messageid}"]`).length>0)return}const recentMessages=messagesContainer.find(".message").slice(-3);let isDuplicate=!1;if(recentMessages.each((function(){const contentEl=(0,_jquery.default)(this).find(".content");if(0===contentEl.length)return!0;const msgContent=contentEl.text();return msgContent&&msgContent.trim()===message.trim()?(isDuplicate=!0,!1):void 0})),isDuplicate&&!messageid)return;if(messageid){if(messagesContainer.find(`[data-messageid="${messageid}"]`).length>0)return}const safeMessage=message&&"string"==typeof message?message:"",container=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container"),behavior=container.data("behavior"),viewingTurn="turns"===behavior?getViewingTurn(pageid):null,templateData={content:safeMessage,id:messageid||"temp-"+Date.now()};if(viewingTurn){templateData.turn_id=viewingTurn;const turnNumber=getTurnNumberForId(pageid,viewingTurn)||viewingTurn;templateData.turn_label="Turno "+turnNumber}_templates.default.render("mod_harpiasurvey/chat_user_message",templateData).then((html=>{if(messageid){if(messagesContainer.find(`[data-messageid="${messageid}"]`).length>0)return}_templates.default.appendNodeContents(messagesContainer[0],html);"turns"===messagesContainer.closest(".ai-conversation-container").data("behavior")&&insertTurnSeparators(pageid),setTimeout((()=>{scrollToBottom(pageid)}),50)})).catch((()=>{if(messageid){if(messagesContainer.find(`[data-messageid="${messageid}"]`).length>0)return}let messageHtml='<div class="message my-3" data-messageid="'+(messageid||"temp-"+Date.now())+'"';viewingTurn&&(messageHtml+=' data-turn-id="'+viewingTurn+'"'),messageHtml+='><div class="d-flex justify-content-end"><div class="border rounded p-2 bg-primary text-white" style="max-width: 80%;"><div class="content">'+message+"</div></div></div></div>",messagesContainer.append(messageHtml),setTimeout((()=>{scrollToBottom(pageid)}),50)}))},sendMessage=(cmid,pageid,message,modelid,button,input,loading)=>{const container=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container"),behavior=container.data("behavior"),viewingTurn="turns"===behavior?getViewingTurn(pageid):null;let parentid=null;if("continuous"===behavior){const viewingConversation=container.data("viewing-conversation"),messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`);if(viewingConversation){const visibleMessages=messagesContainer.find(".message:visible");if(visibleMessages.length>0){const lastMessage=visibleMessages.last(),lastMessageId=parseInt(lastMessage.data("messageid"),10);lastMessageId&&!isNaN(lastMessageId)&&(parentid=lastMessageId)}}else{const allMessages=messagesContainer.find(".message");if(allMessages.length>0){const lastMessage=allMessages.last(),lastMessageId=parseInt(lastMessage.data("messageid"),10);lastMessageId&&!isNaN(lastMessageId)&&(parentid=lastMessageId)}}}const params=new URLSearchParams({action:"send_ai_message",cmid:cmid,pageid:pageid,message:message,modelid:modelid,sesskey:_config.default.sesskey});"turns"===behavior&&viewingTurn&&params.append("turn_id",viewingTurn),"continuous"===behavior&&parentid&&params.append("parentid",parentid),fetch(_config.default.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(loading.hide(),data.success){if("continuous"===behavior&&data.root_conversation_id){const container=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container");container.data("viewing-conversation",data.root_conversation_id),container.attr("data-viewing-conversation",data.root_conversation_id)}data.messageid&&data.content?function(pageid,content,messageid){let turnId=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`);if(!messageid)return console.error("displayAIMessage called without messageid"),Promise.resolve();if(!content)return console.error("displayAIMessage called without content"),Promise.resolve();if(messagesContainer.find(`[data-messageid="${messageid}"]`).length>0)return console.log("AI message already displayed:",messageid),Promise.resolve();const templateData={id:messageid,content:content&&"string"==typeof content?content:""};if(turnId){templateData.turn_id=turnId,templateData.pageid=pageid;const container=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container");templateData.cmid=container.data("cmid");const turnNumber=getTurnNumberForId(pageid,turnId)||turnId;templateData.turn_label="Turno "+turnNumber}return _templates.default.render("mod_harpiasurvey/chat_ai_message",templateData).then((html=>messagesContainer.find(`[data-messageid="${messageid}"]`).length>0?Promise.resolve():(_templates.default.appendNodeContents(messagesContainer[0],html),new Promise((resolve=>{requestAnimationFrame((()=>{if("turns"===messagesContainer.closest(".ai-conversation-container").data("behavior")&&insertTurnSeparators(pageid),turnId){setTimeout((()=>{ensureTurnEvaluationQuestionsRendered(pageid,turnId).then((()=>{loadTurnEvaluationResponses(pageid,turnId)}))}),100);const currentTurn=getCurrentTurn(pageid);turnId>currentTurn&&(currentTurns[pageid]=turnId,updateTurnDisplay(pageid)),getViewingTurn(pageid)===turnId&&filterMessagesByTurn(pageid,turnId)}setTimeout((()=>{scrollToBottom(pageid)}),50),requestAnimationFrame((()=>{resolve()}))}))}))))).catch((()=>{if(messagesContainer.find(`[data-messageid="${messageid}"]`).length>0)return Promise.resolve();const messageHtml='<div class="message my-3" data-messageid="'+messageid+'"><div class="d-flex"><div class="border rounded p-2 bg-light" style="max-width: 80%;"><div class="content">'+content+"</div></div></div></div>";return messagesContainer.append(messageHtml),setTimeout((()=>{scrollToBottom(pageid)}),50),Promise.resolve()}))}(pageid,data.content,data.messageid,data.turn_id).then((()=>{if("turns"===behavior&&data.turn_id){const currentTurn=getCurrentTurn(pageid);(data.turn_id>currentTurn||data.turn_id===currentTurn+1)&&(currentTurns[pageid]=data.turn_id,updateTurnDisplay(pageid),setViewingTurn(pageid,data.turn_id))}"continuous"===behavior&&loadConversationTree(pageid),setTimeout((()=>{updateChatLockState(pageid)}),100)})).catch((()=>{setTimeout((()=>{updateChatLockState(pageid)}),100)})):(_notification.default.addNotification({message:"Received response but missing message ID or content",type:"error"}),input.prop("disabled",!1),button.prop("disabled",!1),input.focus())}else _notification.default.addNotification({message:data.message||"Error sending message",type:"error"}),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()})).catch((error=>{loading.hide(),console.error("Error sending message:",error),_notification.default.addNotification({message:"Error sending message: "+error.message,type:"error"}),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()}))},scrollToBottom=pageid=>{const messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`);0!==messagesContainer.length&&requestAnimationFrame((()=>{const container=messagesContainer[0];container&&(container.scrollTop=container.scrollHeight)}))},ensureTurnEvaluationQuestionsRendered=(pageid,turnId)=>{const containerWrapper=(0,_jquery.default)(`#turn-evaluation-questions-container-${pageid}`);if(0===containerWrapper.length)return Promise.resolve();const existingContainer=containerWrapper.find(`.turn-evaluation-questions[data-turn-id="${turnId}"]`);return existingContainer.length>0&&existingContainer.find(".question-item").length>0?Promise.resolve():loadTurnEvaluationQuestions(pageid,turnId)},loadTurnEvaluationQuestions=(pageid,turnId)=>{const container=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container"),questionsDataEl=(0,_jquery.default)(`#turn-evaluation-questions-data-${pageid}`);if(0===questionsDataEl.length)return Promise.resolve();try{const questionsForTurn=JSON.parse(questionsDataEl.text()).filter((q=>{const minturn=q.min_turn||1;if(turnId<minturn)return!1;if(null!==q.show_only_turn&&void 0!==q.show_only_turn&&""!==q.show_only_turn){const showOnlyTurnNum=parseInt(q.show_only_turn,10),turnIdNum=parseInt(turnId,10);if(console.log("  Checking show_only_turn:",showOnlyTurnNum,"vs turnId:",turnIdNum),showOnlyTurnNum!==turnIdNum)return console.log("  Rejected: show_only_turn",showOnlyTurnNum,"!== turnId",turnIdNum),!1}if(null!==q.hide_on_turn&&void 0!==q.hide_on_turn&&""!==q.hide_on_turn){const hideOnTurnNum=parseInt(q.hide_on_turn,10),turnIdNum=parseInt(turnId,10);if(console.log("  Checking hide_on_turn:",hideOnTurnNum,"vs turnId:",turnIdNum),hideOnTurnNum===turnIdNum)return console.log("  Rejected: hide_on_turn",hideOnTurnNum,"=== turnId",turnIdNum),!1}return console.log("  Accepted question:",q.id),!0}));console.log("loadTurnEvaluationQuestions: questionsForTurn =",questionsForTurn);const containerWrapper=(0,_jquery.default)(`#turn-evaluation-questions-container-${pageid}`);if(0===containerWrapper.length)return Promise.resolve();const cmid=container.data("cmid");if(!cmid)return console.error("cmid not found for pageid:",pageid),Promise.resolve();containerWrapper.find(".turn-evaluation-questions").hide();let evaluationContainer=containerWrapper.find(`.turn-evaluation-questions[data-turn-id="${turnId}"]`);if(0===evaluationContainer.length){const containerHtml=`<div class="turn-evaluation-questions mt-3 pt-3 border-top" data-turn-id="${turnId}" data-pageid="${pageid}" data-cmid="${cmid}"></div>`;containerWrapper.append(containerHtml),evaluationContainer=containerWrapper.find(`.turn-evaluation-questions[data-turn-id="${turnId}"]`)}return 0===questionsForTurn.length?(evaluationContainer.html("").hide(),console.log("No questions for turn",turnId,"- cleared and hid container"),Promise.resolve()):(console.log("Rendering turn evaluation questions:",{pageid:pageid,turnId:turnId,cmid:cmid,questionsCount:questionsForTurn.length}),_templates.default.render("mod_harpiasurvey/turn_evaluation_questions",{questions:questionsForTurn,has_questions:questionsForTurn.length>0,turn_id:turnId,pageid:pageid,cmid:cmid}).then((html=>{evaluationContainer.html(html).show(),console.log("Turn evaluation questions rendered. HTML length:",html.length);const button=evaluationContainer.find(".save-turn-evaluation-questions-btn");return console.log("Save button found after render:",button.length,"Button data:",{turnId:button.data("turn-id"),pageid:button.data("pageid"),cmid:button.data("cmid")}),Promise.resolve()})).catch((error=>(console.error("Error rendering turn evaluation questions:",error),Promise.reject(error)))))}catch(error){console.error("Error parsing turn evaluation questions data:",error)}},saveTurnEvaluationQuestions=(cmid,pageid,turnId,responses,button,originalText)=>{if(!turnId||turnId<1)return _notification.default.addNotification({message:"Invalid turn ID",type:"error"}),button.prop("disabled",!1),void button.text(originalText);const savePromises=Object.keys(responses).map((questionId=>{const params=new URLSearchParams({action:"save_response",cmid:cmid,pageid:pageid,questionid:questionId,response:responses[questionId],turn_id:turnId.toString(),sesskey:_config.default.sesskey}),url=_config.default.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString();return console.log("Saving turn evaluation response:",{questionId:questionId,turnId:turnId,url:url}),fetch(url,{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>response.json())).then((data=>(console.log("Response from save:",data),data)))}));Promise.all(savePromises).then((results=>{if(results.every((r=>r.success))){const evaluationContainer=(0,_jquery.default)(`#turn-evaluation-questions-container-${pageid}`).find(`.turn-evaluation-questions[data-turn-id="${turnId}"]`),now=Math.floor(Date.now()/1e3);Object.keys(responses).forEach((questionId=>{showTurnEvaluationTimestamp(evaluationContainer,questionId,now)}))}else _notification.default.addNotification({message:"Some responses could not be saved",type:"error"});button.prop("disabled",!1),button.text(originalText)})).catch((error=>{console.error("Error saving turn evaluation questions:",error),_notification.default.addNotification({message:"Error saving responses: "+error.message,type:"error"}),button.prop("disabled",!1),button.text(originalText)}))},loadTurnEvaluationResponses=(pageid,turnId)=>{const cmid=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container").data("cmid"),evaluationContainer=(0,_jquery.default)(`#turn-evaluation-questions-container-${pageid}`).find(`.turn-evaluation-questions[data-turn-id="${turnId}"]`);if(0===evaluationContainer.length)return;const params=new URLSearchParams({action:"get_turn_responses",cmid:cmid,pageid:pageid,turn_id:turnId,sesskey:_config.default.sesskey});fetch(_config.default.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>response.json())).then((data=>{data.success&&data.responses&&Object.keys(data.responses).length>0?Object.keys(data.responses).forEach((questionId=>{const responseData=data.responses[questionId],responseValue="object"==typeof responseData?responseData.response:responseData,timestamp="object"==typeof responseData?responseData.timemodified:null,questionType=evaluationContainer.find(`[data-questionid="${questionId}"]`).data("questiontype");if("multiplechoice"===questionType)try{const values=JSON.parse(responseValue);Array.isArray(values)&&values.forEach((val=>{const selector=`input[name="question_${questionId}_turn[]"][value="${val}"]`;evaluationContainer.find(selector).prop("checked",!0)}))}catch(e){}else if("select"===questionType)evaluationContainer.find(`select[name="question_${questionId}_turn"]`).val(responseValue);else if("singlechoice"===questionType||"likert"===questionType){const selector=`input[name="question_${questionId}_turn"][value="${responseValue}"]`;evaluationContainer.find(selector).prop("checked",!0)}else"number"===questionType||"shorttext"===questionType?evaluationContainer.find(`input[name="question_${questionId}_turn"]`).val(responseValue):"longtext"===questionType&&evaluationContainer.find(`textarea[name="question_${questionId}_turn"]`).val(responseValue);timestamp?showTurnEvaluationTimestamp(evaluationContainer,questionId,timestamp):hideTurnEvaluationTimestamp(evaluationContainer,questionId)})):(clearTurnEvaluationForm(pageid,turnId),evaluationContainer.find(".turn-evaluation-saved-message").remove())})).catch((error=>{console.error("Error loading turn evaluation responses:",error)}))},clearTurnEvaluationForm=(pageid,turnId)=>{const evaluationContainer=(0,_jquery.default)(`#turn-evaluation-questions-container-${pageid}`).find(`.turn-evaluation-questions[data-turn-id="${turnId}"]`);0!==evaluationContainer.length&&(evaluationContainer.find('input[type="radio"]').prop("checked",!1),evaluationContainer.find('input[type="checkbox"]').prop("checked",!1),evaluationContainer.find("select").val(""),evaluationContainer.find('input[type="text"], input[type="number"]').val(""),evaluationContainer.find("textarea").val(""),evaluationContainer.find(".turn-evaluation-saved-message").remove())},showTurnEvaluationTimestamp=(evaluationContainer,questionId,timestamp)=>{hideTurnEvaluationTimestamp(evaluationContainer,questionId);const questionItem=evaluationContainer.find(`[data-questionid="${questionId}"]`);if(0===questionItem.length)return;const messageHtml=`<div class="mt-2 small text-muted turn-evaluation-saved-message" data-questionid="${questionId}"><i class="fa fa-check-circle" aria-hidden="true"></i> Saved on ${new Date(1e3*timestamp).toLocaleString()}</div>`;questionItem.append(messageHtml)},hideTurnEvaluationTimestamp=(evaluationContainer,questionId)=>{evaluationContainer.find(`.turn-evaluation-saved-message[data-questionid="${questionId}"]`).remove()},getCurrentTurn=pageid=>currentTurns[pageid]||1,getViewingTurn=pageid=>{const container=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container");return parseInt(container.data("viewing-turn")||getCurrentTurn(pageid),10)},turnHasMessages=(pageid,turnId)=>{const messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`);let messageCount=0;return messagesContainer.find(".message").each((function(){const messageTurnId=(0,_jquery.default)(this).data("turn-id");parseInt(messageTurnId,10)===turnId&&messageCount++})),messageCount>0},isTurnComplete=(pageid,turnId)=>{const messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`);let userCount=0,aiCount=0;return messagesContainer.find(".message").each((function(){const messageTurnId=(0,_jquery.default)(this).data("turn-id");if(parseInt(messageTurnId,10)===turnId){const role=(0,_jquery.default)(this).data("role");"user"===role?userCount++:"assistant"===role&&aiCount++}})),userCount>=1&&aiCount>=1},setViewingTurn=(pageid,turn)=>{if(console.log("setViewingTurn called for pageid:",pageid,"turn:",turn),!pageid||!turn)return void console.warn("setViewingTurn: Invalid pageid or turn",{pageid:pageid,turn:turn});const container=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container");if(0===container.length)return void console.warn("setViewingTurn: Container not found for pageid:",pageid);const previousTurn=container.data("viewing-turn");container.data("viewing-turn",turn),container.attr("data-viewing-turn",turn),(turn=>{if(console.log("updateTurnInUrl called with turn:",turn,"type:",typeof turn),null==turn)return void console.warn("updateTurnInUrl: turn is undefined or null, skipping");const turnNum=parseInt(turn,10);if(isNaN(turnNum)||turnNum<1)console.warn("updateTurnInUrl: invalid turn number:",turn,"parsed as:",turnNum);else try{const url=new URL(window.location.href);url.searchParams.get("turn")!==turnNum.toString()?(url.searchParams.set("turn",turnNum.toString()),window.history.replaceState({},"",url.toString()),console.log("updateTurnInUrl: Updated URL with turn",turnNum,"New URL:",url.toString())):console.log("updateTurnInUrl: Turn",turnNum,"already in URL, skipping update")}catch(e){console.error("Error updating turn in URL:",e,"turn value:",turn)}})(turn),previousTurn!==turn&&"turns"===container.data("behavior")&&setTimeout((()=>{ensureTurnEvaluationQuestionsRendered(pageid,turn).then((()=>{loadTurnEvaluationResponses(pageid,turn)}))}),50)},updateTurnDisplay=pageid=>{const viewingTurn=getViewingTurn(pageid),currentTurn=getCurrentTurn(pageid),turnLabel="Turno "+(getTurnNumberForId(pageid,viewingTurn)||viewingTurn);(0,_jquery.default)(`#current-turn-number-${pageid}`).text(turnLabel);const prevBtn=(0,_jquery.default)(`.prev-turn-btn[data-pageid="${pageid}"]`);viewingTurn>1?prevBtn.show():prevBtn.hide();const nextBtn=(0,_jquery.default)(`.next-turn-btn[data-pageid="${pageid}"]`);viewingTurn<currentTurn?nextBtn.show().html('Go to current turn <i class="fa fa-chevron-right"></i>'):viewingTurn===currentTurn&&isTurnComplete(pageid,viewingTurn)?nextBtn.show().html('Next turn <i class="fa fa-chevron-right"></i>'):nextBtn.hide(),updateSubpageVisibility(pageid)},updateSubpageVisibility=pageid=>{const viewingTurn=getViewingTurn(pageid),subpagesContainer=(0,_jquery.default)(`#subpages-container-${pageid}`);0!==subpagesContainer.length&&subpagesContainer.find(".subpage-item").each((function(){const $subpage=(0,_jquery.default)(this),visibilityType=$subpage.data("visibility-type"),turnNumber=$subpage.data("turn-number");let shouldShow=!1;switch(visibilityType){case"all_turns":shouldShow=!0;break;case"first_turn":shouldShow=1===viewingTurn;break;case"specific_turn":shouldShow=viewingTurn===turnNumber;break;default:shouldShow=!1}shouldShow?($subpage.slideDown(200),updateSubpageQuestionVisibility($subpage,viewingTurn)):$subpage.slideUp(200)}))},updateSubpageQuestionVisibility=($subpage,viewingTurn)=>{$subpage.find(".question-item").each((function(){const $question=(0,_jquery.default)(this),visibilityType=$question.data("visibility-type")||"all_turns",turnNumber=$question.data("turn-number");let shouldShow=!1;switch(visibilityType){case"all_turns":default:shouldShow=!0;break;case"first_turn":shouldShow=1===viewingTurn;break;case"specific_turn":shouldShow=viewingTurn===turnNumber}shouldShow?$question.slideDown(200):$question.slideUp(200)}))},updateChatLockState=pageid=>{const viewingTurn=getViewingTurn(pageid),currentTurn=getCurrentTurn(pageid),viewingTurnNum=parseInt(viewingTurn,10),currentTurnNum=parseInt(currentTurn,10),input=(0,_jquery.default)(`#chat-input-page-${pageid}`),sendBtn=(0,_jquery.default)(`.chat-send-btn[data-pageid="${pageid}"]`),lockMessage=(0,_jquery.default)(`#turn-locked-message-${pageid}`),maxTurns=input.closest(".ai-conversation-container").data("max-turns"),maxTurnsNum=null!=maxTurns?parseInt(maxTurns,10):null,conversationTurnCount=getTurnCountForConversation(pageid,viewingTurnNum),hasReachedTurnLimit=null!==maxTurnsNum&&null!==conversationTurnCount&&conversationTurnCount>=maxTurnsNum;if(viewingTurnNum<currentTurnNum){input.prop("disabled",!0),sendBtn.prop("disabled",!0),lockMessage.length>0&&lockMessage.show();const directBranchContainer=(0,_jquery.default)(`#direct-branch-container-${pageid}`);directBranchContainer.length>0&&directBranchContainer.hide()}else if(viewingTurnNum===currentTurnNum&&isTurnComplete(pageid,viewingTurnNum))if(hasReachedTurnLimit&&turnHasMessages(pageid,viewingTurnNum)){input.prop("disabled",!0),sendBtn.prop("disabled",!0),input.val(""),lockMessage.length>0&&(0,_str.get_string)("maxturnsreached","mod_harpiasurvey").then((str=>{lockMessage.text(str).show()}));const directBranchContainer=(0,_jquery.default)(`#direct-branch-container-${pageid}`);directBranchContainer.length>0&&directBranchContainer.hide()}else{input.prop("disabled",!0),sendBtn.prop("disabled",!0),input.val(""),lockMessage.length>0&&lockMessage.hide();const directBranchContainer=(0,_jquery.default)(`#direct-branch-container-${pageid}`);directBranchContainer.length>0&&directBranchContainer.show()}else if(viewingTurnNum!==currentTurnNum||isTurnComplete(pageid,viewingTurnNum)){input.prop("disabled",!1),sendBtn.prop("disabled",!1);const directBranchContainer=(0,_jquery.default)(`#direct-branch-container-${pageid}`);directBranchContainer.length>0&&directBranchContainer.hide(),lockMessage.length>0&&lockMessage.hide()}else{if(hasReachedTurnLimit&&turnHasMessages(pageid,viewingTurnNum)){input.prop("disabled",!0),sendBtn.prop("disabled",!0),input.val(""),lockMessage.length>0&&(0,_str.get_string)("maxturnsreached","mod_harpiasurvey").then((str=>{lockMessage.text(str).show()}));const directBranchContainer=(0,_jquery.default)(`#direct-branch-container-${pageid}`);return void(directBranchContainer.length>0&&directBranchContainer.hide())}(0,_jquery.default)(`#chat-loading-page-${pageid}`).is(":visible")?(input.prop("disabled",!0),sendBtn.prop("disabled",!0)):(input.prop("disabled",!1),sendBtn.prop("disabled",!1));const directBranchContainer=(0,_jquery.default)(`#direct-branch-container-${pageid}`);directBranchContainer.length>0&&directBranchContainer.hide(),lockMessage.length>0&&lockMessage.hide()}},updateMessageTurnLabels=pageid=>{(0,_jquery.default)(`#chat-messages-page-${pageid}`).find(".message").each((function(){const $msg=(0,_jquery.default)(this),turnId=parseInt($msg.data("turn-id"),10);if(turnId){const turnLabel="Turno "+(getTurnNumberForId(pageid,turnId)||turnId),$badge=$msg.find(".badge").filter((function(){return(0,_jquery.default)(this).closest(".position-absolute").length>0}));if($badge.length>0)$badge.text(turnLabel);else{const $firstBadge=$msg.find(".badge").first();$firstBadge.length>0&&$firstBadge.text(turnLabel)}}}))},insertTurnSeparators=pageid=>{const messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`);let lastTurnId=null;const viewingTurn=getViewingTurn(pageid);let relevantTurnIds=[],relevantTurnIdsSet=new Set;viewingTurn&&(relevantTurnIds=getRelevantTurnIds(pageid,viewingTurn),relevantTurnIdsSet=new Set(relevantTurnIds)),messagesContainer.find(".turn-separator").remove(),messagesContainer.find(".message").each((function(){const messageTurnId=(0,_jquery.default)(this).data("turn-id");if(messageTurnId){const currentTurnId=parseInt(messageTurnId,10);if(viewingTurn&&!relevantTurnIdsSet.has(currentTurnId))return;if(null!==lastTurnId&&currentTurnId!==lastTurnId){const cmid=messagesContainer.closest(".ai-conversation-container").data("cmid"),branchInfo=((pageid,turnId)=>{const tree=conversationTrees[pageid];if(!tree||!tree.roots)return null;const findNode=(nodes,targetId)=>{for(const node of nodes){if(node.turn_id===targetId)return node;if(node.children&&node.children.length>0){const found=findNode(node.children,targetId);if(found)return found}}return null},node=findNode(tree.roots,turnId);return node?{is_branch:!node.is_root,branch_label:node.branch_label||null}:null})(pageid,currentTurnId),isBranch=!!branchInfo&&branchInfo.is_branch,branchLabel=branchInfo?branchInfo.branch_label:null,turnNumber=getTurnNumberForId(pageid,currentTurnId)||currentTurnId,viewingTurn=getViewingTurn(pageid),isPreviousTurn=currentTurnId<viewingTurn;_templates.default.render("mod_harpiasurvey/turn_separator",{turn_id:currentTurnId,turn_number:turnNumber,is_branch:isBranch,branch_label:branchLabel,pageid:pageid,cmid:cmid,is_previous_turn:isPreviousTurn,can_create_branch:!1}).then((html=>{(0,_jquery.default)(this).before(html)})).catch((()=>{const separatorHtml='<div class="turn-separator my-4" data-turn-separator="'+currentTurnId+'"><div class="d-flex align-items-center justify-content-between"><hr class="flex-grow-1" style="border-color: #6c757d; border-width: 2px;"><div class="px-3 d-flex align-items-center gap-2"><span class="badge badge-secondary">Turn '+currentTurnId+'</span></div><hr class="flex-grow-1" style="border-color: #6c757d; border-width: 2px;"></div></div>';(0,_jquery.default)(this).before(separatorHtml)}))}lastTurnId=currentTurnId}else null===messageTurnId&&null!==lastTurnId&&(_templates.default.render("mod_harpiasurvey/turn_separator",{turn_id:"?"}).then((html=>{(0,_jquery.default)(this).before(html)})).catch((()=>{(0,_jquery.default)(this).before('<div class="turn-separator my-4"><div class="d-flex align-items-center"><hr class="flex-grow-1" style="border-color: #6c757d; border-width: 2px;"><div class="px-3"><span class="badge badge-secondary">New Messages</span></div><hr class="flex-grow-1" style="border-color: #6c757d; border-width: 2px;"></div></div>')})),lastTurnId=null)}))},getRelevantTurnIds=(pageid,turnId)=>{const tree=conversationTrees[pageid];if(!tree||!tree.roots)return[turnId];const root=findRootForTurn(tree.roots,turnId);if(!root)return[turnId];const findNodeInConversation=(node,targetId)=>{if(parseInt(node.turn_id,10)===parseInt(targetId,10))return node;if(node.direct_branches)for(const db of node.direct_branches){if(parseInt(db.turn_id,10)===parseInt(targetId,10))return db;if(db.children)for(const child of db.children){const found=findNodeInConversation(child,targetId);if(found)return found}}if(node.children)for(const child of node.children){const found=findNodeInConversation(child,targetId);if(found)return found}return null},node=findNodeInConversation(root,turnId);if(!node)return[turnId];if(node.is_root&&parseInt(node.turn_id,10)===parseInt(root.turn_id,10))return[turnId];if(node.is_direct_branch)return[parseInt(root.turn_id,10),turnId];const pathToRoot=[];let current=node;const rootTurnId=parseInt(root.turn_id,10);for(;current&&current.parent_turn_id;){const parentTurnId=current.parent_turn_id;if(parseInt(parentTurnId,10)===rootTurnId){rootTurnId<=turnId&&!pathToRoot.includes(rootTurnId)&&pathToRoot.unshift(rootTurnId);break}const parentNode=findNodeInConversation(root,parentTurnId);if(parentNode&&parentTurnId<=turnId&&pathToRoot.unshift(parentTurnId),current=parentNode,!current)break}!pathToRoot.includes(rootTurnId)&&rootTurnId<=turnId&&pathToRoot.unshift(rootTurnId);return[...pathToRoot.filter((tid=>tid<=turnId)),turnId]},filterMessagesByTurn=(pageid,turnId)=>{const messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`);insertTurnSeparators(pageid);const relevantTurnIds=getRelevantTurnIds(pageid,turnId),relevantTurnIdsSet=new Set(relevantTurnIds);messagesContainer.find(".message").each((function(){const messageTurnId=(0,_jquery.default)(this).data("turn-id");if(messageTurnId){const msgTurn=parseInt(messageTurnId,10);relevantTurnIdsSet.has(msgTurn)?msgTurn===turnId?((0,_jquery.default)(this).show(),(0,_jquery.default)(this).removeClass("previous-turn-message")):((0,_jquery.default)(this).addClass("previous-turn-message"),(0,_jquery.default)(this).hide()):((0,_jquery.default)(this).hide(),(0,_jquery.default)(this).removeClass("previous-turn-message"))}else(0,_jquery.default)(this).show(),(0,_jquery.default)(this).removeClass("previous-turn-message")})),messagesContainer.find(".turn-separator").each((function(){const separatorTurnId=(0,_jquery.default)(this).data("turn-separator");if(separatorTurnId){const sepTurn=parseInt(separatorTurnId,10);if(relevantTurnIdsSet.has(sepTurn))if(sepTurn<turnId){void 0===(0,_jquery.default)(this).data("collapsed")&&(0,_jquery.default)(this).data("collapsed",!0),(0,_jquery.default)(this).hide();const toggleIcon=(0,_jquery.default)(this).find(".toggle-turn-btn").find(".toggle-turn-icon");!0===(0,_jquery.default)(this).data("collapsed")?toggleIcon.removeClass("fa-chevron-up").addClass("fa-chevron-down"):toggleIcon.removeClass("fa-chevron-down").addClass("fa-chevron-up")}else(0,_jquery.default)(this).data("collapsed",!1),(0,_jquery.default)(this).show();else(0,_jquery.default)(this).hide()}else(0,_jquery.default)(this).hide()}));const toggleBtn=(0,_jquery.default)(`.toggle-previous-messages-btn[data-pageid="${pageid}"]`);if(toggleBtn.length>0){if(messagesContainer.find(".previous-turn-message").length>0){toggleBtn.show();messagesContainer.find(".previous-turn-message").first().is(":visible")?(toggleBtn.html('<i class="fa fa-history" aria-hidden="true"></i> Ocultar anteriores'),toggleBtn.attr("title","Ocultar conversas anteriores")):(toggleBtn.html('<i class="fa fa-history" aria-hidden="true"></i> Mostrar anteriores'),toggleBtn.attr("title","Mostrar conversas anteriores"))}else toggleBtn.hide()}setTimeout((()=>{scrollToBottom(pageid)}),50)},filterMessagesByConversation=(pageid,conversationId)=>{const messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`),conversationMessageIds=new Set;conversationMessageIds.add(conversationId);const messageParentMap=new Map;messagesContainer.find(".message").each((function(){const messageId=parseInt((0,_jquery.default)(this).data("messageid"),10),parentId=parseInt((0,_jquery.default)(this).data("parentid"),10);messageId&&parentId&&messageParentMap.set(messageId,parentId)}));let changed=!0;for(;changed;){changed=!1;for(const[messageId,parentId]of messageParentMap.entries())!conversationMessageIds.has(messageId)&&conversationMessageIds.has(parentId)&&(conversationMessageIds.add(messageId),changed=!0)}messagesContainer.find(".message").each((function(){const messageId=parseInt((0,_jquery.default)(this).data("messageid"),10);conversationMessageIds.has(messageId)?(0,_jquery.default)(this).show():(0,_jquery.default)(this).hide()})),setTimeout((()=>{scrollToBottom(pageid)}),50)},navigateToConversation=(pageid,conversationId)=>{const container=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container");container.data("viewing-conversation",conversationId),container.attr("data-viewing-conversation",conversationId),filterMessagesByConversation(pageid,conversationId);const sidebar=(0,_jquery.default)(`#conversation-tree-sidebar-${pageid}`);sidebar.length&&(sidebar.data("sidebar-view","list"),loadConversationTree(pageid))},loadConversationTree=pageid=>{const treeContainer=(0,_jquery.default)(`#conversation-tree-${pageid}`),sidebar=(0,_jquery.default)(`#conversation-tree-sidebar-${pageid}`);if(0===treeContainer.length)return console.warn("Tree container not found for pageid:",pageid),Promise.resolve(null);const cmid=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container").data("cmid");if(!cmid)return console.error("cmid not found for pageid:",pageid),treeContainer.html('<div class="text-danger text-center small py-3">Error: Course module ID not found. Please refresh the page.</div>'),Promise.resolve(null);const params=new URLSearchParams;return params.append("action","get_conversation_tree"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_config.default.sesskey),fetch(_config.default.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(console.log("Conversation tree response:",data),data.success&&data.tree){data.tree.roots=(data.tree.roots||[]).map(((root,idx)=>({...root,conversation_number:idx+1}))),conversationTrees[pageid]=data.tree;const behavior=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container").data("behavior")||data.behavior||"turns";let currentView=sidebar.data("sidebar-view");if(currentView||(currentView="continuous"===behavior?"list":1===data.tree.roots.length?"detail":"list",sidebar.data("sidebar-view",currentView)),"continuous"===behavior)renderConversationList(pageid,data.tree.roots);else if("list"===currentView)renderConversationList(pageid,data.tree.roots);else{const viewingTurn=getViewingTurn(pageid),root=findRootForTurn(data.tree.roots,viewingTurn);root?renderConversationDetail(pageid,root):data.tree.roots.length>0?renderConversationDetail(pageid,data.tree.roots[0]):renderConversationList(pageid,[]);const currentViewingTurn=getViewingTurn(pageid);currentViewingTurn&&ensureTurnEvaluationQuestionsRendered(pageid,currentViewingTurn).then((()=>{loadTurnEvaluationResponses(pageid,currentViewingTurn)}))}return updateMessageTurnLabels(pageid),data.tree}return treeContainer.html('<div class="text-muted text-center small py-3">'+(data.message||"No conversation tree available yet.")+"</div>"),null})).catch((error=>(console.error("Error loading conversation tree:",error),treeContainer.html('<div class="text-danger text-center small py-3">Error loading conversation tree: '+error.message+"<br>Please check the browser console for details and refresh the page.</div>"),null)))},findRootForTurn=(roots,turnId)=>{const findInNode=(node,targetId)=>{if(parseInt(node.turn_id,10)===parseInt(targetId,10))return!0;if(node.direct_branches)for(const db of node.direct_branches){if(parseInt(db.turn_id,10)===parseInt(targetId,10))return!0;if(db.children)for(const child of db.children)if(findInNode(child,targetId))return!0}if(node.children)for(const child of node.children)if(findInNode(child,targetId))return!0;return!1};for(const root of roots)if(findInNode(root,turnId))return root;return null},countNodes=node=>{let count=1;return node.direct_branches&&node.direct_branches.forEach((branch=>{count+=countNodes(branch)})),node.children&&node.children.forEach((child=>{count+=countNodes(child)})),count},renderConversationList=(pageid,roots)=>{const treeContainer=(0,_jquery.default)(`#conversation-tree-${pageid}`),rootsWithCount=roots.map(((root,idx)=>({...root,conversation_id:root.conversation_id||root.turn_id,turn_count:countNodes(root),conversation_number:root.conversation_number||idx+1})));_templates.default.render("mod_harpiasurvey/conversation_list",{roots:rootsWithCount,pageid:pageid}).then((html=>{treeContainer.html(html)})).catch((error=>{console.error("Error rendering conversation list:",error)}))},getTurnCountForConversation=(pageid,turnId)=>{const tree=conversationTrees[pageid];if(!tree||!tree.roots||!turnId)return null;const root=findRootForTurn(tree.roots,turnId);return root?countNodes(root):null},calculateTurnNumber=(node,turnIndex,parentNumber)=>{if(node.is_root||node.is_direct_branch)return String(turnIndex+1);{const branchIndex=turnIndex+1;return parentNumber?`${parentNumber}.${branchIndex}`:String(branchIndex)}},getTurnNumberForId=(pageid,turnId)=>{const tree=conversationTrees[pageid];if(!tree||!tree.roots)return null;const root=((roots,targetId)=>{const findInNode=(node,target)=>{if(parseInt(node.turn_id,10)===parseInt(target,10))return!0;if(node.direct_branches)for(const db of node.direct_branches){if(parseInt(db.turn_id,10)===parseInt(target,10))return!0;if(db.children)for(const child of db.children)if(findInNode(child,target))return!0}if(node.children)for(const child of node.children)if(findInNode(child,target))return!0;return!1};for(const root of roots)if(findInNode(root,targetId))return root;return null})(tree.roots,turnId);if(!root)return null;const findAndNumber=(node,targetId,parentNumber,turnIndex)=>{const nodeNumber=calculateTurnNumber(node,turnIndex,parentNumber);if(parseInt(node.turn_id,10)===parseInt(targetId,10))return nodeNumber;if(node.direct_branches&&node.direct_branches.length>0){const sortedDB=[...node.direct_branches].sort(((a,b)=>parseInt(a.turn_id,10)-parseInt(b.turn_id,10)));let dbCounter=turnIndex+1;for(const db of sortedDB){const dbNumber=calculateTurnNumber(db,dbCounter,null);if(parseInt(db.turn_id,10)===parseInt(targetId,10))return dbNumber;if(db.children&&db.children.length>0){const sortedChildren=[...db.children].sort(((a,b)=>parseInt(a.turn_id,10)-parseInt(b.turn_id,10)));for(let i=0;i<sortedChildren.length;i++){const found=findAndNumber(sortedChildren[i],targetId,dbNumber,i);if(found)return found}}dbCounter++}}if(node.children&&node.children.length>0){const sortedChildren=[...node.children].sort(((a,b)=>parseInt(a.turn_id,10)-parseInt(b.turn_id,10)));for(let i=0;i<sortedChildren.length;i++){const found=findAndNumber(sortedChildren[i],targetId,nodeNumber,i);if(found)return found}}return null};return findAndNumber(root,turnId,null,0)},prepareNodeData=function(node,level,currentTurnId,pageid,cmid){let turnIndex=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,parentNumber=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,behavior=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"turns";const isCurrent=parseInt(node.turn_id,10)===parseInt(currentTurnId,10),hasChildren=node.children&&node.children.length>0,isDirectBranch=node.is_direct_branch||!1,turnNumber=calculateTurnNumber(node,turnIndex,parentNumber);return{turn_id:node.turn_id,conversation_id:node.conversation_id||node.turn_id,turn_number:turnNumber,is_root:node.is_root||!1,is_direct_branch:isDirectBranch,is_current:isCurrent,has_children:hasChildren,branch_label:node.branch_label||null,level:level,expanded:!0,pageid:pageid,cmid:cmid,can_create_branch:"turns"===behavior,children:hasChildren?node.children.map(((child,index)=>prepareNodeData(child,isDirectBranch?level:level+1,currentTurnId,pageid,cmid,index,turnNumber,behavior))):[]}},renderConversationDetail=(pageid,root)=>{const treeContainer=(0,_jquery.default)(`#conversation-tree-${pageid}`),container=(0,_jquery.default)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container"),cmid=container.data("cmid"),behavior=container.data("behavior")||"turns";if("continuous"===behavior){const viewingConv=container.data("viewing-conversation")||root.conversation_id||root.turn_id,isCurrent=parseInt(root.conversation_id||root.turn_id,10)===parseInt(viewingConv,10),rootNodeData={turn_id:root.turn_id,conversation_id:root.conversation_id||root.turn_id,turn_number:null,is_root:!0,is_direct_branch:!1,is_current:isCurrent,has_children:!1,branch_label:null,level:0,expanded:!0,pageid:pageid,cmid:cmid,can_create_branch:!1};return void _templates.default.render("mod_harpiasurvey/conversation_detail",{root_node:rootNodeData,root_turn_id:root.turn_id,direct_branches:[],pageid:pageid,cmid:cmid,conversation_number:root.conversation_number||1}).then((html=>{treeContainer.html(html)})).catch((error=>{console.error("Error rendering conversation detail:",error)}))}const viewingTurn=getViewingTurn(pageid);let turnCounter=0;const rootNodeData=prepareNodeData(root,0,viewingTurn,pageid,cmid,turnCounter,null,behavior);turnCounter++;const directBranches=[];if(root.direct_branches&&root.direct_branches.length>0){[...root.direct_branches].sort(((a,b)=>parseInt(a.turn_id,10)-parseInt(b.turn_id,10))).forEach((node=>{directBranches.push(prepareNodeData(node,1,viewingTurn,pageid,cmid,turnCounter,null,behavior)),turnCounter++}))}_templates.default.render("mod_harpiasurvey/conversation_detail",{root_node:rootNodeData,root_turn_id:root.turn_id,direct_branches:directBranches,pageid:pageid,cmid:cmid,conversation_number:root.conversation_number||1}).then((html=>{treeContainer.html(html)})).catch((error=>{console.error("Error rendering conversation detail:",error)}))},createBranchFromTurn=function(cmid,pageid,parentTurnId){let buttonEl=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const btn=buttonEl?(0,_jquery.default)(buttonEl):null;let originalHtml=null;btn&&btn.length&&(originalHtml=btn.html(),btn.prop("disabled",!0).addClass("branch-btn-loading"),btn.html('<i class="fa fa-spinner fa-spin fa-xs" aria-hidden="true"></i>'));const params=new URLSearchParams;params.append("action","create_branch"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("parent_turn_id",parentTurnId),params.append("sesskey",_config.default.sesskey),fetch(_config.default.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(btn&&btn.length&&(btn.prop("disabled",!1).removeClass("branch-btn-loading"),null!==originalHtml&&btn.html(originalHtml)),data.success){navigateToTurn(pageid,data.new_turn_id,!0),addLocalBranchNode(pageid,parentTurnId,data.new_turn_id);(0,_jquery.default)(`#conversation-tree-sidebar-${pageid}`).data("sidebar-view","detail"),loadConversationTree(pageid),(0,_str.get_string)("branchcreated","mod_harpiasurvey").then((msg=>{_notification.default.addNotification({message:msg,type:"success"})})).catch((()=>{_notification.default.addNotification({message:"Branch created successfully",type:"success"})}))}else _notification.default.addNotification({message:data.message||"Failed to create turn",type:"error"})})).catch((error=>{btn&&btn.length&&(btn.prop("disabled",!1).removeClass("branch-btn-loading"),null!==originalHtml&&btn.html(originalHtml)),console.error("Error creating turn:",error),_notification.default.addNotification({message:"Error creating turn: "+error.message,type:"error"})}))},addLocalBranchNode=(pageid,parentTurnId,newTurnId)=>{const tree=conversationTrees[pageid];if(!tree||!tree.roots)return;const root=findRootForTurn(tree.roots,parentTurnId);if(!root)return;const newNode={turn_id:newTurnId,is_root:!1,is_direct_branch:!1,parent_turn_id:parentTurnId,branch_label:String(newTurnId),children:[],timecreated:Math.floor(Date.now()/1e3),timecreated_str:(new Date).toLocaleString()},attach=node=>{if(parseInt(node.turn_id,10)===parseInt(parentTurnId,10))return node.is_root||node.is_direct_branch?(newNode.is_direct_branch=!0,node.direct_branches||(node.direct_branches=[]),node.direct_branches.push(newNode)):(node.children||(node.children=[]),node.children.push(newNode)),!0;if(node.direct_branches)for(const db of node.direct_branches)if(attach(db))return!0;if(node.children)for(const child of node.children)if(attach(child))return!0;return!1};attach(root),renderConversationDetail(pageid,root)},createNewRoot=(cmid,pageid)=>{const container=(0,_jquery.default)(`.ai-conversation-container[data-pageid="${pageid}"]`),behavior=container.data("behavior")||"turns",messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`),params=new URLSearchParams;params.append("action","create_root"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_config.default.sesskey),fetch(_config.default.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(data.success){if("turns"===behavior){currentTurns[pageid]=data.new_turn_id,setViewingTurn(pageid,data.new_turn_id),updateTurnDisplay(pageid),updateChatLockState(pageid),messagesContainer.html('<div class="text-muted text-center small py-3">New conversation started. Send a message to begin.</div>'),(0,_jquery.default)(`#turn-evaluation-questions-container-${pageid}`).empty();(0,_jquery.default)(`#conversation-tree-sidebar-${pageid}`).data("sidebar-view","detail"),setTimeout((()=>{loadConversationTree(pageid).then((tree=>{if(tree&&tree.roots){const newRoot=tree.roots.find((r=>parseInt(r.turn_id,10)===parseInt(data.new_turn_id,10)));newRoot&&renderConversationDetail(pageid,newRoot)}}))}),100)}else{const newConversationId=parseInt(data.new_conversation_id||data.new_turn_id,10);container.data("viewing-conversation",newConversationId),container.attr("data-viewing-conversation",newConversationId),messagesContainer.html('<div class="text-muted text-center small py-3">New conversation started. Send a message to begin.</div>');(0,_jquery.default)(`#conversation-tree-sidebar-${pageid}`).data("sidebar-view","list"),setTimeout((()=>{loadConversationTree(pageid).then((tree=>{var _treeData$roots;if(tree&&tree.roots){const root=tree.roots.find((r=>parseInt(r.conversation_id||r.turn_id,10)===newConversationId));if(root)return void navigateToConversation(pageid,root.conversation_id||root.turn_id)}const treeData=conversationTrees[pageid]||{roots:[]},nextNumber=((null===(_treeData$roots=treeData.roots)||void 0===_treeData$roots?void 0:_treeData$roots.length)||0)+1,newRoot={turn_id:newConversationId,conversation_id:newConversationId,is_root:!0,children:[],parent_turn_id:null,branch_label:null,timecreated:Math.floor(Date.now()/1e3),timecreated_str:(new Date).toLocaleString(),message_count:1,conversation_number:nextNumber};treeData.roots=[...treeData.roots||[],newRoot],conversationTrees[pageid]=treeData,renderConversationList(pageid,treeData.roots),navigateToConversation(pageid,newConversationId)}))}),100)}_notification.default.addNotification({message:data.message||"New conversation created successfully",type:"success"})}else _notification.default.addNotification({message:data.message||"Failed to create new root",type:"error"})})).catch((error=>{console.error("Error creating new root:",error),_notification.default.addNotification({message:"Error creating new root: "+error.message,type:"error"})}))},navigateToTurn=function(pageid,turnId){let setAsCurrent=arguments.length>2&&void 0!==arguments[2]&&arguments[2];setAsCurrent&&(currentTurns[pageid]=turnId),setViewingTurn(pageid,turnId),updateTurnDisplay(pageid),updateChatLockState(pageid);const messagesContainer=(0,_jquery.default)(`#chat-messages-page-${pageid}`);messagesContainer.find(".turn-separator").each((function(){const separatorTurnId=(0,_jquery.default)(this).data("turn-separator");if(separatorTurnId){if(parseInt(separatorTurnId,10)<turnId){(0,_jquery.default)(this).data("collapsed",!0);const toggleIcon=(0,_jquery.default)(this).find(".toggle-turn-btn").find(".toggle-turn-icon");toggleIcon.length>0&&toggleIcon.removeClass("fa-chevron-up").addClass("fa-chevron-down")}}})),filterMessagesByTurn(pageid,turnId),updateSubpageVisibility(pageid),ensureTurnEvaluationQuestionsRendered(pageid,turnId).then((()=>{loadTurnEvaluationResponses(pageid,turnId)}));const sidebar=(0,_jquery.default)(`#conversation-tree-sidebar-${pageid}`);sidebar.length&&(sidebar.data("sidebar-view","detail"),loadConversationTree(pageid).then((tree=>{if(tree&&tree.roots){const root=findRootForTurn(tree.roots,turnId);root&&(renderConversationDetail(pageid,root),ensureTurnEvaluationQuestionsRendered(pageid,turnId).then((()=>{loadTurnEvaluationResponses(pageid,turnId)})))}}))),setTimeout((()=>{loadConversationTree(pageid)}),100)},initMultiModelChat=(pageid,cmid)=>{console.log("Initializing multi-model chat for page "+pageid);const container=(0,_jquery.default)(`.multi-model-chat-container[data-pageid="${pageid}"]`);if(0===container.length)return;const input=(0,_jquery.default)(`#chat-input-${pageid}`),sendButton=(0,_jquery.default)(`#send-message-btn-${pageid}`),modelIds=[];container.find("[data-model-id]").each((function(){const modelId=parseInt((0,_jquery.default)(this).data("model-id"),10);modelId&&!modelIds.includes(modelId)&&modelIds.push(modelId)})),console.log("Found "+modelIds.length+" models for multi-model chat"),sendButton.on("click",(function(e){e.preventDefault();const message=input.val().trim();if(!message)return;if(0===modelIds.length)return void _notification.default.addNotification({message:"No models available",type:"error"});input.prop("disabled",!0),sendButton.prop("disabled",!0),input.val("");const tempId="temp-user-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);modelIds.forEach((modelId=>{displayUserMessageMultiModel(pageid,message,tempId,modelId)})),sendMessageToAllModels(cmid,pageid,message,modelIds,sendButton,input)})),input.on("keydown",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendButton.click())}))},displayUserMessageMultiModel=(pageid,message,messageid,modelId)=>{const messagesContainer=(0,_jquery.default)(`#chat-messages-model-${modelId}-${pageid}`);0!==messagesContainer.length&&(messagesContainer.find(".text-center.text-muted").remove(),_templates.default.render("mod_harpiasurvey/chat_user_message",{id:messageid,content:message,timecreated:Math.floor(Date.now()/1e3)}).then((html=>(messagesContainer.append(html),messagesContainer.scrollTop(messagesContainer[0].scrollHeight),html))).catch(_notification.default.exception))},sendMessageToAllModels=(cmid,pageid,message,modelIds,button,input)=>{const wwwroot=_config.default.wwwroot,sesskey=_config.default.sesskey||M.cfg.sesskey,ajaxUrl=wwwroot+"/mod/harpiasurvey/ajax.php";modelIds.forEach((modelId=>{const messagesContainer=(0,_jquery.default)(`#chat-messages-model-${modelId}-${pageid}`),loading=(0,_jquery.default)('<div class="text-center py-2"><i class="fa fa-spinner fa-spin"></i> Thinking...</div>');loading.attr("id",`chat-loading-model-${modelId}-${pageid}`),messagesContainer.append(loading),messagesContainer.scrollTop(messagesContainer[0].scrollHeight)}));const promises=modelIds.map((modelId=>{const params=new URLSearchParams({action:"send_ai_message",cmid:cmid,pageid:pageid,message:message,modelid:modelId,sesskey:sesskey});return fetch(ajaxUrl+"?"+params.toString()).then((response=>response.json())).then((response=>{(0,_jquery.default)(`#chat-loading-model-${modelId}-${pageid}`).remove(),response.success?((pageid,content,messageid,modelId)=>{const messagesContainer=(0,_jquery.default)(`#chat-messages-model-${modelId}-${pageid}`);0!==messagesContainer.length&&_templates.default.render("mod_harpiasurvey/chat_ai_message",{id:messageid,content:content,timecreated:Math.floor(Date.now()/1e3)}).then((html=>(messagesContainer.append(html),messagesContainer.scrollTop(messagesContainer[0].scrollHeight),html))).catch(_notification.default.exception)})(pageid,response.content,response.messageid,modelId):_notification.default.addNotification({message:`Error from ${getModelName(pageid,modelId)}: ${response.message||"Unknown error"}`,type:"error"})})).catch((error=>{(0,_jquery.default)(`#chat-loading-model-${modelId}-${pageid}`).remove(),_notification.default.exception(error)}))}));Promise.all(promises).finally((()=>{input.prop("disabled",!1),button.prop("disabled",!1),input.focus()}))},getModelName=(pageid,modelId)=>{const tab=(0,_jquery.default)(`#model-tab-${modelId}-${pageid}`);return tab.length>0?tab.text().trim():`Model ${modelId}`}}));

//# sourceMappingURL=core_chat.min.js.map
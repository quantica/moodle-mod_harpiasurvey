define("mod_harpiasurvey/continuous",["exports","./common_chat"],(function(_exports,_common_chat){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;let initialized=!1,commonHandlersRegistered=!1,treeHandlersRegistered=!1;_exports.init=()=>initialize();const initialize=()=>{if(initialized)return;const containers=(0,_common_chat.$)('.ai-conversation-container[data-behavior="continuous"]');0!==containers.length&&(containers.each((function(){const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10);pageid&&initContinuousPage(pageid)})),function(){if(commonHandlersRegistered)return;(0,_common_chat.$)(document).on("click",".chat-send-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),cmid=parseInt(button.data("cmid"),10),pageid=parseInt(button.data("pageid"),10);if(!cmid||!pageid)return void(0,_common_chat.addError)("Missing cmid or pageid");const input=(0,_common_chat.$)(`#chat-input-page-${pageid}`);if(0===input.length)return void(0,_common_chat.addError)("Chat input not found");const inputValue=input.val();if(!inputValue)return;const message=inputValue.trim();if(!message)return;const modelsdata=button.closest(".ai-conversation-container").data("models");let modelid=null;if(modelsdata){const modelids=modelsdata.split(",");modelids.length>0&&(modelid=parseInt(modelids[0],10))}if(!modelid)return void(0,_common_chat.addError)("No model available");input.prop("disabled",!0),button.prop("disabled",!0),input.val("");const tempId="temp-user-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);displayUserMessage(pageid,message,tempId);const loading=(0,_common_chat.$)(`#chat-loading-page-${pageid}`);loading.show(),sendMessage(cmid,pageid,message,modelid,button,input,loading)})),(0,_common_chat.$)(document).on("keydown",".chat-input",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),(0,_common_chat.$)(this).closest(".ai-conversation-container").find(".chat-send-btn").click())})),commonHandlersRegistered=!0}(),function(){if(treeHandlersRegistered)return;(0,_common_chat.$)(document).on("click",'.tree-node-content[data-action="navigate"]',(function(e){e.preventDefault();const node=(0,_common_chat.$)(this),conversationId=parseInt(node.data("conversation-id"),10),pageid=node.closest(".conversation-tree-sidebar").attr("id").replace("conversation-tree-sidebar-","");pageid&&navigateToConversation(parseInt(pageid,10),conversationId)})),(0,_common_chat.$)(document).on("click",".conversation-item",(function(e){e.preventDefault();const item=(0,_common_chat.$)(this),conversationId=parseInt(item.data("conversation-id"),10),sidebarId=item.closest(".conversation-tree-sidebar").attr("id"),pageid=parseInt(sidebarId.replace("conversation-tree-sidebar-",""),10);pageid&&navigateToConversation(pageid,conversationId)})),(0,_common_chat.$)(document).on("click",".create-root-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);pageid&&cmid?createNewRoot(cmid,pageid):(0,_common_chat.addError)("Missing required data to create root")})),(0,_common_chat.$)(document).on("click",".export-conversation-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);if(!pageid||!cmid)return void(0,_common_chat.addError)("Missing required data to export conversation");const container=(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`),conversationId=container.data("viewing-conversation")||parseInt(container.attr("data-viewing-conversation"),10),params=new URLSearchParams;params.append("action","export_conversation"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),conversationId&&params.append("conversation_id",conversationId),window.open(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),"_blank")})),treeHandlersRegistered=!0}(),initialized=!0)},initContinuousPage=pageid=>{const container=(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`),allMessages=(0,_common_chat.$)(`#chat-messages-page-${pageid}`).find(".message");if(allMessages.length>0){const lastMessage=allMessages.last(),lastMessageId=parseInt(lastMessage.data("messageid"),10);if(lastMessageId&&!isNaN(lastMessageId)){let rootId=lastMessageId,currentId=lastMessageId,found=!1;const parentMap=new Map;for(allMessages.each((function(){const msgId=parseInt((0,_common_chat.$)(this).data("messageid"),10),parentId=parseInt((0,_common_chat.$)(this).data("parentid"),10);msgId&&!isNaN(msgId)&&parentMap.set(msgId,parentId&&!isNaN(parentId)?parentId:null)}));currentId&&!found;){const parentId=parentMap.get(currentId);parentId?currentId=parentId:(rootId=currentId,found=!0)}found&&(container.data("viewing-conversation",rootId),container.attr("data-viewing-conversation",rootId),filterMessagesByConversation(pageid,rootId))}}const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);sidebar.length>0&&(sidebar.show(),loadConversationTree(pageid))};const filterMessagesByConversation=(pageid,conversationId)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`),conversationMessageIds=new Set;conversationMessageIds.add(conversationId);const messageParentMap=new Map;messagesContainer.find(".message").each((function(){const messageId=parseInt((0,_common_chat.$)(this).data("messageid"),10),parentId=parseInt((0,_common_chat.$)(this).data("parentid"),10);messageId&&!isNaN(messageId)&&messageParentMap.set(messageId,parentId&&!isNaN(parentId)?parentId:null)}));let changed=!0;for(;changed;){changed=!1;for(const[messageId,parentId]of messageParentMap.entries())!conversationMessageIds.has(messageId)&&parentId&&conversationMessageIds.has(parentId)&&(conversationMessageIds.add(messageId),changed=!0)}messageParentMap.has(conversationId)&&conversationMessageIds.add(conversationId);let hasVisibleMessages=!1;messagesContainer.find(".message").each((function(){const messageId=parseInt((0,_common_chat.$)(this).data("messageid"),10);conversationMessageIds.has(messageId)?((0,_common_chat.$)(this).show(),hasVisibleMessages=!0):(0,_common_chat.$)(this).hide()}));const placeholder=messagesContainer.find(".text-center.text-muted");hasVisibleMessages?placeholder.hide():0===placeholder.length?messagesContainer.prepend('<div class="text-center text-muted py-4"><p>No messages yet. Send a message to start the conversation.</p></div>'):placeholder.show(),setTimeout((()=>(0,_common_chat.scrollToBottom)(pageid)),50)},sendMessage=(cmid,pageid,message,modelid,button,input,loading)=>{const container=(0,_common_chat.$)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container"),viewingConversation=container.data("viewing-conversation");let parentid=null;const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);if(viewingConversation){const conversationMessageIds=new Set;conversationMessageIds.add(viewingConversation);const messageParentMap=new Map;messagesContainer.find(".message").each((function(){const messageId=parseInt((0,_common_chat.$)(this).data("messageid"),10),parentId=parseInt((0,_common_chat.$)(this).data("parentid"),10);messageId&&!isNaN(messageId)&&messageParentMap.set(messageId,parentId&&!isNaN(parentId)?parentId:null)}));let changed=!0;for(;changed;){changed=!1;for(const[messageId,parentId]of messageParentMap.entries())!conversationMessageIds.has(messageId)&&parentId&&conversationMessageIds.has(parentId)&&(conversationMessageIds.add(messageId),changed=!0)}let lastMessageInConversation=null,lastTimeCreated=0;if(messagesContainer.find(".message").each((function(){const messageId=parseInt((0,_common_chat.$)(this).data("messageid"),10);if(conversationMessageIds.has(messageId)){const timeCreated=parseInt((0,_common_chat.$)(this).data("timecreated"),10)||0;timeCreated>=lastTimeCreated&&(lastTimeCreated=timeCreated,lastMessageInConversation=(0,_common_chat.$)(this))}})),lastMessageInConversation&&lastMessageInConversation.length>0){const lastMessageId=parseInt(lastMessageInConversation.data("messageid"),10);lastMessageId&&!isNaN(lastMessageId)&&(parentid=lastMessageId)}else parentid=viewingConversation}else parentid=null;const params=new URLSearchParams({action:"send_ai_message",cmid:cmid,pageid:pageid,message:message,modelid:modelid,sesskey:_common_chat.Config.sesskey});parentid&&!isNaN(parentid)&&parentid>0&&params.append("parentid",parentid),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{loading.hide(),data.success?(data.root_conversation_id&&(container.data("viewing-conversation",data.root_conversation_id),container.attr("data-viewing-conversation",data.root_conversation_id)),data.messageid&&data.content?displayAIMessage(pageid,data.content,data.messageid,data.turn_id).then((()=>{loadConversationTree(pageid),setTimeout((()=>{(0,_common_chat.scrollToBottom)(pageid)}),100),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()})):((0,_common_chat.addError)("Received response but missing message ID or content"),input.prop("disabled",!1),button.prop("disabled",!1),input.focus())):((0,_common_chat.addError)(data.message||"Error sending message"),input.prop("disabled",!1),button.prop("disabled",!1),input.focus())})).catch((error=>{loading.hide(),console.error("Error sending message:",error),(0,_common_chat.addError)("Error sending message: "+error.message),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()}))},displayUserMessage=(pageid,message,messageid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);0!==messagesContainer.length&&(messagesContainer.find(".text-center.text-muted").remove(),_common_chat.Templates.render("mod_harpiasurvey/chat_user_message",{id:messageid,content:message,timecreated:Math.floor(Date.now()/1e3)}).then((html=>{messagesContainer.append(html),(0,_common_chat.scrollToBottom)(pageid)})).catch(_common_chat.Notification.exception))},displayAIMessage=(pageid,content,messageid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`);return 0===messagesContainer.length?Promise.resolve():_common_chat.Templates.render("mod_harpiasurvey/chat_ai_message",{id:messageid,content:content,timecreated:Math.floor(Date.now()/1e3)}).then((html=>(messagesContainer.append(html),(0,_common_chat.scrollToBottom)(pageid),html))).catch(_common_chat.Notification.exception)},renderConversationListSimple=(pageid,roots)=>{const treeContainer=(0,_common_chat.$)(`#conversation-tree-${pageid}`);if(0===treeContainer.length)return;if(0===roots.length)return void treeContainer.html('<div class="text-muted text-center small py-3">No conversations yet. Click "New conversation" to start.</div>');const container=(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`),viewingConversation=container.data("viewing-conversation")||parseInt(container.attr("data-viewing-conversation"),10);let html='<ul class="list-group list-group-flush">';roots.forEach((root=>{const conversationNumber=root.conversation_number||"",conversationId=root.id||root.conversation_id||root.turn_id,isActive=viewingConversation&&parseInt(conversationId,10)===parseInt(viewingConversation,10);html+=`<li class="list-group-item conversation-item ${isActive?"active":""}" data-conversation-id="${conversationId}" style="cursor: pointer;">`,html+='<div class="d-flex justify-content-between align-items-center">',html+=`<span class="font-weight-bold">Conversation ${conversationNumber}</span>`,html+=`<small class="${isActive?"text-white-50":"text-muted"}">${root.message_count||0} messages</small>`,html+="</div>",html+="</li>"})),html+="</ul>",treeContainer.html(html)},loadConversationTree=pageid=>{const treeContainer=(0,_common_chat.$)(`#conversation-tree-${pageid}`),sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);if(0===treeContainer.length)return Promise.resolve(null);const cmid=(0,_common_chat.getCmid)(pageid);if(!cmid)return treeContainer.html('<div class="text-danger text-center small py-3">Error: Course module ID not found. Please refresh the page.</div>'),Promise.resolve(null);const params=new URLSearchParams;return params.append("action","get_conversation_tree"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>data.success&&data.tree?(data.tree.roots=(data.tree.roots||[]).map(((root,idx)=>({...root,conversation_number:idx+1}))),_common_chat.conversationTrees[pageid]=data.tree,sidebar.data("sidebar-view","list"),renderConversationListSimple(pageid,data.tree.roots),data.tree):(treeContainer.html('<div class="text-muted text-center small py-3">'+(data.message||"No conversation tree available yet.")+"</div>"),null))).catch((error=>(console.error("Error loading conversation tree:",error),treeContainer.html('<div class="text-danger text-center small py-3">Error loading conversation tree: '+error.message+"<br>Please check the browser console for details and refresh the page.</div>"),null)))},navigateToConversation=(pageid,conversationId)=>{const container=(0,_common_chat.$)(`#chat-messages-page-${pageid}`).closest(".ai-conversation-container");container.data("viewing-conversation",conversationId),container.attr("data-viewing-conversation",conversationId),filterMessagesByConversation(pageid,conversationId);const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);sidebar.length&&(sidebar.data("sidebar-view","list"),loadConversationTree(pageid))},createNewRoot=(cmid,pageid)=>{const container=(0,_common_chat.$)(`.ai-conversation-container[data-pageid="${pageid}"]`),messagesContainer=(0,_common_chat.$)(`#chat-messages-page-${pageid}`),params=new URLSearchParams;params.append("action","create_root"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(data.success){const newConversationId=parseInt(data.new_conversation_id||data.new_turn_id,10);container.data("viewing-conversation",newConversationId),container.attr("data-viewing-conversation",newConversationId),messagesContainer.html('<div class="text-muted text-center small py-3">New conversation started. Send a message to begin.</div>');(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`).data("sidebar-view","list"),setTimeout((()=>{loadConversationTree(pageid).then((tree=>{var _treeData$roots;if(tree&&tree.roots){const root=tree.roots.find((r=>parseInt(r.conversation_id||r.turn_id,10)===newConversationId));if(root)return void navigateToConversation(pageid,root.conversation_id||root.turn_id)}const treeData=_common_chat.conversationTrees[pageid]||{roots:[]},nextNumber=((null===(_treeData$roots=treeData.roots)||void 0===_treeData$roots?void 0:_treeData$roots.length)||0)+1,newRoot={turn_id:newConversationId,conversation_id:newConversationId,is_root:!0,children:[],parent_turn_id:null,branch_label:null,timecreated:Math.floor(Date.now()/1e3),timecreated_str:(new Date).toLocaleString(),message_count:1,conversation_number:nextNumber};treeData.roots=[...treeData.roots||[],newRoot],_common_chat.conversationTrees[pageid]=treeData,renderConversationListSimple(pageid,treeData.roots),navigateToConversation(pageid,newConversationId)}))}),100),_common_chat.Notification.addNotification({message:data.message||"New conversation created successfully",type:"success"})}else(0,_common_chat.addError)(data.message||"Failed to create new root")})).catch((error=>{console.error("Error creating new root:",error),(0,_common_chat.addError)("Error creating new root: "+error.message)}))}}));

//# sourceMappingURL=continuous.min.js.map
{"version":3,"file":"multi_model_continuous.min.js","sources":["../src/multi_model_continuous.js"],"sourcesContent":["// Multi-model continuous conversation logic for harpiasurvey chat.\nimport {\n    Templates,\n    Notification,\n    Config,\n    getString,\n    $,\n    addError,\n    conversationTrees\n} from './common_chat';\n\nlet initialized = false;\nlet handlersRegistered = false;\nlet treeHandlersRegistered = false;\nlet editLabel = 'Edit';\n\nconst lockQuestionItem = (questionItem) => {\n    questionItem.attr('data-response-locked', '1');\n    questionItem.removeAttr('data-response-editing');\n    questionItem.find('input, select, textarea').prop('disabled', true);\n};\n\nconst ensureEditButton = (questionItem) => {\n    let controls = questionItem.find('.question-edit-controls');\n    if (controls.length === 0) {\n        controls = $('<div class=\"mt-2 question-edit-controls\"></div>');\n        questionItem.append(controls);\n    }\n    let button = controls.find('.question-edit-btn');\n    if (button.length === 0) {\n        button = $('<button type=\"button\" class=\"btn btn-sm btn-outline-secondary question-edit-btn\"></button>');\n        controls.append(button);\n    }\n    button.text(editLabel);\n    button.show();\n};\n\nconst clearEvaluationQuestion = (questionItem) => {\n    questionItem.removeAttr('data-response-locked');\n    questionItem.removeAttr('data-response-editing');\n    questionItem.find('.saved-response-message').remove();\n    questionItem.find('.answer-history').remove();\n    questionItem.find('.question-edit-controls').remove();\n\n    const questionType = questionItem.data('questiontype');\n    if (questionType === 'singlechoice' || questionType === 'likert') {\n        questionItem.find('input[type=\"radio\"]').prop('checked', false);\n    } else if (questionType === 'multiplechoice') {\n        questionItem.find('input[type=\"checkbox\"]').prop('checked', false);\n    } else if (questionType === 'select') {\n        questionItem.find('select').prop('selectedIndex', 0);\n    } else if (questionType === 'number' || questionType === 'shorttext') {\n        questionItem.find('input[type=\"number\"], input[type=\"text\"]').val('');\n    } else if (questionType === 'longtext') {\n        questionItem.find('textarea').val('');\n    }\n    questionItem.find('input, select, textarea').prop('disabled', false);\n};\n\nconst loadConversationEvaluationResponsesForModel = (pageid, modelid, conversationId) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const cmid = parseInt(container.attr('data-cmid') || container.data('cmid'), 10);\n    if (!cmid) {\n        return;\n    }\n    const pane = $(`#model-pane-${modelid}-${pageid}`);\n    if (pane.length === 0) {\n        return;\n    }\n    const evaluationContainer = pane.find('.page-questions');\n    if (evaluationContainer.length === 0) {\n        return;\n    }\n\n    const questionItems = evaluationContainer.find('.question-item[data-questionid]');\n    questionItems.each(function() {\n        clearEvaluationQuestion($(this));\n    });\n\n    if (!conversationId) {\n        return;\n    }\n\n    const params = new URLSearchParams({\n        action: 'get_turn_responses',\n        cmid: cmid,\n        pageid: pageid,\n        turn_id: conversationId,\n        sesskey: Config.sesskey\n    });\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (!data.success || !data.responses) {\n            return;\n        }\n\n        Object.keys(data.responses).forEach((questionId) => {\n            const responseData = data.responses[questionId];\n            const questionItem = evaluationContainer.find(`.question-item[data-questionid=\"${questionId}\"]`);\n            if (questionItem.length === 0) {\n                return;\n            }\n\n            const questionType = questionItem.data('questiontype');\n            const value = responseData.response;\n\n            if (questionType === 'singlechoice' || questionType === 'likert') {\n                questionItem.find('input[type=\"radio\"]').prop('checked', false);\n                questionItem.find(`input[type=\"radio\"][value=\"${value}\"]`).prop('checked', true);\n            } else if (questionType === 'multiplechoice') {\n                questionItem.find('input[type=\"checkbox\"]').prop('checked', false);\n                try {\n                    const values = JSON.parse(value);\n                    if (Array.isArray(values)) {\n                        values.forEach((val) => {\n                            questionItem.find(`input[type=\"checkbox\"][value=\"${val}\"]`).prop('checked', true);\n                        });\n                    }\n                } catch (e) {\n                    // ignore invalid JSON\n                }\n            } else if (questionType === 'select') {\n                questionItem.find('select').val(value);\n            } else if (questionType === 'number') {\n                questionItem.find('input[type=\"number\"]').val(value);\n            } else if (questionType === 'shorttext') {\n                questionItem.find('input[type=\"text\"]').val(value);\n            } else if (questionType === 'longtext') {\n                questionItem.find('textarea').val(value);\n            }\n\n            if (responseData.saved_datetime) {\n                getString('saved', 'mod_harpiasurvey').then((savedText) => {\n                    getString('on', 'mod_harpiasurvey').then((onText) => {\n                        const icon = '<i class=\"fa fa-check-circle\" aria-hidden=\"true\"></i>';\n                        questionItem.append(\n                            '<div class=\"mt-2 small text-muted saved-response-message\">' +\n                            `${icon} ${savedText} ${onText} ${responseData.saved_datetime}</div>`\n                        );\n                    });\n                });\n            }\n\n            getString('answerhistory', 'mod_harpiasurvey').then((historyText) => {\n                if ((responseData.history_count || 0) > 1) {\n                    const details = $('<details class=\"answer-history mt-1\"></details>');\n                    details.append(`<summary>${historyText} (${responseData.history_count})</summary>`);\n                    const list = $('<ul class=\"list-unstyled mt-2 mb-0\"></ul>');\n                    (responseData.history_items || []).forEach((item) => {\n                        list.append(`<li class=\"mb-1\"><span class=\"text-muted\">${item.time}</span> â€” ${item.response}</li>`);\n                    });\n                    details.append(list);\n                    questionItem.append(details);\n                }\n            });\n\n            lockQuestionItem(questionItem);\n            ensureEditButton(questionItem);\n        });\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error loading multi-model continuous evaluation responses:', error);\n    });\n};\n\nexport const init = () => initialize();\n\n/**\n * Ensure one model tab is active (fallback for inconsistent initial markup/bootstrap state).\n *\n * @param {Object} container jQuery container\n */\nconst ensureFirstTabActive = (container) => {\n    if (container.find('.nav-link.active').length > 0 && container.find('.tab-pane.active').length > 0) {\n        return;\n    }\n\n    const firstTab = container.find('.nav-link[data-model-id]').first();\n    const firstPane = container.find('.tab-pane[data-model-id]').first();\n    if (firstTab.length === 0 || firstPane.length === 0) {\n        return;\n    }\n\n    container.find('.nav-link[data-model-id]').removeClass('active').attr('aria-selected', 'false');\n    container.find('.tab-pane[data-model-id]').removeClass('show active');\n    firstTab.addClass('active').attr('aria-selected', 'true');\n    firstPane.addClass('show active');\n};\n\n/**\n * Initialize multi-model continuous-mode chat containers.\n */\nconst initialize = () => {\n    if (initialized) {\n        return;\n    }\n    getString('edit', 'moodle').then((str) => {\n        editLabel = str;\n    }).catch(() => {\n        editLabel = 'Edit';\n    });\n    // Register handlers first, before initializing pages\n    registerHandlers();\n    registerTreeHandlers();\n    const containers = $('.multi-model-chat-container[data-behavior=\"continuous\"]');\n    if (containers.length === 0) {\n        initialized = true;\n        return;\n    }\n    containers.each(function() {\n        const pageid = parseInt($(this).data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n        initMultiModelPage(pageid);\n    });\n    initialized = true;\n};\n\n/**\n * Initialize a specific multi-model continuous chat page.\n *\n * @param {number} pageid Page ID\n */\nconst initMultiModelPage = (pageid) => {\n    // Initialize each model tab's conversation state\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    ensureFirstTabActive(container);\n    const tabPanes = container.find('.tab-pane[data-model-id]');\n\n    // Build a global parent map from ALL messages across ALL models\n    // This is needed to find the shared conversation root\n    const globalParentMap = new Map();\n    tabPanes.each(function() {\n        const modelId = parseInt($(this).data('model-id'), 10);\n        const messagesContainer = $(`#chat-messages-model-${modelId}-${pageid}`);\n        messagesContainer.find('.message').each(function() {\n            const msgId = parseInt($(this).data('messageid'), 10);\n            const parentId = parseInt($(this).data('parentid'), 10);\n            if (msgId && !isNaN(msgId)) {\n                globalParentMap.set(msgId, parentId && !isNaN(parentId) ? parentId : null);\n            }\n        });\n    });\n\n    // Find the shared conversation root by checking all messages\n    let sharedRootId = null;\n    tabPanes.each(function() {\n        const modelId = parseInt($(this).data('model-id'), 10);\n        const messagesContainer = $(`#chat-messages-model-${modelId}-${pageid}`);\n        const messages = messagesContainer.find('.message');\n        if (messages.length > 0) {\n            const lastMessage = messages.last();\n            const lastMessageId = parseInt(lastMessage.data('messageid'), 10);\n            if (lastMessageId && !isNaN(lastMessageId)) {\n                // Find root conversation by traversing parent chain using global map\n                let rootId = lastMessageId;\n                let currentId = lastMessageId;\n                let found = false;\n                \n                while (currentId && !found) {\n                    const parentId = globalParentMap.get(currentId);\n                    if (!parentId) {\n                        rootId = currentId;\n                        found = true;\n                    } else {\n                        currentId = parentId;\n                    }\n                }\n\n                if (found) {\n                    // Store model-specific conversation\n                    container.data(`viewing-conversation-${modelId}`, rootId);\n                    // Set shared conversation root only once (first discovered),\n                    // so initial selection is stable and does not jump to the newest conversation.\n                    if (!sharedRootId) {\n                        sharedRootId = rootId;\n                    }\n                }\n            }\n        }\n    });\n\n    // Set the shared conversation root for all models\n    if (sharedRootId) {\n        container.data('viewing-conversation', sharedRootId);\n        container.attr('data-viewing-conversation', sharedRootId);\n    }\n\n    // Scroll to bottom for active tab\n    const activeTab = container.find('.tab-pane.active');\n    if (activeTab.length > 0) {\n        const activeModelId = parseInt(activeTab.data('model-id'), 10);\n        setTimeout(() => {\n            scrollToBottomForModel(pageid, activeModelId);\n        }, 100);\n    }\n\n    // Initialize sidebar for conversation tree\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (sidebar.length > 0) {\n        sidebar.show();\n        loadConversationTreeForMultiModel(pageid).then(() => {\n            const selectedConversation = container.data('viewing-conversation') ||\n                parseInt(container.attr('data-viewing-conversation'), 10);\n            tabPanes.each(function() {\n                const modelId = parseInt($(this).data('model-id'), 10);\n                filterMessagesByConversationForModel(pageid, modelId, selectedConversation);\n                loadConversationEvaluationResponsesForModel(pageid, modelId, selectedConversation || null);\n            });\n        });\n    }\n};\n\n/**\n * Register event handlers for multi-model chat.\n */\nfunction registerHandlers() {\n    if (handlersRegistered) {\n        return;\n    }\n\n    // Handle send button clicks for multi-model tabs\n    $(document).on('click', '.multi-model-chat-container .chat-send-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const container = button.closest('.multi-model-chat-container');\n\n        // Get cmid and pageid from container (more reliable than button)\n        const cmid = parseInt(container.attr('data-cmid') || container.data('cmid'), 10);\n        const pageid = parseInt(container.attr('data-pageid') || container.data('pageid'), 10);\n        // Get modelid from button\n        const modelid = parseInt(button.attr('data-model-id') || button.data('modelId') || button.data('model-id'), 10);\n\n        if (!cmid || !pageid || !modelid) {\n            // eslint-disable-next-line no-console\n            console.error('Missing data attributes:', {\n                cmid: container.attr('data-cmid'),\n                pageid: container.attr('data-pageid'),\n                modelid: button.attr('data-model-id'),\n                containerHtml: container[0]?.outerHTML?.substring(0, 200),\n                buttonHtml: button[0]?.outerHTML?.substring(0, 200)\n            });\n            addError('Missing cmid, pageid, or model-id');\n            return;\n        }\n\n        // Try to find input by ID first\n        let input = $(`#chat-input-model-${modelid}-${pageid}`);\n        \n        // If not found, try to find by data attributes (fallback)\n        if (input.length === 0) {\n            input = container.find(`textarea.chat-input[data-model-id=\"${modelid}\"]`);\n        }\n\n        // If still not found, try to find in the active tab pane\n        if (input.length === 0) {\n            const activePane = container.find('.tab-pane.active');\n            input = activePane.find(`textarea.chat-input[data-model-id=\"${modelid}\"]`);\n        }\n        \n        if (input.length === 0) {\n            // eslint-disable-next-line no-console\n            console.error('Chat input not found:', {\n                modelid: modelid,\n                pageid: pageid,\n                expectedId: `chat-input-model-${modelid}-${pageid}`,\n                foundInputs: container.find('textarea.chat-input').map(function() {\n                    const $el = $(this);\n                    return {\n                        id: $el.attr('id'),\n                        modelId: $el.attr('data-model-id'),\n                        pageId: $el.attr('data-pageid')\n                    };\n                }).get(),\n                allTextareas: container.find('textarea').length\n            });\n            addError('Chat input not found for model ' + modelid);\n            return;\n        }\n\n        const inputValue = input.val();\n        if (!inputValue || !inputValue.trim()) {\n            return;\n        }\n\n        const message = inputValue.trim();\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n        input.val('');\n\n        const tempId = 'temp-user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n        displayUserMessage(pageid, modelid, message, tempId);\n\n        const loading = $(`#chat-loading-model-${modelid}-${pageid}`);\n        loading.show();\n\n        sendMessage(cmid, pageid, message, modelid, button, input, loading);\n    });\n\n    // Handle Enter key in textarea\n    $(document).on('keydown', '.multi-model-chat-container .chat-input', function(e) {\n        if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault();\n            const input = $(this);\n            const container = input.closest('.multi-model-chat-container');\n            const pageid = parseInt(container.attr('data-pageid') || container.data('pageid'), 10);\n            const modelid = parseInt(input.attr('data-model-id') || input.data('modelId') || input.data('model-id'), 10);\n            $(`#send-message-btn-model-${modelid}-${pageid}`).click();\n        }\n    });\n\n    // Handle tab switching to scroll to bottom\n    $(document).on('shown.bs.tab', '.multi-model-chat-container .nav-link[data-bs-toggle=\"tab\"]', function() {\n        const tab = $(this);\n        const targetId = tab.data('bs-target');\n        const pane = $(targetId);\n        const modelid = parseInt(pane.data('model-id'), 10);\n        const pageid = parseInt(tab.closest('.multi-model-chat-container').data('pageid'), 10);\n\n        if (modelid && pageid) {\n            setTimeout(() => {\n                scrollToBottomForModel(pageid, modelid);\n            }, 100);\n        }\n    });\n\n    handlersRegistered = true;\n}\n\nconst sendMessage = (cmid, pageid, message, modelid, button, input, loading) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    // Use shared conversation ID across all models, not model-specific\n    const viewingConversation = container.data('viewing-conversation');\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n\n    let parentid = null;\n    if (viewingConversation) {\n        // For multi-model conversations, we want to continue the same conversation\n        // Find the last message in this model's container that belongs to this conversation\n        const visibleMessages = messagesContainer.find('.message:visible');\n        if (visibleMessages.length > 0) {\n            const lastMessage = visibleMessages.last();\n            const lastMessageId = parseInt(lastMessage.data('messageid'), 10);\n            if (lastMessageId && !isNaN(lastMessageId)) {\n                parentid = lastMessageId;\n            }\n        } else {\n            // If no visible messages in this model for the selected conversation,\n            // anchor the new message to the selected conversation root.\n            parentid = parseInt(viewingConversation, 10);\n        }\n    } else {\n        // No conversation selected - do not chain to a previous message.\n        // Let backend create a fresh root conversation.\n        parentid = null;\n    }\n\n    const params = new URLSearchParams({\n        action: 'send_ai_message',\n        cmid: cmid,\n        pageid: pageid,\n        message: message,\n        modelid: modelid,\n        sesskey: Config.sesskey\n    });\n\n    if (parentid) {\n        params.append('parentid', parentid);\n    }\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then(response => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then(data => {\n        loading.hide();\n        if (data.success) {\n            if (data.root_conversation_id) {\n                container.data('viewing-conversation', data.root_conversation_id);\n                container.attr('data-viewing-conversation', data.root_conversation_id);\n                container.data(`viewing-conversation-${modelid}`, data.root_conversation_id);\n                container.find('.tab-pane[data-model-id]').each(function() {\n                    const targetModelId = parseInt($(this).data('model-id'), 10);\n                    loadConversationEvaluationResponsesForModel(pageid, targetModelId, data.root_conversation_id);\n                });\n            }\n            if (data.messageid && data.content) {\n                displayAIMessage(pageid, modelid, data.content, data.messageid, data.turn_id).then(() => {\n                    setTimeout(() => {\n                        scrollToBottomForModel(pageid, modelid);\n                    }, 100);\n                    input.prop('disabled', false);\n                    button.prop('disabled', false);\n                    input.focus();\n                });\n            } else {\n                addError('Received response but missing message ID or content');\n                input.prop('disabled', false);\n                button.prop('disabled', false);\n                input.focus();\n            }\n        } else {\n            addError(data.message || 'Error sending message');\n            input.prop('disabled', false);\n            button.prop('disabled', false);\n            input.focus();\n        }\n    })\n    .catch(error => {\n        loading.hide();\n        // eslint-disable-next-line no-console\n        console.error('Error sending message:', error);\n        addError('Error sending message: ' + error.message);\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    });\n};\n\nconst displayUserMessage = (pageid, modelid, message, messageid) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    messagesContainer.find('.text-center.text-muted').remove();\n    Templates.render('mod_harpiasurvey/chat_user_message', {\n        id: messageid,\n        content: message,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottomForModel(pageid, modelid);\n    }).catch(Notification.exception);\n};\n\nconst displayAIMessage = (pageid, modelid, content, messageid, turnId) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return Promise.resolve();\n    }\n    return Templates.render('mod_harpiasurvey/chat_ai_message', {\n        id: messageid,\n        content: content,\n        turn_id: turnId || null,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottomForModel(pageid, modelid);\n        return html;\n    }).catch(Notification.exception);\n};\n\nconst scrollToBottomForModel = (pageid, modelid) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length > 0) {\n        messagesContainer.scrollTop(messagesContainer[0].scrollHeight);\n    }\n};\n\n/**\n * Load conversation tree from server and render it for multi-model pages.\n * Similar to continuous.js but adapted for multi-model context.\n *\n * @param {number} pageid Page ID\n * @return {Promise} Promise that resolves when tree is loaded\n */\nconst loadConversationTreeForMultiModel = (pageid) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (treeContainer.length === 0) {\n        return Promise.resolve(null);\n    }\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const cmid = parseInt(container.attr('data-cmid') || container.data('cmid'), 10);\n    if (!cmid) {\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error: Course module ID not found. Please refresh the page.</div>');\n        return Promise.resolve(null);\n    }\n    const params = new URLSearchParams();\n    params.append('action', 'get_conversation_tree');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n    return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (data.success && data.tree) {\n            data.tree.roots = (data.tree.roots || []).map((root, idx) => ({\n                ...root,\n                conversation_number: idx + 1\n            }));\n            conversationTrees[pageid] = data.tree;\n            sidebar.data('sidebar-view', 'list');\n            renderConversationList(pageid, data.tree.roots);\n            return data.tree;\n        } else {\n            treeContainer.html('<div class=\"text-muted text-center small py-3\">' +\n                (data.message || 'No conversation tree available yet.') + '</div>');\n            return null;\n        }\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error loading conversation tree:', error);\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error loading conversation tree: ' + error.message + '<br>' +\n            'Please check the browser console for details and refresh the page.</div>');\n        return null;\n    });\n};\n\n/**\n * Render conversation list in sidebar.\n *\n * @param {number} pageid Page ID\n * @param {Array} roots Array of root conversations\n */\nconst renderConversationList = (pageid, roots) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    if (treeContainer.length === 0) {\n        return;\n    }\n    if (roots.length === 0) {\n        treeContainer.html('<div class=\"text-muted text-center small py-3\">' +\n            'No conversations yet. Click \"New conversation\" to start.</div>');\n        return;\n    }\n    \n    // Get the current viewing conversation\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const viewingConversation = container.data('viewing-conversation') || \n                                 parseInt(container.attr('data-viewing-conversation'), 10);\n    \n    let html = '<ul class=\"list-group list-group-flush\">';\n    roots.forEach((root) => {\n        const conversationNumber = root.conversation_number || '';\n        // Try multiple possible ID fields\n        const conversationId = root.id || root.conversation_id || root.turn_id;\n        const isActive = viewingConversation && parseInt(conversationId, 10) === parseInt(viewingConversation, 10);\n        const activeClass = isActive ? 'active bg-primary text-white' : '';\n        html += `<li class=\"list-group-item conversation-item ${activeClass}\" data-conversation-id=\"${conversationId}\" style=\"cursor: pointer;\">`;\n        html += `<div class=\"d-flex justify-content-between align-items-center\">`;\n        html += `<span class=\"font-weight-bold\">Conversation ${conversationNumber}</span>`;\n        html += `<small class=\"${isActive ? 'text-white-50' : 'text-muted'}\">${root.message_count || 0} messages</small>`;\n        html += `</div>`;\n        html += `</li>`;\n    });\n    html += '</ul>';\n    treeContainer.html(html);\n};\n\n/**\n * Register tree handlers for sidebar navigation.\n *\n * @return {void}\n */\nfunction registerTreeHandlers() {\n    if (treeHandlersRegistered) {\n        return;\n    }\n    $(document).on('click', '.conversation-item', function(e) {\n        e.preventDefault();\n        const item = $(this);\n        const conversationId = parseInt(item.data('conversation-id'), 10);\n        const sidebarId = item.closest('.conversation-tree-sidebar').attr('id');\n        const pageid = parseInt(sidebarId.replace('conversation-tree-sidebar-', ''), 10);\n        if (!pageid) {\n            return;\n        }\n        navigateToConversation(pageid, conversationId);\n    });\n\n    $(document).on('click', '.create-root-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            addError('Missing required data to create root');\n            return;\n        }\n        createNewRoot(cmid, pageid);\n    });\n    \n    // Handle export conversation button clicks.\n    $(document).on('click', '.export-conversation-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            addError('Missing required data to export conversation');\n            return;\n        }\n        \n        // Get current viewing conversation (shared across all models)\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        const conversationId = container.data('viewing-conversation') || \n                                parseInt(container.attr('data-viewing-conversation'), 10);\n        \n        // Build export URL\n        const params = new URLSearchParams();\n        params.append('action', 'export_conversation');\n        params.append('cmid', cmid);\n        params.append('pageid', pageid);\n        params.append('sesskey', Config.sesskey);\n        \n        if (conversationId) {\n            params.append('conversation_id', conversationId);\n        }\n        \n        // Open export URL in new window/tab to trigger download\n        window.open(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), '_blank');\n    });\n\n    treeHandlersRegistered = true;\n}\n\n/**\n * Navigate to a specific conversation.\n * For multi-model, we need to filter messages by conversation across all model tabs.\n *\n * @param {number} pageid Page ID\n * @param {number} conversationId Conversation ID (root message ID)\n */\nconst navigateToConversation = (pageid, conversationId) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    if (container.length === 0) {\n        // eslint-disable-next-line no-console\n        console.error('Container not found for pageid:', pageid);\n        return;\n    }\n    \n    // Store the viewing conversation ID\n    container.data('viewing-conversation', conversationId);\n    container.attr('data-viewing-conversation', conversationId);\n    \n    // Filter messages for each model tab\n    const tabPanes = container.find('.tab-pane[data-model-id]');\n    tabPanes.each(function() {\n        const modelId = parseInt($(this).data('model-id'), 10);\n        filterMessagesByConversationForModel(pageid, modelId, conversationId);\n        loadConversationEvaluationResponsesForModel(pageid, modelId, conversationId);\n    });\n    \n    // Reload tree to update active state highlighting\n    loadConversationTreeForMultiModel(pageid);\n};\n\n/**\n * Filter messages by conversation for a specific model.\n * Since messages are already in model-specific containers, we just filter by conversation.\n * For multi-model conversations, we need to find messages that belong to the same conversation root,\n * even if they're from different models (they should all share the same root conversation ID).\n *\n * @param {number} pageid Page ID\n * @param {number} modelId Model ID\n * @param {number} conversationId Conversation ID (root message ID)\n */\nconst filterMessagesByConversationForModel = (pageid, modelId, conversationId) => {\n    const messagesContainer = $(`#chat-messages-model-${modelId}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    \n    const conversationMessageIds = new Set();\n    conversationMessageIds.add(conversationId);\n    const messageParentMap = new Map();\n    \n    // Build parent map from ALL messages in ALL model containers to find the full conversation tree\n    // This is important for multi-model conversations where messages from different models\n    // might be linked through the same conversation root\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    container.find('.tab-pane[data-model-id]').each(function() {\n        const modelContainer = $(this);\n        const modelMessagesContainer = modelContainer.find('.chat-messages');\n        modelMessagesContainer.find('.message').each(function() {\n            const messageId = parseInt($(this).data('messageid'), 10);\n            const parentId = parseInt($(this).data('parentid'), 10);\n            if (messageId && !isNaN(messageId)) {\n                messageParentMap.set(messageId, parentId && !isNaN(parentId) ? parentId : null);\n            }\n        });\n    });\n    \n    // Find all messages in this conversation (traverse down from root across all models)\n    const toProcess = [conversationId];\n    while (toProcess.length > 0) {\n        const currentId = toProcess.shift();\n        messageParentMap.forEach((parentId, messageId) => {\n            if (parentId === currentId) {\n                conversationMessageIds.add(messageId);\n                toProcess.push(messageId);\n            }\n        });\n    }\n    \n    // Show/hide messages based on conversation membership\n    let hasVisibleMessages = false;\n    messagesContainer.find('.message').each(function() {\n        const messageId = parseInt($(this).data('messageid'), 10);\n        if (conversationMessageIds.has(messageId)) {\n            $(this).show();\n            hasVisibleMessages = true;\n        } else {\n            $(this).hide();\n        }\n    });\n    \n    // If no messages are visible, show the \"no messages yet\" placeholder\n    const placeholder = messagesContainer.find('.text-center.text-muted');\n    if (!hasVisibleMessages) {\n        if (placeholder.length === 0) {\n            // Add placeholder if it doesn't exist\n            messagesContainer.prepend('<div class=\"text-center text-muted py-4\"><p>' +\n                'No messages yet. Send a message to start the conversation.</p></div>');\n        } else {\n            placeholder.show();\n        }\n    } else {\n        placeholder.hide();\n    }\n    \n    // Scroll to bottom after filtering\n    setTimeout(() => {\n        scrollToBottomForModel(pageid, modelId);\n    }, 50);\n};\n\n/**\n * Create a new root conversation.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n */\nconst createNewRoot = (cmid, pageid) => {\n    const params = new URLSearchParams();\n    params.append('action', 'create_root');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n    \n    return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (data.success) {\n            // Reload the conversation tree\n            loadConversationTreeForMultiModel(pageid).then(() => {\n                // Navigate to the new conversation\n                if (data.root_id) {\n                    // Clear all message containers and show \"no messages\" placeholder\n                    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n                    const tabPanes = container.find('.tab-pane[data-model-id]');\n                    tabPanes.each(function() {\n                        const modelId = parseInt($(this).data('model-id'), 10);\n                        const messagesContainer = $(`#chat-messages-model-${modelId}-${pageid}`);\n                        // Hide all messages\n                        messagesContainer.find('.message').hide();\n                        // Show placeholder\n                        let placeholder = messagesContainer.find('.text-center.text-muted');\n                        if (placeholder.length === 0) {\n                            messagesContainer.prepend('<div class=\"text-center text-muted py-4\"><p>' +\n                                'No messages yet. Send a message to start the conversation.</p></div>');\n                        } else {\n                            placeholder.show();\n                        }\n                        loadConversationEvaluationResponsesForModel(pageid, modelId, data.root_id || null);\n                    });\n                    // Navigate to the new conversation\n                    navigateToConversation(pageid, data.root_id);\n                }\n            });\n        } else {\n            addError(data.message || 'Error creating new conversation');\n        }\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error creating new root:', error);\n        addError('Error creating new conversation: ' + error.message);\n    });\n};\n"],"names":["initialized","handlersRegistered","treeHandlersRegistered","editLabel","loadConversationEvaluationResponsesForModel","pageid","modelid","conversationId","container","cmid","parseInt","attr","data","pane","length","evaluationContainer","find","each","questionItem","removeAttr","remove","questionType","prop","val","clearEvaluationQuestion","this","params","URLSearchParams","action","turn_id","sesskey","Config","fetch","wwwroot","toString","method","headers","then","response","ok","Error","status","json","success","responses","Object","keys","forEach","questionId","responseData","value","values","JSON","parse","Array","isArray","e","saved_datetime","savedText","onText","append","historyText","history_count","details","list","history_items","item","time","lockQuestionItem","controls","button","text","show","ensureEditButton","catch","error","console","initialize","str","document","on","preventDefault","closest","containerHtml","_container$","outerHTML","_container$$outerHTML","substring","buttonHtml","_button$","_button$$outerHTML","input","expectedId","foundInputs","map","$el","id","modelId","pageId","get","allTextareas","inputValue","trim","message","tempId","Date","now","Math","random","substr","displayUserMessage","loading","sendMessage","key","shiftKey","click","tab","targetId","setTimeout","scrollToBottomForModel","registerHandlers","sidebarId","replace","navigateToConversation","createNewRoot","window","open","registerTreeHandlers","containers","initMultiModelPage","firstTab","first","firstPane","removeClass","addClass","ensureFirstTabActive","tabPanes","globalParentMap","Map","msgId","parentId","isNaN","set","sharedRootId","messages","lastMessage","last","lastMessageId","rootId","currentId","found","activeTab","activeModelId","sidebar","loadConversationTreeForMultiModel","selectedConversation","filterMessagesByConversationForModel","viewingConversation","messagesContainer","parentid","visibleMessages","hide","root_conversation_id","targetModelId","messageid","content","displayAIMessage","focus","render","timecreated","floor","html","Notification","exception","turnId","Promise","resolve","Templates","scrollTop","scrollHeight","treeContainer","body","tree","roots","root","idx","conversation_number","renderConversationList","conversationNumber","conversation_id","isActive","message_count","conversationMessageIds","Set","add","messageParentMap","messageId","toProcess","shift","push","hasVisibleMessages","has","placeholder","prepend","root_id"],"mappings":"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"}
{"version":3,"file":"multi_model_continuous.min.js","sources":["../src/multi_model_continuous.js"],"sourcesContent":["// Multi-model continuous conversation logic for harpiasurvey chat.\nimport {\n    Templates,\n    Notification,\n    Config,\n    $,\n    addError,\n    conversationTrees\n} from './common_chat';\n\nlet initialized = false;\nlet handlersRegistered = false;\nlet treeHandlersRegistered = false;\n\nexport const init = () => initialize();\n\n/**\n * Ensure one model tab is active (fallback for inconsistent initial markup/bootstrap state).\n *\n * @param {Object} container jQuery container\n */\nconst ensureFirstTabActive = (container) => {\n    if (container.find('.nav-link.active').length > 0 && container.find('.tab-pane.active').length > 0) {\n        return;\n    }\n\n    const firstTab = container.find('.nav-link[data-model-id]').first();\n    const firstPane = container.find('.tab-pane[data-model-id]').first();\n    if (firstTab.length === 0 || firstPane.length === 0) {\n        return;\n    }\n\n    container.find('.nav-link[data-model-id]').removeClass('active').attr('aria-selected', 'false');\n    container.find('.tab-pane[data-model-id]').removeClass('show active');\n    firstTab.addClass('active').attr('aria-selected', 'true');\n    firstPane.addClass('show active');\n};\n\n/**\n * Initialize multi-model continuous-mode chat containers.\n */\nconst initialize = () => {\n    if (initialized) {\n        return;\n    }\n    // Register handlers first, before initializing pages\n    registerHandlers();\n    registerTreeHandlers();\n    const containers = $('.multi-model-chat-container[data-behavior=\"continuous\"]');\n    if (containers.length === 0) {\n        initialized = true;\n        return;\n    }\n    containers.each(function() {\n        const pageid = parseInt($(this).data('pageid'), 10);\n        if (!pageid) {\n            return;\n        }\n        initMultiModelPage(pageid);\n    });\n    initialized = true;\n};\n\n/**\n * Initialize a specific multi-model continuous chat page.\n *\n * @param {number} pageid Page ID\n */\nconst initMultiModelPage = (pageid) => {\n    // Initialize each model tab's conversation state\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    ensureFirstTabActive(container);\n    const tabPanes = container.find('.tab-pane[data-model-id]');\n\n    // Build a global parent map from ALL messages across ALL models\n    // This is needed to find the shared conversation root\n    const globalParentMap = new Map();\n    tabPanes.each(function() {\n        const modelId = parseInt($(this).data('model-id'), 10);\n        const messagesContainer = $(`#chat-messages-model-${modelId}-${pageid}`);\n        messagesContainer.find('.message').each(function() {\n            const msgId = parseInt($(this).data('messageid'), 10);\n            const parentId = parseInt($(this).data('parentid'), 10);\n            if (msgId && !isNaN(msgId)) {\n                globalParentMap.set(msgId, parentId && !isNaN(parentId) ? parentId : null);\n            }\n        });\n    });\n\n    // Find the shared conversation root by checking all messages\n    let sharedRootId = null;\n    tabPanes.each(function() {\n        const modelId = parseInt($(this).data('model-id'), 10);\n        const messagesContainer = $(`#chat-messages-model-${modelId}-${pageid}`);\n        const messages = messagesContainer.find('.message');\n        if (messages.length > 0) {\n            const lastMessage = messages.last();\n            const lastMessageId = parseInt(lastMessage.data('messageid'), 10);\n            if (lastMessageId && !isNaN(lastMessageId)) {\n                // Find root conversation by traversing parent chain using global map\n                let rootId = lastMessageId;\n                let currentId = lastMessageId;\n                let found = false;\n                \n                while (currentId && !found) {\n                    const parentId = globalParentMap.get(currentId);\n                    if (!parentId) {\n                        rootId = currentId;\n                        found = true;\n                    } else {\n                        currentId = parentId;\n                    }\n                }\n\n                if (found) {\n                    // Store model-specific conversation\n                    container.data(`viewing-conversation-${modelId}`, rootId);\n                    // Set shared conversation root only once (first discovered),\n                    // so initial selection is stable and does not jump to the newest conversation.\n                    if (!sharedRootId) {\n                        sharedRootId = rootId;\n                    }\n                }\n            }\n        }\n    });\n\n    // Set the shared conversation root for all models\n    if (sharedRootId) {\n        container.data('viewing-conversation', sharedRootId);\n        container.attr('data-viewing-conversation', sharedRootId);\n    }\n\n    // Scroll to bottom for active tab\n    const activeTab = container.find('.tab-pane.active');\n    if (activeTab.length > 0) {\n        const activeModelId = parseInt(activeTab.data('model-id'), 10);\n        setTimeout(() => {\n            scrollToBottomForModel(pageid, activeModelId);\n        }, 100);\n    }\n\n    // Initialize sidebar for conversation tree\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (sidebar.length > 0) {\n        sidebar.show();\n        loadConversationTreeForMultiModel(pageid).then(() => {\n            const selectedConversation = container.data('viewing-conversation') ||\n                parseInt(container.attr('data-viewing-conversation'), 10);\n            if (selectedConversation) {\n                tabPanes.each(function() {\n                    const modelId = parseInt($(this).data('model-id'), 10);\n                    filterMessagesByConversationForModel(pageid, modelId, selectedConversation);\n                });\n            }\n        });\n    }\n};\n\n/**\n * Register event handlers for multi-model chat.\n */\nfunction registerHandlers() {\n    if (handlersRegistered) {\n        return;\n    }\n\n    // Handle send button clicks for multi-model tabs\n    $(document).on('click', '.multi-model-chat-container .chat-send-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const container = button.closest('.multi-model-chat-container');\n\n        // Get cmid and pageid from container (more reliable than button)\n        const cmid = parseInt(container.attr('data-cmid') || container.data('cmid'), 10);\n        const pageid = parseInt(container.attr('data-pageid') || container.data('pageid'), 10);\n        // Get modelid from button\n        const modelid = parseInt(button.attr('data-model-id') || button.data('modelId') || button.data('model-id'), 10);\n\n        if (!cmid || !pageid || !modelid) {\n            // eslint-disable-next-line no-console\n            console.error('Missing data attributes:', {\n                cmid: container.attr('data-cmid'),\n                pageid: container.attr('data-pageid'),\n                modelid: button.attr('data-model-id'),\n                containerHtml: container[0]?.outerHTML?.substring(0, 200),\n                buttonHtml: button[0]?.outerHTML?.substring(0, 200)\n            });\n            addError('Missing cmid, pageid, or model-id');\n            return;\n        }\n\n        // Try to find input by ID first\n        let input = $(`#chat-input-model-${modelid}-${pageid}`);\n        \n        // If not found, try to find by data attributes (fallback)\n        if (input.length === 0) {\n            input = container.find(`textarea.chat-input[data-model-id=\"${modelid}\"]`);\n        }\n\n        // If still not found, try to find in the active tab pane\n        if (input.length === 0) {\n            const activePane = container.find('.tab-pane.active');\n            input = activePane.find(`textarea.chat-input[data-model-id=\"${modelid}\"]`);\n        }\n        \n        if (input.length === 0) {\n            // eslint-disable-next-line no-console\n            console.error('Chat input not found:', {\n                modelid: modelid,\n                pageid: pageid,\n                expectedId: `chat-input-model-${modelid}-${pageid}`,\n                foundInputs: container.find('textarea.chat-input').map(function() {\n                    const $el = $(this);\n                    return {\n                        id: $el.attr('id'),\n                        modelId: $el.attr('data-model-id'),\n                        pageId: $el.attr('data-pageid')\n                    };\n                }).get(),\n                allTextareas: container.find('textarea').length\n            });\n            addError('Chat input not found for model ' + modelid);\n            return;\n        }\n\n        const inputValue = input.val();\n        if (!inputValue || !inputValue.trim()) {\n            return;\n        }\n\n        const message = inputValue.trim();\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n        input.val('');\n\n        const tempId = 'temp-user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n        displayUserMessage(pageid, modelid, message, tempId);\n\n        const loading = $(`#chat-loading-model-${modelid}-${pageid}`);\n        loading.show();\n\n        sendMessage(cmid, pageid, message, modelid, button, input, loading);\n    });\n\n    // Handle Enter key in textarea\n    $(document).on('keydown', '.multi-model-chat-container .chat-input', function(e) {\n        if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault();\n            const input = $(this);\n            const container = input.closest('.multi-model-chat-container');\n            const pageid = parseInt(container.attr('data-pageid') || container.data('pageid'), 10);\n            const modelid = parseInt(input.attr('data-model-id') || input.data('modelId') || input.data('model-id'), 10);\n            $(`#send-message-btn-model-${modelid}-${pageid}`).click();\n        }\n    });\n\n    // Handle tab switching to scroll to bottom\n    $(document).on('shown.bs.tab', '.multi-model-chat-container .nav-link[data-bs-toggle=\"tab\"]', function() {\n        const tab = $(this);\n        const targetId = tab.data('bs-target');\n        const pane = $(targetId);\n        const modelid = parseInt(pane.data('model-id'), 10);\n        const pageid = parseInt(tab.closest('.multi-model-chat-container').data('pageid'), 10);\n\n        if (modelid && pageid) {\n            setTimeout(() => {\n                scrollToBottomForModel(pageid, modelid);\n            }, 100);\n        }\n    });\n\n    handlersRegistered = true;\n}\n\nconst sendMessage = (cmid, pageid, message, modelid, button, input, loading) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    // Use shared conversation ID across all models, not model-specific\n    const viewingConversation = container.data('viewing-conversation');\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n\n    let parentid = null;\n    if (viewingConversation) {\n        // For multi-model conversations, we want to continue the same conversation\n        // Find the last message in this model's container that belongs to this conversation\n        const visibleMessages = messagesContainer.find('.message:visible');\n        if (visibleMessages.length > 0) {\n            const lastMessage = visibleMessages.last();\n            const lastMessageId = parseInt(lastMessage.data('messageid'), 10);\n            if (lastMessageId && !isNaN(lastMessageId)) {\n                parentid = lastMessageId;\n            }\n        } else {\n            // If no visible messages in this model for the selected conversation,\n            // anchor the new message to the selected conversation root.\n            parentid = parseInt(viewingConversation, 10);\n        }\n    } else {\n        // No conversation selected - do not chain to a previous message.\n        // Let backend create a fresh root conversation.\n        parentid = null;\n    }\n\n    const params = new URLSearchParams({\n        action: 'send_ai_message',\n        cmid: cmid,\n        pageid: pageid,\n        message: message,\n        modelid: modelid,\n        sesskey: Config.sesskey\n    });\n\n    if (parentid) {\n        params.append('parentid', parentid);\n    }\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then(response => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then(data => {\n        loading.hide();\n        if (data.success) {\n            if (data.root_conversation_id) {\n                container.data('viewing-conversation', data.root_conversation_id);\n                container.attr('data-viewing-conversation', data.root_conversation_id);\n                container.data(`viewing-conversation-${modelid}`, data.root_conversation_id);\n            }\n            if (data.messageid && data.content) {\n                displayAIMessage(pageid, modelid, data.content, data.messageid, data.turn_id).then(() => {\n                    setTimeout(() => {\n                        scrollToBottomForModel(pageid, modelid);\n                    }, 100);\n                    input.prop('disabled', false);\n                    button.prop('disabled', false);\n                    input.focus();\n                });\n            } else {\n                addError('Received response but missing message ID or content');\n                input.prop('disabled', false);\n                button.prop('disabled', false);\n                input.focus();\n            }\n        } else {\n            addError(data.message || 'Error sending message');\n            input.prop('disabled', false);\n            button.prop('disabled', false);\n            input.focus();\n        }\n    })\n    .catch(error => {\n        loading.hide();\n        // eslint-disable-next-line no-console\n        console.error('Error sending message:', error);\n        addError('Error sending message: ' + error.message);\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    });\n};\n\nconst displayUserMessage = (pageid, modelid, message, messageid) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    messagesContainer.find('.text-center.text-muted').remove();\n    Templates.render('mod_harpiasurvey/chat_user_message', {\n        id: messageid,\n        content: message,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottomForModel(pageid, modelid);\n    }).catch(Notification.exception);\n};\n\nconst displayAIMessage = (pageid, modelid, content, messageid, turnId) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return Promise.resolve();\n    }\n    return Templates.render('mod_harpiasurvey/chat_ai_message', {\n        id: messageid,\n        content: content,\n        turn_id: turnId || null,\n        timecreated: Math.floor(Date.now() / 1000)\n    }).then((html) => {\n        messagesContainer.append(html);\n        scrollToBottomForModel(pageid, modelid);\n        return html;\n    }).catch(Notification.exception);\n};\n\nconst scrollToBottomForModel = (pageid, modelid) => {\n    const messagesContainer = $(`#chat-messages-model-${modelid}-${pageid}`);\n    if (messagesContainer.length > 0) {\n        messagesContainer.scrollTop(messagesContainer[0].scrollHeight);\n    }\n};\n\n/**\n * Load conversation tree from server and render it for multi-model pages.\n * Similar to continuous.js but adapted for multi-model context.\n *\n * @param {number} pageid Page ID\n * @return {Promise} Promise that resolves when tree is loaded\n */\nconst loadConversationTreeForMultiModel = (pageid) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    const sidebar = $(`#conversation-tree-sidebar-${pageid}`);\n    if (treeContainer.length === 0) {\n        return Promise.resolve(null);\n    }\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const cmid = parseInt(container.attr('data-cmid') || container.data('cmid'), 10);\n    if (!cmid) {\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error: Course module ID not found. Please refresh the page.</div>');\n        return Promise.resolve(null);\n    }\n    const params = new URLSearchParams();\n    params.append('action', 'get_conversation_tree');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n    return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (data.success && data.tree) {\n            data.tree.roots = (data.tree.roots || []).map((root, idx) => ({\n                ...root,\n                conversation_number: idx + 1\n            }));\n            conversationTrees[pageid] = data.tree;\n            sidebar.data('sidebar-view', 'list');\n            renderConversationList(pageid, data.tree.roots);\n            return data.tree;\n        } else {\n            treeContainer.html('<div class=\"text-muted text-center small py-3\">' +\n                (data.message || 'No conversation tree available yet.') + '</div>');\n            return null;\n        }\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error loading conversation tree:', error);\n        treeContainer.html('<div class=\"text-danger text-center small py-3\">' +\n            'Error loading conversation tree: ' + error.message + '<br>' +\n            'Please check the browser console for details and refresh the page.</div>');\n        return null;\n    });\n};\n\n/**\n * Render conversation list in sidebar.\n *\n * @param {number} pageid Page ID\n * @param {Array} roots Array of root conversations\n */\nconst renderConversationList = (pageid, roots) => {\n    const treeContainer = $(`#conversation-tree-${pageid}`);\n    if (treeContainer.length === 0) {\n        return;\n    }\n    if (roots.length === 0) {\n        treeContainer.html('<div class=\"text-muted text-center small py-3\">' +\n            'No conversations yet. Click \"New conversation\" to start.</div>');\n        return;\n    }\n    \n    // Get the current viewing conversation\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    const viewingConversation = container.data('viewing-conversation') || \n                                 parseInt(container.attr('data-viewing-conversation'), 10);\n    \n    let html = '<ul class=\"list-group list-group-flush\">';\n    roots.forEach((root) => {\n        const conversationNumber = root.conversation_number || '';\n        // Try multiple possible ID fields\n        const conversationId = root.id || root.conversation_id || root.turn_id;\n        const isActive = viewingConversation && parseInt(conversationId, 10) === parseInt(viewingConversation, 10);\n        const activeClass = isActive ? 'active bg-primary text-white' : '';\n        html += `<li class=\"list-group-item conversation-item ${activeClass}\" data-conversation-id=\"${conversationId}\" style=\"cursor: pointer;\">`;\n        html += `<div class=\"d-flex justify-content-between align-items-center\">`;\n        html += `<span class=\"font-weight-bold\">Conversation ${conversationNumber}</span>`;\n        html += `<small class=\"${isActive ? 'text-white-50' : 'text-muted'}\">${root.message_count || 0} messages</small>`;\n        html += `</div>`;\n        html += `</li>`;\n    });\n    html += '</ul>';\n    treeContainer.html(html);\n};\n\n/**\n * Register tree handlers for sidebar navigation.\n *\n * @return {void}\n */\nfunction registerTreeHandlers() {\n    if (treeHandlersRegistered) {\n        return;\n    }\n    $(document).on('click', '.conversation-item', function(e) {\n        e.preventDefault();\n        const item = $(this);\n        const conversationId = parseInt(item.data('conversation-id'), 10);\n        const sidebarId = item.closest('.conversation-tree-sidebar').attr('id');\n        const pageid = parseInt(sidebarId.replace('conversation-tree-sidebar-', ''), 10);\n        if (!pageid) {\n            return;\n        }\n        navigateToConversation(pageid, conversationId);\n    });\n\n    $(document).on('click', '.create-root-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            addError('Missing required data to create root');\n            return;\n        }\n        createNewRoot(cmid, pageid);\n    });\n    \n    // Handle export conversation button clicks.\n    $(document).on('click', '.export-conversation-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const pageid = parseInt(button.data('pageid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        if (!pageid || !cmid) {\n            addError('Missing required data to export conversation');\n            return;\n        }\n        \n        // Get current viewing conversation (shared across all models)\n        const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n        const conversationId = container.data('viewing-conversation') || \n                                parseInt(container.attr('data-viewing-conversation'), 10);\n        \n        // Build export URL\n        const params = new URLSearchParams();\n        params.append('action', 'export_conversation');\n        params.append('cmid', cmid);\n        params.append('pageid', pageid);\n        params.append('sesskey', Config.sesskey);\n        \n        if (conversationId) {\n            params.append('conversation_id', conversationId);\n        }\n        \n        // Open export URL in new window/tab to trigger download\n        window.open(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), '_blank');\n    });\n\n    treeHandlersRegistered = true;\n}\n\n/**\n * Navigate to a specific conversation.\n * For multi-model, we need to filter messages by conversation across all model tabs.\n *\n * @param {number} pageid Page ID\n * @param {number} conversationId Conversation ID (root message ID)\n */\nconst navigateToConversation = (pageid, conversationId) => {\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    if (container.length === 0) {\n        // eslint-disable-next-line no-console\n        console.error('Container not found for pageid:', pageid);\n        return;\n    }\n    \n    // Store the viewing conversation ID\n    container.data('viewing-conversation', conversationId);\n    container.attr('data-viewing-conversation', conversationId);\n    \n    // Filter messages for each model tab\n    const tabPanes = container.find('.tab-pane[data-model-id]');\n    tabPanes.each(function() {\n        const modelId = parseInt($(this).data('model-id'), 10);\n        filterMessagesByConversationForModel(pageid, modelId, conversationId);\n    });\n    \n    // Reload tree to update active state highlighting\n    loadConversationTreeForMultiModel(pageid);\n};\n\n/**\n * Filter messages by conversation for a specific model.\n * Since messages are already in model-specific containers, we just filter by conversation.\n * For multi-model conversations, we need to find messages that belong to the same conversation root,\n * even if they're from different models (they should all share the same root conversation ID).\n *\n * @param {number} pageid Page ID\n * @param {number} modelId Model ID\n * @param {number} conversationId Conversation ID (root message ID)\n */\nconst filterMessagesByConversationForModel = (pageid, modelId, conversationId) => {\n    const messagesContainer = $(`#chat-messages-model-${modelId}-${pageid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n    \n    const conversationMessageIds = new Set();\n    conversationMessageIds.add(conversationId);\n    const messageParentMap = new Map();\n    \n    // Build parent map from ALL messages in ALL model containers to find the full conversation tree\n    // This is important for multi-model conversations where messages from different models\n    // might be linked through the same conversation root\n    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n    container.find('.tab-pane[data-model-id]').each(function() {\n        const modelContainer = $(this);\n        const modelMessagesContainer = modelContainer.find('.chat-messages');\n        modelMessagesContainer.find('.message').each(function() {\n            const messageId = parseInt($(this).data('messageid'), 10);\n            const parentId = parseInt($(this).data('parentid'), 10);\n            if (messageId && !isNaN(messageId)) {\n                messageParentMap.set(messageId, parentId && !isNaN(parentId) ? parentId : null);\n            }\n        });\n    });\n    \n    // Find all messages in this conversation (traverse down from root across all models)\n    const toProcess = [conversationId];\n    while (toProcess.length > 0) {\n        const currentId = toProcess.shift();\n        messageParentMap.forEach((parentId, messageId) => {\n            if (parentId === currentId) {\n                conversationMessageIds.add(messageId);\n                toProcess.push(messageId);\n            }\n        });\n    }\n    \n    // Show/hide messages based on conversation membership\n    let hasVisibleMessages = false;\n    messagesContainer.find('.message').each(function() {\n        const messageId = parseInt($(this).data('messageid'), 10);\n        if (conversationMessageIds.has(messageId)) {\n            $(this).show();\n            hasVisibleMessages = true;\n        } else {\n            $(this).hide();\n        }\n    });\n    \n    // If no messages are visible, show the \"no messages yet\" placeholder\n    const placeholder = messagesContainer.find('.text-center.text-muted');\n    if (!hasVisibleMessages) {\n        if (placeholder.length === 0) {\n            // Add placeholder if it doesn't exist\n            messagesContainer.prepend('<div class=\"text-center text-muted py-4\"><p>' +\n                'No messages yet. Send a message to start the conversation.</p></div>');\n        } else {\n            placeholder.show();\n        }\n    } else {\n        placeholder.hide();\n    }\n    \n    // Scroll to bottom after filtering\n    setTimeout(() => {\n        scrollToBottomForModel(pageid, modelId);\n    }, 50);\n};\n\n/**\n * Create a new root conversation.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n */\nconst createNewRoot = (cmid, pageid) => {\n    const params = new URLSearchParams();\n    params.append('action', 'create_root');\n    params.append('cmid', cmid);\n    params.append('pageid', pageid);\n    params.append('sesskey', Config.sesskey);\n    \n    return fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: params.toString()\n    })\n    .then((response) => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then((data) => {\n        if (data.success) {\n            // Reload the conversation tree\n            loadConversationTreeForMultiModel(pageid).then(() => {\n                // Navigate to the new conversation\n                if (data.root_id) {\n                    // Clear all message containers and show \"no messages\" placeholder\n                    const container = $(`.multi-model-chat-container[data-pageid=\"${pageid}\"]`);\n                    const tabPanes = container.find('.tab-pane[data-model-id]');\n                    tabPanes.each(function() {\n                        const modelId = parseInt($(this).data('model-id'), 10);\n                        const messagesContainer = $(`#chat-messages-model-${modelId}-${pageid}`);\n                        // Hide all messages\n                        messagesContainer.find('.message').hide();\n                        // Show placeholder\n                        let placeholder = messagesContainer.find('.text-center.text-muted');\n                        if (placeholder.length === 0) {\n                            messagesContainer.prepend('<div class=\"text-center text-muted py-4\"><p>' +\n                                'No messages yet. Send a message to start the conversation.</p></div>');\n                        } else {\n                            placeholder.show();\n                        }\n                    });\n                    // Navigate to the new conversation\n                    navigateToConversation(pageid, data.root_id);\n                }\n            });\n        } else {\n            addError(data.message || 'Error creating new conversation');\n        }\n    })\n    .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error('Error creating new root:', error);\n        addError('Error creating new conversation: ' + error.message);\n    });\n};\n"],"names":["initialized","handlersRegistered","treeHandlersRegistered","initialize","document","on","e","preventDefault","button","this","container","closest","cmid","parseInt","attr","data","pageid","modelid","console","error","containerHtml","_container$","outerHTML","_container$$outerHTML","substring","buttonHtml","_button$","_button$$outerHTML","input","length","find","expectedId","foundInputs","map","$el","id","modelId","pageId","get","allTextareas","inputValue","val","trim","message","prop","tempId","Date","now","Math","random","toString","substr","displayUserMessage","loading","show","sendMessage","key","shiftKey","click","tab","targetId","pane","setTimeout","scrollToBottomForModel","registerHandlers","item","conversationId","sidebarId","replace","navigateToConversation","createNewRoot","params","URLSearchParams","append","Config","sesskey","window","open","wwwroot","registerTreeHandlers","containers","each","initMultiModelPage","firstTab","first","firstPane","removeClass","addClass","ensureFirstTabActive","tabPanes","globalParentMap","Map","msgId","parentId","isNaN","set","sharedRootId","messages","lastMessage","last","lastMessageId","rootId","currentId","found","activeTab","activeModelId","sidebar","loadConversationTreeForMultiModel","then","selectedConversation","filterMessagesByConversationForModel","viewingConversation","messagesContainer","parentid","visibleMessages","action","fetch","method","headers","response","ok","Error","status","json","hide","success","root_conversation_id","messageid","content","displayAIMessage","turn_id","focus","catch","remove","render","timecreated","floor","html","Notification","exception","turnId","Promise","resolve","Templates","scrollTop","scrollHeight","treeContainer","body","tree","roots","root","idx","conversation_number","renderConversationList","forEach","conversationNumber","conversation_id","isActive","message_count","conversationMessageIds","Set","add","messageParentMap","messageId","toProcess","shift","push","hasVisibleMessages","has","placeholder","prepend","root_id"],"mappings":"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"}
define("mod_harpiasurvey/notification_modal",["exports","core/str","core/notification","jquery"],(function(_exports,_str,_notification,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_notification=_interopRequireDefault(_notification),_jquery=_interopRequireDefault(_jquery);const MODAL_ID="harpiasurvey-notification-modal";let cachedStrings=null,observerStarted=!1,notificationPatched=!1,modalInitialized=!1;const getStrings=()=>cachedStrings?Promise.resolve(cachedStrings):Promise.all([(0,_str.get_string)("notifications","mod_harpiasurvey").catch((()=>"Notifications")),(0,_str.get_string)("notificationclose","mod_harpiasurvey").catch((()=>"Close")),(0,_str.get_string)("notificationsuccess","mod_harpiasurvey").catch((()=>"Success")),(0,_str.get_string)("notificationerror","mod_harpiasurvey").catch((()=>"Error")),(0,_str.get_string)("notificationwarning","mod_harpiasurvey").catch((()=>"Warning")),(0,_str.get_string)("notificationinfo","mod_harpiasurvey").catch((()=>"Info"))]).then((strings=>(cachedStrings={title:strings[0],closeLabel:strings[1],labels:{success:strings[2],danger:strings[3],warning:strings[4],info:strings[5]}},cachedStrings))),buildModal=(title,closeLabel,items)=>{const bodyItems=items.map((item=>{const badgeClass="danger"===item.type?"danger":"success"===item.type?"success":"warning"===item.type?"warning":"info";return`\n            <div class="alert alert-${item.type} mb-2" role="alert">\n                <span class="badge badge-${badgeClass} d-inline-block mb-1">${item.label}</span>\n                <div>${item.html}</div>\n            </div>\n        `})).join("");return`\n        <div class="modal fade" id="${MODAL_ID}" tabindex="-1" aria-hidden="true">\n            <div class="modal-dialog modal-dialog-centered">\n                <div class="modal-content">\n                    <div class="modal-header">\n                        <h5 class="modal-title">${title}</h5>\n                        <button type="button" class="close ml-auto ms-auto" data-dismiss="modal" data-bs-dismiss="modal" aria-label="${closeLabel}">\n                            <span aria-hidden="true">&times;</span>\n                        </button>\n                    </div>\n                    <div class="modal-body">\n                        ${bodyItems}\n                    </div>\n                    <div class="modal-footer">\n                        <button type="button" class="btn btn-primary" data-dismiss="modal" data-bs-dismiss="modal">${closeLabel}</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `},collectAlerts=root=>root.find(".alert").filter((function(){const el=(0,_jquery.default)(this);return el.text().trim().length>0&&!el.attr("data-harpia-notification-handled")})),showItemsInModal=items=>{items&&items.length&&getStrings().then((strings=>{const normalized=items.map((item=>{const type=item.type||"info";return{type:type,label:strings.labels[type]||strings.labels.info,html:item.html||""}})).filter((item=>""!==item.html.trim()));if(!normalized.length)return;const existing=(0,_jquery.default)(`#${MODAL_ID}`);0===existing.length?((0,_jquery.default)("body").append(buildModal(strings.title,strings.closeLabel,normalized)),modalInitialized=!0):modalInitialized?(existing.find(".modal-title").text(strings.title),existing.find(".modal-body").html(normalized.map((item=>{const badgeClass="danger"===item.type?"danger":"success"===item.type?"success":"warning"===item.type?"warning":"info";return`\n                    <div class="alert alert-${item.type} mb-2" role="alert">\n                        <span class="badge badge-${badgeClass} d-inline-block mb-1">${item.label}</span>\n                        <div>${item.html}</div>\n                    </div>\n                `})).join(""))):(existing.replaceWith(buildModal(strings.title,strings.closeLabel,normalized)),modalInitialized=!0);const root=(0,_jquery.default)("#user-notifications");root.length&&root.hide();(modalElement=>{modalElement&&(window.bootstrap&&window.bootstrap.Modal?window.bootstrap.Modal.getOrCreateInstance(modalElement).show():void 0!==_jquery.default&&_jquery.default.fn&&"function"==typeof _jquery.default.fn.modal&&(0,_jquery.default)(modalElement).modal("show"))})(document.getElementById(MODAL_ID))}))},showAlertsInModal=root=>{const notices=collectAlerts(root);notices.length&&getStrings().then((strings=>{const items=[];notices.each((function(){const el=(0,_jquery.default)(this),type=(node=>{const el=(0,_jquery.default)(node);return el.hasClass("alert-danger")||el.hasClass("alert-error")?"danger":el.hasClass("alert-success")?"success":el.hasClass("alert-warning")?"warning":"info"})(this);items.push({type:type,label:strings.labels[type]||strings.labels.info,html:el.html()}),el.attr("data-harpia-notification-handled","1"),el.remove()})),items.length&&showItemsInModal(items)}))};_exports.init=()=>{(()=>{if(notificationPatched||!_notification.default||"function"!=typeof _notification.default.addNotification)return;const originalAddNotification=_notification.default.addNotification.bind(_notification.default);_notification.default.addNotification=function(){let data=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const message=data.message,html=Array.isArray(message)?message.join("<br>"):String(message||"");return html.trim()?(showItemsInModal([{type:data.type||"info",html:html}]),Promise.resolve()):originalAddNotification(data)},notificationPatched=!0})();const root=(0,_jquery.default)("#user-notifications");root.length&&(showAlertsInModal(root),(root=>{if(observerStarted)return;observerStarted=!0;const observer=new MutationObserver((()=>{showAlertsInModal(root)}));root.length&&root[0]&&observer.observe(root[0],{childList:!0,subtree:!0})})(root))}}));

//# sourceMappingURL=notification_modal.min.js.map
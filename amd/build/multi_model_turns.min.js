define("mod_harpiasurvey/multi_model_turns",["exports","./common_chat","./fancytree_loader"],(function(_exports,_common_chat,_fancytree_loader){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;let initialized=!1,handlersRegistered=!1,treeHandlersRegistered=!1,turnHandlersRegistered=!1;const fancytreeInstances={},modelTurns={};_exports.init=()=>initialize();const initialize=()=>{if(initialized)return;!function(){if(handlersRegistered)return;(0,_common_chat.$)(document).on("click",'.multi-model-chat-container[data-behavior="turns"] .chat-send-btn',(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),cmid=parseInt(button.data("cmid"),10),pageid=parseInt(button.data("pageid"),10),modelid=parseInt(button.data("model-id"),10),container=button.closest(".multi-model-chat-container");if("turns"!==container.data("behavior"))return;if(!cmid||!pageid||!modelid)return void(0,_common_chat.addError)("Missing cmid, pageid, or model-id");const input=(0,_common_chat.$)(`#chat-input-model-${modelid}-${pageid}`);if(0===input.length)return void(0,_common_chat.addError)("Chat input not found");const inputValue=input.val();if(!inputValue||!inputValue.trim())return;const message=inputValue.trim(),viewingTurn=getViewingTurnForModel(pageid,modelid),currentTurn=getCurrentTurnForModel(pageid,modelid),viewingTurnNum=parseInt(viewingTurn,10);if(viewingTurnNum<parseInt(currentTurn,10))return void(0,_common_chat.getString)("chatlocked","mod_harpiasurvey").then((str=>{_common_chat.Notification.addNotification({message:str+" Navigate to the current turn first.",type:"error"})}));const maxTurns=container.data("max-turns");if(null!=maxTurns){const maxTurnsNum=parseInt(maxTurns,10),turnCount=getTurnCountForConversationForModel(pageid,modelid,viewingTurnNum);if(null!==turnCount&&turnCount>=maxTurnsNum&&isTurnCompleteForModel(pageid,modelid,viewingTurnNum))return void(0,_common_chat.getString)("maxturnsreached","mod_harpiasurvey").then((str=>{_common_chat.Notification.addNotification({message:str,type:"error"})}))}input.prop("disabled",!0),button.prop("disabled",!0),input.val("");const tempId="temp-user-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);displayUserMessageForModel(pageid,modelid,message,tempId);const loading=(0,_common_chat.$)(`#chat-loading-model-${modelid}-${pageid}`);loading.show(),sendMessageForModel(cmid,pageid,message,modelid,button,input,loading)})),(0,_common_chat.$)(document).on("keydown",'.multi-model-chat-container[data-behavior="turns"] .chat-input',(function(e){if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const input=(0,_common_chat.$)(this),modelid=parseInt(input.data("model-id"),10),pageid=parseInt(input.data("pageid"),10);(0,_common_chat.$)(`#send-message-btn-model-${modelid}-${pageid}`).click()}})),handlersRegistered=!0}(),function(){if(treeHandlersRegistered)return;(0,_common_chat.$)(document).on("click",'.multi-model-chat-container[data-behavior="turns"] ~ .conversation-tree-sidebar .conversation-item, .conversation-tree-sidebar .conversation-item',(function(e){e.preventDefault();const item=(0,_common_chat.$)(this);let rootTurnId=parseInt(item.data("root-turn-id"),10);rootTurnId&&!isNaN(rootTurnId)||(rootTurnId=parseInt(item.data("conversation-id"),10)),rootTurnId&&!isNaN(rootTurnId)||(rootTurnId=parseInt(item.data("turn-id"),10));const sidebar=item.closest(".conversation-tree-sidebar"),pageid=parseInt(sidebar.attr("id").replace("conversation-tree-sidebar-",""),10),container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`);if(!pageid||0===container.length)return;const activeTab=container.find(".tab-pane.active"),activeModelId=parseInt(activeTab.data("model-id"),10);if(activeModelId)rootTurnId&&(sidebar.data("sidebar-view","detail"),navigateToTurnForModel(pageid,activeModelId,rootTurnId));else{const firstTab=container.find(".tab-pane[data-model-id]").first(),firstModelId=parseInt(firstTab.data("model-id"),10);firstModelId&&rootTurnId&&(sidebar.data("sidebar-view","detail"),navigateToTurnForModel(pageid,firstModelId,rootTurnId))}})),(0,_common_chat.$)(document).on("click",".back-to-list-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10);if(!pageid)return;(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`).data("sidebar-view","list");const tree=_common_chat.conversationTrees[pageid];tree?(0,_common_chat.renderConversationList)(pageid,tree.roots):loadConversationTree(pageid).then((()=>{const tree=_common_chat.conversationTrees[pageid];tree&&(0,_common_chat.renderConversationList)(pageid,tree.roots)}))})),(0,_common_chat.$)(document).on("click",".create-branch-from-tree-btn, .ft-branch-btn",(function(e){e.preventDefault(),e.stopPropagation();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid")||button.closest("[data-pageid]").data("pageid"),10),cmid=parseInt(button.data("cmid")||button.closest("[data-cmid]").data("cmid"),10),turnId=parseInt(button.data("turn-id")||button.closest("[data-turn-id]").data("turn-id"),10);pageid&&cmid&&turnId?createBranchFromTurnForModel(cmid,pageid,turnId,button):(0,_common_chat.addError)("Missing required data to create branch")})),(0,_common_chat.$)(document).on("click",".create-direct-branch-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);let parentTurnId=parseInt(button.data("root-turn-id"),10);if(!parentTurnId||isNaN(parentTurnId)){const activeTab=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`).find(".tab-pane.active"),activeModelId=parseInt(activeTab.data("model-id"),10);parentTurnId=getViewingTurnForModel(pageid,activeModelId)}pageid&&cmid&&parentTurnId?createBranchFromTurnForModel(cmid,pageid,parentTurnId,button):(0,_common_chat.addError)("Missing required data to create branch")})),(0,_common_chat.$)(document).on("click",".create-root-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);pageid&&cmid?createNewRootForModel(cmid,pageid):(0,_common_chat.addError)("Missing required data to create root")})),(0,_common_chat.$)(document).on("click",".export-conversation-btn",(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),cmid=parseInt(button.data("cmid"),10);if(!pageid||!cmid)return void(0,_common_chat.addError)("Missing required data to export conversation");const activeTab=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`).find(".tab-pane.active"),activeModelId=parseInt(activeTab.data("model-id"),10),viewingTurn=activeModelId?getViewingTurnForModel(pageid,activeModelId):null,params=new URLSearchParams;params.append("action","export_conversation"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),viewingTurn&&params.append("turn_id",viewingTurn),window.open(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),"_blank")})),(0,_common_chat.$)(document).on("click",".tree-toolbar-collapse-all",(function(e){e.preventDefault();const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10),tree=fancytreeInstances[pageid];tree&&tree.visit((node=>node.setExpanded(!1)))})),(0,_common_chat.$)(document).on("click",".tree-toolbar-expand-current",(function(e){e.preventDefault();const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10),tree=fancytreeInstances[pageid];if(tree){const activeTab=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`).find(".tab-pane.active"),activeModelId=parseInt(activeTab.data("model-id"),10),viewingTurn=getViewingTurnForModel(pageid,activeModelId),node=tree.getNodeByKey(String(viewingTurn));node&&(node.makeVisible(),node.setActive(!0))}})),treeHandlersRegistered=!0}(),function(){if(turnHandlersRegistered)return;(0,_common_chat.$)(document).on("click",'.multi-model-chat-container[data-behavior="turns"] .toggle-previous-messages-btn',(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),modelid=parseInt(button.data("model-id"),10),messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`),newState=!(!0===messagesContainer.data("show-previous"));messagesContainer.data("show-previous",newState),newState?(messagesContainer.find(".previous-turn-message").show(),updatePreviousToggleLabelForModel(button,!0)):(messagesContainer.find(".previous-turn-message").hide(),updatePreviousToggleLabelForModel(button,!1))})),(0,_common_chat.$)(document).on("click",'.multi-model-chat-container[data-behavior="turns"] .toggle-tree-btn',(function(e){e.preventDefault();const button=(0,_common_chat.$)(this),pageid=parseInt(button.data("pageid"),10),sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);sidebar.is(":visible")?(sidebar.hide(),button.removeClass("active")):(sidebar.show(),button.addClass("active"),loadConversationTree(pageid))})),turnHandlersRegistered=!0}();const containers=(0,_common_chat.$)('.multi-model-chat-container[data-behavior="turns"]');0!==containers.length?(containers.each((function(){const pageid=parseInt((0,_common_chat.$)(this).data("pageid"),10);pageid&&initMultiModelTurnsPage(pageid)})),initialized=!0):initialized=!0},initMultiModelTurnsPage=pageid=>{const tabPanes=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`).find(".tab-pane[data-model-id]");modelTurns[pageid]||(modelTurns[pageid]={});const urlParams=new URLSearchParams(window.location.search),urlTurn=urlParams.get("turn"),urlModel=urlParams.get("model");if(tabPanes.each((function(){const modelid=parseInt((0,_common_chat.$)(this).data("model-id"),10),messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);messagesContainer.find(".message, [data-model-id] .message").each((function(){const $msg=(0,_common_chat.$)(this),wrapper=$msg.closest("[data-model-id]"),wrapperModelId=wrapper.length?parseInt(wrapper.data("model-id"),10):null;$msg.attr("data-model-id")||$msg.attr("data-model-id",wrapperModelId||modelid),$msg.attr("data-model-id")!==String(modelid)&&wrapperModelId!==modelid&&$msg.attr("data-model-id",modelid)}));let maxTurn=0;messagesContainer.find("[data-turn-id]").each((function(){const turnId=parseInt((0,_common_chat.$)(this).data("turn-id"),10);turnId&&turnId>maxTurn&&(maxTurn=turnId)}));const calculatedCurrentTurn=maxTurn>0?maxTurn:1;modelTurns[pageid][modelid]||(modelTurns[pageid][modelid]=calculatedCurrentTurn);let initialViewingTurn=modelTurns[pageid][modelid];if(null!==urlTurn&&""!==urlTurn){const parsedTurn=parseInt(urlTurn,10);!isNaN(parsedTurn)&&parsedTurn>0&&(null!==urlModel&&""!==urlModel&&parseInt(urlModel,10)!==modelid||(initialViewingTurn=parsedTurn))}setViewingTurnForModel(pageid,modelid,initialViewingTurn),updateTurnDisplayForModel(pageid,modelid),updateChatLockStateForModel(pageid,modelid)})),null!==urlModel&&""!==urlModel){const modelIdFromUrl=parseInt(urlModel,10);if(!isNaN(modelIdFromUrl)){const tabButton=(0,_common_chat.$)(`#model-tab-${modelIdFromUrl}-${pageid}`);tabButton.length>0&&tabButton.tab("show")}}const sidebar=(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);if(sidebar.length>0){sidebar.show();const firstModel=tabPanes.first().data("model-id");(0,_common_chat.$)(`.toggle-tree-btn[data-pageid="${pageid}"][data-model-id="${firstModel}"]`).addClass("active"),loadConversationTree(pageid).then((()=>{tabPanes.each((function(){const modelid=parseInt((0,_common_chat.$)(this).data("model-id"),10),viewingTurn=getViewingTurnForModel(pageid,modelid);filterMessagesByTurnForModel(pageid,modelid,viewingTurn)}))})).catch((()=>{tabPanes.each((function(){const modelid=parseInt((0,_common_chat.$)(this).data("model-id"),10),viewingTurn=getViewingTurnForModel(pageid,modelid);filterMessagesByTurnForModel(pageid,modelid,viewingTurn)}))}))}else tabPanes.each((function(){const modelid=parseInt((0,_common_chat.$)(this).data("model-id"),10),viewingTurn=getViewingTurnForModel(pageid,modelid);filterMessagesByTurnForModel(pageid,modelid,viewingTurn)}));setTimeout((()=>{tabPanes.each((function(){const modelid=parseInt((0,_common_chat.$)(this).data("model-id"),10),viewingTurn=getViewingTurnForModel(pageid,modelid);ensureTurnEvaluationQuestionsRenderedForModel(pageid,modelid,viewingTurn).then((()=>{loadTurnEvaluationResponsesForModel(pageid,modelid,viewingTurn)})).catch((error=>{console.error("Error loading turn evaluation questions on init:",error)}))}))}),100)},getViewingTurnForModel=(pageid,modelid)=>{var _modelTurns$pageid;const container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`),key=`viewing-turn-${modelid}`;return parseInt(container.data(key)||(null===(_modelTurns$pageid=modelTurns[pageid])||void 0===_modelTurns$pageid?void 0:_modelTurns$pageid[modelid])||1,10)},setViewingTurnForModel=(pageid,modelid,turn)=>{const key=`viewing-turn-${modelid}`;(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`).data(key,turn),modelTurns[pageid]||(modelTurns[pageid]={}),modelTurns[pageid][modelid]=turn;const urlParams=new URLSearchParams(window.location.search);urlParams.set("turn",turn),urlParams.set("model",modelid);const newUrl=window.location.pathname+"?"+urlParams.toString();window.history.replaceState({},"",newUrl);const tabButton=(0,_common_chat.$)(`#model-tab-${modelid}-${pageid}`);tabButton.length>0&&tabButton.tab("show")},getCurrentTurnForModel=(pageid,modelid)=>{var _modelTurns$pageid2;return(null===(_modelTurns$pageid2=modelTurns[pageid])||void 0===_modelTurns$pageid2?void 0:_modelTurns$pageid2[modelid])||1},updateTurnDisplayForModel=(pageid,modelid)=>{const viewingTurn=getViewingTurnForModel(pageid,modelid),badge=(0,_common_chat.$)(`#current-turn-badge-model-${modelid}-${pageid}`),numberSpan=(0,_common_chat.$)(`#current-turn-number-model-${modelid}-${pageid}`);badge.length&&numberSpan.length&&(0,_common_chat.getString)("turn","mod_harpiasurvey").then((turnStr=>{numberSpan.text(`${turnStr} ${viewingTurn}`)}))},updateChatLockStateForModel=(pageid,modelid)=>{const viewingTurn=getViewingTurnForModel(pageid,modelid),currentTurn=getCurrentTurnForModel(pageid,modelid),input=(0,_common_chat.$)(`#chat-input-model-${modelid}-${pageid}`),button=(0,_common_chat.$)(`#send-message-btn-model-${modelid}-${pageid}`),container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`),maxTurns=container.data("max-turns");container.data("min-turns");let shouldLock=!1;if(viewingTurn<currentTurn)shouldLock=!0;else if(null!=maxTurns){const maxTurnsNum=parseInt(maxTurns,10),turnCount=getTurnCountForConversationForModel(pageid,modelid,viewingTurn);null!==turnCount&&turnCount>=maxTurnsNum&&isTurnCompleteForModel(pageid,modelid,viewingTurn)&&(shouldLock=!0)}shouldLock?(input.prop("disabled",!0),button.prop("disabled",!0),(0,_common_chat.getString)("chatlocked","mod_harpiasurvey").then((str=>{input.attr("placeholder",str)}))):(input.prop("disabled",!1),button.prop("disabled",!1),(0,_common_chat.getString)("typeyourmessage","mod_harpiasurvey").then((str=>{input.attr("placeholder",str)})))},filterMessagesByTurnForModel=(pageid,modelid,viewingTurn)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);if(0===messagesContainer.length)return;const shouldShowPrevious=!0===messagesContainer.data("show-previous"),tree=_common_chat.conversationTrees[pageid],root=tree?(0,_common_chat.findRootForTurn)(tree.roots||[],viewingTurn):null,allowedTurnIds=new Set;if(allowedTurnIds.add(parseInt(viewingTurn,10)),root){const addPath=(node,targetId,path)=>{if(parseInt(node.turn_id,10)===parseInt(targetId,10))return path.forEach((id=>allowedTurnIds.add(id))),allowedTurnIds.add(parseInt(node.turn_id,10)),!0;if(node.direct_branches)for(const db of node.direct_branches)if(addPath(db,targetId,[...path,parseInt(node.turn_id,10)]))return!0;if(node.children)for(const child of node.children)if(addPath(child,targetId,[...path,parseInt(node.turn_id,10)]))return!0;return!1};addPath(root,viewingTurn,[])}else allowedTurnIds.add(parseInt(viewingTurn,10));messagesContainer.find(".message").each((function(){const $msg=(0,_common_chat.$)(this),messageTurnId=parseInt($msg.data("turn-id"),10);if(parseInt($msg.data("model-id"),10)!==modelid)return void $msg.removeClass("previous-turn-message").hide();if(!messageTurnId||isNaN(messageTurnId))return void $msg.removeClass("previous-turn-message").hide();const isCurrentTurn=messageTurnId===parseInt(viewingTurn,10);allowedTurnIds.has(messageTurnId)?isCurrentTurn?$msg.removeClass("previous-turn-message").show():($msg.addClass("previous-turn-message"),shouldShowPrevious?$msg.show():$msg.hide()):$msg.removeClass("previous-turn-message").hide()}));const toggleBtn=(0,_common_chat.$)(`.toggle-previous-messages-btn[data-pageid="${pageid}"][data-model-id="${modelid}"]`);if(toggleBtn.length>0){if(messagesContainer.find(".previous-turn-message").length>0){toggleBtn.show(),toggleBtn.prop("disabled",!1);const isVisible=messagesContainer.find(".previous-turn-message").first().is(":visible");updatePreviousToggleLabelForModel(toggleBtn,isVisible)}else toggleBtn.hide()}setTimeout((()=>{scrollToBottomForModel(pageid,modelid)}),50)},updatePreviousToggleLabelForModel=(button,isVisible)=>{isVisible?(0,_common_chat.getString)("hideprevious","mod_harpiasurvey").then((str=>{button.html('<i class="fa fa-eye-slash" aria-hidden="true"></i> '+str)})):(0,_common_chat.getString)("showprevious","mod_harpiasurvey").then((str=>{button.html('<i class="fa fa-history" aria-hidden="true"></i> '+str)}))},scrollToBottomForModel=(pageid,modelid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);0!==messagesContainer.length&&requestAnimationFrame((()=>{const container=messagesContainer[0];container&&(container.scrollTop=container.scrollHeight)}))},getTurnCountForConversationForModel=(pageid,modelid,turnId)=>{const tree=_common_chat.conversationTrees[pageid];if(!tree||!tree.roots)return null;const root=(0,_common_chat.findRootForTurn)(tree.roots,turnId);return root?(0,_common_chat.countNodes)(root):null},isTurnCompleteForModel=(pageid,modelid,turnId)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);let hasUser=!1,hasAssistant=!1;return messagesContainer.find(`.message[data-turn-id="${turnId}"]`).each((function(){const role=(0,_common_chat.$)(this).data("role");"user"===role?hasUser=!0:"assistant"===role&&(hasAssistant=!0)})),hasUser&&hasAssistant},ensureTurnEvaluationQuestionsRenderedForModel=(pageid,modelid,turn)=>{const scriptEl=(0,_common_chat.$)(`#turn-evaluation-questions-data-${pageid}`);if(0===scriptEl.length)return Promise.resolve();try{const questionsData=JSON.parse(scriptEl.text()),tabPane=(0,_common_chat.$)(`#model-pane-${modelid}-${pageid}`),questionsContainer=tabPane.find(".turn-evaluation-questions");if(0===questionsContainer.length){const container=(0,_common_chat.$)('<div class="turn-evaluation-questions mt-4"></div>');tabPane.append(container),questionsContainer=container}const filteredQuestions=questionsData.filter((q=>null!==q.show_only_turn&&void 0!==q.show_only_turn?parseInt(q.show_only_turn,10)===turn:null===q.hide_on_turn||void 0===q.hide_on_turn||parseInt(q.hide_on_turn,10)!==turn));return 0===filteredQuestions.length?(questionsContainer.empty(),Promise.resolve()):_common_chat.Templates.render("mod_harpiasurvey/turn_evaluation_questions",{questions:filteredQuestions,pageid:pageid,modelid:modelid,turn:turn}).then((html=>{questionsContainer.html(html)}))}catch(error){return console.error("Error parsing turn evaluation questions:",error),Promise.resolve()}},loadTurnEvaluationResponsesForModel=(pageid,modelid,turn)=>{};const displayUserMessageForModel=(pageid,modelid,message,messageid)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);if(0===messagesContainer.length)return;messagesContainer.find(".text-center.text-muted").remove();const viewingTurn=getViewingTurnForModel(pageid,modelid);_common_chat.Templates.render("mod_harpiasurvey/chat_user_message",{id:messageid,content:message,timecreated:Math.floor(Date.now()/1e3)}).then((html=>{const $html=(0,_common_chat.$)(html);$html.attr("data-messageid",messageid),$html.attr("data-model-id",modelid),viewingTurn&&$html.attr("data-turn-id",viewingTurn),$html.attr("data-role","user"),messagesContainer.append($html),scrollToBottomForModel(pageid,modelid)})).catch(_common_chat.Notification.exception)},sendMessageForModel=(cmid,pageid,message,modelid,button,input,loading)=>{(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`);const viewingTurn=getViewingTurnForModel(pageid,modelid);let parentid=null;const visibleMessages=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`).find(".message:visible");if(visibleMessages.length>0){const lastMessage=visibleMessages.last(),lastMessageId=parseInt(lastMessage.data("messageid"),10);lastMessageId&&!isNaN(lastMessageId)&&(parentid=lastMessageId)}const params=new URLSearchParams({action:"send_ai_message",cmid:cmid,pageid:pageid,message:message,modelid:modelid,sesskey:_common_chat.Config.sesskey});parentid&&params.append("parentid",parentid),viewingTurn&&params.append("turn_id",viewingTurn),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(loading.hide(),data.success)if(data.messageid&&data.content){const newTurnId=data.turn_id?parseInt(data.turn_id,10):viewingTurn;newTurnId>viewingTurn&&(setViewingTurnForModel(pageid,modelid,newTurnId),modelTurns[pageid][modelid]=newTurnId,updateTurnDisplayForModel(pageid,modelid)),displayAIMessageForModel(pageid,modelid,data.content,data.messageid,newTurnId).then((()=>{const turnToView=newTurnId||viewingTurn;loadConversationTree(pageid).then((()=>{filterMessagesByTurnForModel(pageid,modelid,turnToView),updateChatLockStateForModel(pageid,modelid),setTimeout((()=>{scrollToBottomForModel(pageid,modelid)}),100)})).catch((()=>{filterMessagesByTurnForModel(pageid,modelid,turnToView),updateChatLockStateForModel(pageid,modelid),setTimeout((()=>{scrollToBottomForModel(pageid,modelid)}),100)}))}))}else(0,_common_chat.addError)("Received response but missing message ID or content"),input.prop("disabled",!1),button.prop("disabled",!1),input.focus();else(0,_common_chat.addError)(data.message||"Error sending message"),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()})).catch((error=>{loading.hide(),console.error("Error sending message:",error),(0,_common_chat.addError)("Error sending message: "+error.message),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()}))},displayAIMessageForModel=(pageid,modelid,content,messageid,turnId)=>{const messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);return 0===messagesContainer.length?Promise.resolve():_common_chat.Templates.render("mod_harpiasurvey/chat_ai_message",{id:messageid,content:content,timecreated:Math.floor(Date.now()/1e3),turn_id:turnId,modelid:modelid}).then((html=>{const $html=(0,_common_chat.$)(html);return $html.attr("data-messageid",messageid),$html.attr("data-model-id",modelid),turnId&&$html.attr("data-turn-id",turnId),$html.attr("data-role","assistant"),messagesContainer.append($html),scrollToBottomForModel(pageid,modelid),$html[0].outerHTML})).catch(_common_chat.Notification.exception)},loadConversationTree=pageid=>{const treeContainer=(0,_common_chat.$)(`#conversation-tree-${pageid}`);(0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`);if(0===treeContainer.length)return Promise.resolve(null);const container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`),cmid=parseInt(container.attr("data-cmid")||container.data("cmid"),10);if(!cmid)return treeContainer.html('<div class="text-danger text-center small py-3">Error: Course module ID not found. Please refresh the page.</div>'),Promise.resolve(null);const params=new URLSearchParams;return params.append("action","get_conversation_tree"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(data.success&&data.tree){data.tree.roots=(data.tree.roots||[]).map(((root,idx)=>({...root,conversation_number:idx+1}))),_common_chat.conversationTrees[pageid]=data.tree;const activeTab=container.find(".tab-pane.active");let activeModelId=parseInt(activeTab.data("model-id"),10);activeModelId&&!isNaN(activeModelId)||(activeModelId=parseInt(container.find(".tab-pane[data-model-id]").first().data("model-id"),10));const viewingTurn=activeModelId?getViewingTurnForModel(pageid,activeModelId):data.tree.roots&&data.tree.roots.length>0?parseInt(data.tree.roots[0].turn_id,10):1,cmid=(0,_common_chat.getCmid)(pageid);return"list"===((0,_common_chat.$)(`#conversation-tree-sidebar-${pageid}`).data("sidebar-view")||"list")?(0,_common_chat.renderConversationList)(pageid,data.tree.roots):(0,_fancytree_loader.ensureFancytree)().then((()=>{renderFancyTree(pageid,data.tree.roots,viewingTurn,cmid)})).catch((error=>{console.error("Error loading Fancytree:",error),(0,_common_chat.renderConversationList)(pageid,data.tree.roots)})),data.tree}return treeContainer.html('<div class="text-muted text-center small py-3">'+(data.message||"No conversation tree available yet.")+"</div>"),null})).catch((error=>(console.error("Error loading conversation tree:",error),treeContainer.html('<div class="text-danger text-center small py-3">Error loading conversation tree: '+error.message+"<br>Please check the browser console for details and refresh the page.</div>"),null)))},toFancyNode=(node,idx,parentNumber,viewingTurn,cmid)=>{const turnNumber=(0,_common_chat.calculateTurnNumber)(node,idx,parentNumber),title="Turn "+turnNumber+(node.branch_label?" ("+node.branch_label+")":""),children=[];let childCounter=0;if(node.direct_branches&&node.direct_branches.length>0){[...node.direct_branches].sort(((a,b)=>parseInt(a.turn_id,10)-parseInt(b.turn_id,10))).forEach((db=>{children.push(toFancyNode(db,childCounter,turnNumber,viewingTurn,cmid)),childCounter++}))}if(node.children&&node.children.length>0){[...node.children].sort(((a,b)=>parseInt(a.turn_id,10)-parseInt(b.turn_id,10))).forEach(((child,childIdx)=>{children.push(toFancyNode(child,childIdx,turnNumber,viewingTurn,cmid))}))}const hasChildren=children.length>0,extraClasses=[];return node.is_root?extraClasses.push("ft-root"):node.is_direct_branch?extraClasses.push("ft-direct-branch"):extraClasses.push("ft-branch"),hasChildren&&extraClasses.push("ft-has-children"),{title:title,key:String(node.turn_id),expanded:node.is_root||parseInt(node.turn_id,10)===parseInt(viewingTurn,10),active:parseInt(node.turn_id,10)===parseInt(viewingTurn,10),extraClasses:extraClasses.join(" "),children:children,data:{turn_id:node.turn_id,is_root:node.is_root||!1,is_direct_branch:node.is_direct_branch||!1,cmid:cmid,turn_number:turnNumber}}},renderFancyTree=(pageid,roots,viewingTurn,cmid)=>{const treeContainer=(0,_common_chat.$)(`#conversation-tree-${pageid}`);if(0===treeContainer.length)return;const rootForViewing=(0,_common_chat.findRootForTurn)(roots||[],viewingTurn),rootsToRender=rootForViewing?[rootForViewing]:roots&&roots.length>0?[roots[0]]:[],source=rootsToRender.map(((root,idx)=>toFancyNode(root,idx,null,viewingTurn,cmid))),activeRootTurnId=rootsToRender.length?rootsToRender[0].turn_id:null;treeContainer.html('<div class="tree-header d-flex align-items-center justify-content-between mb-2"><div class="d-flex align-items-center"><button class="btn btn-link btn-sm p-0 mr-2 back-to-list-btn" data-pageid="'+pageid+'" title="Back to list"><i class="fa fa-arrow-left"></i></button><span class="font-weight-bold text-primary">Conversations</span></div><div class="btn-group btn-group-sm tree-toolbar" role="group"><button class="btn btn-outline-secondary tree-toolbar-collapse-all" data-pageid="'+pageid+'" title="Collapse all"><i class="fa fa-minus-square-o" aria-hidden="true"></i></button><button class="btn btn-outline-secondary tree-toolbar-expand-current" data-pageid="'+pageid+'" title="Focus current turn"><i class="fa fa-bullseye" aria-hidden="true"></i></button></div></div>'+(activeRootTurnId?'<div class="mb-2"><button class="btn btn-sm btn-success btn-block create-direct-branch-btn" data-pageid="'+pageid+'" data-cmid="'+cmid+'" data-root-turn-id="'+activeRootTurnId+'"><i class="fa fa-plus-circle" aria-hidden="true"></i> New turn from root</button></div>':"")+'<div class="fancytree-host fancytree-skin-win8" id="fancytree-host-'+pageid+'"></div>');const host=(0,_common_chat.$)(`#fancytree-host-${pageid}`);host.fancytree({source:source,checkbox:!1,selectMode:1,toggleEffect:!1,clickFolderMode:3,activate:(event,data)=>{const turnId=parseInt(data.node.key,10);if(turnId){const activeTab=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`).find(".tab-pane.active"),activeModelId=parseInt(activeTab.data("model-id"),10);activeModelId&&navigateToTurnForModel(pageid,activeModelId,turnId)}},renderNode:(event,data)=>{const node=data.node,turnId=parseInt(node.key,10);(0,_common_chat.$)(node.span).find(".ft-branch-btn").remove();const $btn=(0,_common_chat.$)('<button type="button" class="btn btn-xs btn-outline-success ml-1 ft-branch-btn" title="Branch"></button>');$btn.append('<i class="fa fa-code-branch"></i>'),$btn.on("click",(e=>{e.preventDefault(),e.stopPropagation(),cmid&&turnId?createBranchFromTurnForModel(cmid,pageid,turnId,$btn):_common_chat.Notification.addNotification({message:"Missing data to create branch",type:"error"})})),(0,_common_chat.$)(node.span).find(".fancytree-title").after($btn)}}),fancytreeInstances[pageid]=host.fancytree("getTree")},navigateToTurnForModel=(pageid,modelid,turnId)=>{setViewingTurnForModel(pageid,modelid,turnId),updateTurnDisplayForModel(pageid,modelid),updateChatLockStateForModel(pageid,modelid),filterMessagesByTurnForModel(pageid,modelid,turnId),ensureTurnEvaluationQuestionsRenderedForModel(pageid,modelid,turnId).then((()=>{loadTurnEvaluationResponsesForModel(pageid,modelid,turnId)}))},createBranchFromTurnForModel=(cmid,pageid,turnId,button)=>{const params=new URLSearchParams;params.append("action","create_branch"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("parent_turn_id",turnId),params.append("sesskey",_common_chat.Config.sesskey),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>response.json())).then((data=>{data.success?(loadConversationTree(pageid),_common_chat.Notification.addNotification({message:data.message||"Branch created successfully",type:"success"})):(0,_common_chat.addError)(data.message||"Failed to create branch")})).catch((error=>{console.error("Error creating branch:",error),(0,_common_chat.addError)("Error creating branch: "+error.message)}))};const createNewRootForModel=(cmid,pageid)=>{const params=new URLSearchParams;params.append("action","create_root"),params.append("cmid",cmid),params.append("pageid",pageid),params.append("sesskey",_common_chat.Config.sesskey),fetch(_common_chat.Config.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>response.json())).then((data=>{if(data.success){const container=(0,_common_chat.$)(`.multi-model-chat-container[data-pageid="${pageid}"]`),activeTab=container.find(".tab-pane.active"),activeModelId=parseInt(activeTab.data("model-id"),10);container.find(".tab-pane[data-model-id]").each((function(){const modelid=parseInt((0,_common_chat.$)(this).data("model-id"),10),messagesContainer=(0,_common_chat.$)(`#chat-messages-model-${modelid}-${pageid}`);messagesContainer.empty(),messagesContainer.html('<div class="text-center text-muted py-4"><p>{{#str}}nomessagesyet, mod_harpiasurvey{{/str}}</p></div>')})),loadConversationTree(pageid).then((()=>{if(activeModelId&&data.turn_id)navigateToTurnForModel(pageid,activeModelId,parseInt(data.turn_id,10),!0);else{const firstModel=container.find(".tab-pane[data-model-id]").first(),firstModelId=parseInt(firstModel.data("model-id"),10);firstModelId&&data.turn_id&&navigateToTurnForModel(pageid,firstModelId,parseInt(data.turn_id,10),!0)}})),_common_chat.Notification.addNotification({message:data.message||"New conversation created successfully",type:"success"})}else(0,_common_chat.addError)(data.message||"Failed to create new conversation")})).catch((error=>{console.error("Error creating new root:",error),(0,_common_chat.addError)("Error creating new root: "+error.message)}))}}));

//# sourceMappingURL=multi_model_turns.min.js.map
define("mod_harpiasurvey/review_conversation",["exports","core/config","core/notification","jquery"],(function(_exports,_config,_notification,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_config=_interopRequireDefault(_config),_notification=_interopRequireDefault(_notification),_jquery=_interopRequireDefault(_jquery);let initialized=!1;const ajaxPost=params=>fetch(_config.default.wwwroot+"/mod/harpiasurvey/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:params.toString()}).then((response=>response.json())),clearQuestionInputs=pageid=>{(0,_jquery.default)(".page-view .page-questions .question-item").each((function(){const item=(0,_jquery.default)(this),questiontype=item.data("questiontype");"singlechoice"===questiontype||"likert"===questiontype?item.find('input[type="radio"]').prop("checked",!1):"multiplechoice"===questiontype?item.find('input[type="checkbox"]').prop("checked",!1):"select"===questiontype?item.find("select").val(""):"number"===questiontype||"shorttext"===questiontype?item.find("input").val(""):"longtext"===questiontype&&item.find("textarea").val(""),item.attr("data-response-locked","0"),item.attr("data-response-editing","1"),item.find(".saved-response-message").remove(),item.find(".answer-history").remove(),item.find(".question-edit-btn").hide(),item.find("input, select, textarea").prop("disabled",!1)}));(0,_jquery.default)(".page-view .page-questions .save-all-status").hide().empty();(0,_jquery.default)(`.save-all-responses-btn[data-pageid="${pageid}"]`).removeClass("btn-success btn-warning").addClass("btn-primary")},loadEvaluationResponses=(cmid,pageid,threadid)=>{const responseParams=new URLSearchParams({action:"get_review_evaluation_responses",cmid:String(cmid),pageid:String(pageid),threadid:String(threadid),sesskey:_config.default.sesskey});return ajaxPost(responseParams).then((response=>{if(!response.success)throw new Error(response.message||"Failed to load review evaluation responses.");clearQuestionInputs(pageid);(0,_jquery.default)(`.review-conversation-container[data-pageid="${pageid}"]`).attr("data-review-target-id",String(response.targetid||""));(0,_jquery.default)(`.ai-conversation-container[data-pageid="${pageid}"]`).attr("data-review-target-id",String(response.targetid||""));const responses=response.responses||{};Object.keys(responses).forEach((questionid=>{const questionItem=(0,_jquery.default)(`.page-view .page-questions .question-item[data-questionid="${questionid}"]`);questionItem.length&&((questionItem,questionType,responseValue)=>{if(null!=responseValue&&""!==responseValue)if("singlechoice"!==questionType&&"likert"!==questionType){if("multiplechoice"===questionType){let values=[];try{values=JSON.parse(responseValue)}catch(e){values=[]}return Array.isArray(values)||(values=[]),void values.forEach((value=>{questionItem.find(`input[type="checkbox"][value="${value}"]`).prop("checked",!0)}))}"select"!==questionType?"number"!==questionType&&"shorttext"!==questionType?"longtext"===questionType&&questionItem.find("textarea").val(responseValue):questionItem.find("input").val(responseValue):questionItem.find("select").val(String(responseValue))}else questionItem.find(`input[type="radio"][value="${responseValue}"]`).prop("checked",!0)})(questionItem,questionItem.data("questiontype"),responses[questionid].response)}))}))},loadThread=(cmid,pageid,threadid)=>{const params=new URLSearchParams({action:"get_review_thread_messages",cmid:String(cmid),pageid:String(pageid),threadid:String(threadid),sesskey:_config.default.sesskey});return ajaxPost(params).then((response=>{if(!response.success)throw new Error(response.message||"Failed to load review conversation.");return((pageid,messages)=>{const container=(0,_jquery.default)(`#review-thread-messages-${pageid}`);container.empty(),messages&&0!==messages.length?(messages.forEach((msg=>{const roleClass="assistant"===msg.role?"border-primary":"border-secondary",roleLabel=msg.role?msg.role.charAt(0).toUpperCase()+msg.role.slice(1):"Message",row=(0,_jquery.default)('<div class="review-message-item border rounded p-2 mb-2 bg-white"></div>');row.addClass(roleClass),row.append(`<div class="small text-muted mb-1"><strong>${roleLabel}</strong>${msg.timecreated?` â€¢ ${msg.timecreated}`:""}</div>`),row.append(`<div class="review-message-content">${msg.content||""}</div>`),container.append(row)})),container.scrollTop(0)):container.html('<div class="text-muted text-center small py-3">No messages in this conversation.</div>')})(pageid,response.messages||[]),loadEvaluationResponses(cmid,pageid,threadid)})).catch((error=>{_notification.default.addNotification({message:error.message||"Failed to load review conversation.",type:"error"})}))},bindHandlers=()=>{(0,_jquery.default)(document).on("click",".review-thread-item",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),pageid=parseInt(button.data("pageid"),10),threadid=parseInt(button.data("thread-id"),10),container=(0,_jquery.default)(`.review-conversation-container[data-pageid="${pageid}"]`),cmid=parseInt(container.data("cmid"),10);pageid&&threadid&&cmid&&((0,_jquery.default)(`.review-thread-item[data-pageid="${pageid}"]`).removeClass("active"),button.addClass("active"),loadThread(cmid,pageid,threadid))}))};_exports.init=()=>{initialized||(bindHandlers(),initialized=!0),(0,_jquery.default)(".review-conversation-container").each((function(){const container=(0,_jquery.default)(this),pageid=parseInt(container.data("pageid"),10),cmid=parseInt(container.data("cmid"),10),defaultthread=parseInt(container.data("review-default-thread-id"),10);if(!pageid||!cmid||!defaultthread)return;const defaultButton=container.find(`.review-thread-item[data-thread-id="${defaultthread}"]`);defaultButton.length&&defaultButton.trigger("click")}))}}));

//# sourceMappingURL=review_conversation.min.js.map
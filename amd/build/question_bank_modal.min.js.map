{"version":3,"file":"question_bank_modal.min.js","sources":["../src/question_bank_modal.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Question bank modal module.\n *\n * @module     mod_harpiasurvey/question_bank_modal\n * @copyright  2025 Your Name\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Modal from 'core/modal';\nimport ModalEvents from 'core/modal_events';\nimport Notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport Templates from 'core/templates';\nimport Config from 'core/config';\nimport $ from 'jquery';\n\nlet modalInstance = null;\nlet initialized = false;\n\n/**\n * Initialize the question bank modal functionality.\n * Uses event delegation like aiprompts/aitools modules.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n */\nexport const init = (cmid, pageid) => {\n    if (initialized) {\n        // Event listener already attached (can be called multiple times).\n        return;\n    }\n\n    $(\"body\").on(\"click\", \".question-bank-modal-trigger\", function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const triggerCmid = parseInt(button.data(\"cmid\"), 10);\n        const triggerPageid = parseInt(button.data(\"pageid\"), 10);\n        showModal(triggerCmid || cmid, triggerPageid || pageid);\n    });\n\n    // Handle subpage question bank modal triggers.\n    $(\"body\").on(\"click\", \".subpage-question-bank-modal-trigger\", function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const triggerCmid = parseInt(button.data(\"cmid\"), 10);\n        const triggerPageid = parseInt(button.data(\"pageid\"), 10);\n        const triggerSubpageid = parseInt(button.data(\"subpageid\"), 10);\n        showSubpageModal(triggerCmid || cmid, triggerPageid || pageid, triggerSubpageid);\n    });\n\n    initialized = true;\n};\n\n/**\n * Show the question bank modal.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @returns {Promise}\n */\nexport const showModal = (cmid, pageid) => {\n    if (modalInstance) {\n        modalInstance.show();\n        loadQuestions(cmid, pageid);\n        return Promise.resolve();\n    }\n\n    return getString('questionbank', 'mod_harpiasurvey').then((title) => {\n        return Modal.create({\n            title: title,\n            body: Templates.render('mod_harpiasurvey/question_bank_modal_body', {\n                loading: true\n            }),\n            large: true,\n            show: true,\n        });\n    }).then((modal) => {\n        modalInstance = modal;\n\n        // Load questions when modal is shown.\n        modal.getRoot().on(ModalEvents.shown, () => {\n            loadQuestions(cmid, pageid);\n        });\n\n        // Handle add question button clicks.\n        modal.getRoot().on('click', '[data-action=\"add-question\"]', (e) => {\n            e.preventDefault();\n            const questionId = parseInt(e.currentTarget.dataset.questionid, 10);\n            addQuestionToPage(cmid, pageid, questionId);\n        });\n\n        // Clean up when modal is hidden.\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            modal.setBody(Templates.render('mod_harpiasurvey/question_bank_modal_body', {\n                loading: true\n            }));\n        });\n\n        return modal;\n    }).catch(Notification.exception);\n};\n\n/**\n * Load available questions via AJAX.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n */\nconst loadQuestions = (cmid, pageid) => {\n    const bodyPromise = modalInstance.getBodyPromise();\n    const wwwroot = Config.wwwroot;\n    const ajaxUrl = wwwroot + '/mod/harpiasurvey/ajax.php';\n    const params = new URLSearchParams({\n        action: 'get_available_questions',\n        cmid: cmid,\n        pageid: pageid\n    });\n\n    fetch(ajaxUrl + '?' + params.toString())\n        .then((response) => response.json())\n        .then((response) => {\n            if (response.success) {\n                // Note: evaluates_conversation_id has been removed.\n                // All questions on aichat pages automatically evaluate the page's chat conversation.\n\n                return Templates.render('mod_harpiasurvey/question_bank_modal_body', {\n                    questions: response.questions,\n                    has_questions: response.questions.length > 0,\n                    is_aichat_page: response.is_aichat_page || false,\n                    cmid: cmid,\n                    pageid: pageid\n                });\n            } else {\n                return Templates.render('mod_harpiasurvey/question_bank_modal_body', {\n                    error: response.message || 'Error loading questions',\n                    has_questions: false\n                });\n            }\n        })\n        .then((html) => {\n            return bodyPromise.then(() => {\n                modalInstance.setBody(html);\n            });\n        })\n        .catch((error) => {\n            return bodyPromise.then(() => {\n                modalInstance.setBody(Templates.render('mod_harpiasurvey/question_bank_modal_body', {\n                    error: 'Error loading questions',\n                    has_questions: false\n                }));\n            });\n            Notification.exception(error);\n        });\n};\n\n/**\n * Add a question to the page via AJAX.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {number} questionId Question ID\n */\nconst addQuestionToPage = (cmid, pageid, questionId) => {\n    const wwwroot = Config.wwwroot;\n    const sesskey = Config.sesskey || M.cfg.sesskey;\n    const ajaxUrl = wwwroot + '/mod/harpiasurvey/ajax.php';\n\n    // Note: evaluates_conversation_id has been removed.\n    // All questions on aichat pages automatically evaluate the page's chat conversation.\n\n    const params = new URLSearchParams({\n        action: 'add_question_to_page',\n        cmid: cmid,\n        pageid: pageid,\n        questionid: questionId,\n        sesskey: sesskey\n    });\n\n    fetch(ajaxUrl + '?' + params.toString())\n        .then((response) => response.json())\n        .then((response) => {\n            if (response.success) {\n                Notification.addNotification({\n                    message: response.message,\n                    type: 'success'\n                });\n                // Reload the page to show the new question.\n                window.location.reload();\n            } else {\n                Notification.addNotification({\n                    message: response.message || 'Error adding question',\n                    type: 'error'\n                });\n            }\n        })\n        .catch(Notification.exception);\n};\n\nlet subpageModalInstance = null;\n\n/**\n * Show the question bank modal for subpages.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {number} subpageid Subpage ID\n * @returns {Promise}\n */\nexport const showSubpageModal = (cmid, pageid, subpageid) => {\n    if (subpageModalInstance) {\n        subpageModalInstance.show();\n        loadSubpageQuestions(cmid, pageid, subpageid);\n        return Promise.resolve();\n    }\n\n    return getString('addquestiontosubpage', 'mod_harpiasurvey').then((title) => {\n        return Modal.create({\n            title: title,\n            body: Templates.render('mod_harpiasurvey/question_bank_modal_body', {\n                loading: true\n            }),\n            large: true,\n            show: true,\n        });\n    }).then((modal) => {\n        subpageModalInstance = modal;\n\n        // Load questions when modal is shown.\n        modal.getRoot().on(ModalEvents.shown, () => {\n            loadSubpageQuestions(cmid, pageid, subpageid);\n        });\n\n        // Handle add question button clicks.\n        modal.getRoot().on('click', '[data-action=\"add-question-to-subpage\"]', (e) => {\n            e.preventDefault();\n            const questionId = parseInt(e.currentTarget.dataset.questionid, 10);\n            addQuestionToSubpage(cmid, pageid, subpageid, questionId);\n        });\n\n        // Clean up when modal is hidden.\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            modal.setBody(Templates.render('mod_harpiasurvey/question_bank_modal_body', {\n                loading: true\n            }));\n        });\n\n        return modal;\n    }).catch(Notification.exception);\n};\n\n/**\n * Load available questions for subpage via AJAX.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {number} subpageid Subpage ID\n */\nconst loadSubpageQuestions = (cmid, pageid, subpageid) => {\n    const bodyPromise = subpageModalInstance.getBodyPromise();\n    const wwwroot = Config.wwwroot;\n    const ajaxUrl = wwwroot + '/mod/harpiasurvey/ajax.php';\n    const params = new URLSearchParams({\n        action: 'get_available_subpage_questions',\n        cmid: cmid,\n        pageid: pageid,\n        subpageid: subpageid\n    });\n\n    fetch(ajaxUrl + '?' + params.toString())\n        .then((response) => response.json())\n        .then((response) => {\n            if (response.success) {\n                return Templates.render('mod_harpiasurvey/question_bank_modal_body', {\n                    questions: response.questions,\n                    has_questions: response.questions.length > 0,\n                    is_aichat_page: false,\n                    cmid: cmid,\n                    pageid: pageid,\n                    subpageid: subpageid,\n                    is_subpage: true\n                });\n            } else {\n                return Templates.render('mod_harpiasurvey/question_bank_modal_body', {\n                    error: response.message || 'Error loading questions',\n                    has_questions: false\n                });\n            }\n        })\n        .then((html) => {\n            return bodyPromise.then(() => {\n                subpageModalInstance.setBody(html);\n            });\n        })\n        .catch((error) => {\n            return bodyPromise.then(() => {\n                subpageModalInstance.setBody(Templates.render('mod_harpiasurvey/question_bank_modal_body', {\n                    error: 'Error loading questions',\n                    has_questions: false\n                }));\n            });\n            Notification.exception(error);\n        });\n};\n\n/**\n * Add a question to the subpage via AJAX.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {number} subpageid Subpage ID\n * @param {number} questionId Question ID\n */\nconst addQuestionToSubpage = (cmid, pageid, subpageid, questionId) => {\n    const wwwroot = Config.wwwroot;\n    const sesskey = Config.sesskey || M.cfg.sesskey;\n    const ajaxUrl = wwwroot + '/mod/harpiasurvey/ajax.php';\n\n    const params = new URLSearchParams({\n        action: 'add_question_to_subpage',\n        cmid: cmid,\n        pageid: pageid,\n        subpageid: subpageid,\n        questionid: questionId,\n        sesskey: sesskey\n    });\n\n    fetch(ajaxUrl + '?' + params.toString())\n        .then((response) => response.json())\n        .then((response) => {\n            if (response.success) {\n                Notification.addNotification({\n                    message: response.message,\n                    type: 'success'\n                });\n                // Reload the page to show the new question.\n                window.location.reload();\n            } else {\n                Notification.addNotification({\n                    message: response.message || 'Error adding question',\n                    type: 'error'\n                });\n            }\n        })\n        .catch(Notification.exception);\n};\n\n"],"names":["modalInstance","initialized","cmid","pageid","on","e","preventDefault","button","this","triggerCmid","parseInt","data","triggerPageid","showModal","triggerSubpageid","showSubpageModal","show","loadQuestions","Promise","resolve","then","title","Modal","create","body","Templates","render","loading","large","modal","getRoot","ModalEvents","shown","questionId","currentTarget","dataset","questionid","addQuestionToPage","hidden","setBody","catch","Notification","exception","bodyPromise","getBodyPromise","ajaxUrl","Config","wwwroot","params","URLSearchParams","action","fetch","toString","response","json","success","questions","has_questions","length","is_aichat_page","error","message","html","sesskey","M","cfg","addNotification","type","window","location","reload","subpageModalInstance","subpageid","loadSubpageQuestions","addQuestionToSubpage","is_subpage"],"mappings":"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"}
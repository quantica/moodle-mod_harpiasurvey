{"version":3,"file":"navigation_control.min.js","sources":["../src/navigation_control.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Navigation control module for harpiasurvey.\n *\n * @module     mod_harpiasurvey/navigation_control\n * @copyright  2025 Your Name\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {get_string as getString} from 'core/str';\nimport $ from 'jquery';\n\nlet initialized = false;\nlet unloadWarningMessage = 'There are evaluation questions you did not answer. Are you sure you want to quit?';\n\n/**\n * Check if all questions on the current page are answered.\n *\n * @return {boolean} True if all questions are answered\n */\nconst areAllQuestionsAnswered = () => {\n    let allAnswered = true;\n    const unansweredQuestions = [];\n\n    // Check all question inputs on the page.\n    $('.question-item').each(function() {\n        const questionItem = $(this);\n        const questionType = questionItem.data('questiontype');\n        const required = questionItem.data('required');\n        const isRequired = required === 1 || required === true || required === '1';\n\n        if (!isRequired) {\n            return;\n        }\n\n        if (!questionItem.is(':visible')) {\n            return;\n        }\n\n        // Skip AI conversation questions as they don't need to be answered before navigation.\n        if (questionType === 'aiconversation') {\n            return;\n        }\n\n        let hasAnswer = false;\n\n        // Check based on question type.\n        if (questionType === 'singlechoice' || questionType === 'likert') {\n            // Radio buttons - check if any is checked.\n            const checked = questionItem.find('input[type=\"radio\"]:checked');\n            hasAnswer = checked.length > 0;\n        } else if (questionType === 'multiplechoice') {\n            // Checkboxes - check if any is checked.\n            const checked = questionItem.find('input[type=\"checkbox\"]:checked');\n            hasAnswer = checked.length > 0;\n        } else if (questionType === 'select') {\n            // Select dropdown - check if value is selected.\n            const select = questionItem.find('select');\n            hasAnswer = select.val() && select.val() !== '';\n        } else if (questionType === 'number') {\n            // Number input - check if value is not empty.\n            const input = questionItem.find('input[type=\"number\"]');\n            const value = input.val();\n            hasAnswer = value !== '' && value !== null && value !== undefined;\n        } else if (questionType === 'shorttext') {\n            // Text input - check if value is not empty.\n            const input = questionItem.find('input[type=\"text\"]');\n            hasAnswer = input.val() && input.val().trim() !== '';\n        } else if (questionType === 'longtext') {\n            // Textarea - check if value is not empty.\n            const textarea = questionItem.find('textarea');\n            hasAnswer = textarea.val() && textarea.val().trim() !== '';\n        }\n\n        if (!hasAnswer) {\n            allAnswered = false;\n            const questionName = questionItem.find('h5, h6').first().text() || 'Question';\n            unansweredQuestions.push(questionName);\n        }\n    });\n\n    return {\n        allAnswered: allAnswered,\n        unansweredQuestions: unansweredQuestions\n    };\n};\n\n/**\n * Initialize navigation control.\n *\n * @param {boolean} canmanage Whether user can manage (admin) - if true, no restrictions apply\n */\nexport const init = (canmanage = false) => {\n    if (initialized) {\n        return;\n    }\n\n    // If user can manage (admin), don't apply any restrictions.\n    if (canmanage) {\n        initialized = true;\n        return;\n    }\n\n    // Check if we're in only_forward mode.\n    const navElement = $('.pages-navigation-bar[data-navigation-mode], nav[data-navigation-mode]').first();\n    const navigationMode = navElement.data('navigation-mode');\n    const canManageValue = navElement.data('canmanage');\n    const canManageNav = canManageValue === true || canManageValue === 1 || canManageValue === '1';\n    const isOnlyForward = navigationMode === 'only_forward';\n    const isFreeNavigation = navigationMode === 'free_navigation';\n\n    // If admin, no restrictions.\n    if (canManageNav) {\n        initialized = true;\n        return;\n    }\n\n    getString('unansweredquestionsleavewarning', 'mod_harpiasurvey').then((message) => {\n        unloadWarningMessage = message;\n    }).catch(() => {\n        unloadWarningMessage = 'There are evaluation questions you did not answer. Are you sure you want to quit?';\n    });\n\n    // Keep only-forward direction restrictions, but do not block page changes for unanswered questions.\n    $(document).on('click', '.navigation-next-link', function(e) {\n        if (!isOnlyForward) {\n            return true;\n        }\n        return true;\n    });\n\n    // Keep default pagination behavior; only disabled items remain blocked below.\n    $(document).on('click', '.pagination a.page-link', function(e) {\n        if (!isOnlyForward) {\n            return true;\n        }\n        const link = $(this);\n        if (link.hasClass('navigation-next-link')) {\n            return;\n        }\n        if (link.closest('li').hasClass('active')) {\n            return;\n        }\n        return true;\n    });\n\n    // Prevent clicking on page tabs for previous pages in only_forward mode.\n    $(document).on('click', '.pages-tabs .page-tab-link', function(e) {\n        // Check if user can manage (admin) - if so, allow all navigation.\n        const navBar = $('.pages-navigation-bar[data-navigation-mode]');\n        const canManage = navBar.data('canmanage') === true || navBar.data('canmanage') === 1;\n\n        if (canManage) {\n            // Admin can navigate freely.\n            return;\n        }\n\n        // Only apply restrictions in only_forward mode.\n        const navMode = navBar.data('navigation-mode');\n\n        const link = $(this);\n        const pageid = link.data('pageid');\n        const currentPageId = $('.pages-tabs .page-tab-link.active').data('pageid');\n\n        // Find the index of the clicked page and current page.\n        let clickedIndex = -1;\n        let currentIndex = -1;\n        $('.pages-tabs .page-tab-link').each(function(index) {\n            const tabPageId = $(this).data('pageid');\n            if (tabPageId == pageid) {\n                clickedIndex = index;\n            }\n            if (tabPageId == currentPageId) {\n                currentIndex = index;\n            }\n        });\n\n        // If clicking on a previous page in only_forward mode, prevent navigation.\n        if (navMode === 'only_forward' && clickedIndex >= 0 && currentIndex >= 0 && clickedIndex < currentIndex) {\n            e.preventDefault();\n            return false;\n        }\n\n        // Do not block page changes for unanswered questions anymore.\n    });\n\n    // Also prevent clicking on page numbers for previous pages.\n    $(document).on('click', '.pagination .page-item.disabled .page-link', function(e) {\n        e.preventDefault();\n        return false;\n    });\n\n    if (isFreeNavigation) {\n        window.addEventListener('beforeunload', (event) => {\n            const result = areAllQuestionsAnswered();\n            if (result.allAnswered) {\n                return;\n            }\n            event.preventDefault();\n            event.returnValue = unloadWarningMessage;\n            return unloadWarningMessage;\n        });\n    }\n\n    initialized = true;\n};\n"],"names":["initialized","unloadWarningMessage","areAllQuestionsAnswered","allAnswered","unansweredQuestions","each","questionItem","this","questionType","data","required","is","hasAnswer","find","length","select","val","value","input","trim","textarea","questionName","first","text","push","canmanage","navElement","navigationMode","canManageValue","canManageNav","isOnlyForward","isFreeNavigation","then","message","catch","document","on","e","link","hasClass","closest","navBar","navMode","pageid","currentPageId","clickedIndex","currentIndex","index","tabPageId","preventDefault","window","addEventListener","event","returnValue"],"mappings":";;;;;;;8IA0BIA,aAAc,EACdC,qBAAuB,0FAOrBC,wBAA0B,SACxBC,aAAc,QACZC,oBAAsB,6BAG1B,kBAAkBC,MAAK,iBACfC,cAAe,mBAAEC,MACjBC,aAAeF,aAAaG,KAAK,gBACjCC,SAAWJ,aAAaG,KAAK,iBACH,IAAbC,WAA+B,IAAbA,UAAkC,MAAbA,qBAMrDJ,aAAaK,GAAG,sBAKA,mBAAjBH,wBAIAI,WAAY,KAGK,iBAAjBJ,cAAoD,WAAjBA,aAA2B,CAG9DI,UADgBN,aAAaO,KAAK,+BACdC,OAAS,OAC1B,GAAqB,mBAAjBN,aAAmC,CAG1CI,UADgBN,aAAaO,KAAK,kCACdC,OAAS,OAC1B,GAAqB,WAAjBN,aAA2B,OAE5BO,OAAST,aAAaO,KAAK,UACjCD,UAAYG,OAAOC,OAA0B,KAAjBD,OAAOC,WAChC,GAAqB,WAAjBR,aAA2B,OAG5BS,MADQX,aAAaO,KAAK,wBACZG,MACpBJ,UAAsB,KAAVK,OAAAA,MAAgBA,WACzB,GAAqB,cAAjBT,aAA8B,OAE/BU,MAAQZ,aAAaO,KAAK,sBAChCD,UAAYM,MAAMF,OAAgC,KAAvBE,MAAMF,MAAMG,YACpC,GAAqB,aAAjBX,aAA6B,OAE9BY,SAAWd,aAAaO,KAAK,YACnCD,UAAYQ,SAASJ,OAAmC,KAA1BI,SAASJ,MAAMG,WAG5CP,UAAW,CACZT,aAAc,QACRkB,aAAef,aAAaO,KAAK,UAAUS,QAAQC,QAAU,WACnEnB,oBAAoBoB,KAAKH,kBAI1B,CACHlB,YAAaA,YACbC,oBAAqBA,oCAST,eAACqB,qEACbzB,sBAKAyB,sBACAzB,aAAc,SAKZ0B,YAAa,mBAAE,0EAA0EJ,QACzFK,eAAiBD,WAAWjB,KAAK,mBACjCmB,eAAiBF,WAAWjB,KAAK,aACjCoB,cAAkC,IAAnBD,gBAA8C,IAAnBA,gBAA2C,MAAnBA,eAClEE,cAAmC,iBAAnBH,eAChBI,iBAAsC,oBAAnBJ,eAGrBE,mCAKM,kCAAmC,oBAAoBG,MAAMC,UACnEhC,qBAAuBgC,WACxBC,OAAM,KACLjC,qBAAuB,2GAIzBkC,UAAUC,GAAG,QAAS,yBAAyB,SAASC,UAI/C,yBAITF,UAAUC,GAAG,QAAS,2BAA2B,SAASC,OACnDP,qBACM,QAELQ,MAAO,mBAAE/B,aACX+B,KAAKC,SAAS,0BAGdD,KAAKE,QAAQ,MAAMD,SAAS,yCAOlCJ,UAAUC,GAAG,QAAS,8BAA8B,SAASC,SAErDI,QAAS,mBAAE,mDAC8B,IAA7BA,OAAOhC,KAAK,cAAsD,IAA7BgC,OAAOhC,KAAK,0BAQ7DiC,QAAUD,OAAOhC,KAAK,mBAGtBkC,QADO,mBAAEpC,MACKE,KAAK,UACnBmC,eAAgB,mBAAE,qCAAqCnC,KAAK,cAG9DoC,cAAgB,EAChBC,cAAgB,4BAClB,8BAA8BzC,MAAK,SAAS0C,aACpCC,WAAY,mBAAEzC,MAAME,KAAK,UAC3BuC,WAAaL,SACbE,aAAeE,OAEfC,WAAaJ,gBACbE,aAAeC,UAKP,iBAAZL,SAA8BG,cAAgB,GAAKC,cAAgB,GAAKD,aAAeC,cACvFT,EAAEY,kBACK,iCAObd,UAAUC,GAAG,QAAS,8CAA8C,SAASC,UAC3EA,EAAEY,kBACK,KAGPlB,kBACAmB,OAAOC,iBAAiB,gBAAiBC,YACtBlD,0BACJC,mBAGXiD,MAAMH,iBACNG,MAAMC,YAAcpD,qBACbA,yBAvFXD,aAAc"}
{"version":3,"file":"navigation_control.min.js","sources":["../src/navigation_control.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Navigation control module for harpiasurvey.\n *\n * @module     mod_harpiasurvey/navigation_control\n * @copyright  2025 Your Name\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {get_string as getString} from 'core/str';\nimport $ from 'jquery';\n\nlet initialized = false;\n\n/**\n * Check if all questions on the current page are answered.\n *\n * @return {boolean} True if all questions are answered\n */\nconst areAllQuestionsAnswered = () => {\n    let allAnswered = true;\n    const unansweredQuestions = [];\n\n    // Check all question inputs on the page.\n    $('.question-item').each(function() {\n        const questionItem = $(this);\n        const questionType = questionItem.data('questiontype');\n\n        // Skip AI conversation questions as they don't need to be answered before navigation.\n        if (questionType === 'aiconversation') {\n            return;\n        }\n\n        let hasAnswer = false;\n\n        // Check based on question type.\n        if (questionType === 'singlechoice' || questionType === 'likert') {\n            // Radio buttons - check if any is checked.\n            const checked = questionItem.find('input[type=\"radio\"]:checked');\n            hasAnswer = checked.length > 0;\n        } else if (questionType === 'multiplechoice') {\n            // Checkboxes - check if any is checked.\n            const checked = questionItem.find('input[type=\"checkbox\"]:checked');\n            hasAnswer = checked.length > 0;\n        } else if (questionType === 'select') {\n            // Select dropdown - check if value is selected.\n            const select = questionItem.find('select');\n            hasAnswer = select.val() && select.val() !== '';\n        } else if (questionType === 'number') {\n            // Number input - check if value is not empty.\n            const input = questionItem.find('input[type=\"number\"]');\n            const value = input.val();\n            hasAnswer = value !== '' && value !== null && value !== undefined;\n        } else if (questionType === 'shorttext') {\n            // Text input - check if value is not empty.\n            const input = questionItem.find('input[type=\"text\"]');\n            hasAnswer = input.val() && input.val().trim() !== '';\n        } else if (questionType === 'longtext') {\n            // Textarea - check if value is not empty.\n            const textarea = questionItem.find('textarea');\n            hasAnswer = textarea.val() && textarea.val().trim() !== '';\n        }\n\n        if (!hasAnswer) {\n            allAnswered = false;\n            const questionName = questionItem.find('h5').text() || 'Question';\n            unansweredQuestions.push(questionName);\n        }\n    });\n\n    return {\n        allAnswered: allAnswered,\n        unansweredQuestions: unansweredQuestions\n    };\n};\n\n/**\n * Initialize navigation control.\n *\n * @param {boolean} canmanage Whether user can manage (admin) - if true, no restrictions apply\n */\nexport const init = (canmanage = false) => {\n    if (initialized) {\n        return;\n    }\n\n    // If user can manage (admin), don't apply any restrictions.\n    if (canmanage) {\n        initialized = true;\n        return;\n    }\n\n    // Check if we're in only_forward mode.\n    const navElement = $('nav[data-navigation-mode]');\n    const navigationMode = navElement.data('navigation-mode');\n    const canManageNav = navElement.data('canmanage') === true || navElement.data('canmanage') === 1;\n\n    // If admin, no restrictions.\n    if (canManageNav) {\n        initialized = true;\n        return;\n    }\n\n    if (navigationMode !== 'only_forward') {\n        // Free navigation mode - no restrictions.\n        initialized = true;\n        return;\n    }\n\n    // Only forward mode - add validation.\n    $(document).on('click', '.navigation-next-link', function(e) {\n        e.preventDefault();\n        const link = $(this);\n        const pageid = link.data('pageid');\n\n        // Check if all questions are answered.\n        const result = areAllQuestionsAnswered(pageid);\n\n        if (!result.allAnswered) {\n            // Show alert.\n            getString('questionsmustbeanswered', 'mod_harpiasurvey').then((message) => {\n                alert(message);\n            });\n            return false;\n        }\n\n        // All questions answered - proceed to next page.\n        window.location.href = link.attr('href');\n    });\n\n    // Prevent clicking on page tabs for previous pages in only_forward mode.\n    $(document).on('click', '.pages-tabs .page-tab-link', function(e) {\n        // Check if user can manage (admin) - if so, allow all navigation.\n        const navBar = $('.pages-navigation-bar[data-navigation-mode]');\n        const canManage = navBar.data('canmanage') === true || navBar.data('canmanage') === 1;\n\n        if (canManage) {\n            // Admin can navigate freely.\n            return;\n        }\n\n        // Only apply restrictions in only_forward mode.\n        const navMode = navBar.data('navigation-mode');\n\n        if (navMode !== 'only_forward') {\n            // Free navigation - allow all tab clicks.\n            return;\n        }\n\n        const link = $(this);\n        const pageid = link.data('pageid');\n        const currentPageId = $('.pages-tabs .page-tab-link.active').data('pageid');\n\n        // Find the index of the clicked page and current page.\n        let clickedIndex = -1;\n        let currentIndex = -1;\n        $('.pages-tabs .page-tab-link').each(function(index) {\n            const tabPageId = $(this).data('pageid');\n            if (tabPageId == pageid) {\n                clickedIndex = index;\n            }\n            if (tabPageId == currentPageId) {\n                currentIndex = index;\n            }\n        });\n\n        // If clicking on a previous page, prevent navigation.\n        if (clickedIndex >= 0 && currentIndex >= 0 && clickedIndex < currentIndex) {\n            e.preventDefault();\n            return false;\n        }\n\n        // If clicking on a future page, check if all questions are answered on current page.\n        if (clickedIndex >= 0 && currentIndex >= 0 && clickedIndex > currentIndex) {\n            // Check if all questions are answered on current page.\n            const result = areAllQuestionsAnswered(currentPageId);\n\n            if (!result.allAnswered) {\n                e.preventDefault();\n                getString('questionsmustbeanswered', 'mod_harpiasurvey').then((message) => {\n                    alert(message);\n                });\n                return false;\n            }\n        }\n    });\n\n    // Also prevent clicking on page numbers for previous pages.\n    $(document).on('click', '.pagination .page-item.disabled .page-link', function(e) {\n        e.preventDefault();\n        return false;\n    });\n\n    initialized = true;\n};\n"],"names":["initialized","areAllQuestionsAnswered","allAnswered","unansweredQuestions","each","questionItem","this","questionType","data","hasAnswer","find","length","select","val","value","input","trim","textarea","questionName","text","push","canmanage","navElement","navigationMode","canManageNav","document","on","e","preventDefault","link","then","message","alert","window","location","href","attr","navBar","pageid","currentPageId","clickedIndex","currentIndex","index","tabPageId"],"mappings":";;;;;;;8IA0BIA,aAAc,QAOZC,wBAA0B,SACxBC,aAAc,QACZC,oBAAsB,6BAG1B,kBAAkBC,MAAK,iBACfC,cAAe,mBAAEC,MACjBC,aAAeF,aAAaG,KAAK,mBAGlB,mBAAjBD,wBAIAE,WAAY,KAGK,iBAAjBF,cAAoD,WAAjBA,aAA2B,CAG9DE,UADgBJ,aAAaK,KAAK,+BACdC,OAAS,OAC1B,GAAqB,mBAAjBJ,aAAmC,CAG1CE,UADgBJ,aAAaK,KAAK,kCACdC,OAAS,OAC1B,GAAqB,WAAjBJ,aAA2B,OAE5BK,OAASP,aAAaK,KAAK,UACjCD,UAAYG,OAAOC,OAA0B,KAAjBD,OAAOC,WAChC,GAAqB,WAAjBN,aAA2B,OAG5BO,MADQT,aAAaK,KAAK,wBACZG,MACpBJ,UAAsB,KAAVK,OAAAA,MAAgBA,WACzB,GAAqB,cAAjBP,aAA8B,OAE/BQ,MAAQV,aAAaK,KAAK,sBAChCD,UAAYM,MAAMF,OAAgC,KAAvBE,MAAMF,MAAMG,YACpC,GAAqB,aAAjBT,aAA6B,OAE9BU,SAAWZ,aAAaK,KAAK,YACnCD,UAAYQ,SAASJ,OAAmC,KAA1BI,SAASJ,MAAMG,WAG5CP,UAAW,CACZP,aAAc,QACRgB,aAAeb,aAAaK,KAAK,MAAMS,QAAU,WACvDhB,oBAAoBiB,KAAKF,kBAI1B,CACHhB,YAAaA,YACbC,oBAAqBA,oCAST,eAACkB,qEACbrB,sBAKAqB,sBACArB,aAAc,SAKZsB,YAAa,mBAAE,6BACfC,eAAiBD,WAAWd,KAAK,mBACjCgB,cAAgD,IAAjCF,WAAWd,KAAK,cAA0D,IAAjCc,WAAWd,KAAK,aAG1EgB,aACAxB,aAAc,EAIK,iBAAnBuB,oCAOFE,UAAUC,GAAG,QAAS,yBAAyB,SAASC,GACtDA,EAAEC,uBACIC,MAAO,mBAAEvB,MACAuB,KAAKrB,KAAK,cAGVP,0BAEHC,sCAEE,0BAA2B,oBAAoB4B,MAAMC,UAC3DC,MAAMD,aAEH,EAIXE,OAAOC,SAASC,KAAON,KAAKO,KAAK,+BAInCX,UAAUC,GAAG,QAAS,8BAA8B,SAASC,SAErDU,QAAS,mBAAE,mDAC8B,IAA7BA,OAAO7B,KAAK,cAAsD,IAA7B6B,OAAO7B,KAAK,uBAUnD,iBAFA6B,OAAO7B,KAAK,gCAQtB8B,QADO,mBAAEhC,MACKE,KAAK,UACnB+B,eAAgB,mBAAE,qCAAqC/B,KAAK,cAG9DgC,cAAgB,EAChBC,cAAgB,yBAClB,8BAA8BrC,MAAK,SAASsC,aACpCC,WAAY,mBAAErC,MAAME,KAAK,UAC3BmC,WAAaL,SACbE,aAAeE,OAEfC,WAAaJ,gBACbE,aAAeC,UAKnBF,cAAgB,GAAKC,cAAgB,GAAKD,aAAeC,oBACzDd,EAAEC,kBACK,KAIPY,cAAgB,GAAKC,cAAgB,GAAKD,aAAeC,aAAc,KAExDxC,0BAEHC,mBACRyB,EAAEC,qCACQ,0BAA2B,oBAAoBE,MAAMC,UAC3DC,MAAMD,aAEH,0BAMjBN,UAAUC,GAAG,QAAS,8CAA8C,SAASC,UAC3EA,EAAEC,kBACK,KAGX5B,aAAc,GAxFVA,aAAc"}